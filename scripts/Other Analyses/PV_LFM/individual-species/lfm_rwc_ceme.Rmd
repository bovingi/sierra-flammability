---
title: "RWC x LFM"
author: "Indra Boving"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, results='hide', warning= FALSE)
options(knitr.duplicate.label = "allow")
library(here)
library(janitor)
library(tidyverse)
library(plotly)
library(DT)
library(broom)
library(lubridate)
library(udpipe)
library(equatiomatic)
```

# Section 1: Pressure Volume Curves

```{r}
data <- read_csv(here("data", "processed-data", "allcurves_clean.csv"), show_col_types = FALSE) %>% 
  mutate(sample = as.factor(sample)) %>% 
  mutate(month = as.factor(month)) %>% 
  mutate(date = date(date))
```
 
### 1.1: Variation in TLPs
 
Look at just one species and timepoint: CEME and fall

```{r}
pv.CEME.all <- data %>% 
  filter(spp == "CEME")

ggplot(pv.CEME.all) +
  geom_point(aes(x = rwd, y = -1/water_potential, color = as.factor(date)), size = .5, alpha = .5) +
  theme_light() +
  labs(x = "Relative Water Deficit", 
       y = "-1/Water potential")

pv.CEME.fall.summary <- data %>%
  group_by(date) %>% 
  filter(spp == "CEME" & timing == "fall" ) %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))
```

```{r}
ggplot(pv.CEME.fall.summary) +
    geom_bar(aes(y = mean, x = date), position="dodge", stat="identity", fill = "lightblue", alpha = .5) +
    geom_errorbar(aes(x=date, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="black", alpha=0.9) +
   labs(title = "CEME TLP, fall dates") +
   theme_light()
```

In fall and spring: 

- fall both dates combined ()

```{r}
pv.CEME.summary <- data %>%
  group_by(timing) %>% 
  filter(spp == "CEME") %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))

 ggplot(pv.CEME.summary) +
    geom_bar(aes(y = mean, x = timing), position="dodge", stat="identity", fill = "lightblue", alpha = .5) +
    geom_errorbar(aes(x=timing, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="black", alpha=0.9) +
   labs(title = "CEME TLP, all dates", 
        y = "TLP (-Mpa)", 
        x = "timing") +
   theme_light()
```


# ```{r, include = TRUE}
# #Split df into groups, then pull sample vectors
# fall.CEME <- pv.CEME.all %>% 
#   filter(timing == "fall") %>% 
#   group_by(sample) %>% 
#   arrange(water_potential) %>%
#   filter(row_number()==1) %>% 
#   pull(tlp)
# 
# spring.CEME <- pv.CEME.all %>% 
#   filter(timing == "spring") %>% 
#    group_by(sample) %>% 
#   arrange(water_potential) %>%
#   filter(row_number()==1) %>% 
#   pull(tlp)
# 
# CEME_tlp_t <- t.test(spring.CEME, fall.CEME)
# CEME_tlp_t
# ```


### 1.2: Try to predict Mpa from LFM with just one species

1.  Get datasets in order:

-   select for just the species and date we are interested in
-   remove any anomalous curves
-   pull the TLP as a value
-   make two sub-datasets: one for all points above the TLP, one for all points below the TLP

```{r message=FALSE, warnings=F}
pv.CEME.fall <- data %>%
  filter(spp == "CEME" & timing == "fall" ) %>% 
  filter(sample != 3)

CEME.tlp <- pv.CEME.fall %>% 
  summarise(mean(tlp)) %>% pull()

CEME.sd <- pv.CEME.fall %>% 
  summarise(sd(tlp)) %>% pull()
```

For fall PV curves, the mean TLP = `r round(CEME.tlp,2)`, sd = `r round(CEME.sd,2)`

```{r, echo=FALSE, message=FALSE, results='hide'}
pv.CEME.fall %>% 
  ggplot(aes(y = water_potential, x = lfm, color = as.factor(date))) +
  geom_point(alpha = .5, size = .5) +
  geom_hline(yintercept = CEME.tlp,
             colour = "lightblue") +
  labs(title = "CEME Pressure Volume Curves, LFM x Mpa", 
       x = "LFM (%)", y = "Mpa") +
  theme_light()
```
Subset data based on TLP: 

```{r}
CEME.above.tlp <- pv.CEME.fall %>% 
  filter(water_potential > tlp) 
# %>% 
#   filter(lfm < 200, lfm > 90)

CEME.below.tlp <- pv.CEME.fall %>% 
  filter(water_potential < tlp)
```

2.  For points below the TLP, there should be a linear relationship between -1/Mpa and LFM

```{r}
CEME.below.tlp %>% 
ggplot(aes(y = -1/water_potential, x = lfm, color = as.factor(sample), shape = as.factor(month))) +
  geom_jitter(alpha = .6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, size = .5, alpha = .5) +
  labs(y = "-1/Mpa", x = "LFM (%)") +
  theme_light()

fit.below.CEME <-lm(-1/water_potential~lfm, CEME.below.tlp)
summary(fit.below.CEME)

mpa.predicted.r <- predict.lm(fit.below.CEME, newdata = data_frame(lfm = 180)) %>% as.numeric() #use this to extract lfm
mpa.predicted.r
```

3.  For points above the TLP, there should be a linear relationship between Mpa and lfm

```{r}
ggplot(data = CEME.above.tlp, aes(y = water_potential, x = lfm, color = sample, shape = as.factor(date))) +
  geom_jitter(alpha = .6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, size = .5, alpha = .5) +
labs(y = "Mpa", x = "LFM (%)")+
  theme_light()

fit.above.CEME <- lm(water_potential ~ lfm, CEME.above.tlp)
summary(fit.above.CEME)

lfm.predicted.r.fit1 <- predict.lm(fit.above.CEME, newdata = data_frame(lfm = 150, swc = 1.3)) %>% as.numeric() #use this to extract lfm
lfm.predicted.r.fit1
```


```{r}
#Adding in SWC might help model?
fit2 <- lm(water_potential ~ lfm + swc, CEME.above.tlp)
summary(fit2)

lfm.predicted.r <- predict.lm(fit2, newdata = data_frame(lfm = 150, swc = 1.3)) %>% as.numeric() #use this to extract lfm
lfm.predicted.r
```

We have some linear models that should be able to predict Mpa from LFM. Now, to test it out...

# Section 2: Can we predict actual values using the models built from the PV curves?

### 2.1: Flam-curve values

- Read in flam curve data

```{r}
flam_curve_phys_all <- read_csv(here("data", "processed-data", "flam_curve_phys_all.csv"), show_col_types = FALSE)
```

- Use `predict()` to see if we can use PV curve models to get values collected during flammability curve testing. 

```{r}
#Our models: 
pretty1 <- extract_eq(fit.below.CEME)
pretty1
pretty2 <- extract_eq(fit.above.CEME)
pretty2
```

We're just interested in CEME, so just look there: 

```{r}
flam_curve_phys_CEME_above <- flam_curve_phys_all %>% 
  filter(rwc_new < 100) %>% 
  filter(spp == "CEME") %>% 
  filter(mpa > tlp)

flam_curve_phys_CEME_below <- flam_curve_phys_all %>% 
  filter(rwc_new < 100) %>% 
  filter(spp == "CEME") %>% 
  filter(mpa < tlp)
```

```{r}
predict.below <- predict(fit.below.CEME, newdata = flam_curve_phys_CEME_below, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.below <- data.frame(flam_curve_phys_CEME_below, predict.below)

predict.df.below %>% 
  ggplot(aes(y = -1/water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, 1) +
  xlim(0, 1) +
  labs(title = "CEME.Actual vs. predicted water potential for points BELOW the TLP", 
       y = "Actual -1/Mpa", 
       x = "Predicted -1/Mpa") +
   theme_light() 
```


```{r}
predict.df.below %>% 
  ggplot(aes(y = water_potential, x = -1/fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -5) +
  xlim(0, -5) +
  labs(title = "CEME. Actual vs. predicted water potential for points BELOW the TLP", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
   theme_light() 
```


```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_below <- ggplot(predict.df.below, aes(x = lfm, y = -1/fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = flam_curve_phys_CEME_below, aes(x = lfm, y = mpa), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa for point BELOW the TLP (CEME)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_below
```

```{r}
predict.above <- predict(fit.above.CEME, newdata = flam_curve_phys_CEME_above, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.above <- data.frame(flam_curve_phys_CEME_above, predict.above)

predict.df.above %>% 
  ggplot(aes(y = water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -3) +
  xlim(0, -3) +
  labs(title = "Actual vs. predicted water potential for points ABOVE the TLP", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
   theme_light() 
```

```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_above <- ggplot(predict.df.above, aes(x = lfm, y = fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = flam_curve_phys_CEME_above, aes(x = lfm, y = mpa), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa for points ABOVE the TLP (CEME)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_above
```

### 2.2: Field data

- Use `predict()` to see if we can use PV curve models to get values collected in the field (predict midday Mpa from LFM): 

```{r}
field_data_CEME <- read_csv(here("data", "processed-data", "field_data.csv"), show_col_types = FALSE) %>% 
  filter(spp == "CEME")
```

We're just interested in CEME, so just look there: 

```{r}
field_data_CEME_above <- field_data_CEME %>% 
  filter(water_potential > tlp)

field_data_CEME_below <- field_data_CEME %>% 
  filter(water_potential < tlp)
```

```{r}
predict.below <- predict(fit.below.CEME, newdata = field_data_CEME_below, se.fit = TRUE, interval = "confidence") #make prediction
predict.below
# Bind to the data to make it actually useful:
predict.df.below <- data.frame(field_data_CEME_below, predict.below)

predict.df.below %>% 
  ggplot(aes(y = -1/water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, 1) +
  xlim(0, 1) +
  labs(title = "Actual vs. predicted water potential for points BELOW the TLP (CEME)", 
       y = "Actual -1/Mpa", 
       x = "Predicted -1/Mpa") +
   theme_light() 

predict.df.below %>% 
  ggplot(aes(y = water_potential, x = -1/fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -5) +
  xlim(0, -5) +
  labs(title = "Actual vs. predicted for points BELOW TLP (CEME)", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
   theme_light() 
```


```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_below <- ggplot(predict.df.below, aes(x = lfm, y = -1/fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = field_data_CEME_below, aes(x = lfm, y = water_potential), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa BELOW TLP (CEME)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_below
```

```{r}
predict.above <- predict(fit.above.CEME, newdata = field_data_CEME_above, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.above <- data.frame(field_data_CEME_above, predict.above)

predict.df.above %>% 
  ggplot(aes(y = water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -3) +
  xlim(0, -3) +
  labs(title = "Actual vs. predicted water potential for points ABOVE the TLP (CEME)", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
 theme_light() 
```

```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_above <- ggplot(predict.df.above, aes(x = lfm, y = fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = field_data_CEME_above, aes(x = lfm, y = water_potential), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa for points ABOVE the TLP (CEME)")+
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_above
```
