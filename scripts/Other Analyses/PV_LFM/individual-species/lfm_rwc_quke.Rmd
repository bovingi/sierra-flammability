---
title: "RWC x LFM"
author: "Indra Boving"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, results='hide', warning= FALSE)
options(knitr.duplicate.label = "allow")
library(here)
library(janitor)
library(tidyverse)
library(plotly)
library(DT)
library(broom)
library(lubridate)
library(udpipe)
library(equatiomatic)
```

# Section 1: Pressure Volume Curves

```{r}
data <- read_csv(here("data", "processed-data", "allcurves_clean.csv"), show_col_types = FALSE) %>% 
  mutate(sample = as.factor(sample)) %>% 
  mutate(month = as.factor(month)) %>% 
  mutate(date = date(date)) %>% 
  mutate(year = year(date))
```
 
### 1.1: Variation in TLPs
 
```{r}
pv.QUKE.all <- data %>% 
  filter(spp == "QUKE")

ggplot(pv.QUKE.all) +
  geom_point(aes(x = rwd, y = -1/water_potential, color = as.factor(date)), size = .5, alpha = .5) +
  theme_light() +
  labs(x = "Relative Water Deficit", 
       y = "-1/Water potential")

pv.QUKE.fall.summary <- data %>%
  group_by(date) %>% 
  filter(spp == "QUKE" & timing == "fall" ) %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))
```

1. All dates: 

```{r}
pv.QUKE.summary.date <- data %>%
  group_by(date) %>% 
  filter(spp == "QUKE") %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))

ggplot(pv.QUKE.summary.date) +
    geom_bar(aes(y = mean, x = date), position="dodge", stat="identity", fill = "lightblue", alpha = .5) +
    geom_errorbar(aes(x=date, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="black", alpha=0.9) +
   labs(title = "QUKE TLP, all dates") +
   theme_light()
```

```{r, include = TRUE}
#See if sig. difference in TLP:
#Split df into groups, then pull sample vectors
fall.QUKE <- pv.QUKE.all %>% 
  filter(timing == "fall") %>% 
  filter(year == 2021) %>% 
  group_by(sample) %>% 
  arrange(water_potential) %>%
  filter(row_number()==1) %>% 
  pull(tlp)
```

```{r}
QUKE.tlp.test <- aov(tlp ~ as.factor(date), pv.QUKE.all)
TukeyHSD(QUKE.tlp.test)
```
There is (?) a significant difference between dates (p = 0.0101)

### 1.2: Try to predict Mpa from LFM with just one species

1.  Get datasets in order:

-   select for just the species and date we are interested in
-   remove any anomalous curves
-   pull the TLP as a value
-   make two sub-datasets: one for all points above the TLP, one for all points below the TLP

```{r message=FALSE, warnings=F}
pv.QUKE.fall <- data %>%
  filter(spp == "QUKE" & timing == "fall" ) %>% 
  filter(sample != 3)

QUKE.tlp <- pv.QUKE.fall %>% 
  summarise(mean(tlp)) %>% pull()

QUKE.sd <- pv.QUKE.fall %>% 
  summarise(sd(tlp)) %>% pull()
```

For fall PV curves, the mean TLP = `r round(QUKE.tlp,2)`, sd = `r round(QUKE.sd,2)`

```{r, echo=FALSE, message=FALSE, results='hide'}
pv.QUKE.fall %>% 
  ggplot(aes(y = water_potential, x = lfm, color = as.factor(date))) +
  geom_point(alpha = .7, size = .7) +
  geom_hline(yintercept = QUKE.tlp,
             colour = "lightblue") +
  labs(title = "QUKE Pressure Volume Curves, LFM x Mpa", 
       x = "LFM (%)", y = "Mpa") +
  theme_light()
```


```{r}
#Subset data based on TLP: 

QUKE.above.tlp <- pv.QUKE.fall %>% 
  filter(water_potential > tlp) 
# %>% 
#   filter(lfm < 200, lfm > 90)

QUKE.below.tlp <- pv.QUKE.fall %>% 
  filter(water_potential < tlp)
```

2.  For points below the TLP, there should be a linear relationship between -1/Mpa and LFM

```{r}
QUKE.below.tlp %>% 
ggplot(aes(y = -1/water_potential, x = lfm, color = as.factor(sample), shape = as.factor(date))) +
  geom_jitter(alpha = .6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, size = .5, alpha = .5) +
  labs(y = "-1/Mpa", x = "LFM (%)") +
  theme_light()

fit.below.QUKE <-lm(-1/water_potential~lfm, QUKE.below.tlp)
summary(fit.below.QUKE)
plot(fit.below.QUKE)
```

3.  For points above the TLP, there should be a linear relationship between Mpa and lfm

```{r}
ggplot(data = QUKE.above.tlp, aes(y = water_potential, x = lfm, color = sample, shape = as.factor(date))) +
  geom_jitter(alpha = .6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, size = .5, alpha = .5) +
labs(y = "Mpa", x = "LFM (%)")+
  theme_light()

fit.above.QUKE <- lm(water_potential ~ lfm, QUKE.above.tlp)
summary(fit.above.QUKE)
plot(fit.above.QUKE)
```


```{r}
#Adding in SWC might help model?
fit2 <- lm(water_potential ~ lfm + swc, QUKE.above.tlp)
summary(fit2)

lfm.predicted.r <- predict.lm(fit2, newdata = data_frame(lfm = 150, swc = 1.3)) %>% as.numeric() #use this to extract lfm
lfm.predicted.r
```

We have some linear models that should be able to predict Mpa from LFM. Now, to test it out...

# Section 2: Can we predict actual values using the models built from the PV curves?

## 2.1: Flam-curve values

- Read in flam curve data

```{r}
flam_curve_phys_all <- read_csv(here("data", "processed-data", "flam_curve_phys_all.csv"), show_col_types = FALSE)
```

- Use `predict()` to see if we can use PV curve models to get values collected during flammability curve testing. 

```{r, results='asis'}
#Our models: 
pretty1 <- extract_eq(fit.below.QUKE)
pretty1
pretty2 <- extract_eq(fit.above.QUKE)
pretty2
```

We're just interested in QUKE, so just look there: 

```{r}
flam_curve_phys_QUKE_above <- flam_curve_phys_all %>% 
  filter(rwc_new < 100) %>% 
  filter(spp == "QUKE") %>% 
  filter(mpa > tlp)

flam_curve_phys_QUKE_below <- flam_curve_phys_all %>% 
  filter(rwc_new < 100) %>% 
  filter(spp == "QUKE") %>% 
  filter(mpa < tlp)
```

### Below TLP:

```{r}
predict.below <- predict(fit.below.QUKE, newdata = flam_curve_phys_QUKE_below, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.below <- data.frame(flam_curve_phys_QUKE_below, predict.below)

predict.df.below %>% 
  ggplot(aes(y = -1/water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, 1) +
  xlim(0, 1) +
  labs(title = "QUKE. Actual vs. predicted -1/Mpa for points BELOW the TLP", 
       y = "Actual -1/Mpa", 
       x = "Predicted -1/Mpa") +
   theme_light() 
```


```{r}
predict.df.below %>% 
  ggplot(aes(y = water_potential, x = -1/fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -5) +
  xlim(0, -5) +
  labs(title = "QUKE. Actual vs. predicted water potential for points BELOW the TLP", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
   theme_light() 
```


```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_below <- ggplot(predict.df.below, aes(x = lfm, y = -1/fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = flam_curve_phys_QUKE_below, aes(x = lfm, y = mpa), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa for point BELOW the TLP (QUKE)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_below
```

### Above TLP:

```{r}
predict.above <- predict(fit.above.QUKE, newdata = flam_curve_phys_QUKE_above, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.above <- data.frame(flam_curve_phys_QUKE_above, predict.above)

predict.df.above %>% 
  ggplot(aes(y = water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -3) +
  xlim(0, -3) +
  labs(title = "Actual vs. predicted water potential for points ABOVE the TLP", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
   theme_light() 
```

```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_above <- ggplot(predict.df.above, aes(x = lfm, y = fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = flam_curve_phys_QUKE_above, aes(x = lfm, y = mpa), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa for points ABOVE the TLP (QUKE)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_above
```

## 2.2: Field data

- Use `predict()` to see if we can use PV curve models to get values collected in the field (predict midday Mpa from LFM): 

```{r}
field_data_QUKE <- read_csv(here("data", "processed-data", "field_data.csv"), show_col_types = FALSE) %>% 
  filter(spp == "QUKE")
```

We're just interested in QUKE, so just look there: 

```{r}
field_data_QUKE_above <- field_data_QUKE %>% 
  filter(water_potential > tlp)

field_data_QUKE_below <- field_data_QUKE %>% 
  filter(water_potential < tlp)
```


### Below TLP:

```{r}
predict.below <- predict(fit.below.QUKE, newdata = field_data_QUKE_below, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.below <- data.frame(field_data_QUKE_below, predict.below)

predict.df.below %>% 
  ggplot(aes(y = -1/water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, 1) +
  xlim(0, 1) +
  labs(title = "Actual vs. predicted water potential for points BELOW the TLP (QUKE)", 
       y = "Actual -1/Mpa", 
       x = "Predicted -1/Mpa") +
   theme_light() 

predict.df.below %>% 
  ggplot(aes(y = water_potential, x = -1/fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -5) +
  xlim(0, -5) +
  labs(title = "Actual vs. predicted for points BELOW TLP (QUKE)", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
   theme_light() 
```


```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_below <- ggplot(predict.df.below, aes(x = lfm, y = -1/fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = field_data_QUKE_below, aes(x = lfm, y = water_potential), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa BELOW TLP (QUKE)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_below
```

### Above TLP:

```{r}
predict.above <- predict(fit.above.QUKE, newdata = field_data_QUKE_above, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.above <- data.frame(field_data_QUKE_above, predict.above)

predict.df.above %>% 
  ggplot(aes(y = water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -3) +
  xlim(0, -3) +
  labs(title = "Actual vs. predicted water potential for points ABOVE the TLP (QUKE)", 
       y = "Actual Mpa", 
       x = "Predicted Mpa") +
 theme_light() 
```

```{r, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_above <- ggplot(predict.df.above, aes(x = lfm, y = fit.fit)) +
  geom_point(color = "lightblue", alpha = 0.7) +
  geom_point(data = field_data_QUKE_above, aes(x = lfm, y = water_potential), alpha = 0.7) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (lightblue) vs. observed (black) LFM and Mpa for points ABOVE the TLP (QUKE)")+
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_above
```
