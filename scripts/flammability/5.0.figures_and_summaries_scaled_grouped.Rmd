---
title: "Visualizations and Summaries - Figures"
author: "Indra Boving & Joe Celebrezze"
date: "6/21/2022"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(ggpubr)
library(cowplot)
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
#library(strengejacke)
library(sjPlot) # table functions
library(here)
library(effects) #for plofhng model effects
library(sjstats) #use for r2 functions
library("broom.mixed")
library(MuMIn)
library(modelsummary)
library(nlme)
library(lme4)
library(MetBrewer)
#devtools::install_github("an-bui/calecopal")
#library(calecopal)
#devtools::install_github("hohenstein/remef")
library(remef)

library(kableExtra)

filter = dplyr::filter
mutate = dplyr::mutate
select = dplyr::select
here = here::here
group_by = dplyr::group_by

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```

#------------------------------------
# 1. Data Wrangling

- For the Sierra analysis, this is combining all species and dropping the august sampling data (not enough samples and it was measured a lil differently). 

```{r}
mem_data_all_raw <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv")) %>% 
  select(lfm, mpa, fh, fh, fd, gd,tti, prop_ignite, temp_change, ignition, sample_wt, dry_wt, fresh_wt, water_wt, location, site, year_month, spp, individual, bins10lfm, bins5lfm, bins20lfm) %>% 
  mutate(dw_flam_sample = sample_wt * (dry_wt/fresh_wt),
         ww_flam_sample = sample_wt * (water_wt/fresh_wt)) %>% 
  mutate(excess_water = (ww_flam_sample - dw_flam_sample)) %>% 
  dplyr::group_by(spp) %>% 
  mutate(mpa_scaled = scale(mpa),
         dw_flam_sample_scaled = scale(dw_flam_sample), 
         sample_wt_scaled = scale(sample_wt), 
         ww_flam_sample_scaled = scale(ww_flam_sample),
         lfm_scaled = scale(lfm), 
         excess_water_scaled = scale(excess_water)) %>% 
  mutate(Species = case_when(
    spp == "arpa" ~ "A. patula", 
    spp == "abco" ~ "A. concolor",
    spp == "cade" ~ "C. decurrens",
    spp == "ceco" ~ "C. cordulatus",
    spp == "pije" ~ "P. jeffreyi",
    spp == "quke" ~ "Q. kelloggii"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "arpa" ~ "Angiosperm", 
    spp == "abco" ~ "Gymnosperm",
    spp == "cade" ~ "Gymnosperm",
    spp == "ceco" ~ "Angiosperm",
    spp == "pije" ~ "Gymnosperm",
    spp == "quke" ~ "Angiosperm"
  )) %>% 
  filter(!year_month %in% c("2021_august")) %>% 
  filter(ignition != 2) %>% # Removing manual ignitions
  drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled) 

mem_data_all <- mem_data_all_raw %>% 
  filter(spp != "ceco")

field_data_all <- read_csv(here("processed-data", "analysis 2.0","field_data_2020_2021.csv"))
```

## Specifying significance
The below is based on the mixed effects models used for each flam metric. The tti.sig, fd.sig, etc. are regarding to species significance, while the F.tti.sig are regarding to angio vs gymno functional group significance
```{r}
# Significance by species
mem_data_all <- mem_data_all %>% 
  mutate(tti.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(fh.mpa.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "Yes", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(fh.lfm.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "Yes", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(fd.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(gd.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(prop.ig.mpa.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(prop.ig.lfm.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(temp.change.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No"))

# Significance by functional group
mem_data_all <- mem_data_all %>% 
  mutate(F.tti.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.fh.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "Yes")) %>% 
  mutate(F.gd.lfm.sig = case_when(
    F.Group == "Angiosperm" ~ "Yes", F.Group == "Gymnosperm" ~ "Yes")) %>% 
  mutate(F.gd.mpa.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No"))
```

## Pre- & Post- TLP
```{r}
# PV Data
pv_summary_df_timing <- read_csv(here("processed-data", "pv_summary_df_timing.csv"), show_col_types = FALSE) %>% 
   filter(timing == "fall") %>% 
  mutate_if(is.character, str_to_lower) %>% 
  #mutate_at(spp, str_to_lower) %>% 
  mutate(spp = str_trim(spp),
    name = paste(spp,"_pv", sep = ""), 
    mean_tlp = -1*mean_tlp, 
    lwr = -1*lwr, 
    upr = -1*upr) %>% 
  filter(!spp %in% c("adfa", "ceme"))

pv_summary_df_timing %>% 
  group_split(spp) %>%
   setNames(unique(pv_summary_df_timing$name)) %>%
  list2env(envir = globalenv())

mem_data_all_raw <- mem_data_all_raw %>% 
  mutate(pre.post.tlp = case_when(
    spp == 'abco' & mpa > abco_pv$mean_tlp ~ 'post',
    spp == 'abco' & mpa < abco_pv$mean_tlp ~ 'pre',
    spp == 'arpa' & mpa > arpa_pv$mean_tlp ~ 'post',
    spp == 'arpa' & mpa < arpa_pv$mean_tlp ~ 'pre',
    spp == 'cade' & mpa > cade_pv$mean_tlp ~ 'post',
    spp == 'cade' & mpa < cade_pv$mean_tlp ~ 'pre',
    spp == 'pije' & mpa > pije_pv$mean_tlp ~ 'post',
    spp == 'pije' & mpa < pije_pv$mean_tlp ~ 'pre',
    spp == 'ceco' & mpa > ceco_pv$mean_tlp ~ 'post',
    spp == 'ceco' & mpa < ceco_pv$mean_tlp ~ 'pre',
    spp == 'quke' & mpa > quke_pv$mean_tlp ~ 'post',
    spp == 'quke' & mpa < quke_pv$mean_tlp ~ 'pre'
  )) %>% 
  mutate(pre.post.tlp.lfm = case_when(
    spp == 'abco' & lfm > abco_pv$mean_lfm ~ 'pre',
    spp == 'abco' & lfm < abco_pv$mean_lfm ~ 'post',
    spp == 'arpa' & lfm > arpa_pv$mean_lfm ~ 'pre',
    spp == 'arpa' & lfm < arpa_pv$mean_lfm ~ 'post',
    spp == 'cade' & lfm > cade_pv$mean_lfm ~ 'pre',
    spp == 'cade' & lfm < cade_pv$mean_lfm ~ 'post',
    spp == 'pije' & lfm > pije_pv$mean_lfm ~ 'pre',
    spp == 'pije' & lfm < pije_pv$mean_lfm ~ 'post',
    spp == 'ceco' & lfm > ceco_pv$mean_lfm ~ 'pre',
    spp == 'ceco' & lfm < ceco_pv$mean_lfm ~ 'post',
    spp == 'quke' & lfm > quke_pv$mean_lfm ~ 'pre',
    spp == 'quke' & lfm < quke_pv$mean_lfm ~ 'post'
  ))
```


# 2. Remef figures of each flam metric

## TTI
```{r}
mem_data_all_r <- mem_data_all%>% drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled, fh, gd)

tti_mod <- lmer(tti ~ spp*mpa_scaled + spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

tti_mod_fgroup <- lmer(tti ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)

r_tti_mpa <- remef(tti_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_tti_lfm <- remef(tti_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_tti_mpa <- r_tti_mpa
mem_data_all_r$r_tti_lfm <- r_tti_lfm

tti_plot <- mem_data_all_r %>% 
  ggplot(aes(y = tti, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",                                   axis.text = element_text(size = 14), axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition (sec)") +
  annotate(geom = "text", x = -1.8, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot

tti_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_tti_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",                                   axis.text = element_text(size = 14), axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition") +
  annotate(geom = "text", x = -1.8, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot_r

tti_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = tti, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none", 
        axis.text = element_text(size = 14), 
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition (sec)") +
  annotate(geom = "text", x = -2.6, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot_lfm

# For main figure:
tti_plot_lfm_r <- mem_data_all_r %>%
  ggplot(aes(y = r_tti_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.tti.sig), alpha = .75) + 
  ##color_many2  + # For color by F.Group w/ CECO
  #color_noceco+ # For color by F.Group w/o CECO
  scale_color_manual(values = c('#FDD358', 'black')) + # For color by angio vs gymno; change F.Group > F.Group, tti.sig > F.tti.sig (version 2)
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Time to Ignition") +
  annotate(geom = "text", x = -2.6, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot_lfm_r

#ggarrange(tti_plot, tti_plot_r, tti_plot_lfm, tti_plot_lfm_r )
```

## FH
```{r}
fh_mod <- lmer(fh ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fh_mod_fgroup <- lmer(fh ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)

r_fh_mpa <- remef(fh_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fh_lfm <- remef(fh_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fh_mpa <- r_fh_mpa
mem_data_all_r$r_fh_lfm <- r_fh_lfm

fh_plot <- mem_data_all_r %>% 
  ggplot(aes(y = fh, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.mpa.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -1.8, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot

fh_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.mpa.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height") +
  annotate(geom = "text", x = -1.8, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot_r

# For main plot:
fh_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = fh, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.lfm.sig), alpha = .75) + 
  #color_many2  +
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -2.6, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot_lfm

fh_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.fh.sig), alpha = .75) + 
  #color_many2  + # For color by F.Group w/ CECO
  #color_noceco+ # For color by F.Group w/o CECO
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_color_manual(values = c('#FDD358', 'black')) + # For color by angio vs gymno; change F.Group > F.Group (version 2)
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank())+
  labs(x = "", 
       y = "Flame Height") +
  annotate(geom = "text", x = -2.6, y = 55, label = 'd', fontface = 'bold', size = 10)
fh_plot_lfm_r

#ggarrange(fh_plot, fh_plot_r, fh_plot_lfm, fh_plot_lfm_r, nrow = 2, ncol = 2)
```

## GD
```{r}
gd_mod <- lmer(gd ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

gd_mod_fgroup <- lmer(gd ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)

r_gd_mpa <- remef(gd_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_gd_lfm <- remef(gd_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_gd_mpa <- r_gd_mpa
mem_data_all_r$r_gd_lfm <- r_gd_lfm

gd_plot <- mem_data_all_r %>% 
  ggplot(aes(y = gd, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration (sec)") +
  annotate(geom = "text", x = -1.8, y = 435, label = 'c', fontface = 'bold', size = 10)
gd_plot

gd_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration") +
  annotate(geom = "text", x = -1.8, y = 430, label = 'c', fontface = 'bold', size = 10)
gd_plot_r

gd_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = gd, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration (sec)") +
  annotate(geom = "text", x = -2.6, y = 420, label = 'c', fontface = 'bold', size = 10)
gd_plot_lfm

# For main figure:
gd_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.gd.lfm.sig), alpha = .75) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'))+
  #color_many2 + # For color by F.Group w/ CECO
  #color_noceco + # For color by F.Group w/o CECO
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_color_manual(values = c('#FDD358', 'black')) + # For color by angio vs gymno; change F.Group > F.Group (version 2)
  labs(x = "LFM", 
       y = "Glow Duration") +
  annotate(geom = "text", x = -2.6, y = 400, label = 'g', fontface = 'bold', size = 10)
gd_plot_lfm_r

#ggarrange(gd_plot, gd_plot_r, gd_plot_lfm, gd_plot_lfm_r, nrow = 2, ncol = 2)
```

## FD
```{r}
fd_mod <- lmer(fd ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fd_mod_fgroup <- lmer(fd ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)

r_fd_mpa <- remef(fd_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fd_lfm <- remef(fd_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fd_mpa <- r_fd_mpa
mem_data_all_r$r_fd_lfm <- r_fd_lfm

fd_plot <- mem_data_all_r %>% 
  ggplot(aes(y = fd, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration (sec)") +
  annotate(geom = "text", x = -1.8, y = 96, label = 'd', fontface = 'bold', size = 10)
fd_plot

fd_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fd_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
                       axis.text = element_text(size = 14),
                       axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration") +
  annotate(geom = "text", x = -1.8, y = 87, label = 'd', fontface = 'bold', size = 10)
fd_plot_r

fd_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = fd, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration (sec)") +
  annotate(geom = "text", x = -2.6, y = 95, label = 'd', fontface = 'bold', size = 10)
fd_plot_lfm

fd_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fd_lfm, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration") +
  annotate(geom = "text", x = -2.6, y = 88, label = 'd', fontface = 'bold', size = 10)
fd_plot_lfm_r

#ggarrange(fd_plot, fd_plot_r, fd_plot_lfm, fd_plot_lfm_r, nrow = 2, ncol = 2)
```

## Temp Change
```{r}
temp_change_mod <- lmer(temp_change ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + spp*sample_wt_scaled + (1 | individual), data = mem_data_all) 

performance::check_collinearity(temp_change_mod)
temp_change_mod
AIC(temp_change_mod)
```

```{r}
temp_change_mod <- lmer(temp_change ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r) 
#temp_change_mod_noints <- lmer(temp_change ~ spp + mpa_scaled + lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all) 

r_temp_change_mpa <- remef(temp_change_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_temp_change_lfm <- remef(temp_change_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_temp_change_mpa <- r_temp_change_mpa
mem_data_all_r$r_temp_change_lfm <- r_temp_change_lfm

temp_change_plot <- mem_data_all_r %>% 
  ggplot(aes(y = temp_change, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Temp. Change (C)") +
  annotate(geom = "text", x = -1.8, y = 250, label = 'e', fontface = 'bold', size = 10)
temp_change_plot

temp_change_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_temp_change_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 18, face = 'bold'),
        axis.title.y = element_text(size = 22, face = 'bold')) +
  labs(x = "Water Potential (Scaled)", 
       y = "Temp. Change") +
  annotate(geom = "text", x = -1.8, y = 255, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_r

temp_change_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = temp_change, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Temp. Change (C)") +
  annotate(geom = "text", x = -2.6, y = 245, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_lfm

temp_change_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_temp_change_lfm, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 18, face = 'bold'),
        axis.title.y = element_text(size = 22, face = 'bold'))+
  labs(x = "LFM (Scaled)", 
       y = "Temp. Change") +
  annotate(geom = "text", x = -2.6, y = 255, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_lfm_r

#ggarrange(temp_change_plot, temp_change_plot_r, temp_change_plot_lfm, temp_change_plot_lfm_r, nrow = 2, ncol = 2)
```

## Prop. Ignite
```{r}
prop_ignite_mod <- lmer(prop_ignite ~ spp*mpa_scaled + spp*lfm_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all_r)
#prop_ignite_mod_noints <- lmer(prop_ignite ~ spp + mpa_scaled + lfm_scaled  + site + year_month + (1 | individual), data = mem_data_all)

r_prop_ignite_mpa <- remef(prop_ignite_mod, fix = c("sample_wt_scaled","lfm_scaled","site"), ran = list(individual = c("(Intercept)")))
r_prop_ignite_lfm <- remef(prop_ignite_mod, fix = c("sample_wt_scaled","mpa_scaled","site"), ran = list(individual = c("(Intercept)")))

mem_data_prop_ignite_r <- mem_data_all_r %>% 
  drop_na(prop_ignite)
mem_data_prop_ignite_r$r_prop_ignite_mpa <- r_prop_ignite_mpa
mem_data_prop_ignite_r$r_prop_ignite_lfm <- r_prop_ignite_lfm

prop_ignite_plot <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = prop_ignite, 
             x = mpa_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.mpa.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Proportion Ignited (%)") +
  annotate(geom = "text", x = -1.8, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot

prop_ignite_plot_r <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = r_prop_ignite_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.mpa.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Proportion Ignited") +
  annotate(geom = "text", x = -1.8, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot_r

prop_ignite_plot_lfm <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = prop_ignite, 
             x = lfm_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.lfm.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Proportion Ignited (%)") +
  annotate(geom = "text", x = -2.6, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot_lfm

prop_ignite_plot_lfm_r <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = r_prop_ignite_lfm, 
             x = lfm_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.lfm.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Proportion Ignited") +
  annotate(geom = "text", x = -2.6, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot_lfm_r

#ggarrange(prop_ignite_plot, prop_ignite_plot_r, prop_ignite_plot_lfm, prop_ignite_plot_lfm_r, nrow = 2, ncol = 2)
```


####  Boxplots
```{r}
# prop_ignite_mod <- lmer(prop_ignite ~ spp*mpa_scaled + spp*lfm_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all_r)
# 
# r_prop_ignite_mpa <- remef(prop_ignite_mod, fix = c("sample_wt_scaled","lfm_scaled","site"), ran = list(individual = c("(Intercept)")))
# r_prop_ignite_lfm <- remef(prop_ignite_mod, fix = c("sample_wt_scaled","mpa_scaled","site"), ran = list(individual = c("(Intercept)")))
# 
# mem_data_all
# mem_data_prop_ignite_r <- mem_data_all_r %>% 
#   drop_na(prop_ignite) %>% 
#  # group_by(spp) %>% 
#    mutate(bin=cut_width(lfm, 
#                         width=10, 
#                         boundary=0
#                        # dig.lab = 3,
#                       # ordered_result = T
#                         )) 
# 
# mem_data_prop_ignite_r$r_prop_ignite_mpa <- r_prop_ignite_mpa
# 
# mem_data_prop_ignite_r$r_prop_ignite_lfm <- r_prop_ignite_lfm
# 
# range(mem_data_prop_ignite_r$lfm)
# # 
# unique(mem_data_prop_ignite_r$bin)
# unique(mem_data_prop_ignite_r$bins10lfm)
# # 
# mem_data_prop_ignite_r <- mem_data_prop_ignite_r %>% 
#   mutate(bin_relevel = forcats::fct_relevel(bin, "[10,20]",
#                                           "(20,30]", 
#                                           "(30,40]", 
#                                          # "[40,50]", 
#                                           "(40,50]",
#                                           "(50,60]", 
#                                          # "[50, 60]",
#                                                 "(60,70]", 
#                                          #"[60,70]",
#                                          "(70,80]", "(80,90]", "(90,100]", "(100,110]",
#                                                 "(110,120]", "(120,130]", "(130,140]", "(150,160]","(160,170]", "(170,180]", "(180,190]", "(190,200]", "(230,240]")) %>% 
#   arrange() %>% 
#    mutate(hydration = case_when(
#      lfm < 150 ~ 'dry', 
#      lfm > 150 ~ 'wet', 
#      TRUE ~ 'something'
#    ))
```
```{r, warning=FALSE}
# mem_data_prop_ignite_r %>% 
#   #filter(spp == "quke") %>% 
#   ggplot(aes(y = r_prop_ignite_lfm, 
#              x = bin_relevel))+
#    facet_wrap(~spp, scales = "free") +
#    geom_boxplot()
```

The below code seems to work for proportion ignited, and also shows some interesting trends (angios are igniting less often):

```{r, warning=FALSE}

df <- mem_data_all_raw %>% 
   mutate(hydration = case_when(
     lfm <= 100 ~ 'dry', 
     lfm > 100 ~ 'wet', 
     TRUE ~ 'something'
   )) %>% 
   #filter(lfm < 150) %>% 
    mutate(ignition2 = case_when(
     ignition == "M" ~ 0, 
     ignition == "1 and M" ~ 1, 
     ignition == "1" ~ 1, 
     ignition == "2" ~ 1, 
     ignition == "3" ~ 0, 
     TRUE ~ as.numeric(ignition))) %>% 
   group_by(spp, individual, hydration) %>% #group by year, model, spp, group column
   add_tally %>% 
   mutate(total = sum(ignition2, na.rm = T), 
          prop_ignite = paste0(round(100 * total/n)), 
          prop_ignite = as.numeric(prop_ignite)) %>% 
  # mutate(prop_dry = ) %>% 
   mutate(spp_props = forcats::fct_relevel(spp, 
                                           "ceco", 
                                           "quke",
                                           "arpa", 
                                           "pije", 
                                           "cade", 
                                           "abco")) %>% 
  ungroup() %>% 
  group_by(spp, individual) %>% 
   add_tally %>% 
   mutate(total_all = sum(ignition2, na.rm = T), 
          prop_ignite_all = paste0(round(100 * total_all/nn)), 
          prop_ignite_all = as.numeric(prop_ignite_all))
 

 df %>% 
   ggplot(aes(y = prop_ignite, 
              x = spp_props, 
              fill = hydration)) +
   geom_boxplot(alpha = .5) +
   facet_wrap(~`F.Group`, scales = "free") +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration") 
 
  df %>% 
   # group_by(spp) %>% 
   # add_tally() %>% 
   ggplot(aes(y = prop_ignite_all, 
              x = spp_props, 
              #fill = hydration
              )) +
   geom_boxplot(alpha = .5) +
    facet_wrap(~`F.Group`, scales = "free_x"
               ) +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration") 
```

##### Pre- vs. Post-TLP
```{r}
df %>% 
   ggplot(aes(y = prop_ignite, 
              x = spp_props, 
              fill = factor(pre.post.tlp, level = c('pre', 'post')))) +
   geom_boxplot(alpha = .5) +
   facet_wrap(~`F.Group`, scales = "free") +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration")

df %>% 
   ggplot(aes(y = prop_ignite, 
              x = spp_props, 
              fill = factor(pre.post.tlp.lfm, level = c('pre', 'post')))) +
   geom_boxplot(alpha = .5) +
   facet_wrap(~`F.Group`, scales = "free") +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Pre- or Post-TLP (Split by LFM)")
```

###### Angiosperms ONLY
```{r}
df %>% filter(F.Group == "Angiosperm") %>% 
   ggplot(aes(y = prop_ignite, 
              x = Species, 
              fill = factor(pre.post.tlp, level = c('pre', 'post')))) +
   geom_boxplot(alpha = .5) +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration")  +
   theme(axis.title.y = element_text(face = 'bold', size = 12),
         axis.text.y = element_text(size = 8),
         axis.title.x = element_blank(),
         axis.text.x = element_text(face = 'italic', size = 10),
         legend.title = element_text(face = 'bold', size = 10),
         panel.grid = element_blank())
```


It looks like it doesnt make a huge difference if we use remef or not, so we'll go ahead and use it.
Now, putting all figures together, remef only: 

# All together
```{r}
plot_legend <- mem_data_all_r %>% 
  ggplot(aes(x = tti, y = mpa, group = Species)) +
  geom_point(aes(color = Species), size = 2.2) +
  geom_smooth(se = F, method = 'lm', aes(color = Species, lty = fh.mpa.sig)) +
  #color_many2  +
  labs(color = "Species", lty = "Significant?") +
  theme(legend.text = element_text(size = 16, face = 'italic'), 
        legend.title = element_text(size = 22, face = 'bold'),
        legend.key = element_rect(fill = 'white')) +
  guides(lty = guide_legend(override.aes = list(color = 'black')))

legend <- cowplot::get_legend(plot_legend)
```

#### MPa
```{r, fig.height=5, fig.width=9}
#Mpas:
plots <- cowplot::plot_grid(tti_plot_r,
          fh_plot_r,
          gd_plot_r,
          fd_plot_r,
          temp_change_plot_r,
          prop_ignite_plot_r
          #, 
         # ncol = 3, 
         # nrow = 2, 
          )
plots
plots_legend <- cowplot::plot_grid(plots, legend, rel_widths = c(5, 1))
plots_legend

#ggsave(plot=plots_legend, bg = "white" , here::here("figures", "mpa_flam_metrics.jpeg"), device="jpg")

ggsave(plot=plots_legend, bg = "white" , here::here("figures", "mpa_flam_metrics_withceco.jpeg"), device="jpg")
```

#### LFM
```{r, fig.height=5, fig.width=9}
plots <- cowplot::plot_grid(tti_plot_lfm_r,
          fh_plot_lfm_r,
          gd_plot_lfm_r,
          fd_plot_lfm_r,
          temp_change_plot_lfm_r,
          prop_ignite_plot_lfm_r
          #, 
         # ncol = 3, 
         # nrow = 2, 
          )
plots
plots_legend <- cowplot::plot_grid(plots, legend, rel_widths = c(5, 1))
plots_legend

#ggsave(plot=plots_legend, bg = "white" , here::here("figures", "lfm_flam_metrics.jpeg"), device="jpg")

ggsave(plot=plots_legend, bg = "white" , here::here("figures", "lfm_flam_metrics_withceco.jpeg"), device="jpg")
```
#3. Species Differences

#### Data
```{r}
tidy_data <- read_csv(here::here("processed-data", "analysis 2.0", "tidy_all_mems.csv")) %>% 
  add_row(term = c("sppabco", "sppabco", "sppabco", "sppabco", "sppabco", "sppabco"),
          estimate =c(0,0,0,0,0,0), 
          y_var = c("fh", "fd", "tti", "gd", "prop_ignite", "temp_change")) %>% 
  mutate(upr = estimate + (std.error/2), 
         lwr = estimate - (std.error/2)) %>% 
  mutate(species = case_when(
    term == "sppabco" ~ "A. concolor",
       term ==                "spparpa" ~ "A. patula",
        term ==               "sppcade" ~ "C. decurrens", 
         term ==              "sppceco" ~ "C. cordulatus", 
         term ==              "spppije" ~ "P. jefferyi",
          term ==             "sppquke" ~ "Q. kelloggii"
  )) %>% 
    mutate(y_var_name= case_when(
    y_var == "tti" ~ "Time to ignition",
       y_var ==                "fh" ~ "Flame height",
        y_var ==               "fd" ~ "Flame duration", 
         y_var ==              "prop_ignite" ~ "Prop. ignited", 
         y_var ==              "temp_change" ~ "Temp. change",
          y_var ==             "gd" ~ "Glow duration"
  ))
```
```{r}
unique(tidy_data$term)
```

### Species Effects
```{r, fig.height=3, fig.width=6}
spp_estimates <- tidy_data  %>% 
  filter(term %in% c("sppabco",
                     "spparpa", 
                     "sppcade" ,
                     "sppceco",
                     "spppije",
                     "sppquke"                 
                     )) %>% 
  ggplot(
    aes(color= species)
    ) + 
  geom_point(aes(x = estimate,y = species), size =3) +
    geom_point(aes(x = upr, y = species), size = 1) +
  geom_point(aes(x = lwr, y = species), size = 1) +
  #geom_line(aes(group = species, y = species, x = upr)) +
  geom_segment(aes(x= lwr, xend = upr, y = species, yend = species, color = species))+
  labs(y = "", 
       color = "Species", 
       x = "Estimate") +
    facet_wrap(~y_var_name, scales = "free") + 
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  axis.text.y = element_blank(), axis.ticks.y = element_blank()
)+
  geom_vline(xintercept = 0,
             linetype="dotted") +
  color_many2 
spp_estimates

ggsave(plot=spp_estimates, bg = "white" , here::here("figures", "spp_estimates_flam_metrics_withceco.jpeg"), device="jpg")
```

# 4. Effect Size Plots
For these plots, focusing on TTI, FH, GD, Prop Ignition

## MEM Table
Originally, I used this to pull the effect size from, but the numbers provided for the spp:lfm_scaled interaction represented the intercepts rather than the slopes, so instead I punched these two lines of code into the scatterplots:

  facet_wrap(~Species) +
  stat_regline_equation(label.y = 250, aes(label = ..eq.label..)) +
  
And then I jotted down the slopes from each linear equation to represent species' effect sizes.
  
```{r}
tab_model(tti_mod_fgroup, fh_mod_fgroup, gd_mod_fgroup, prop_ignite_mod,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
         string.pred = "Coeffcient", 
        dv.labels = c("Time to Ignition", "Flame Height","Glow Duration", "Proportion  Ignited"),
         title = "Effect Size Plots: MEM Table",
  string.p = "P-Value", 
  p.style = "stars")
```

  ---------------------------------------------------------------------------------------
 | NOTE: For standard error, should we do +/-0.5*standard error  or +/- standard error ? |
  ---------------------------------------------------------------------------------------

## TTI
Gathering effect sizes from equations and standard error from the summary of the mixed effects model
```{r}
summary(tti_mod)

species <- c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii")
tti.ES.lfm <- c(7.4, -0.057, 6.4, 9.3, 0.55) # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
tti.SE.lfm <- c(3.0378, 5.3613, 4.3614, 4.6098, 7.6662)
tti.sig.lfm <- c('No', 'No', 'No', 'No', 'No')
tti.ES.mpa <- c(-3.8,3.5, -3.4, 1.7, 1.9) 
tti.SE.mpa <- c(2.8881, 5.1628, 4.1256, 4.1848, 7.5027)
tti.sig.mpa <- c('No', 'No', 'No', 'Yes', 'No')
tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))

tti.ES.lfm.plot <- ggplot(data = tti.ES.df, aes(x = species, y = tti.ES.lfm, 
                                                color = species, shape = tti.sig.lfm)) +
  labs(color = 'Species', shape = 'Significant?', title = 'LFM') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = tti.ES.lfm - 0.5*tti.SE.lfm, ymax = tti.ES.lfm + 0.5*tti.SE.lfm)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  scale_y_continuous(limits = c(-12.5, 13.5), breaks = c(-10,-5, 0, 5, 10)) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(16, 10)) +
  annotate(geom = "text", x = 0.9, y = 11, label = 'b', fontface = 'bold', size = 10) +
  annotate(geom = "text", x = 2, y = 13, label = 'Gymnosperms', size = 4) +
  annotate(geom = "text", x = 4.5, y = 13, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(c(0.2, 0.05, 0.1, 0.1), 'cm'),
        legend.position = 'none') # Hash out if you want legends for individual panels. Added this line of code to all plots to arrange them nicely.
tti.ES.lfm.plot
  
tti.ES.mpa.plot <- ggplot(data = tti.ES.df, aes(x = species, y = tti.ES.mpa,
                                                color = species, shape = tti.sig.mpa)) +
  labs(y = '', color = 'Species', shape = 'Significant?', title = 'Water Potential') +
  scale_y_continuous(limits = c(-12.5, 13.5), breaks = c(-10,-5, 0, 5, 10),
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = ' ')) +
  geom_point(size = 5, cex = 5) +
  geom_linerange(aes(ymin = tti.ES.mpa - 0.5*tti.SE.mpa, ymax = tti.ES.mpa + 0.5*tti.SE.mpa)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(16, 10)) +
  annotate(geom = "text", x = 0.9, y = 11, label = 'c', fontface = 'bold', size = 10) +
  annotate(geom = "text", x = 2, y = 13, label = 'Gymnosperms', size = 4) +
  annotate(geom = "text", x = 4.5, y = 13, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(c(0.2, 0.2, 0.1, 0), 'cm'),
        legend.position = 'none') # Hash out if you want legends for individual panels. Added this line of code to all plots to arrange them nicely.
tti.ES.mpa.plot
```

## FH
```{r}
summary(fh_mod)

# CECO info: ES.lfm = 1.4 SE.lfm = 6.379, sig.lfm = yes, ES.mpa = -5, SE.mpa = 7.725, sig.mpa = yes
fh.ES.lfm <- c(-1.7, -4.5, -2.3, -1.2, -3.7) # Following this order: ABCO, CADE, PIJE, ARPA, QUKE
fh.SE.lfm <- c(0.8147, 1.4422, 1.1660, 1.2257, 2.0679)
fh.sig.lfm <- c('Yes', 'No', 'No', 'Yes', 'No')
fh.ES.mpa <- c(-2.2, 0.048, -1.1, -0.4, -0.13) 
fh.SE.mpa <- c(0.7819, 1.3925, 1.1130, 1.1283, 2.0264)
fh.sig.mpa <- c('Yes', 'No', 'No', 'Yes', 'No')
fh.ES.df <- data.frame(species, fh.ES.lfm, fh.SE.lfm, fh.sig.lfm, fh.ES.mpa, fh.SE.mpa, fh.sig.mpa)

fh.ES.df$species <- factor(fh.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))

fh.ES.lfm.plot <- ggplot(data = fh.ES.df, aes(x = species, y = fh.ES.lfm, 
                                                color = species, shape = fh.sig.lfm)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = fh.ES.lfm - 0.5*fh.SE.lfm, ymax = fh.ES.lfm + 0.5*fh.SE.lfm)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  scale_y_continuous(limits = c(-5.5, 3), breaks = c(-5,-2.5, 0, 2.5)) +
  #color_many2 +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(16, 10)) +
  annotate(geom = "text", x = 0.9, y = 2, label = 'e', fontface = 'bold', size = 10) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.margin = unit(c(0.1, 0.05, 0.1, 0.1), 'cm'),
        legend.position = 'none')
fh.ES.lfm.plot
  
fh.ES.mpa.plot <- ggplot(data = fh.ES.df, aes(x = species, y = fh.ES.mpa,
                                                color = species, shape = fh.sig.mpa)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  scale_y_continuous(limits = c(-5.5, 3), breaks = c(-5,-2.5, 0, 2.5),
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = 'Hydration x Species Effect Size',
                     breaks = c(-5,-2.5, 0, 2.5),
                     labels = c(-5,-2.5, 0, 2.5))) +
  geom_point(size = 5, cex = 5) +
  geom_linerange(aes(ymin = fh.ES.mpa - 0.5*fh.SE.mpa, ymax = fh.ES.mpa + 0.5*fh.SE.mpa)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  #color_many2 +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(16, 10)) +
  annotate(geom = "text", x = 0.9, y = 2, label = 'f', fontface = 'bold', size = 10) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.margin = unit(c(0.1, 0.2, 0.1, 0), 'cm'),
        legend.position = 'none')
fh.ES.mpa.plot
```

## GD
```{r}
summary(gd_mod)

# CECO information: ES.lfm = -67, sig.lfm = yes, SE.lfm = 64.019, ES.mpa = 100, sig.mpa = yes, SE.mpa = 79.34

gd.ES.lfm <- c(16, 18, 12, 16, -4.7) # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
gd.sig.lfm <- c('No', 'No', 'No', 'No', 'Yes')
gd.SE.lfm <- c(8.163, 14.544, 11.419, 11.799, 21.231)
gd.ES.mpa <- c(16, 11, 9.5, 8.6, 27)
gd.sig.mpa <- c('Yes', 'No', 'No', 'No', 'Yes')
gd.SE.mpa <- c(8.246, 14.276, 11.483, 11.692, 20.943)
gd.ES.df <- data.frame(species, gd.ES.lfm, gd.sig.lfm, gd.SE.lfm, gd.ES.mpa, gd.sig.mpa, gd.SE.mpa)

gd.ES.df$species <- factor(gd.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))

gd.ES.lfm.plot <- ggplot(data = gd.ES.df, aes(x = species, y = gd.ES.lfm, 
                                                color = species, shape = gd.sig.lfm)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = gd.ES.lfm - 0.5*gd.SE.lfm, ymax = gd.ES.lfm + 0.5*gd.SE.lfm)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  scale_y_continuous(limits = c(-20, 40), breaks = c(-10, 0, 10, 20,  30)) +
  #color_many2 +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(16, 10)) +
  annotate(geom = "text", x = 0.9, y = 33, label = 'h', fontface = 'bold', size = 10) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.margin = unit(c(0.1, 0.05, 0.1, 0.1), 'cm'),
        legend.position = 'none')
gd.ES.lfm.plot
  
gd.ES.mpa.plot <- ggplot(data = gd.ES.df, aes(x = species, y = gd.ES.mpa,
                                                color = species, shape = gd.sig.mpa)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  scale_y_continuous(limits = c(-20, 40), breaks = c(-10, 0, 10, 20,  30),
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = ' ',
                     breaks = c(-10, 0, 10, 20,  30),
                     labels = c(-10, 0, 10, 20,  30))) +
  geom_point(size = 5, cex = 5) +
  geom_linerange(aes(ymin = gd.ES.mpa - 0.5*gd.SE.mpa, ymax = gd.ES.mpa + 0.5*gd.SE.mpa)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  #color_many2 +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(16, 10)) +
  annotate(geom = "text", x = 0.9, y = 33, label = 'i', fontface = 'bold', size = 10) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.margin = unit(c(0.1, 0.2, 0.1, 0), 'cm'),
        legend.position = 'none')
gd.ES.mpa.plot
```

## Prop. Ignite
Still needs to be updated w/ correct effect sizes, but I decided to wait for the prop. ignite figure to be worked out before doing so...

```{r}
summary(prop_ignite_mod)

prop_ignite.ES.lfm <- c(0.023, -5.152, 1.020, -0.135, -12.584) # Following this order: ABCO,  ARPA, CADE, PIJE, QUKE (no CECO)
prop_ignite.sig.lfm <- c('No', 'Yes', 'No', 'No', 'Yes')
prop_ignite.SE.lfm <- c(1.1996, 1.8206, 2.1238, 1.7219, 3.1043)
prop_ignite.ES.mpa <- c(-0.354, -7.942, 1.386, 0.253, -3.041)
prop_ignite.sig.mpa <- c('No', 'Yes', 'No', 'No', 'No')
prop_ignite.SE.mpa <- c(1.1519, 1.6624, 2.0509, 1.6437, 3.0430)
prop_ignite.ES.df <- data.frame(species, prop_ignite.ES.lfm, prop_ignite.sig.lfm, prop_ignite.SE.lfm, prop_ignite.ES.mpa, prop_ignite.sig.mpa, prop_ignite.SE.mpa)

prop_ignite.ES.lfm.plot <- ggplot(data = prop_ignite.ES.df, aes(x = species, y = prop_ignite.ES.lfm, 
                                                color = species, shape = prop_ignite.sig.lfm)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = prop_ignite.ES.lfm - 0.5*prop_ignite.SE.lfm, ymax = prop_ignite.ES.lfm + 0.5*prop_ignite.SE.lfm)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  scale_y_continuous(limits = c(-16, 6), breaks = c(-15,-10, -5, 0, 5)) +
  color_noceco+
  scale_shape_manual(values = c(16, 10)) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        legend.position = 'none')
prop_ignite.ES.lfm.plot
  
prop_ignite.ES.mpa.plot <- ggplot(data = prop_ignite.ES.df, aes(x = species, y = prop_ignite.ES.mpa,
                                                color = species, shape = prop_ignite.sig.mpa)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  scale_y_continuous(limits = c(-16, 6), breaks = c(-15,-10, -5, 0, 5),
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = 'Species x Hydration Effect Size on Ignition Rate',
                     breaks = c(-15,-10, -5, 0, 5),
                     labels = c(-15,-10, -5, 0, 5))) +
  geom_point(size = 5, cex = 5) +
  geom_linerange(aes(ymin = prop_ignite.ES.mpa - 0.5*prop_ignite.SE.mpa, ymax = prop_ignite.ES.mpa + 0.5*prop_ignite.SE.mpa)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  geom_vline(xintercept = 3.5, alpha = 0.5, size = 0.3, lty = 2) +
  theme_bw() +
  color_noceco+
  scale_shape_manual(values = c(16, 10)) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        legend.position = 'none')
prop_ignite.ES.mpa.plot
```

# 5. Main Figure
Arranging effect size plots and scatterplots into one figure

For now, focusing on TTI, FH, GD until we figure out how we hope to incorporate prop_ignite 

Set up:
```{r}
blank_plot <- ggplot(data = prop_ignite.ES.df, aes(x = species, y = prop_ignite.ES.mpa)) +
  geom_point(color = 'white') +
  theme_void()

plot_legend.ES <- ggplot(data = gd.ES.df, aes(x = species, y = gd.ES.mpa,
                                                color = species, shape = gd.sig.mpa)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  geom_point(size = 2, cex = 5) +
  geom_linerange(aes(ymin = gd.ES.mpa - 0.5*gd.SE.mpa, ymax = gd.ES.mpa + 0.5*gd.SE.mpa)) +
  theme_bw() +
  #color_many2 +
  color_noceco+
  scale_shape_manual(values = c(16, 10)) +
  theme(legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic', size = 13))

plot_legend.scatterplot <- mem_data_all_r %>% 
  ggplot(aes(x = tti, y = mpa, group = F.Group)) +
  geom_point(aes(color = F.Group), size = 2.2) +
  geom_smooth(se = F, method = 'lm', aes(color = F.Group, lty = F.fh.sig)) +
  scale_color_manual(values = c('#FDD358', 'black')) + # For color by angio vs gymno 
  labs(color = "Functional Group", lty = "Significant?") +
  theme(legend.text = element_text(size = 13),  # , face = 'italic'
        legend.title = element_text(size = 14, face = 'bold'),
        legend.key = element_rect(fill = 'white')) +
  guides(lty = guide_legend(override.aes = list(color = 'black')))

ES_legend <- cowplot::get_legend(plot_legend.ES)
SP_legend <- cowplot::get_legend(plot_legend.scatterplot)
```

Arranging:
Note: I had to do some wacky things with blank plots to get the final product to look okay. I still think we could improve it, but I felt like this was passable for now.
```{r}
scatterplots <- cowplot::plot_grid(blank_plot, tti_plot_lfm_r, fh_plot_lfm_r, gd_plot_lfm_r,
                                   ncol = 1, rel_heights = c(0.9, 10, 10, 10))

ES.plots <- cowplot::plot_grid(tti.ES.lfm.plot, tti.ES.mpa.plot,
                              blank_plot, blank_plot,
                              fh.ES.lfm.plot, fh.ES.mpa.plot,
                              blank_plot, blank_plot,
                              gd.ES.lfm.plot, gd.ES.mpa.plot,
                              blank_plot, blank_plot,
                              ncol = 2, nrow = 6,
                              rel_widths = c(6,7.5),
                              rel_heights = c(11.2, 0.985, 10.2, 0.9, 9.8, 1.6))

main_figure_no_legend <- cowplot::plot_grid(scatterplots, ES.plots, ncol = 2, rel_widths = c(10,9))
main_figure_no_legend

legend <- cowplot::plot_grid(SP_legend, ES_legend, ncol = 1)

main_figure <- cowplot::plot_grid(main_figure_no_legend, legend, ncol = 2, rel_widths = c(5,1))
main_figure

ggsave(plot = main_figure, bg = 'white', 
       here("figures", "species.x.hydration.effect.and.scatterplots.jpg"),
       width = 15, height = 8)
```

