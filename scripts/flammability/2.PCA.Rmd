---
title: "PCA Figure and Table"
author: "Indra Boving & Joe Celebrezze"
date: "6/20/2022"
output: html_document
---

OCT 29 NOTES: Probably will not use PCA - doesn't really tell as nice of a story with all species. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup
Necessary packages:
```{r}
library(here)
library(tidyverse)
library(kableExtra)
library(ggbiplot)
library(sjPlot)
library(ggpubr)
library(remef)
library(lme4)

here = here::here
rename = dplyr::rename
select = dplyr::select

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```

# 1.1. PCA Figure

Plot setup:
```{r warning=FALSE}
### Note: This dataset includes only Epiradiator and Ignited samples
sierra_flamdata_pca_all <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv"), show_col_types = FALSE) 

sierra_flamdata_pca <- sierra_flamdata_pca_all %>% 
  filter(ignition == 1 
        # ignition_num == 1
         ) %>% 
  mutate(F.Group = case_when(
    spp == "arpa" ~ "Angiosperm", 
    spp == "abco" ~ "Gymnosperm",
    spp == "cade" ~ "Gymnosperm",
    spp == "ceco" ~ "Angiosperm",
    spp == "pije" ~ "Gymnosperm",
    spp == "quke" ~ "Angiosperm"
  )) %>% 
   select("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample", "F.Group") %>% 
  na.omit(c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample"))

 # filter(year == 2020)

figure_epi_pca_quant <- (sierra_flamdata_pca[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change")]) %>%  
 transmute( "               Flame Duration" = fd, #using spaces to shift labels over instead of \t since \t is leading to little blank squares popping up on the plot.. spaces are just manual tabs anyways right?
           "                 Flame Height" = fh,
           "Post-flame Glow" = pfg,
          "Time to Ignition" = tti,
         # "Max. Temp" = taller_temp_max,
            "Glow Duration" = gd,
          "\nGlow to Ignition" = gti,
          "\nTime to First Glow" = ttfg, 
          "Temp Change" = temp_change
          ) %>% 
  na.omit()

figure_epi_pca_cat <-  (sierra_flamdata_pca[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample", "F.Group")]) %>% 
  na.omit() %>% 
  select(hydration, spp, year_month, sample, F.Group) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Species" = spp,
            "Timing" = year_month, 
            "Sample" = sample) 
  
  figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), 
                          center = TRUE, 
                          scale = TRUE, 
                          retx=TRUE)
  
figure_epi_pca <- (sierra_flamdata_pca[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample", "F.Group")]) %>% 
  na.omit() 
```


```{r warning=FALSE}
#Setting up plotting data: 

#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_epi_pca_cat)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("                 Flame Height", "Max. Temp","               Flame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("Time to Ignition", "\nGlow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))
```

Plot:
```{r}
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  ylim(-4, 3) +
  geom_point(size = 1.75, alpha = .45, aes(shape = Species
                                       , color = Species)
                                       , data = PCAvalues) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .9, alpha = 0.9,
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .9, alpha = 0.9,
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .9, alpha = 0.9,
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 0.7), 
          y = (PCA_combustability$PC2 * 1.15),
          label = PCA_combustability$Variables, size = 3.5,
          fontface = 'bold') +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.3), 
           y = (PCA_ignitability$PC2 * 1.45), 
           label = PCA_ignitability$Variables, size = 3.5,
           fontface = 'bold') +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.3),
           y = (PCA_consumability$PC2 * 1.1), 
           label = PCA_consumability$Variables, size = 3.5,
           fontface = 'bold') + 
  geom_segment(aes(x = -3.1, xend = -3.1, y = -3.45, yend = -1.85), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = -3.25, y = -2.6, label = "Less Consumable", angle = 90, size = 3.5) +
  geom_segment(aes(x = -3.1, xend = -1.35, y = -3.45, yend = -3.45), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = -2.25, y = -3.68, label = "Larger & Hotter Flames, \n Faster Ignition", size = 3.5) +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
          legend.key = element_rect(fill = "white"),
          legend.position = c(0.2,0.9),
          legend.title = element_text(face = 'bold', size = 15),
          legend.text = element_text(face = 'italic', size = 13),
          axis.title = element_text(face = 'bold', size = 15)) +
 # scale_color_manual(values = c("#9D0208","#F48C06")) + 
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) + 
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()

ggsave(here("figures", "pca.jpg"),
       height = 7, width = 9)
```

## Adding principal components into dataset

```{r warning=FALSE}
x_flam <-predict(pcobj)  ### generate scores for each row in sierra_flamdata_pca

pca_flam_data <- as_data_frame(x_flam) 

all_data_pca <- bind_cols(sierra_flamdata_pca, pca_flam_data)

# #because we wants instances where they didn't ignite for the logistic regression: 
sierra_flamdata_pca_noignitions <- sierra_flamdata_pca_all %>%
 # mutate(LFM = lfm_NAs_imputed) %>%
  #filter(year == 2020) %>%
 # filter(model == "EPI") %>%
  filter(ignition == 0)

all_data_withnoignitions <- bind_rows(all_data_pca, sierra_flamdata_pca_noignitions)

#dataset with the above columns, PCA using imputed NAs (medians), and flam metrics with NAs still in there:
mem_data <- all_data_withnoignitions

write_csv(mem_data, here("processed-data", "analysis 2.0", "mem_data_sierra_alldates.csv"))
```

# 1.2. PCA Table

```{r warning=FALSE}
figure_epi_pca_cat <- (sierra_flamdata_pca[c("hydration", "spp", "year_month", "sample")]) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Timing" = year_month, 
            "Sample" = sample) %>% 
  mutate(Species = case_when(
    spp ==  "ARPA" ~ "A. patula", 
    spp == "ABCO" ~ "A. concolor", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "PIJE" ~ "P. jeffryii", 
    spp == "CECO" ~ "C. cordulatus",
    spp == "QUKE" ~ "Q. kellogii"
  ))


figure_varimax <- varimax(pcobj$rotation[,1:3])
figure_varimax

sjPlot::tab_pca(pcobj, 
        rotation = c("varimax"), 
        digits = 2,
        show.var = TRUE,
  string.pov = "Proportion of Variance",
  string.cpov = "Cumulative Proportion") 

```

#---

# 2. Interspecific differences

## Setup
```{r}
sierra_flamdata_pca_noceco <- sierra_flamdata_pca_all %>% 
  filter(ignition == 1
         ) %>% 
  mutate(F.Group = case_when(
    spp == "arpa" ~ "Angiosperm", 
    spp == "abco" ~ "Gymnosperm",
    spp == "cade" ~ "Gymnosperm",
    spp == "ceco" ~ "Angiosperm",
    spp == "pije" ~ "Gymnosperm",
    spp == "quke" ~ "Angiosperm"
  )) %>% 
  filter(spp != "ceco") %>% 
   select("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample", "F.Group", "mpa", "lfm_outliers_out", "site", "individual", "sample_wt") %>% 
  na.omit(c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample"))
  
figure_epi_pca_quant_spp <- (sierra_flamdata_pca_noceco[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change")]) %>%  
  mutate(tti = tti*-1) %>% 
  transmute( "Flame Duration" = fd,
           "Flame Height" = fh,
           "Post-flame Glow" = pfg,
           "Ignitability" = tti,
           "Glow Duration" = gd,
           "Glow to Ignition" = gti,
           "Time to First Glow" = ttfg, 
           "Temp Change" = temp_change
          ) %>% 
  na.omit()

figure_epi_pca_cat_spp <-  (sierra_flamdata_pca_noceco[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample", "F.Group")]) %>% 
  na.omit() %>% 
  select(hydration, spp, year_month, sample, F.Group) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Species" = spp,
            "Timing" = year_month, 
            "Sample" = sample) 
  
figure_prcomp_spp <- prcomp(na.omit(figure_epi_pca_quant_spp), 
                          center = TRUE, 
                          scale = TRUE)
  
figure_epi_pca_spp <- (sierra_flamdata_pca_noceco[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg","temp_change", "hydration", "spp", "year_month", "sample", "F.Group")]) %>% 
  na.omit() 
```

## Visualization
```{r}
ggbiplot(figure_prcomp_spp,
         groups = figure_epi_pca_spp$F.Group,
         ellipse = TRUE, circle = FALSE, varname.size = 4, alpha = 0.5) +
  theme_bw() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        aspect.ratio = 1/1,
        axis.title = element_text(face = 'bold'),
        legend.title = element_text(face = 'bold')) +
  labs(color = 'Functional Group')
```

## Principal Components vs. LFM

### PC1
```{r}
# Putting principal components into dataset
spp_pc_flam <-predict(figure_prcomp_spp) 
pca_flam_data_spp <- as_data_frame(spp_pc_flam) 
spp_data_pca <- bind_cols(sierra_flamdata_pca_noceco, pca_flam_data_spp)

# MEM and REMEF
pc1_mod <- lmer(PC1 ~ spp*mpa + spp*lfm_outliers_out + site + year_month + sample_wt + (1 | individual), data = spp_data_pca)
r_pc1_lfm <- remef(pc1_mod, fix = c("mpa", "sample_wt", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM
spp_data_pca$r_pc1_lfm <- r_pc1_lfm

# PC1 vs. LFM visualization
pc1_vs_lfm_r <- spp_data_pca %>%
  ggplot(aes(y = r_pc1_lfm, 
             x = lfm_outliers_out, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group), alpha = .75) + 
  scale_color_manual(values = c('#FDD358', 'black')) +
  theme(axis.text.y = element_text(size = 13),
        axis.title = element_text(size = 16, face = 'bold')) +
        #axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "Live Fuel Moisture (%)", 
       y = "PC1",
       color = "Functional Group") +
  annotate('text', x = 35, y = -4.5, label = 'More Combustible, \nMore Sustainable', size = 3) +
  geom_segment(aes(x = 35, xend = 35, y = -4.2, yend = -2.8), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = 35, y = -2.5, label = 'More Ignitable', size = 3)
pc1_vs_lfm_r
```

### PC2
```{r}
# MEM and REMEF
pc2_mod <- lmer(PC2 ~ spp*mpa + spp*lfm_outliers_out + site + year_month + sample_wt + (1 | individual), data = spp_data_pca)
r_pc2_lfm <- remef(pc2_mod, fix = c("mpa", "sample_wt", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM
spp_data_pca$r_pc2_lfm <- r_pc2_lfm

# PC2 vs. LFM visualization
pc2_vs_lfm_r <- spp_data_pca %>%
  ggplot(aes(y = r_pc2_lfm, 
             x = lfm_outliers_out, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group), alpha = .75) + 
  scale_color_manual(values = c('#FDD358', 'black')) +
  theme(axis.text.y = element_text(size = 13),
        axis.title = element_text(size = 16, face = 'bold'),
        axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "Live Fuel Moisture (%)", 
       y = "PC2",
       color = "Functional Group") +
  annotate('text', x = 35, y = 4.5, label = 'More Consumable', size = 3) +
  geom_segment(aes(x = 35, xend = 35, y = 2.8, yend = 4.2), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85)
pc2_vs_lfm_r
```



#---

#STOPPED HERE, Oct. 22, 2022

IF we end up using the PCA then we can use Joe's code below :) 

#---

## Nicer Table (kableExtra)
First, making dataframe with eigenvalues for principal components, proportion of variance explained and cumulative proportion:
```{r}
eig1 <- c(0.76, 0.62, 0.51, -0.72, -0.82, -0.11, 0.11, 0.01, 37.17, 37.17)
eig2 <- c(-0.17, 0.14, -0.16, -0.41, -0.39, -0.99, -0.93, -0.09, 23.23, 60.39)
eig3 <- c(-0.05, -0.31, 0.11, 0.45, -0.23, 0.04, 0.15, 0.98, 14.72, 75.11)
flam.metrics <- c("Flame Duration", "Flame Height", "Max. Temp.", "Time to Ignition", "Glow to Ignition", "Glow Duration", "Post-flame Glow", "Time to First Glow", "Proportion of Variance (%)", "Cumulative Proportion (%)")
pca.table.df <- data.frame(flam.metrics, eig1, eig2, eig3)
```
there was probably a more elegant way to do that, but since there aren't too many numbers to enter in by hand, I thought it would be quicker to just go ahead and do so.

Now, using kableExtra package to visualize how each component is weighted by each flam. metric
```{r}
pca.table.df %>%
  mutate(flam.metrics = cell_spec(flam.metrics, 'html', bold = ifelse(flam.metrics == c("Proportion of Variance (%)", "Cumulative Proportion (%)"), T, F), color = 'black')) %>% 
  mutate(eig1 = cell_spec(eig1, 'html', bold = ifelse(abs(eig1) > 0.5, T, F), color = 'black')) %>% 
  mutate(eig2 = cell_spec(eig2, 'html', bold = ifelse(abs(eig2) > 0.5, T, F), color = 'black')) %>% 
  mutate(eig3 = cell_spec(eig3, 'html', bold = ifelse(abs(eig3) > 0.5, T, F), color = 'black')) %>% 
  kable(format = 'html', escape = F, col.names = c(' ', 'Component 1', 'Component 2', 'Component 3')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T, font_size = 30) %>% 
  row_spec(c(9:10), background = '#D3D3D3') %>% 
  save_kable(here('figures', 'main-figures', 'pca_table.html'))
```


# 2. Supplemental Figure
This figure shows two PCA's side-by-side, one for each species and will be included in the supplemental figures

## ADFA
Plot setup:
```{r warning=FALSE}
### Note: This dataset includes only Epiradiator and Ignited samples
sierra_flamdata_pca.adfa <- sierra_flamdata_pca %>% 
  filter(spp == "ADFA")

 # filter(year == 2020)

figure_epi_pca_quant.adfa <- (sierra_flamdata_pca.adfa[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp_max")]) %>%  
 transmute("\n\nFlame Duration" = fd,
           " Flame Height" = fh,
           "Post-flame Glow" = pfg,
           "\nTime to Ignition" = tti,
           "\nMax. Temp" = temp_max,
           "Glow Duration" = gd,
           "\nGlow to Ignition" = gti,
           "Time to First Glow\n" = ttfg
          )

figure_epi_pca_cat.adfa <- (sierra_flamdata_pca.adfa[c("hydration", "spp", "year_month", "sample")]) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Timing" = year_month, 
            "Sample" = sample) %>% 
  mutate(Species = case_when(
    spp == "ADFA" ~ "Adenostoma fasciculatum"
  ))

figure_prcomp.adfa <- prcomp(na.omit(figure_epi_pca_quant.adfa), center = TRUE, scale = TRUE, retx=TRUE)

#Setting up plotting data: 

#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant.adfa), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues.adfa <- cbind(df.u, figure_epi_pca_cat.adfa)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c(" Flame Height", "\nMax. Temp",
                          "\n\nFlame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("\nTime to Ignition", "\nGlow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "Time to First Glow\n"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))
```

Plot:
```{r}
adfa.pca.plot <- ggplot(PCAvalues.adfa, aes(x = PC1, y = PC2)) +
  geom_point(size = 1.5, alpha = .4, color = "#9D0208", data = PCAvalues.adfa) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .8, alpha = 0.85,
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, alpha = 0.85,
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, alpha = 0.85,
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 0.95), 
          y = (PCA_combustability$PC2 * 1.325),
          label = PCA_combustability$Variables, size = 3.2,
          fontface = 'bold') +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.3), 
           y = (PCA_ignitability$PC2 * 0.95), 
           label = PCA_ignitability$Variables, size = 3.2,
           fontface = 'bold') +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.3),
           y = (PCA_consumability$PC2 * 1.1), 
           label = PCA_consumability$Variables, size = 3.2,
           fontface = 'bold') + 
   geom_segment(aes(x = -3.1, xend = -3.1, y = -3.3, yend = -1.275), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = -3.25, y = -2.35, label = "More Consumable", angle = 90, size = 3.5) +
  geom_segment(aes(x = -3.1, xend = -1.4, y = -3.3, yend = -3.3), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = -2.25, y = -3.68, label = "Larger & Hotter Flames, \n Faster Ignition", size = 3.5) +
  annotate('text', x = -2.25, y = 4, label = "A. fasciculatum", size = 5, fontface = 4) +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
          legend.key = element_rect(fill = "white"),
          legend.title = element_text(face = 'bold', size = 12),
          legend.text = element_text(face = 'italic', size = 10),
          axis.title = element_text(face = 'bold', size = 12), 
          plot.title = element_text(face = 'italic'),
          aspect.ratio = 1/1) +
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) +
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
  
adfa.pca.plot
```

## CEME
Plot setup:
```{r warning=FALSE}
### Note: This dataset includes only Epiradiator and Ignited samples
sierra_flamdata_pca.ceme <- sierra_flamdata_pca %>% 
  filter(spp == "CEME")

 # filter(year == 2020)

figure_epi_pca_quant.ceme <- (sierra_flamdata_pca.ceme[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp_max")]) %>%  
 transmute("  Flame Duration" = fd,
           "     Flame Height" = fh,
           "Post-flame Glow" = pfg,
           "Time to Ignition" = tti,
           "Max. Temp" = temp_max,
           "Glow Duration" = gd,
           "Glow to Ignition" = gti,
           "\nTime to First Glow" = ttfg
          )

figure_epi_pca_cat.ceme <- (sierra_flamdata_pca.ceme[c("hydration", "spp", "year_month", "sample")]) %>% 
  transmute("Hydration" = hydration, 
            spp = spp,
            "Timing" = year_month, 
            "Sample" = sample) %>% 
  mutate(Species = case_when(
    spp == "CEME" ~ "Ceanothus megacarpus"
  ))

figure_prcomp.ceme <- prcomp(na.omit(figure_epi_pca_quant.ceme), center = TRUE, scale = TRUE, retx=TRUE)

#Setting up plotting data: 

#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant.ceme), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues.ceme <- cbind(df.u, figure_epi_pca_cat.ceme)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("     Flame Height", "Max. Temp",
                          "  Flame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("Time to Ignition", "Glow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))
```

Plot:
```{r}
ceme.pca.plot <- ggplot(PCAvalues.ceme, aes(x = PC1, y = PC2)) +
  geom_point(size = 1.5, alpha = .5, shape = 17, color = "#F48C06", data = PCAvalues.ceme) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .8, alpha = 0.85,
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, alpha = 0.85,
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, alpha = 0.85,
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 1.5), 
          y = (PCA_combustability$PC2 * 1.1),
          label = PCA_combustability$Variables, size = 3.2,
          fontface = 'bold') +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.4), 
           y = (PCA_ignitability$PC2 * 1.05), 
           label = PCA_ignitability$Variables, size = 3.2,
           fontface = 'bold') +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.3),
           y = (PCA_consumability$PC2 * 1.05), 
           label = PCA_consumability$Variables, size = 3.2,
           fontface = 'bold') + 
  geom_segment(aes(x = -3.1, xend = -3.1, y = -3.4, yend = -1.9), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = -3.25, y = -2.65, label = "Less Consumable", angle = 90, size = 3.5) +
  geom_segment(aes(x = -3.1, xend = -1.15, y = -3.4, yend = -3.4), arrow = arrow(length = unit(1/2, 'picas')), size = 0.35, alpha = 0.85) +
  annotate('text', x = -2.2, y = -3.68, label = "Larger & Hotter Flames, \n Faster Ignition", size = 3.5) +
  annotate('text', x = -2.2, y = 2, label = "C. megacarpus", size = 5, fontface = 4) +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
          legend.key = element_rect(fill = "white"),
          legend.title = element_text(face = 'bold', size = 12),
          legend.text = element_text(face = 'italic', size = 10),
          axis.title = element_text(face = 'bold', size = 12), 
          plot.title = element_text(face = 'italic'),
          aspect.ratio = 1/1) +
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) +
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
  
ceme.pca.plot
```

## Arranging Plots
```{r}
ggarrange(adfa.pca.plot,ceme.pca.plot)

ggsave(here('figures','supp-figures','spp.pca.jpg'), height = 6, width = 12)
```

