---
title: "quke segmented regressions"
author: "Indra Boving & Joe Celebrezze"
date: "4/15/2021"
output: html_document
---


#Setup:
```{r}
knitr::opts_chunk$set(echo = TRUE)
#lots of extra here, but oh well___ 
library(ggplot2)
library(gapminder)
library(tidyverse)
library(lme4)
library(here)
library(segmented)
library(nlme)
library(lubridate)
library(plotrix)
filter = dplyr::filter
here = here::here
select = dplyr::select

# Function to plot mixed effects model segmented regressions:
source(here::here("scripts", "scripts_functions", "plot_segmented_MEM_V2.R"))
```

# Reading in Dataframe
```{r}
seg_data_subset <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv")) %>% 
  mutate(id = individual)
```

# Color by Season

```{r}
seg_data_subset$color <- "#ee8577"
seg_data_subset$color[seg_data_subset$year_month=='2020_october']="#ce4441"
seg_data_subset$color[seg_data_subset$year_month=='2020_september']="#c969a1"
seg_data_subset$color[seg_data_subset$year_month=='2021_august']="#ffbb44"
```

# Splitting by Species and by Sampling Date

```{r} 
seg_data_subset <- seg_data_subset %>% 
  mutate_if(is.character, str_to_lower) %>% 
  mutate(spp = str_trim(spp),
         lfm_scaled = scale(lfm),
    name = paste(spp,"_max", sep = ""), 
    name_subset = paste(spp, "_subset_seg", sep = ""), #this is def working. 
   # name_yearmonth = intersect(spp, year_month), 
    name_yearmonth = paste(spp, year_month, "subset_seg", sep = "_")) %>% 
  drop_na(lfm, mpa) #Dropping NA values for both LFM and mpa

quke_subset_seg <- seg_data_subset %>% 
  filter(spp == "quke")

quke_2020_oct_subset_seg <- seg_data_subset %>% 
  filter(spp == "quke", 
         year_month == "2020_october")

quke_2020_sept_subset_seg <- seg_data_subset %>% 
  filter(spp == "quke", 
         year_month == "2020_september")

quke_2020_subset_seg <- seg_data_subset %>% 
  filter(spp == "quke", 
         year_month %in% c("2020_september", "2020_october"))

quke_2021_aug_subset_seg <- seg_data_subset %>% 
  filter(spp == "quke", 
         year_month == "2021_august")

# seg_data_subset %>% 
#   group_split(spp) %>%
#   #rowwise() %>% 
#   setNames(unique(seg_data_subset$name_subset))  %>% #this is not working...wrong name for df. 
#   list2env(envir = globalenv())

# seg_data_subset %>% 
#   group_split(name_yearmonth) %>%
#   setNames(unique(seg_data_subset$name_yearmonth))  %>%
#   list2env(envir = globalenv())
```


# Maximums for LFM, MPa

```{r}
max_seg_data <- seg_data_subset %>% 
  type.convert(as.is = TRUE) %>% 
  select(mpa, lfm, spp) %>% 
  group_by(spp) %>% 
  summarise(across(where(is.numeric), max, .names = "max_{.col}")) 

quke_max_mpa <- max_seg_data %>% 
  filter(spp == "quke") %>% 
  select(max_mpa) %>% 
  pull()

quke_max_lfm <- max_seg_data %>% 
  filter(spp == "quke") %>% 
  select(max_lfm) %>% 
  pull()
```

# PV Curve Data


```{r}
pv_summary_df_timing <- read_csv(here("processed-data", "pv_summary_df_timing.csv"), show_col_types = FALSE) %>% 
   filter(timing == "fall") %>% 
  mutate_if(is.character, str_to_lower) %>% 
  #mutate_at(spp, str_to_lower) %>% 
  mutate(spp = str_trim(spp),
    name = paste(spp,"_pv", sep = ""), 
    mean_tlp = -1*mean_tlp, 
    lwr = -1*lwr, 
    upr = -1*upr) %>% 
  filter(!spp %in% c("ADFA", "CEME")) 
  

pv_summary_df_timing %>% 
  group_split(spp) %>%
   setNames(unique(pv_summary_df_timing$name)) %>%
  list2env(envir = globalenv())

mean_mpa_quke <- quke_pv %>% 
  select(mean_tlp) %>% 
  pull()

lwr_mpa_quke <- quke_pv %>% 
  select(lwr) %>% 
  pull()

upr_mpa_quke <- quke_pv %>% 
  select(upr) %>% 
  pull()

mean_lfm_quke <- quke_pv %>% 
  select(mean_lfm) %>% 
  pull()

lwr_lfm_quke <- quke_pv %>% 
  select(lwr_lfm) %>% 
  pull()

upr_lfm_quke <- quke_pv %>% 
  select(upr_lfm) %>% 
  pull()
```
# -------

#Summary visualizations:

```{r}
quke_subset_seg %>% 
  filter(ignition == 1) %>% 
  select(year_month, location, tti, fh, fd, gd, temp_change, prop_ignite) %>%
  gather(-year_month, -location, key = "var", value = "value") %>%
  ggplot() +
  geom_density(aes(x = value, 
                   color = year_month, 
                   fill = year_month), 
               alpha = .4) +
  facet_wrap(~ var, scales = "free") 
```

```{r}
quke_subset_seg %>% 
  filter(ignition == 1) %>% 
  select(year_month, year, location, tti, fh, fd, gd, temp_change, prop_ignite) %>%
  gather(-year_month, -location, -year, key = "var", value = "value") %>%
  ggplot() +
  geom_density(aes(x = value, 
                   color = as.factor(year), 
                   fill =  as.factor(year)),
               alpha = .4) +
  facet_wrap(~ var, scales = "free") 
```

```{r}
quke_cor <- quke_subset_seg %>% 
  filter(ignition == 1) %>% 
  select(tti, fh, fd, gd, temp_change, prop_ignite, lfm, mpa) %>% 
  drop_na() %>% 
  cor()

corrplot::corrplot.mixed(quke_cor, order = 'AOE')
```


# -------

#Segmented regressions: 

We're just going to do a few metrics, to represent each of the axes: 

Ignitability: TTI, Prop.ignite

Combustibility: FH, Max Temp, Temp Change

Sustainability: FD, 

Consumability: GD

Maybe: Max temp

#LFM

###Holding vectors: this will be a df with all to collect results as we go: 

No random effects: 

```{r}
lfm_psi_tti <- c(rep(NaN, 1))
lfm_psi_fh <- c(rep(NaN, 1))
lfm_psi_fd <- c(rep(NaN, 1))
lfm_psi_gd <- c(rep(NaN, 1))
#lfm_psi_gti <- c(rep(NaN, 1))
#lfm_psi_lfm_pfg <- c(rep(NaN, 1))
#lfm_psi_ttfg <- c(rep(NaN, 1))
lfm_psi_fd <- c(rep(NaN, 1))
lfm_psi_prop_ignite <- c(rep(NaN, 1))
lfm_psi_temp_change <- c(rep(NaN, 1))

lfm_st_err_tti <- c(rep(NaN, 1))
lfm_st_err_fh <- c(rep(NaN, 1))
lfm_st_err_fd <- c(rep(NaN, 1))
lfm_st_err_gd <- c(rep(NaN, 1))
#lfm_st_err_gti <- c(rep(NaN, 1))
#lfm_st_err_lfm_pfg <- c(rep(NaN, 1))
#lfm_st_err_ttfg <- c(rep(NaN, 1))
lfm_st_err_fd <- c(rep(NaN, 1))
lfm_st_err_prop_ignite <- c(rep(NaN, 1))
lfm_st_err_temp_change <- c(rep(NaN, 1))

lfm_p_value_tti <- c(rep(NaN, 1))
lfm_p_value_fh <- c(rep(NaN, 1))
lfm_p_value_fd <- c(rep(NaN, 1))
lfm_p_value_gd <- c(rep(NaN, 1))
#lfm_p_value_gti <- c(rep(NaN, 1))
#lfm_p_value_lfm_pfg <- c(rep(NaN, 1))
#lfm_p_value_ttfg <- c(rep(NaN, 1))
lfm_p_value_fd <- c(rep(NaN, 1))
lfm_p_value_prop_ignite <- c(rep(NaN, 1))
lfm_p_value_temp_change <- c(rep(NaN, 1))

lfm_quke_thresholds_seg <- tibble::data_frame(lfm_psi_tti, lfm_st_err_tti, lfm_p_value_tti,
                              lfm_psi_fh, lfm_st_err_fh, lfm_p_value_fh,
                              lfm_psi_fd, lfm_st_err_fd,lfm_p_value_fd,
                              lfm_psi_gd, lfm_st_err_gd, lfm_p_value_gd, 
                              #lfm_psi_gti, lfm_st_err_gti, 
                              #lfm_psi_lfm_pfg, lfm_st_err_lfm_pfg, 
                              #lfm_psi_ttfg, lfm_st_err_ttfg,
                              lfm_psi_prop_ignite, lfm_st_err_prop_ignite, lfm_p_value_prop_ignite,
                              lfm_psi_temp_change, lfm_st_err_temp_change, lfm_p_value_temp_change
                              )
```


Randem effecs: 

```{r}
lfm_psi_tti <- c(rep(NaN, 1))
lfm_psi_fh <- c(rep(NaN, 1))
lfm_psi_fd <- c(rep(NaN, 1))
lfm_psi_gd <- c(rep(NaN, 1))
#lfm_psi_gti <- c(rep(NaN, 1))
#lfm_psi_lfm_pfg <- c(rep(NaN, 1))
#lfm_psi_ttfg <- c(rep(NaN, 1))
lfm_psi_fd <- c(rep(NaN, 1))
lfm_psi_prop_ignite <- c(rep(NaN, 1))
lfm_psi_temp_change <- c(rep(NaN, 1))

lfm_st_err_tti <- c(rep(NaN, 1))
lfm_st_err_fh <- c(rep(NaN, 1))
lfm_st_err_fd <- c(rep(NaN, 1))
lfm_st_err_gd <- c(rep(NaN, 1))
#lfm_st_err_gti <- c(rep(NaN, 1))
#lfm_st_err_lfm_pfg <- c(rep(NaN, 1))
#lfm_st_err_ttfg <- c(rep(NaN, 1))
lfm_st_err_fd <- c(rep(NaN, 1))
lfm_st_err_prop_ignite <- c(rep(NaN, 1))
lfm_st_err_temp_change <- c(rep(NaN, 1))

lfm_quke_thresholds_rand_seg <- tibble::data_frame(lfm_psi_tti, lfm_st_err_tti,
                              lfm_psi_fh, lfm_st_err_fh, 
                              lfm_psi_fd, lfm_st_err_fd,
                              lfm_psi_gd, lfm_st_err_gd, 
                              #lfm_psi_gti, lfm_st_err_gti, 
                              #lfm_psi_lfm_pfg, lfm_st_err_lfm_pfg, 
                              #lfm_psi_ttfg, lfm_st_err_ttfg,
                              lfm_psi_prop_ignite, lfm_st_err_prop_ignite, 
                              lfm_psi_temp_change, lfm_st_err_temp_change)
```


### Time to Ignition

```{r}
quke_subset_seg_tti <- quke_subset_seg %>%
  drop_na(tti)

#Segmented regression with random changepoints: 

o_mod<-lme(tti~lfm + year_month, random=~1|id, data=quke_subset_seg_tti)
os_mod_b<-segmented.default(o_mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod_b)

#put into the df:
lfm_quke_thresholds_rand_seg[1] <- summary(os_mod_b)$psi[2]
lfm_quke_thresholds_rand_seg[2] <- summary(os_mod_b)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(tti~lfm + year_month, data = quke_subset_seg_tti)
u_mod_b <- segmented(u_mod, ~lfm)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
lfm_quke_thresholds_seg[1] <- summary(u_mod_b)$psi[2]
lfm_quke_thresholds_seg[2] <- summary(u_mod_b)$psi[3]
lfm_quke_thresholds_seg[3] <- u_mod_davies$p.value


rsegplot.lfm(os_mod_b, quke_subset_seg_tti, max.x = quke_max_lfm, y.variable = 'tti', y.lab = "Time to Ignition (s)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke)
```
Combustibility Metrics:

### Flame Height
```{r}
quke_subset_seg_fh <- quke_subset_seg %>% drop_na(fh) 

o_mod<-lme(fh~lfm + year_month, random=~1|id, data=quke_subset_seg_fh)
os_mod<-segmented.default(o_mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
lfm_quke_thresholds_rand_seg[3] <- summary(os_mod)$psi[2]
lfm_quke_thresholds_rand_seg[4] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(fh~lfm + year_month, data = quke_subset_seg_fh)
u_mod_b <- segmented(u_mod, ~lfm)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
lfm_quke_thresholds_seg[4] <- summary(u_mod_b)$psi[2]
lfm_quke_thresholds_seg[5] <- summary(u_mod_b)$psi[3]
lfm_quke_thresholds_seg[6] <- u_mod_davies$p.value

rsegplot.lfm(os_mod, quke_subset_seg_fh, max.x = quke_max_lfm, y.variable = 'fh', y.lab = "Flame Height (cm)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke)
```

Sustainability Metrics:
### Flame Duration
```{r}
quke_subset_seg_fd <- quke_subset_seg %>% drop_na(fd)

o_mod<-lme(fd~lfm + year_month, random=~1|id, data=quke_subset_seg_fd)
os_mod <-segmented.default(o_mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
lfm_quke_thresholds_rand_seg[5] <- summary(os_mod)$psi[2]
lfm_quke_thresholds_rand_seg[6] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(fd~lfm + year_month, data = quke_subset_seg_fd)
u_mod_b <- segmented(u_mod, ~lfm)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
lfm_quke_thresholds_seg[7] <- summary(u_mod_b)$psi[2]
lfm_quke_thresholds_seg[8] <- summary(u_mod_b)$psi[3]
lfm_quke_thresholds_seg[9] <- u_mod_davies$p.value

rsegplot.lfm(os_mod, quke_subset_seg_fd, max.x = quke_max_lfm, y.variable = 'fd', y.lab = "Flame Duration (s)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke)
```

### Glow Duration
```{r}
quke_subset_seg_gd <- quke_subset_seg %>% drop_na(gd)

o_mod<-lme(gd~lfm + year_month, random=~1|id, data=quke_subset_seg_gd)
os_mod <-segmented.default(o_mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
lfm_quke_thresholds_rand_seg[7] <- summary(os_mod)$psi[2]
lfm_quke_thresholds_rand_seg[8] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(gd~lfm + year_month, data = quke_subset_seg_gd)
u_mod_b <- segmented(u_mod, ~lfm)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
lfm_quke_thresholds_seg[10] <- summary(u_mod_b)$psi[2]
lfm_quke_thresholds_seg[11] <- summary(u_mod_b)$psi[3]
lfm_quke_thresholds_seg[12] <- u_mod_davies$p.value

rsegplot.lfm(os_mod, quke_subset_seg_gd, max.x = quke_max_lfm, y.variable = 'gd', y.lab = "Glow Duration (s)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke)
```


### Prop. Ignite (5%)
```{r}
quke_subset_seg_prop_ignite <- quke_subset_seg %>% drop_na(prop_ignite)

o_mod<-lme(prop_ignite~lfm + year_month, random=~1|id, quke_subset_seg_prop_ignite )
os_mod<-segmented.default(o_mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
lfm_quke_thresholds_rand_seg[9] <- summary(os_mod)$psi[2]
lfm_quke_thresholds_rand_seg[10] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(prop_ignite~lfm + year_month, data = quke_subset_seg_prop_ignite)
u_mod_b <- segmented(u_mod, ~lfm)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
lfm_quke_thresholds_seg[13] <- summary(u_mod_b)$psi[2]
lfm_quke_thresholds_seg[14] <- summary(u_mod_b)$psi[3]
lfm_quke_thresholds_seg[15] <- u_mod_davies$p.value

rsegplot.lfm(os_mod, quke_subset_seg_prop_ignite, max.x = quke_max_lfm, y.variable = 'prop_ignite', y.lab = "Proportion Ignted (5% Bins of LFM)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke)
```

<!-- ### Glow to Ignition -->
<!-- ```{r} -->
<!-- quke_subset_seg_gti <- quke_subset_seg %>%  -->
<!--   drop_na(gti) -->

<!-- o_mod<-lme(gti~lfm + year_month, random=~1|id, data=quke_subset_seg_gti) -->
<!-- os_mod<-segmented.default(o_mod, ~lfm, npsi=list(lfm=1)) -->
<!-- #summarizing results (note the '_coef' argument) -->
<!-- summary.segmented(os_mod) -->

<!-- #rsegplot.lfm(os_mod, quke_subset_seg_gti, max.x = quke_max_lfm, y.variable = 'gti', y.lab = "Glow to Ignition (s)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke) -->
<!-- ``` -->



<!-- ### Max_ Temp_ -->
<!-- ```{r} -->
<!-- quke_subset_seg_lower_temp_max <- quke_subset_seg %>%  -->
<!--   drop_na(lower_temp_max) -->

<!-- o_mod<-lme(lower_temp_max~lfm + year_month, random=~1|id, data=quke_subset_seg_lower_temp_max) -->
<!-- os_mod<-segmented.default(o_mod, ~lfm, npsi=list(lfm=1)) -->
<!-- #summarizing results (note the '_coef' argument) -->
<!-- summary.segmented(os_mod) -->
<!-- os_mod -->

<!-- #rsegplot.lfm(os_mod, quke_subset_seg_lower_temp_max, max.x = quke_max_lfm, y.variable = 'lower_temp_max', y.lab = "Maximum Temperature (C)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke) -->
<!-- ``` -->


### Temp change: 

```{r}
quke_subset_seg_temp_change <- quke_subset_seg %>% 
  drop_na(temp_change)

o_mod<-lme(lower_temp_max~lfm + year_month, random=~1|id, data=quke_subset_seg_temp_change)
os_mod<-segmented.default(o_mod, ~lfm, npsi=list(lfm=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)
os_mod

#put into the df:
lfm_quke_thresholds_rand_seg[11] <- summary(os_mod)$psi[2]
lfm_quke_thresholds_rand_seg[12] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(temp_change~lfm + year_month, data = quke_subset_seg_temp_change)
u_mod_b <- segmented(u_mod, ~lfm)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
lfm_quke_thresholds_seg[16] <- summary(u_mod_b)$psi[2]
lfm_quke_thresholds_seg[17] <- summary(u_mod_b)$psi[3]
lfm_quke_thresholds_seg[18] <- u_mod_davies$p.value

rsegplot.lfm(os_mod, quke_subset_seg_temp_change, max.x = quke_max_lfm, y.variable = 'temp_change', y.lab = "Temp Change (C)", tlp = mean_lfm_quke, tlp.lower = lwr_lfm_quke, tlp.upper = upr_lfm_quke)
```
#LFM: FInal table: 


```{r}
#No random effects: 
quke_lfm_summary_df <- lfm_quke_thresholds_seg %>% 
  pivot_longer(everything(), 
               names_to = "flam_metric", 
              values_to = "value") %>% 
  group_by(flam_metric) %>% 
   summarise(value = mean(value)) %>% 
             #sd_bootstrap = sd(value)) %>% 
  mutate(across('flam_metric', str_replace, 'lfm_', ''),
         across('flam_metric', str_replace_all, '_', ' '), 
         statistic = case_when(
           grepl("p value", flam_metric) ~ "p value",
            grepl("psi", flam_metric) ~"psi",
            grepl("st err", flam_metric) ~"st err")) %>% 
  mutate(across('flam_metric', str_replace, 'p value|st err|psi', ''), 
         analysis = "segmented") %>% 
  arrange(flam_metric, statistic, value, analysis)
         
quke_lfm_summary_df

#with random effects: 
quke_lfm_rand_summary_df <- lfm_quke_thresholds_rand_seg %>% 
  pivot_longer(everything(), 
               names_to = "flam_metric", 
              values_to = "value") %>% 
  group_by(flam_metric) %>% 
   summarise(value = mean(value)) %>% 
             #sd_bootstrap = sd(value)) %>% 
  mutate(across('flam_metric', str_replace, 'lfm_', ''),
         across('flam_metric', str_replace_all, '_', ' '), 
         statistic = case_when(
           grepl("p value", flam_metric) ~ "p value",
            grepl("psi", flam_metric) ~"psi",
            grepl("st err", flam_metric) ~"st err")) %>% 
  mutate(across('flam_metric', str_replace, 'p value|st err|psi', ''), 
         analysis = "random") %>% 
  arrange(flam_metric, statistic, value, analysis)
         
quke_lfm_rand_summary_df

quke_lfm <- bind_rows(quke_lfm_rand_summary_df, quke_lfm_summary_df) %>% 
  mutate(spp = "quke", 
         water_variable = "lfm") 

#ggsave(plot=gridExtra::tableGrob(quke_lfm), filename=here("figures", "segmented_tables", "rand_segmented_lfm_quke.png"))
```



# -------

#MPa

###Holding vectors: this will be a df with all to collect results as we go: 

No random effects: 

```{r}
mpa_psi_tti <- c(rep(NaN, 1))
mpa_psi_fh <- c(rep(NaN, 1))
mpa_psi_fd <- c(rep(NaN, 1))
mpa_psi_gd <- c(rep(NaN, 1))
#mpa_psi_gti <- c(rep(NaN, 1))
#mpa_psi_mpa_pfg <- c(rep(NaN, 1))
#mpa_psi_ttfg <- c(rep(NaN, 1))
mpa_psi_fd <- c(rep(NaN, 1))
mpa_psi_prop_ignite <- c(rep(NaN, 1))
mpa_psi_temp_change <- c(rep(NaN, 1))

mpa_st_err_tti <- c(rep(NaN, 1))
mpa_st_err_fh <- c(rep(NaN, 1))
mpa_st_err_fd <- c(rep(NaN, 1))
mpa_st_err_gd <- c(rep(NaN, 1))
#mpa_st_err_gti <- c(rep(NaN, 1))
#mpa_st_err_mpa_pfg <- c(rep(NaN, 1))
#mpa_st_err_ttfg <- c(rep(NaN, 1))
mpa_st_err_fd <- c(rep(NaN, 1))
mpa_st_err_prop_ignite <- c(rep(NaN, 1))
mpa_st_err_temp_change <- c(rep(NaN, 1))

mpa_p_value_tti <- c(rep(NaN, 1))
mpa_p_value_fh <- c(rep(NaN, 1))
mpa_p_value_fd <- c(rep(NaN, 1))
mpa_p_value_gd <- c(rep(NaN, 1))
#mpa_p_value_gti <- c(rep(NaN, 1))
#mpa_p_value_mpa_pfg <- c(rep(NaN, 1))
#mpa_p_value_ttfg <- c(rep(NaN, 1))
mpa_p_value_fd <- c(rep(NaN, 1))
mpa_p_value_prop_ignite <- c(rep(NaN, 1))
mpa_p_value_temp_change <- c(rep(NaN, 1))

mpa_quke_thresholds_seg <- tibble::data_frame(mpa_psi_tti, mpa_st_err_tti, mpa_p_value_tti,
                              mpa_psi_fh, mpa_st_err_fh, mpa_p_value_fh,
                              mpa_psi_fd, mpa_st_err_fd,mpa_p_value_fd,
                              mpa_psi_gd, mpa_st_err_gd, mpa_p_value_gd, 
                              #mpa_psi_gti, mpa_st_err_gti, 
                              #mpa_psi_mpa_pfg, mpa_st_err_mpa_pfg, 
                              #mpa_psi_ttfg, mpa_st_err_ttfg,
                              mpa_psi_prop_ignite, mpa_st_err_prop_ignite, mpa_p_value_prop_ignite,
                              mpa_psi_temp_change, mpa_st_err_temp_change, mpa_p_value_temp_change
                              )
```


Randem effecs: 

```{r}
mpa_psi_tti <- c(rep(NaN, 1))
mpa_psi_fh <- c(rep(NaN, 1))
mpa_psi_fd <- c(rep(NaN, 1))
mpa_psi_gd <- c(rep(NaN, 1))
#mpa_psi_gti <- c(rep(NaN, 1))
#mpa_psi_mpa_pfg <- c(rep(NaN, 1))
#mpa_psi_ttfg <- c(rep(NaN, 1))
mpa_psi_fd <- c(rep(NaN, 1))
mpa_psi_prop_ignite <- c(rep(NaN, 1))
mpa_psi_temp_change <- c(rep(NaN, 1))

mpa_st_err_tti <- c(rep(NaN, 1))
mpa_st_err_fh <- c(rep(NaN, 1))
mpa_st_err_fd <- c(rep(NaN, 1))
mpa_st_err_gd <- c(rep(NaN, 1))
#mpa_st_err_gti <- c(rep(NaN, 1))
#mpa_st_err_mpa_pfg <- c(rep(NaN, 1))
#mpa_st_err_ttfg <- c(rep(NaN, 1))
mpa_st_err_fd <- c(rep(NaN, 1))
mpa_st_err_prop_ignite <- c(rep(NaN, 1))
mpa_st_err_temp_change <- c(rep(NaN, 1))

mpa_quke_thresholds_rand_seg <- tibble::data_frame(mpa_psi_tti, mpa_st_err_tti,
                              mpa_psi_fh, mpa_st_err_fh, 
                              mpa_psi_fd, mpa_st_err_fd,
                              mpa_psi_gd, mpa_st_err_gd, 
                              #mpa_psi_gti, mpa_st_err_gti, 
                              #mpa_psi_mpa_pfg, mpa_st_err_mpa_pfg, 
                              #mpa_psi_ttfg, mpa_st_err_ttfg,
                              mpa_psi_prop_ignite, mpa_st_err_prop_ignite, 
                              mpa_psi_temp_change, mpa_st_err_temp_change)
```


### Time to Ignition

```{r}
quke_subset_seg_tti <- quke_subset_seg %>%
  drop_na(tti)

#Segmented regression with random changepoints: 

o_mod<-lme(tti~mpa + year_month, random=~1|id, data=quke_subset_seg_tti)
os_mod_b<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod_b)

#put into the df:
mpa_quke_thresholds_rand_seg[1] <- summary(os_mod_b)$psi[2]
mpa_quke_thresholds_rand_seg[2] <- summary(os_mod_b)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(tti~mpa + year_month, data = quke_subset_seg_tti)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
mpa_quke_thresholds_seg[1] <- summary(u_mod_b)$psi[2]
mpa_quke_thresholds_seg[2] <- summary(u_mod_b)$psi[3]
mpa_quke_thresholds_seg[3] <- u_mod_davies$p.value


rsegplot.mpa(os_mod_b, quke_subset_seg_tti, max.x = quke_max_mpa, y.variable = 'tti', y.lab = "Time to Ignition (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```
Combustibility Metrics:

### Flame Height
NOTE: Error popping up for this one...
```{r}
quke_subset_seg_fh <- quke_subset_seg %>% drop_na(fh) 

o_mod<-lme(fh~mpa + year_month, random=~1|id, data=quke_subset_seg_fh)
os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
mpa_quke_thresholds_rand_seg[3] <- summary(os_mod)$psi[2]
mpa_quke_thresholds_rand_seg[4] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(fh~mpa + year_month, data = quke_subset_seg_fh)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
mpa_quke_thresholds_seg[4] <- summary(u_mod_b)$psi[2]
mpa_quke_thresholds_seg[5] <- summary(u_mod_b)$psi[3]
mpa_quke_thresholds_seg[6] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_fh, max.x = quke_max_mpa, y.variable = 'fh', y.lab = "Flame Height (cm)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

Sustainability Metrics:
### Flame Duration
```{r}
quke_subset_seg_fd <- quke_subset_seg %>% drop_na(fd)

o_mod<-lme(fd~mpa + year_month, random=~1|id, data=quke_subset_seg_fd)
os_mod <-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
mpa_quke_thresholds_rand_seg[5] <- summary(os_mod)$psi[2]
mpa_quke_thresholds_rand_seg[6] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(fd~mpa + year_month, data = quke_subset_seg_fd)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
mpa_quke_thresholds_seg[7] <- summary(u_mod_b)$psi[2]
mpa_quke_thresholds_seg[8] <- summary(u_mod_b)$psi[3]
mpa_quke_thresholds_seg[9] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_fd, max.x = quke_max_mpa, y.variable = 'fd', y.lab = "Flame Duration (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

### glow Duration
```{r}
quke_subset_seg_gd <- quke_subset_seg %>% drop_na(gd)

o_mod<-lme(gd~mpa + year_month, random=~1|id, data=quke_subset_seg_gd)
os_mod <-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
mpa_quke_thresholds_rand_seg[7] <- summary(os_mod)$psi[2]
mpa_quke_thresholds_rand_seg[8] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(gd~mpa + year_month, data = quke_subset_seg_gd)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
mpa_quke_thresholds_seg[10] <- summary(u_mod_b)$psi[2]
mpa_quke_thresholds_seg[11] <- summary(u_mod_b)$psi[3]
mpa_quke_thresholds_seg[12] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_gd, max.x = quke_max_mpa, y.variable = 'gd', y.lab = "Glow Duration (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```


### Prop. Ignite (5%)
```{r}
quke_subset_seg_prop_ignite <- quke_subset_seg %>% drop_na(prop_ignite)

o_mod<-lme(prop_ignite~mpa + year_month, random=~1|id, quke_subset_seg_prop_ignite )
os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
mpa_quke_thresholds_rand_seg[9] <- summary(os_mod)$psi[2]
mpa_quke_thresholds_rand_seg[10] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(prop_ignite~mpa + year_month, data = quke_subset_seg_prop_ignite)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
mpa_quke_thresholds_seg[13] <- summary(u_mod_b)$psi[2]
mpa_quke_thresholds_seg[14] <- summary(u_mod_b)$psi[3]
mpa_quke_thresholds_seg[15] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_prop_ignite, max.x = quke_max_mpa, y.variable = 'prop_ignite', y.lab = "Proportion Ignted (5% Bins of mpa)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

<!-- ### Glow to Ignition -->
<!-- ```{r} -->
<!-- quke_subset_seg_gti <- quke_subset_seg %>%  -->
<!--   drop_na(gti) -->

<!-- o_mod<-lme(gti~mpa + year_month, random=~1|id, data=quke_subset_seg_gti) -->
<!-- os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1)) -->
<!-- #summarizing results (note the '_coef' argument) -->
<!-- summary.segmented(os_mod) -->

<!-- #rsegplot.mpa(os_mod, quke_subset_seg_gti, max.x = quke_max_mpa, y.variable = 'gti', y.lab = "Glow to Ignition (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke) -->
<!-- ``` -->



<!-- ### Max_ Temp_ -->
<!-- ```{r} -->
<!-- quke_subset_seg_lower_temp_max <- quke_subset_seg %>%  -->
<!--   drop_na(lower_temp_max) -->

<!-- o_mod<-lme(lower_temp_max~mpa + year_month, random=~1|id, data=quke_subset_seg_lower_temp_max) -->
<!-- os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1)) -->
<!-- #summarizing results (note the '_coef' argument) -->
<!-- summary.segmented(os_mod) -->
<!-- os_mod -->

<!-- #rsegplot.mpa(os_mod, quke_subset_seg_lower_temp_max, max.x = quke_max_mpa, y.variable = 'lower_temp_max', y.lab = "Maximum Temperature (C)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke) -->
<!-- ``` -->


### Temp change
NOTE: Error popping up...
```{r}
quke_subset_seg_temp_change <- quke_subset_seg %>% 
  drop_na(temp_change, lower_temp_max)

o_mod<-lme(lower_temp_max~mpa + year_month, random=~1|id, data=quke_subset_seg_temp_change)
os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)
os_mod

#put into the df:
mpa_quke_thresholds_rand_seg[11] <- summary(os_mod)$psi[2]
mpa_quke_thresholds_rand_seg[12] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(temp_change~mpa + year_month, data = quke_subset_seg_temp_change)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
mpa_quke_thresholds_seg[16] <- summary(u_mod_b)$psi[2]
mpa_quke_thresholds_seg[17] <- summary(u_mod_b)$psi[3]
mpa_quke_thresholds_seg[18] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_temp_change, max.x = quke_max_mpa, y.variable = 'temp_change', y.lab = "Temp Change (C)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

# MPa: Final Table: 
```{r}
#No random effects: 
quke_mpa_summary_df <- mpa_quke_thresholds_seg %>% 
  pivot_longer(everything(), 
               names_to = "flam_metric", 
              values_to = "value") %>% 
  group_by(flam_metric) %>% 
   summarise(value = mean(value)) %>% 
             #sd_bootstrap = sd(value)) %>% 
  mutate(across('flam_metric', str_replace, 'mpa_', ''),
        across('flam_metric', str_replace_all, '_', ' '), 
         statistic = case_when(
           grepl("p value", flam_metric) ~ "p value",
            grepl("psi", flam_metric) ~"psi",
            grepl("st err", flam_metric) ~"st err")) %>% 
  mutate(across('flam_metric', str_replace, 'p value|st err|psi', ''), 
         analysis = "segmented") %>% 
  arrange(flam_metric, statistic, value, analysis)
         
quke_mpa_summary_df

#with random effects: 
quke_mpa_rand_summary_df <- mpa_quke_thresholds_rand_seg %>% 
  pivot_longer(everything(), 
               names_to = "flam_metric", 
              values_to = "value") %>% 
  group_by(flam_metric) %>% 
   summarise(value = mean(value)) %>% 
             #sd_bootstrap = sd(value)) %>% 
  mutate(across('flam_metric', str_replace, 'mpa_', ''),
        across('flam_metric', str_replace_all, '_', ' '), 
         statistic = case_when(
           grepl("p value", flam_metric) ~ "p value",
            grepl("psi", flam_metric) ~"psi",
            grepl("st err", flam_metric) ~"st err")) %>% 
  mutate(across('flam_metric', str_replace, 'p value|st err|psi', ''), 
         analysis = "random") %>% 
  arrange(flam_metric, statistic, value, analysis)
         
quke_mpa_rand_summary_df

quke_mpa <- bind_rows(quke_mpa_rand_summary_df, quke_mpa_summary_df) %>% 
  mutate(spp = "quke", 
         water_variable = "mpa") 

#ggsave(plot=gridExtra::tableGrob(quke_mpa), filename=here("figures", "segmented_tables", "rand_segmented_mpa_quke.png"))
```

#------------
# Top Model
NO THRESHOLDS DETECTED FOR QUKE
Error in MEEM(object, conLin, control$niterEM) : 
  Singularity in backsolve at level 0, block 1

For this round of analyses, going to be using this mixed effects model:
flam_metric ~ spp + lfm + mpa + site + year_month + sample_wt + (1 | individual)
which (with the note that the numerical variables are scaled in the MEM selection) was selected in a linear mixed effects model selection process.

### Holding Vectors
This will be a df with all to collect results as we go: 

No random effects: 
```{r}
top_psi_tti <- c(rep(NaN, 1))
top_psi_fh <- c(rep(NaN, 1))
top_psi_fd <- c(rep(NaN, 1))
top_psi_gd <- c(rep(NaN, 1))
top_psi_fd <- c(rep(NaN, 1))
top_psi_prop_ignite <- c(rep(NaN, 1))
top_psi_temp_change <- c(rep(NaN, 1))

top_st_err_tti <- c(rep(NaN, 1))
top_st_err_fh <- c(rep(NaN, 1))
top_st_err_fd <- c(rep(NaN, 1))
top_st_err_gd <- c(rep(NaN, 1))
top_st_err_fd <- c(rep(NaN, 1))
top_st_err_prop_ignite <- c(rep(NaN, 1))
top_st_err_temp_change <- c(rep(NaN, 1))

top_p_value_tti <- c(rep(NaN, 1))
top_p_value_fh <- c(rep(NaN, 1))
top_p_value_fd <- c(rep(NaN, 1))
top_p_value_gd <- c(rep(NaN, 1))
top_p_value_fd <- c(rep(NaN, 1))
top_p_value_prop_ignite <- c(rep(NaN, 1))
top_p_value_temp_change <- c(rep(NaN, 1))

top_quke_thresholds_seg <- tibble::data_frame(top_psi_tti, top_st_err_tti, top_p_value_tti,
                              top_psi_fh, top_st_err_fh, top_p_value_fh,
                              top_psi_fd, top_st_err_fd,top_p_value_fd,
                              top_psi_gd, top_st_err_gd, top_p_value_gd,
                              top_psi_prop_ignite, top_st_err_prop_ignite, 
                              top_p_value_prop_ignite, top_psi_temp_change,
                              top_st_err_temp_change, top_p_value_temp_change)
```


Random effects: 
```{r}
top_psi_tti <- c(rep(NaN, 1))
top_psi_fh <- c(rep(NaN, 1))
top_psi_fd <- c(rep(NaN, 1))
top_psi_gd <- c(rep(NaN, 1))
top_psi_fd <- c(rep(NaN, 1))
top_psi_prop_ignite <- c(rep(NaN, 1))
top_psi_temp_change <- c(rep(NaN, 1))

top_st_err_tti <- c(rep(NaN, 1))
top_st_err_fh <- c(rep(NaN, 1))
top_st_err_fd <- c(rep(NaN, 1))
top_st_err_gd <- c(rep(NaN, 1))
top_st_err_fd <- c(rep(NaN, 1))
top_st_err_prop_ignite <- c(rep(NaN, 1))
top_st_err_temp_change <- c(rep(NaN, 1))

top_quke_thresholds_rand_seg <- tibble::data_frame(top_psi_tti, top_st_err_tti,
                              top_psi_fh, top_st_err_fh, 
                              top_psi_fd, top_st_err_fd,
                              top_psi_gd, top_st_err_gd,
                              top_psi_prop_ignite, top_st_err_prop_ignite, 
                              top_psi_temp_change, top_st_err_temp_change)
```


### Time to Ignition
```{r}
quke_subset_seg_tti2 <- quke_subset_seg_tti %>%
  drop_na(sample_wt)

#Segmented regression with random changepoints: 
o_mod<-lme(tti~mpa + lfm + sample_wt + year_month + site, random=~1|id, data=quke_subset_seg_tti2)
os_mod_b<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod_b)

#put into the df:
top_quke_thresholds_rand_seg[1] <- summary(os_mod_b)$psi[2]
top_quke_thresholds_rand_seg[2] <- summary(os_mod_b)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(tti~mpa + lfm + sample_wt + year_month + site, data = quke_subset_seg_tti2)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
top_quke_thresholds_seg[1] <- summary(u_mod_b)$psi[2]
top_quke_thresholds_seg[2] <- summary(u_mod_b)$psi[3]
top_quke_thresholds_seg[3] <- u_mod_davies$p.value


rsegplot.mpa(os_mod_b, quke_subset_seg_tti2, max.x = quke_max_mpa, y.variable = 'tti', y.lab = "Time to Ignition (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

Combustibility Metrics:

### Flame Height
```{r}
quke_subset_seg_fh2 <- quke_subset_seg_fh %>%
  drop_na(sample_wt)

o_mod<-lme(fh~mpa + lfm + sample_wt + year_month + site, random=~1|id, data=quke_subset_seg_fh2)
os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
top_quke_thresholds_rand_seg[3] <- summary(os_mod)$psi[2]
top_quke_thresholds_rand_seg[4] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(fh~mpa + lfm + sample_wt + year_month + site, data = quke_subset_seg_fh2)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
top_quke_thresholds_seg[4] <- summary(u_mod_b)$psi[2]
top_quke_thresholds_seg[5] <- summary(u_mod_b)$psi[3]
top_quke_thresholds_seg[6] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_fh2, max.x = quke_max_mpa, y.variable = 'fh', y.lab = "Flame Height (cm)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

Sustainability Metrics:

### Flame Duration
```{r}
quke_subset_seg_fd2 <- quke_subset_seg_fd %>%
  drop_na(sample_wt)

o_mod<-lme(fd~mpa + lfm + sample_wt + year_month + site, random=~1|id, data=quke_subset_seg_fd2)
os_mod <-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
top_quke_thresholds_rand_seg[5] <- summary(os_mod)$psi[2]
top_quke_thresholds_rand_seg[6] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(fd~mpa + lfm + sample_wt + year_month + site, data = quke_subset_seg_fd2)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
top_quke_thresholds_seg[7] <- summary(u_mod_b)$psi[2]
top_quke_thresholds_seg[8] <- summary(u_mod_b)$psi[3]
top_quke_thresholds_seg[9] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_fd2, max.x = quke_max_mpa, y.variable = 'fd', y.lab = "Flame Duration (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

### Glow Duration
```{r}
quke_subset_seg_gd2 <- quke_subset_seg_gd %>%
  drop_na(sample_wt)

o_mod<-lme(gd~mpa + lfm + sample_wt + year_month + site, random=~1|id, data=quke_subset_seg_gd2)
os_mod <-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
top_quke_thresholds_rand_seg[7] <- summary(os_mod)$psi[2]
top_quke_thresholds_rand_seg[8] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(gd~mpa + lfm + sample_wt + year_month + site, data = quke_subset_seg_gd2)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
top_quke_thresholds_seg[10] <- summary(u_mod_b)$psi[2]
top_quke_thresholds_seg[11] <- summary(u_mod_b)$psi[3]
top_quke_thresholds_seg[12] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_gd2, max.x = quke_max_mpa, y.variable = 'gd', y.lab = "Glow Duration (s)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```


### Prop. Ignite (5%)
```{r}
quke_subset_seg_prop_ignite2 <- quke_subset_seg_prop_ignite %>%
  drop_na(sample_wt)

o_mod<-lme(prop_ignite~mpa + lfm + sample_wt + year_month + site, random=~1|id, quke_subset_seg_prop_ignite2)
os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)

#put into the df:
top_quke_thresholds_rand_seg[9] <- summary(os_mod)$psi[2]
top_quke_thresholds_rand_seg[10] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(prop_ignite~mpa + lfm + sample_wt + year_month + site, data = quke_subset_seg_prop_ignite2)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
top_quke_thresholds_seg[13] <- summary(u_mod_b)$psi[2]
top_quke_thresholds_seg[14] <- summary(u_mod_b)$psi[3]
top_quke_thresholds_seg[15] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_prop_ignite2, max.x = quke_max_mpa, y.variable = 'prop_ignite', y.lab = "Proportion Ignted (5% Bins of top)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

### Temp Change
```{r}
quke_subset_seg_temp_change2 <- quke_subset_seg_temp_change %>%
  drop_na(sample_wt)

o_mod<-lme(lower_temp_max~mpa + lfm + sample_wt + year_month + site, random=~1|id, data=quke_subset_seg_temp_change2)
os_mod<-segmented.default(o_mod, ~mpa, npsi=list(mpa=1))
#summarizing results (note the '_coef' argument)
summary.segmented(os_mod)
os_mod

#put into the df:
top_quke_thresholds_rand_seg[11] <- summary(os_mod)$psi[2]
top_quke_thresholds_rand_seg[12] <- summary(os_mod)$psi[3]

# Segmented regression no random changepoints: 

u_mod <- lm(temp_change~mpa + lfm + sample_wt + year_month + site, data = quke_subset_seg_temp_change2)
u_mod_b <- segmented(u_mod, ~mpa)
summary.segmented(u_mod_b)

u_mod_davies <- davies.test(u_mod_b)

#put into the df:
top_quke_thresholds_seg[16] <- summary(u_mod_b)$psi[2]
top_quke_thresholds_seg[17] <- summary(u_mod_b)$psi[3]
top_quke_thresholds_seg[18] <- u_mod_davies$p.value

rsegplot.mpa(os_mod, quke_subset_seg_temp_change2, max.x = quke_max_mpa, y.variable = 'temp_change', y.lab = "Temp Change (C)", tlp = mean_mpa_quke, tlp.lower = lwr_mpa_quke, tlp.upper = upr_mpa_quke)
```

# Final Table (Top Model) 
```{r}
#No random effects: 
quke_top_summary_df <- top_quke_thresholds_seg %>% 
  pivot_longer(everything(), 
               names_to = "flam_metric", 
              values_to = "value") %>% 
  group_by(flam_metric) %>% 
   summarise(value = mean(value)) %>% 
             #sd_bootstrap = sd(value)) %>% 
  mutate(across('flam_metric', str_replace, 'top_', ''),
        across('flam_metric', str_replace_all, '_', ' '), 
         statistic = case_when(
           grepl("p value", flam_metric) ~ "p value",
            grepl("psi", flam_metric) ~"psi",
            grepl("st err", flam_metric) ~"st err")) %>% 
  mutate(across('flam_metric', str_replace, 'p value|st err|psi', ''), 
         analysis = "segmented") %>% 
  arrange(flam_metric, statistic, value, analysis)
         
quke_top_summary_df

#with random effects: 
quke_top_rand_summary_df <- top_quke_thresholds_rand_seg %>% 
  pivot_longer(everything(), 
               names_to = "flam_metric", 
              values_to = "value") %>% 
  group_by(flam_metric) %>% 
   summarise(value = mean(value)) %>% 
             #sd_bootstrap = sd(value)) %>% 
  mutate(across('flam_metric', str_replace, 'top_', ''),
        across('flam_metric', str_replace_all, '_', ' '), 
         statistic = case_when(
           grepl("p value", flam_metric) ~ "p value",
            grepl("psi", flam_metric) ~"psi",
            grepl("st err", flam_metric) ~"st err")) %>% 
  mutate(across('flam_metric', str_replace, 'p value|st err|psi', ''), 
         analysis = "random") %>% 
  arrange(flam_metric, statistic, value, analysis)
         
quke_top_rand_summary_df

quke_top <- bind_rows(quke_top_rand_summary_df, quke_top_summary_df) %>% 
  mutate(spp = "quke", 
         water_variable = "top") 

#ggsave(plot=gridExtra::tableGrob(quke_top), filename=here("figures", "segmented_tables", "rand_segmented_top_quke.png"))
```
#------------

#All together now:

```{r}
quke_all_segmented <- bind_rows(quke_lfm, quke_mpa)

quke_all_segmented_wide <- quke_all_segmented %>% 
  mutate(across('statistic', str_replace, ' ', '_')) %>% 
  pivot_wider(names_from = statistic, 
              values_from = value)

write_csv(quke_all_segmented_wide, 
          here::here("processed-data", "analysis 2.0", "segmented_reg_all", "quke_all_segmented_wide.csv"))
```

#Visualize: 

```{r}
quke_all_segmented_wide %>% 
  #filter(statistic == "psi") %>% 
  ggplot(aes(
    y = psi, 
    x = flam_metric,
    color = analysis, 
   # size = p_value
  )) +
  geom_point() +
  facet_wrap(~water_variable,scales = "free")
```


# ------------
# All species together

I made this chunk of code which only runs if all of the species-specific scripts have been run prior to running this

Due to this, I have the chunk of code as text when I am not planning on using it

```{r}
all_spp_all_segmented <- rbind(abco_all_segmented_wide, arpa_all_segmented_wide, cade_all_segmented_wide, ceco_all_segmented_wide, pije_all_segmented_wide, quke_all_segmented_wide)

mpa_seg_results <- all_spp_all_segmented %>% 
  filter(analysis == 'segmented') %>% 
  filter(water_variable == 'mpa')
focus_mpa_seg_results <- mpa_seg_results %>% 
  filter(st_err < 0.95)

lfm_seg_results <- all_spp_all_segmented %>% 
  filter(analysis == 'segmented') %>% 
  filter(water_variable == 'lfm')
focus_lfm_seg_results <- lfm_seg_results %>% 
  filter(st_err < 15)
```

