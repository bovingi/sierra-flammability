---
title: "Visualizations and Summaries - Figures"
author: "Indra Boving & Joe Celebrezze"
date: "6/21/2022"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(ggpubr)
library(cowplot)
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
#library(strengejacke)
library(sjPlot) # table functions
library(here)
library(effects) #for plofhng model effects
library(sjstats) #use for r2 functions
library("broom.mixed")
library(MuMIn)
library(modelsummary)
library(nlme)
library(lme4)
library(MetBrewer)
library(car)
library(kableExtra)
library(multcomp) # For post-hoc pairwise comparison tests
#devtools::install_github("an-bui/calecopal")
#library(calecopal)
#devtools::install_github("hohenstein/remef")
library(remef)
library(lmerTest)
library(kableExtra)
library(broom)

tidy = broom::tidy
filter = dplyr::filter
mutate = dplyr::mutate
select = dplyr::select
here = here::here
group_by = dplyr::group_by

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```

#------------------------------------
# 1. Data Wrangling

- For the Sierra analysis, this is combining all species and dropping the august sampling data (not enough samples and it was measured a lil differently). 

```{r}
mem_data_all_raw <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv"), show_col_types = F) 

mem_data_all_clean <- mem_data_all_raw %>% 
  select(lfm, mpa, fh, fh, fd, gd,tti, prop_ignite, temp_change, lower_temp_max, ignition, sample_wt, dry_wt, fresh_wt, water_wt, location, site, year_month, spp, individual, bins10lfm, bins5lfm, bins20lfm, notes_flam) %>% 
  mutate(mpa = -1*mpa) %>% 
  mutate(dw_flam_sample = sample_wt * (dry_wt/fresh_wt),
         ww_flam_sample = sample_wt * (water_wt/fresh_wt)) %>% 
  mutate(excess_water = (ww_flam_sample - dw_flam_sample)) %>% 
  #dplyr::group_by(spp) %>% 
  mutate(mpa_scaled = scale(mpa),
         dw_flam_sample_scaled = scale(dw_flam_sample), 
         sample_wt_scaled = scale(sample_wt), 
         ww_flam_sample_scaled = scale(ww_flam_sample),
         lfm_scaled = scale(lfm), 
         excess_water_scaled = scale(excess_water)) %>% 
  mutate(Species = case_when(
    spp == "arpa" ~ "A. patula", 
    spp == "abco" ~ "A. concolor",
    spp == "cade" ~ "C. decurrens",
    spp == "ceco" ~ "C. cordulatus",
    spp == "pije" ~ "P. jeffreyi",
    spp == "quke" ~ "Q. kelloggii"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "arpa" ~ "Angiosperm", 
    spp == "abco" ~ "Gymnosperm",
    spp == "cade" ~ "Gymnosperm",
    spp == "ceco" ~ "Angiosperm",
    spp == "pije" ~ "Gymnosperm",
    spp == "quke" ~ "Angiosperm"
  )) %>% 
  filter(!year_month %in% c("2021_august")) %>% 
  filter(ignition != 2) %>% # Removing manual ignitions
  drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled) 

mem_data_all <- mem_data_all_clean %>% 
  filter(spp != "ceco")

field_data_all <- read_csv(here("processed-data", "analysis 2.0","field_data_2020_2021.csv"), show_col_types = F)
```

## Specifying significance
The below is based on the mixed effects models used for each flam metric. The tti.sig, fd.sig, etc. are regarding to species significance, while the F.tti.sig are regarding to angio vs gymno functional group significance
```{r}
# Significance by species
mem_data_all <- mem_data_all %>% 
  mutate(tti.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(fh.mpa.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "Yes", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(fh.lfm.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "Yes", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(fd.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(gd.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(prop.ig.mpa.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(prop.ig.lfm.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(temp.change.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(temp.max.sig = case_when(
      spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No",
      spp == "ceco" ~ "No", spp == "pije" ~ "No", spp == "quke" ~ "No"
    ))

# Significance by functional group
mem_data_all <- mem_data_all %>% 
  mutate(F.tti.sig = case_when(
    F.Group == "Angiosperm" ~ "Yes", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.fh.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "Yes")) %>% 
  mutate(F.gd.lfm.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.gd.mpa.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.temp.max.lfm.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.temp.max.mpa.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.fd.sig = case_when(
    F.Group == "Angiosperm" ~ "Yes", F.Group == "Gymnosperm" ~ "No"))
```

## Pre- & Post- TLP
```{r}
# PV Data
pv_summary_df_timing <- read_csv(here("processed-data", "pv_summary_df_timing.csv"), show_col_types = FALSE) %>% 
   filter(timing == "fall") %>% 
  mutate_if(is.character, str_to_lower) %>% 
  #mutate_at(spp, str_to_lower) %>% 
  mutate(spp = str_trim(spp),
    name = paste(spp,"_pv", sep = ""), 
    mean_tlp = -1*mean_tlp, 
    lwr = -1*lwr, 
    upr = -1*upr) %>% 
  filter(!spp %in% c("adfa", "ceme"))

pv_summary_df_timing %>% 
  group_split(spp) %>%
   setNames(unique(pv_summary_df_timing$name)) %>%
  list2env(envir = globalenv())

mem_data_all_clean <- mem_data_all_clean %>% 
  mutate(pre.post.tlp = case_when(
    spp == 'abco' & mpa > abco_pv$mean_tlp ~ 'post',
    spp == 'abco' & mpa < abco_pv$mean_tlp ~ 'pre',
    spp == 'arpa' & mpa > arpa_pv$mean_tlp ~ 'post',
    spp == 'arpa' & mpa < arpa_pv$mean_tlp ~ 'pre',
    spp == 'cade' & mpa > cade_pv$mean_tlp ~ 'post',
    spp == 'cade' & mpa < cade_pv$mean_tlp ~ 'pre',
    spp == 'pije' & mpa > pije_pv$mean_tlp ~ 'post',
    spp == 'pije' & mpa < pije_pv$mean_tlp ~ 'pre',
    spp == 'ceco' & mpa > ceco_pv$mean_tlp ~ 'post',
    spp == 'ceco' & mpa < ceco_pv$mean_tlp ~ 'pre',
    spp == 'quke' & mpa > quke_pv$mean_tlp ~ 'post',
    spp == 'quke' & mpa < quke_pv$mean_tlp ~ 'pre'
  )) %>% 
  mutate(pre.post.tlp.lfm = case_when(
    spp == 'abco' & lfm > abco_pv$mean_lfm ~ 'pre',
    spp == 'abco' & lfm < abco_pv$mean_lfm ~ 'post',
    spp == 'arpa' & lfm > arpa_pv$mean_lfm ~ 'pre',
    spp == 'arpa' & lfm < arpa_pv$mean_lfm ~ 'post',
    spp == 'cade' & lfm > cade_pv$mean_lfm ~ 'pre',
    spp == 'cade' & lfm < cade_pv$mean_lfm ~ 'post',
    spp == 'pije' & lfm > pije_pv$mean_lfm ~ 'pre',
    spp == 'pije' & lfm < pije_pv$mean_lfm ~ 'post',
    spp == 'ceco' & lfm > ceco_pv$mean_lfm ~ 'pre',
    spp == 'ceco' & lfm < ceco_pv$mean_lfm ~ 'post',
    spp == 'quke' & lfm > quke_pv$mean_lfm ~ 'pre',
    spp == 'quke' & lfm < quke_pv$mean_lfm ~ 'post'
  ))
```


## Testing Pilot Flame Ignitions
```{r}
# Regex-pattern
string_detect <- paste(c('pilot'), collapse = "|")

mem_data_all <- mem_data_all %>%
  mutate(pilot.flag = case_when(
    str_detect(notes_flam, string_detect) ~ 1,
    TRUE ~ 0)
    )
```

# -----------------------------
# 2. Scatterplots & Models

## TTI
Models:
```{r}
mem_data_all_r <- mem_data_all%>% drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled, fh, gd)

tti_mod <- lmer(tti ~ spp*mpa_scaled + spp*lfm_scaled + site 
                + year_month 
                + sample_wt_scaled 
                + (1 | individual), data = mem_data_all_r)

tti_mod_nosw <- lmer(tti ~ spp*mpa_scaled + spp*lfm_scaled + site 
                + year_month 
                #+ sample_wt_scaled 
                + (1 | individual), data = mem_data_all_r)

tab_model(tti_mod, tti_mod_nosw)
#anova(tti_mod)
```


```{r}
tti_mod.lfm <- lmer(tti ~ spp*lfm_scaled + site + year_month 
                    + sample_wt_scaled 
                    + (1 | individual), data = mem_data_all_r)

tti_mod.mpa <- lmer(tti ~ spp*mpa_scaled + site + year_month 
                    + sample_wt_scaled 
                    + (1 | individual), data = mem_data_all_r)

tti_mod_fgroup <- lmer(tti ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
#anova(tti_mod_fgroup)
```

Remef:
```{r}
r_tti_mpa <- remef(tti_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_tti_lfm <- remef(tti_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_tti_mpa <- r_tti_mpa
mem_data_all_r$r_tti_lfm <- r_tti_lfm
```

Visualizations:
```{r}
tti_plot <- mem_data_all_r %>% 
  ggplot(aes(y = tti, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",                                   axis.text = element_text(size = 14), axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition (sec)") +
  annotate(geom = "text", x = -1.8, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot

# REMEF
tti_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_tti_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",                                   axis.text = element_text(size = 14), axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition") +
  annotate(geom = "text", x = -1.8, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot_r

tti_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = tti, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none", 
        axis.text = element_text(size = 14), 
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition (sec)") +
  annotate(geom = "text", x = -2.6, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot_lfm

# REMEF, for *MAIN* figure:
tti_plot_lfm_r <- mem_data_all_r %>%
  ggplot(aes(y = r_tti_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.tti.sig), alpha = .75, lty = 1) + 
  ##color_many2  + # For color by F.Group w/ CECO
  #color_noceco+ # For color by F.Group w/o CECO
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno; change F.Group > F.Group, tti.sig > F.tti.sig (version 2)
  #scale_shape_manual(values = c(16, 10)) +
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Time to Ignition (s)") +
  annotate(geom = "text", x = -2.6, y = 192.5, label = 'a', fontface = 'bold', size = 10)
tti_plot_lfm_r

#ggarrange(tti_plot, tti_plot_r, tti_plot_lfm, tti_plot_lfm_r )
```

## FH
Models:
```{r}
fh_mod <- lmer(fh ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fh_mod.lfm <- lmer(fh ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
fh_mod.mpa <- lmer(fh ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fh_mod_fgroup <- lmer(fh ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_fh_mpa <- remef(fh_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fh_lfm <- remef(fh_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fh_mpa <- r_fh_mpa
mem_data_all_r$r_fh_lfm <- r_fh_lfm
```

Visualizations:
```{r}
fh_plot <- mem_data_all_r %>% 
  ggplot(aes(y = fh, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.mpa.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -1.8, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot

#REMEF
fh_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.mpa.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height") +
  annotate(geom = "text", x = -1.8, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot_r

fh_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = fh, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.lfm.sig), alpha = .75) + 
  #color_many2  +
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -2.6, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot_lfm

# REMEF, for *MAIN* figure
fh_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.fh.sig), alpha = .75) +
  #color_many2  + # For color by F.Group w/ CECO
  #color_noceco+ # For color by F.Group w/o CECO
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno; change F.Group > F.Group (version 2)
  #scale_shape_manual(values = c(16, 10)) +
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title.y = element_text(size = 16, face = 'bold', 
                                                   margin = margin(r = 10)),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank())+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -2.6, y = 54, label = 'b', fontface = 'bold', size = 10)
fh_plot_lfm_r

#ggarrange(fh_plot, fh_plot_r, fh_plot_lfm, fh_plot_lfm_r, nrow = 2, ncol = 2)
```

## Max. Temp.
Models:
```{r}
lower_temp_max_mod <- lmer(lower_temp_max ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

lower_temp_max_mod.lfm <- lmer(lower_temp_max ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
lower_temp_max_mod.mpa <- lmer(lower_temp_max ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

lower_temp_max_mod_fgroup <- lmer(lower_temp_max ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_lower_temp_max_mpa <- remef(lower_temp_max_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_lower_temp_max_lfm <- remef(lower_temp_max_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_lower_temp_max_mpa <- r_lower_temp_max_mpa
mem_data_all_r$r_lower_temp_max_lfm <- r_lower_temp_max_lfm
```

Visualizations:
```{r}
lower_temp_max_plot <- mem_data_all_r %>% 
  ggplot(aes(y = lower_temp_max, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.max.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Maximum Temperature") +
  annotate(geom = "text", x = -1.8, y = 500, label = 'c', fontface = 'bold', size = 10)
lower_temp_max_plot

#REMEF:
lower_temp_max_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_lower_temp_max_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.max.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Maximum Temperature") +
  annotate(geom = "text", x = -1.8, y = 500, label = 'c', fontface = 'bold', size = 10)
lower_temp_max_plot_r

lower_temp_max_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = lower_temp_max, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.max.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Maximum Temperature") +
  annotate(geom = "text", x = -2.6, y = 500, label = 'c', fontface = 'bold', size = 10)
lower_temp_max_plot_lfm

# REMEF, For *MAIN* figure:
lower_temp_max_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_lower_temp_max_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group,
                   lty = F.temp.max.lfm.sig), alpha = .75, lty = 3) +
  scale_y_continuous(limits = c(150,550), breaks = c(200, 300, 400, 500)) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'))+
  #color_many2 + # For color by spp w/ CECO
  #color_noceco + # For color by spp w/o CECO
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno; change spp > F.Group (version 2)
  #scale_shape_manual(values = c(16, 10)) +
  labs(x = "LFM (scaled, centered)", 
       y = "Maximum Temperature (C)") +
  annotate(geom = "text", x = -2.6, y = 515, label = 'c', fontface = 'bold', size = 10) +
  annotate(geom = 'text', x = -2.3, y = 170, label = 'dry', size = 5) +
  annotate(geom = 'text', x = 3.05, y = 170, label = 'wet', size = 5) +
  geom_segment(aes(x = -2, y = 170, xend = 2.75, yend = 170),
     arrow = arrow(ends = 'both', length = unit(1/2, "picas")), 
      size = .5, alpha = 0.8)
lower_temp_max_plot_lfm_r

#ggarrange(lower_temp_max_plot, lower_temp_max_plot_r, lower_temp_max_plot_lfm, lower_temp_max_plot_lfm_r, nrow = 2, ncol = 2)
```

## GD
Models:
```{r}
gd_mod <- lmer(gd ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

gd_mod.lfm <- lmer(gd ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
gd_mod.mpa <- lmer(gd ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

gd_mod_fgroup <- lmer(gd ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_gd_mpa <- remef(gd_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_gd_lfm <- remef(gd_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_gd_mpa <- r_gd_mpa
mem_data_all_r$r_gd_lfm <- r_gd_lfm
```

Visualizations:
```{r}
gd_plot <- mem_data_all_r %>% 
  ggplot(aes(y = gd, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration (sec)") +
  annotate(geom = "text", x = -1.8, y = 435, label = 'c', fontface = 'bold', size = 10)
gd_plot

#REMEF
gd_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) +
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration") +
  annotate(geom = "text", x = -1.8, y = 430, label = 'c', fontface = 'bold', size = 10)
gd_plot_r

gd_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = gd, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration (sec)") +
  annotate(geom = "text", x = -2.6, y = 420, label = 'c', fontface = 'bold', size = 10)
gd_plot_lfm

# REMEF, for *MAIN* figure:
gd_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.gd.lfm.sig),
              alpha = .75, lty = 3) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'))+
  #color_many2 + # For color by F.Group w/ CECO
  #color_noceco + # For color by F.Group w/o CECO
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno; change F.Group > F.Group (version 2)
  #scale_shape_manual(values = c(16, 10)) +
  labs(x = "LFM", 
       y = "Glow Duration (s)")
  #annotate(geom = "text", x = -2.6, y = 400, label = 'g', fontface = 'bold', size = 10)
gd_plot_lfm_r

#ggarrange(gd_plot, gd_plot_r, gd_plot_lfm, gd_plot_lfm_r, nrow = 2, ncol = 2)
```

## FD
Models:
```{r}
fd_mod <- lmer(fd ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fd_mod.lfm <- lmer(fd ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
fd_mod.mpa <- lmer(fd ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fd_mod_fgroup <- lmer(fd ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_fd_mpa <- remef(fd_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fd_lfm <- remef(fd_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fd_mpa <- r_fd_mpa
mem_data_all_r$r_fd_lfm <- r_fd_lfm
```

Visualizations:
```{r}
fd_plot <- mem_data_all_r %>% 
  ggplot(aes(y = fd, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration (sec)") +
  annotate(geom = "text", x = -1.8, y = 96, label = 'd', fontface = 'bold', size = 10)
fd_plot

#REMEF:
fd_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fd_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(#legend.position = "none",
                       axis.text = element_text(size = 14),
                       axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration") +
  annotate(geom = "text", x = -1.8, y = 87, label = 'd', fontface = 'bold', size = 10)
fd_plot_r

fd_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = fd, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fd.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration (sec)") +
  annotate(geom = "text", x = -2.6, y = 95, label = 'd', fontface = 'bold', size = 10)
fd_plot_lfm

# REMEF, for *MAIN* figure:
fd_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fd_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.fd.sig), alpha = .75) + 
  #color_noceco+ # For color by species w/o CECO
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For angio vs gymno
  scale_linetype_manual(values = c(3, 1)) + # For significance
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration")
  #annotate(geom = "text", x = -2.6, y = 88, label = 'd', fontface = 'bold', size = 10)
fd_plot_lfm_r

#ggarrange(fd_plot, fd_plot_r, fd_plot_lfm, fd_plot_lfm_r, nrow = 2, ncol = 2)
```

## Temp Change
Models:
```{r}
temp_change_mod <- lmer(temp_change ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + spp*sample_wt_scaled + (1 | individual), data = mem_data_all) 

temp_change_mod.fgroup <- lmer(temp_change ~ F.Group*mpa_scaled + F.Group*lfm_scaled +  site + year_month + spp*sample_wt_scaled + (1 | individual), data = mem_data_all)

temp_change_mod <- lmer(temp_change ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r) 
#temp_change_mod_noints <- lmer(temp_change ~ spp + mpa_scaled + lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)
```

Remef:
```{r}
r_temp_change_mpa <- remef(temp_change_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_temp_change_lfm <- remef(temp_change_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_temp_change_mpa <- r_temp_change_mpa
mem_data_all_r$r_temp_change_lfm <- r_temp_change_lfm
```

Visualizations:
```{r}
temp_change_plot <- mem_data_all_r %>% 
  ggplot(aes(y = temp_change, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Temp. Change (C)") +
  annotate(geom = "text", x = -1.8, y = 250, label = 'e', fontface = 'bold', size = 10)
temp_change_plot

# REMEF
temp_change_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_temp_change_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 18, face = 'bold'),
        axis.title.y = element_text(size = 22, face = 'bold')) +
  labs(x = "Water Potential (Scaled)", 
       y = "Temp. Change") +
  annotate(geom = "text", x = -1.8, y = 255, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_r

temp_change_plot_lfm <- mem_data_all_r %>% 
  ggplot(aes(y = temp_change, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Temp. Change (C)") +
  annotate(geom = "text", x = -2.6, y = 245, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_lfm

# REMEF
temp_change_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_temp_change_lfm, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 18, face = 'bold'),
        axis.title.y = element_text(size = 22, face = 'bold'))+
  labs(x = "LFM (Scaled)", 
       y = "Temp. Change") +
  annotate(geom = "text", x = -2.6, y = 255, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_lfm_r

#ggarrange(temp_change_plot, temp_change_plot_r, temp_change_plot_lfm, temp_change_plot_lfm_r, nrow = 2, ncol = 2)
```

## Prop. Ignite
Model:
```{r}
prop_ignite_mod <- lmer(prop_ignite ~ spp*mpa_scaled + spp*lfm_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all_r)
#prop_ignite_mod_noints <- lmer(prop_ignite ~ spp + mpa_scaled + lfm_scaled  + site + year_month + (1 | individual), data = mem_data_all)
```

Remef:
```{r}
r_prop_ignite_mpa <- remef(prop_ignite_mod, fix = c("sample_wt_scaled","lfm_scaled","site"), ran = list(individual = c("(Intercept)")))
r_prop_ignite_lfm <- remef(prop_ignite_mod, fix = c("sample_wt_scaled","mpa_scaled","site"), ran = list(individual = c("(Intercept)")))

mem_data_prop_ignite_r <- mem_data_all_r %>% 
  drop_na(prop_ignite)
mem_data_prop_ignite_r$r_prop_ignite_mpa <- r_prop_ignite_mpa
mem_data_prop_ignite_r$r_prop_ignite_lfm <- r_prop_ignite_lfm
```

Visualizations:
```{r}
prop_ignite_plot <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = prop_ignite, 
             x = mpa_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.mpa.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Proportion Ignited (%)") +
  annotate(geom = "text", x = -1.8, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot

prop_ignite_plot_r <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = r_prop_ignite_mpa, 
             x = mpa_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.mpa.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Proportion Ignited") +
  annotate(geom = "text", x = -1.8, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot_r

prop_ignite_plot_lfm <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = prop_ignite, 
             x = lfm_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.lfm.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Proportion Ignited (%)") +
  annotate(geom = "text", x = -2.6, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot_lfm

prop_ignite_plot_lfm_r <- mem_data_prop_ignite_r %>% 
  ggplot(aes(y = r_prop_ignite_lfm, 
             x = lfm_scaled, 
             group = spp)) +
  scale_y_continuous(limits = c(15, 110), breaks = c(25, 50, 75, 100)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = prop.ig.lfm.sig), alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco+ # For color by species w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Proportion Ignited") +
  annotate(geom = "text", x = -2.6, y = 107.5, label = 'f', fontface = 'bold', size = 10)
prop_ignite_plot_lfm_r

#ggarrange(prop_ignite_plot, prop_ignite_plot_r, prop_ignite_plot_lfm, prop_ignite_plot_lfm_r, nrow = 2, ncol = 2)
```

*NOTE*: It looks like it doesnt make a huge difference if we use remef or not, so we'll go ahead and use it.

Now, putting all figures together, remef only: 

## Arranging:
```{r}
plot_legend <- mem_data_all_r %>% 
  ggplot(aes(y = fh, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, 
              aes(color = Species, lty = fh.mpa.sig), 
              alpha = .75) + 
  #color_many2  + # For color by species w/ CECO
  color_noceco + # For color by species w/o CECO
  theme(#legend.position = "none",
        axis.text = element_text(size = 14, color = "black"),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -1.8, y = 53, label = 'b', fontface = 'bold', size = 10)

legend <- cowplot::get_legend(plot_legend)
```

#### MPa
```{r, fig.height=5, fig.width=9}
#Mpas:
plots <- cowplot::plot_grid(tti_plot_r,
          fh_plot_r,
          gd_plot_r,
          fd_plot_r,
          temp_change_plot_r,
          prop_ignite_plot_r
          #, 
         # ncol = 3, 
         # nrow = 2, 
          )
plots
plots_legend <- cowplot::plot_grid(plots, legend, rel_widths = c(5, 1))
plots_legend

ggsave(plot=plots_legend, bg = "white" , here::here("figures", "mpa_flam_metrics_withceco.jpeg"), device="jpg")
```

#### LFM
```{r, fig.height=5, fig.width=9}
plots <- cowplot::plot_grid(tti_plot_lfm,
          fh_plot_lfm,
          gd_plot_lfm,
          fd_plot_lfm,
          temp_change_plot_lfm_r,
          prop_ignite_plot_lfm_r
          #, 
         # ncol = 3, 
         # nrow = 2, 
          )
plots
plots_legend <- cowplot::plot_grid(plots, legend, rel_widths = c(5, 1))
plots_legend
```

##### F. Groups
```{r, fig.height=5, fig.width=9}
plots <- cowplot::plot_grid(tti_plot_lfm_r,
          fh_plot_lfm_r,
          gd_plot_lfm_r,
          fd_plot_lfm_r,
          temp_change_plot_lfm_r,
          prop_ignite_plot_lfm_r
          #, 
         # ncol = 3, 
         # nrow = 2, 
          )
plots
plots_legend <- cowplot::plot_grid(plots, legend, rel_widths = c(5, 1))
plots_legend

ggsave(plot=plots_legend, bg = "white" , here::here("figures", "lfm_flam_metrics_withceco.jpeg"), device="jpg")
```

# 3. Boxplot: % Ignition
```{r, warning=FALSE}
df <- mem_data_all_clean %>% 
   mutate(hydration = case_when(
     lfm <= 100 ~ 'dry', 
     lfm > 100 ~ 'wet', 
     TRUE ~ 'something'
   )) %>% 
   #filter(lfm < 150) %>% 
    mutate(ignition2 = case_when(
     ignition == "M" ~ 0, 
     ignition == "1 and M" ~ 1, 
     ignition == "1" ~ 1, 
     ignition == "2" ~ 1, 
     ignition == "3" ~ 0, 
     TRUE ~ as.numeric(ignition))) %>% 
   group_by(spp, individual, hydration) %>% #group by year, model, spp, group column
   add_tally %>% 
   mutate(total = sum(ignition2, na.rm = T), 
          prop_ignite = paste0(round(100 * total/n)), 
          prop_ignite = as.numeric(prop_ignite)) %>% 
  # mutate(prop_dry = ) %>% 
   mutate(spp_props = forcats::fct_relevel(spp, 
                                           "ceco", 
                                           "quke",
                                           "arpa", 
                                           "pije", 
                                           "cade", 
                                           "abco")) %>% 
  ungroup() %>% 
  group_by(spp, individual) %>% 
   add_tally %>% 
   mutate(total_all = sum(ignition2, na.rm = T), 
          prop_ignite_all = paste0(round(100 * total_all/nn)), 
          prop_ignite_all = as.numeric(prop_ignite_all))
 

 df %>% 
   ggplot(aes(y = prop_ignite, 
              x = spp_props, 
              fill = hydration)) +
   geom_boxplot(alpha = .5) +
   facet_wrap(~`F.Group`, scales = "free") +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration") 
 
  df %>% 
   # group_by(spp) %>% 
   # add_tally() %>% 
   ggplot(aes(y = prop_ignite_all, 
              x = spp_props, 
              #fill = hydration
              )) +
   geom_boxplot(alpha = .5) +
    facet_wrap(~`F.Group`, scales = "free_x"
               ) +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration") 
```

##### Pre- vs. Post-TLP
```{r}
df %>% 
   ggplot(aes(y = prop_ignite, 
              x = spp_props, 
              fill = factor(pre.post.tlp, level = c('pre', 'post')))) +
   geom_boxplot(alpha = .5) +
   facet_wrap(~`F.Group`, scales = "free") +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration")

df %>% 
   ggplot(aes(y = prop_ignite, 
              x = spp_props, 
              fill = factor(pre.post.tlp.lfm, level = c('pre', 'post')))) +
   geom_boxplot(alpha = .5) +
   facet_wrap(~`F.Group`, scales = "free") +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Pre- or Post-TLP (Split by LFM)")
```

###### Angiosperms ONLY
```{r}
df %>% filter(F.Group == "Angiosperm") %>% 
   ggplot(aes(y = prop_ignite, 
              x = Species, 
              fill = factor(pre.post.tlp, level = c('pre', 'post')))) +
   geom_boxplot(alpha = .5) +
   color_fill +
   labs(y = "Proportion Ignited", 
        x = "Species", 
        fill = "Hydration")  +
   theme(axis.title.y = element_text(face = 'bold', size = 12),
         axis.text.y = element_text(size = 8),
         axis.title.x = element_blank(),
         axis.text.x = element_text(face = 'italic', size = 10),
         legend.title = element_text(face = 'bold', size = 10),
         panel.grid = element_blank())
```

## Main Boxplot
```{r}
boxplot.no.tlp.split <- df %>% filter(F.Group == "Angiosperm") %>% 
   ggplot(aes(y = prop_ignite, 
              x = Species,
              fill = Species)) +
   geom_boxplot(alpha = .8) +
   labs(y = "Proportion Ignited", 
        x = "Species")  +
   scale_y_continuous(limits = c(0, 120), breaks = c(0, 20, 40, 60, 80, 100)) +
   scale_fill_manual(values = c('#87B37A','#EE8739','#5D5D81')) +
   annotate('text', x = 0.7, y = 115, label = 'j', fontface = 'bold', size = 10) +
   theme(axis.title.y = element_text(face = 'bold', size = 14),
         axis.text.y = element_text(size = 10),
         axis.title.x = element_blank(),
         axis.text.x = element_text(face = 'italic', size = 10.5),
         legend.position = 'none',
         panel.grid = element_blank())
boxplot.no.tlp.split
```


## Checking out sample weights
```{r}
ggplot(data = mem_data_all_r, aes(x = mpa, y = sample_wt, color = F.Group)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F) +
  facet_wrap(~Species, nrow = 1) +
  labs(x = "Water Potential", y = "Sample Weight (g)", color = "Functional Group") +
  theme(axis.title = element_text(face = 'bold', size = 15),
        legend.title = element_text(face = 'bold', size = 15))
```


# 4. Effect Size Plots
For these plots, focusing on TTI, FH, GD, Prop Ignition

## MEM Tables

### By F. Group
```{r}
tab_model(tti_mod_fgroup, fh_mod_fgroup, gd_mod_fgroup,lower_temp_max_mod_fgroup,
          fd_mod_fgroup,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
         string.pred = "Coeffcient", 
        dv.labels = c("Time to Ignition", "Flame Height","Glow Duration", "Max Temp", "Flame Duration"),
         title = "Effect Size Plots: MEM Table",
  string.p = "P-Value", 
  p.style = "stars")
```

### By Species 
```{r}
tab_model(tti_mod, fh_mod, gd_mod, lower_temp_max_mod, prop_ignite_mod,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
         string.pred = "Coeffcient", 
        dv.labels = c("Time to Ignition", "Flame Height", "Max Temp", "Glow Duration", "Proportion  Ignited"),
         title = "Effect Size Plots: MEM Table",
  string.p = "P-Value", 
  p.style = "stars")
```

### Extracting Coeffecients
```{r}
tti_mod.coef.df1 <- tidy(tti_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')
tti_mod.coef.df2 <- tidy(tti_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')
tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)

gd_mod.coef.df1 <- tidy(gd_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'GD') %>% 
  mutate(pred = 'lfm')
gd_mod.coef.df2 <- tidy(gd_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'GD') %>% 
  mutate(pred = 'mpa')
gd_mod.coef.df <- rbind(gd_mod.coef.df1, gd_mod.coef.df2)

fh_mod.coef.df1 <- tidy(fh_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FH') %>% 
  mutate(pred = 'lfm')
fh_mod.coef.df2 <- tidy(fh_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FH') %>% 
  mutate(pred = 'mpa')
fh_mod.coef.df <- rbind(fh_mod.coef.df1, fh_mod.coef.df2)

temp_mod.coef.df1 <- tidy(lower_temp_max_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Max Temp') %>% 
  mutate(pred = 'lfm')
temp_mod.coef.df2 <- tidy(lower_temp_max_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Max Temp') %>% 
  mutate(pred = 'mpa')
temp_mod.coef.df <- rbind(temp_mod.coef.df1, temp_mod.coef.df2)

fd_mod.coef.df1 <- tidy(fd_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FD') %>% 
  mutate(pred = 'lfm')
fd_mod.coef.df2 <- tidy(fd_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FD') %>% 
  mutate(pred = 'mpa')
fd_mod.coef.df <- rbind(fd_mod.coef.df1, fd_mod.coef.df2)

coef.df <- rbind(tti_mod.coef.df, fh_mod.coef.df, temp_mod.coef.df, gd_mod.coef.df, fd_mod.coef.df)
```

Quick visualizations of models:
```{r}
tti_spp <- lmer(tti ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(tti_mod)

fh_spp <- lmer(fh ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(fh_spp)

temp_spp <- lmer(temp_change ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(temp_spp)
```

## Sig. function
```{r}
significance <- function(p.value.df, sig.vector) {
  sig.vector <- c(rep("No", 5))
for(i in 1:5){
  if(p.value.df[i] < 0.05){
  sig.vector[i] <- 'Yes'
  }
  else {
  sig.vector[i] <- 'No'
  }
  return(sig.vector)
}
}
```

## Visualizations
### Function
```{r}
ES.plot <- function(df, y.var, sig, std.error, mpa = 'no', margins.vector = c(0.1, 0.1, 0.1, 0.1), limits.vector, breaks.vector, axis.title = ' ') 
  { if(mpa == 'no'){
  ggplot(data = df, aes(x = species, y = y.var,
                       color = species, shape = sig)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  theme_bw() +
  scale_y_continuous(limits = limits.vector, breaks = breaks.vector) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(10, 16)) +
 # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
 # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
 # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(margins.vector, 'cm'),
        legend.position = 'none')
  }
 else{
   ggplot(data = df, aes(x = species, y = y.var,
                       color = species, shape = sig)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  theme_bw() +
  scale_y_continuous(limits = limits.vector, breaks = breaks.vector,
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = axis.title,
                     breaks = breaks.vector,
                     labels = breaks.vector)) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(10, 16)) +
 # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
 # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
 # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.title.y.left = element_blank(),
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(margins.vector, 'cm'),
        legend.position = 'none')
 }
}
```

### TTI
Setup:
```{r}
species <- c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df$estimate[6]
tti.ES.lfm <- c(ref, ref + tti_mod.coef.df$estimate[11:12],
                ref + tti_mod.coef.df$estimate[10],
                ref + tti_mod.coef.df$estimate[13])
  # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
tti.SE.lfm <- c(tti_mod.coef.df$std.error[6], tti_mod.coef.df$std.error[11:12], tti_mod.coef.df$std.error[10], tti_mod.coef.df$std.error[13])
tti.p.value.lfm <- c(tti_mod.coef.df$p.value[6], tti_mod.coef.df$p.value[11:12], tti_mod.coef.df$p.value[10], tti_mod.coef.df$p.value[13])
tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm)
ref2 <- tti_mod.coef.df$estimate[21]
tti.ES.mpa <- c(ref2, ref2 + tti_mod.coef.df$estimate[26:27], 
                ref2 + tti_mod.coef.df$estimate[25], 
                ref2 + tti_mod.coef.df$estimate[28]) 
tti.SE.mpa <- c(tti_mod.coef.df$std.error[21], tti_mod.coef.df$std.error[26:27], tti_mod.coef.df$std.error[25], tti_mod.coef.df$std.error[28])
tti.p.value.mpa <- c(tti_mod.coef.df$p.value[21], tti_mod.coef.df$p.value[26:27], tti_mod.coef.df$p.value[25], tti_mod.coef.df$p.value[28])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)
tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
tti.ES.lfm.plot <- ES.plot(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           margins.vector = c(0.2, 0.05, 0.1, 0.1),
                           limits.vector = c(-6, 19),
                           breaks.vector = c(-5, 0, 5, 10, 15)) +
  annotate(geom = "text", x = 0.7, y = 17.2, label = 'd',
           fontface = 'bold', size = 10) +
  labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.2, 0.3, 0.1, 0),
                           limits.vector = c(-6, 19),
                           breaks.vector = c(-5, 0, 5, 10, 15)) +
  annotate(geom = "text", x = 0.7, y = 17.2, label = 'g',
           fontface = 'bold', size = 10) +
  labs(title = 'Water Potential')
tti.ES.mpa.plot
```

### FH
Setup:
```{r}
ref <- fh_mod.coef.df$estimate[6]
fh.ES.lfm <- c(ref, ref + fh_mod.coef.df$estimate[11:12],
                ref + fh_mod.coef.df$estimate[10],
                ref + fh_mod.coef.df$estimate[13])
  # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
fh.SE.lfm <- c(fh_mod.coef.df$std.error[6], fh_mod.coef.df$std.error[11:12], fh_mod.coef.df$std.error[10], fh_mod.coef.df$std.error[13])
fh.p.value.lfm <- c(fh_mod.coef.df$p.value[6], fh_mod.coef.df$p.value[11:12], fh_mod.coef.df$p.value[10], fh_mod.coef.df$p.value[13])
fh.sig.lfm <- significance(fh.p.value.lfm, fh.sig.lfm)
ref2 <- fh_mod.coef.df$estimate[21]
fh.ES.mpa <- c(ref2, ref2 + fh_mod.coef.df$estimate[26:27], 
                ref2 + fh_mod.coef.df$estimate[25], 
                ref2 + fh_mod.coef.df$estimate[28]) 
fh.SE.mpa <- c(fh_mod.coef.df$std.error[21], fh_mod.coef.df$std.error[26:27], fh_mod.coef.df$std.error[25], fh_mod.coef.df$std.error[28])
fh.p.value.mpa <- c(fh_mod.coef.df$p.value[21], fh_mod.coef.df$p.value[26:27], fh_mod.coef.df$p.value[25], fh_mod.coef.df$p.value[28])
fh.sig.mpa <- significance(fh.p.value.mpa, fh.sig.mpa)
fh.ES.df <- data.frame(species, fh.ES.lfm, fh.SE.lfm, fh.p.value.lfm, fh.sig.lfm, fh.ES.mpa, fh.SE.mpa, fh.p.value.mpa, fh.sig.mpa)

fh.ES.df$species <- factor(fh.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
fh.ES.lfm.plot <- ES.plot(fh.ES.df, fh.ES.lfm, fh.sig.lfm, fh.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-5.5, 5),
                           breaks.vector = c(-4, -2, 0, 2, 4)) +
  annotate(geom = "text", x = 0.7, y = 4.2, label = 'e',
           fontface = 'bold', size = 10)
fh.ES.lfm.plot

fh.ES.mpa.plot <- ES.plot(fh.ES.df, fh.ES.mpa, fh.sig.mpa, fh.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.4, 0.1, 0),
                           limits.vector = c(-5.5, 5),
                           breaks.vector = c(-4, -2, 0, 2, 4),
                          axis.title = 'Hydration x Species Effect Size') +
  annotate(geom = "text", x = 0.7, y = 4.2, label = 'h',
           fontface = 'bold', size = 10) 
fh.ES.mpa.plot
```

### Max. Temp.
Setup:
```{r}
ref <- temp_mod.coef.df$estimate[6]
temp_max.ES.lfm <- c(ref, ref + temp_mod.coef.df$estimate[11:12],
                ref + temp_mod.coef.df$estimate[10],
                ref + temp_mod.coef.df$estimate[13])
  # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
temp_max.SE.lfm <- c(temp_mod.coef.df$std.error[6], temp_mod.coef.df$std.error[11:12], temp_mod.coef.df$std.error[10], temp_mod.coef.df$std.error[13])
temp_max.p.value.lfm <- c(temp_mod.coef.df$p.value[6], temp_mod.coef.df$p.value[11:12], temp_mod.coef.df$p.value[10], temp_mod.coef.df$p.value[13])
temp_max.sig.lfm <- significance(temp_max.p.value.lfm, temp_max.sig.lfm)
ref2 <- temp_mod.coef.df$estimate[21]
temp_max.ES.mpa <- c(ref2, ref2 + temp_mod.coef.df$estimate[26:27], 
                ref2 + temp_mod.coef.df$estimate[25], 
                ref2 + temp_mod.coef.df$estimate[28]) 
temp_max.SE.mpa <- c(temp_mod.coef.df$std.error[21], temp_mod.coef.df$std.error[26:27], temp_mod.coef.df$std.error[25], temp_mod.coef.df$std.error[28])
temp_max.p.value.mpa <- c(temp_mod.coef.df$p.value[21], temp_mod.coef.df$p.value[26:27], temp_mod.coef.df$p.value[25], temp_mod.coef.df$p.value[28])
temp_max.sig.mpa <- significance(temp_max.p.value.mpa, temp_max.sig.mpa)
temp_max.ES.df <- data.frame(species, temp_max.ES.lfm, temp_max.SE.lfm, temp_max.p.value.lfm, temp_max.sig.lfm, temp_max.ES.mpa, temp_max.SE.mpa, temp_max.p.value.mpa, temp_max.sig.mpa)

temp_max.ES.df$species <- factor(temp_max.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
temp_max.ES.lfm.plot <- ES.plot(temp_max.ES.df, temp_max.ES.lfm, temp_max.sig.lfm, temp_max.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-27, 27),
                           breaks.vector = c(-25, -12, 0, 12, 25)) +
  annotate(geom = "text", x = 0.7, y = 23.1, label = 'f',
           fontface = 'bold', size = 10)
temp_max.ES.lfm.plot

temp_max.ES.mpa.plot <- ES.plot(temp_max.ES.df, temp_max.ES.mpa, temp_max.sig.mpa, temp_max.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                          limits.vector = c(-27, 27),
                          breaks.vector = c(-25, -12, 0, 12, 25)) +
  annotate(geom = "text", x = 0.7, y = 23.1, label = 'i',
           fontface = 'bold', size = 10)
temp_max.ES.mpa.plot
```

### GD
Setup:
```{r}
ref <- gd_mod.coef.df$estimate[6]
gd.ES.lfm <- c(ref, ref + gd_mod.coef.df$estimate[11:12],
                ref + gd_mod.coef.df$estimate[10],
                ref + gd_mod.coef.df$estimate[13])
  # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
gd.SE.lfm <- c(gd_mod.coef.df$std.error[6], gd_mod.coef.df$std.error[11:12], gd_mod.coef.df$std.error[10], gd_mod.coef.df$std.error[13])
gd.p.value.lfm <- c(gd_mod.coef.df$p.value[6], gd_mod.coef.df$p.value[11:12], gd_mod.coef.df$p.value[10], gd_mod.coef.df$p.value[13])
gd.sig.lfm <- significance(gd.p.value.lfm, gd.sig.lfm)
ref2 <- gd_mod.coef.df$estimate[21]
gd.ES.mpa <- c(ref2, ref2 + gd_mod.coef.df$estimate[26:27], 
                ref2 + gd_mod.coef.df$estimate[25], 
                ref2 + gd_mod.coef.df$estimate[28]) 
gd.SE.mpa <- c(gd_mod.coef.df$std.error[21], gd_mod.coef.df$std.error[26:27], gd_mod.coef.df$std.error[25], gd_mod.coef.df$std.error[28])
gd.p.value.mpa <- c(gd_mod.coef.df$p.value[21], gd_mod.coef.df$p.value[26:27], gd_mod.coef.df$p.value[25], gd_mod.coef.df$p.value[28])
gd.sig.mpa <- significance(gd.p.value.mpa, gd.sig.mpa)
gd.ES.df <- data.frame(species, gd.ES.lfm, gd.SE.lfm, gd.p.value.lfm, gd.sig.lfm, gd.ES.mpa, gd.SE.mpa, gd.p.value.mpa, gd.sig.mpa)

gd.ES.df$species <- factor(gd.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
gd.ES.lfm.plot <- ES.plot(gd.ES.df, gd.ES.lfm, gd.sig.lfm, gd.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-25, 11),
                           breaks.vector = c(-20, -10, 0, 10)) +
  labs(title = 'LFM')
  #annotate(geom = "text", x = 0.9, y = 9, label = 'e', fontface = 'bold', size = 10)
gd.ES.lfm.plot

gd.ES.mpa.plot <- ES.plot(gd.ES.df, gd.ES.mpa, gd.sig.mpa, gd.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                           limits.vector = c(-25, 11),
                           breaks.vector = c(-20, -10, 0, 10)) +
  labs(title = 'MPa')
  #annotate(geom = "text", x = 0.9, y = 9, label = 'f', fontface = 'bold', size = 10)
gd.ES.mpa.plot

ggarrange(gd_plot_lfm_r, gd.ES.lfm.plot, gd.ES.mpa.plot, nrow = 1)
```

### FD
Setup:
```{r}
ref <- fd_mod.coef.df$estimate[6]
fd.ES.lfm <- c(ref, ref + fd_mod.coef.df$estimate[11:12],
                ref + fd_mod.coef.df$estimate[10],
                ref + fd_mod.coef.df$estimate[13])
  # Following this order: ABCO, CADE, PIJE, ARPA, QUKE (no CECO)
fd.SE.lfm <- c(fd_mod.coef.df$std.error[6], fd_mod.coef.df$std.error[11:12], fd_mod.coef.df$std.error[10], fd_mod.coef.df$std.error[13])
fd.p.value.lfm <- c(fd_mod.coef.df$p.value[6], fd_mod.coef.df$p.value[11:12], fd_mod.coef.df$p.value[10], fd_mod.coef.df$p.value[13])
fd.sig.lfm <- significance(fd.p.value.lfm, fd.sig.lfm)
ref2 <- fd_mod.coef.df$estimate[21]
fd.ES.mpa <- c(ref2, ref2 + fd_mod.coef.df$estimate[26:27], 
                ref2 + fd_mod.coef.df$estimate[25], 
                ref2 + fd_mod.coef.df$estimate[28]) 
fd.SE.mpa <- c(fd_mod.coef.df$std.error[21], fd_mod.coef.df$std.error[26:27], fd_mod.coef.df$std.error[25], fd_mod.coef.df$std.error[28])
fd.p.value.mpa <- c(fd_mod.coef.df$p.value[21], fd_mod.coef.df$p.value[26:27], fd_mod.coef.df$p.value[25], fd_mod.coef.df$p.value[28])
fd.sig.mpa <- significance(fd.p.value.mpa, fd.sig.mpa)
fd.ES.df <- data.frame(species, fd.ES.lfm, fd.SE.lfm, fd.p.value.lfm, fd.sig.lfm, fd.ES.mpa, fd.SE.mpa, fd.p.value.mpa, fd.sig.mpa)

fd.ES.df$species <- factor(fd.ES.df$species, levels = c("A. concolor", "C. decurrens", "P. jeffreyi", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
fd.ES.lfm.plot <- ES.plot(fd.ES.df, fd.ES.lfm, fd.sig.lfm, fd.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-5, 3),
                           breaks.vector = c(-4, -2, 0, 2)) +
  labs(title = "LFM")
  #annotate(geom = "text", x = 0.9, y = 9, label = 'e', fontface = 'bold', size = 10)
fd.ES.lfm.plot

fd.ES.mpa.plot <- ES.plot(fd.ES.df, fd.ES.mpa, fd.sig.mpa, fd.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                           limits.vector = c(-5, 3),
                           breaks.vector = c(-4, -2, 0, 2)) +
  labs(title = "MPa")
  #annotate(geom = "text", x = 0.9, y = 9, label = 'f', fontface = 'bold', size = 10)
fd.ES.mpa.plot

ggarrange(fd_plot_lfm_r, fd.ES.lfm.plot, fd.ES.mpa.plot, nrow = 1)
```

# 5. Main Figure
Arranging effect size plots and scatterplots into one figure

For now, focusing on TTI, FH, GD until we figure out how we hope to incorporate prop_ignite 

Set up:
```{r}
blank_plot <- ggplot(data = gd.ES.df, aes(x = species, y = gd.ES.mpa)) +
  geom_point(color = 'white') +
  theme_void()

tti.ES.df2 <- tti.ES.df
tti.ES.df2$tti.sig.mpa <- factor(tti.ES.df2$tti.sig.mpa, levels = c("Yes", "No"))

plot_legend.ES <- ggplot(data = tti.ES.df2, aes(x = species, y = tti.ES.mpa,
                                                color = species, shape = tti.sig.mpa)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  geom_point(size = 4, cex = 6, alpha = 0.9) +
  geom_linerange(aes(ymin = tti.ES.mpa - 0.5*tti.SE.mpa, ymax = tti.ES.mpa + 0.5*tti.SE.mpa), size = 0.8) +
  theme_bw() +
  #color_many2 +
  color_noceco+
  scale_shape_manual(values = c(16, 10)) +
  theme(legend.title = element_text(face = 'bold', size = 20),
        legend.text = element_text(face = 'italic', size = 17))

plot_legend.scatterplot <- mem_data_all_r %>% 
  ggplot(aes(x = fh, y = mpa, group = F.Group)) +
  geom_point(aes(color = F.Group), size = 2.2) +
  geom_smooth(se = F, method = 'lm', aes(color = F.Group, lty = F.fh.sig)) +
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno
  scale_linetype_manual(values = c(3, 1)) +
  labs(color = "Functional Group", lty = "Significant?") +
  theme(legend.text = element_text(size = 17),  # , face = 'italic'
        legend.title = element_text(size = 20, face = 'bold'),
        legend.key = element_rect(fill = 'white')) +
  guides(lty = guide_legend(override.aes = list(color = 'black')))

ES_legend <- cowplot::get_legend(plot_legend.ES)
SP_legend <- cowplot::get_legend(plot_legend.scatterplot)
```

Arranging:
Note: I had to do some wacky things with blank plots to get the final product to look okay. I still think we could improve it, but I felt like this was passable for now.
```{r}
scatterplots <- cowplot::plot_grid(blank_plot, tti_plot_lfm_r, fh_plot_lfm_r,
                                   lower_temp_max_plot_lfm_r,
                                   ncol = 1, rel_heights = c(0.78, 10, 9.95, 10))

ES.plots <- cowplot::plot_grid(tti.ES.lfm.plot, tti.ES.mpa.plot,
                              blank_plot, blank_plot,
                              fh.ES.lfm.plot, fh.ES.mpa.plot,
                              blank_plot, blank_plot,
                              temp_max.ES.lfm.plot, temp_max.ES.mpa.plot,
                              blank_plot, blank_plot,
                              ncol = 2, nrow = 6,
                              rel_widths = c(6,7.5),
                              rel_heights = c(11.3, 1.25, 10.5, 0.93, 9.6, 1.78))

main_figure_no_legend <- cowplot::plot_grid(scatterplots, ES.plots, ncol = 2, rel_widths = c(10,9))
main_figure_no_legend

legend <- cowplot::plot_grid(ES_legend, SP_legend, ncol = 1)

legend_and_boxplot <- cowplot::plot_grid(blank_plot, boxplot.no.tlp.split, blank_plot, legend, ncol = 1, rel_heights = c(0.29,4.1,0.5,6))

main_figure <- cowplot::plot_grid(main_figure_no_legend, legend_and_boxplot, ncol = 2, rel_widths = c(5,1.5))
main_figure

ggsave(plot = main_figure, bg = 'white', 
       here("figures", "species.x.hydration.effect.and.scatterplots.jpg"),
       width = 16, height = 10)
```

# 6. Summary Table
Comparing slopes, intercepts, and R^2 values of different linear regressions post-remef

Note: this is not looking at slopes, intercepts, etc. of linear mixed effects models. Instead, it is looking at the remef(flam metric) ~ lfm or plots that we included in the main figure

```{r}
ST.spp <- c(rep(c('A. concolor', 'C. decurrens', 'P. jeffreyii', 'A. patula', 'Q. kelloggii'), 3))
ST.flam.metric <- c('Time to Ignition', ' ', ' ', ' ', ' ',
                    'Flame Height', ' ', ' ', ' ', ' ',
                    'Glow Duration', ' ', ' ', ' ', ' ')
ST.slopes <- c(7.4, -0.057, 6.4, 9.3, 0.55, -1.7, -4.5, -2.3, -1.2, -3.7, 16, 18, 12, 16, -4.7)
ST.yints <- c(93, 78, 90, 73, 24, 37, 43, 43, 32, 38, 130, 140, 140, 190, 130)
ST.r2 <- c(0.089, 0.0000071, 0.11, 0.077, 0.006, 0.065, 0.35, 0.16, 0.025, 0.35, 0.14, 0.14, 0.032, 0.043, 0.0028)
ST.df <- data.frame(ST.flam.metric, ST.spp, ST.slopes, ST.yints, ST.r2)
ST.df
```

```{r}
ST.df %>% kable(format = 'html', escape = F, col.names = c('Flam. Metric', 'Species', 'Slope',                                'Y Intercept', 'R2 Value')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T, font_size = 30) %>% 
  save_kable(here('figures', 'interspecific.differences.summary.table.html'))
```

# ------------------------------

# 7. Statistical tests
## ANOVA Tests
```{r}
# Testing Assumptions: Normally distributed residuals
tti.lm <- lm(tti ~ spp, data = mem_data_all)
tti.lm.res <- tti.lm$residuals
qqPlot(tti.lm.res) # Assumption failed
fh.lm <- lm(fh ~ spp, data = mem_data_all)
fh.lm.res <- fh.lm$residuals
qqPlot(fh.lm.res) # Assumption passed
gd.lm <- lm(gd ~ spp, data = mem_data_all)
gd.lm.res <- gd.lm$residuals
qqPlot(gd.lm.res) # Assumption failed

# Try log-transformation
log.tti.lm <- lm(log(tti) ~ spp, data = mem_data_all)
log.tti.lm.res <- log.tti.lm$residuals
qqPlot(log.tti.lm.res) # Better, but unsure if 'passed' assumption
log.fh.lm <- lm(log(fh) ~ spp, data = mem_data_all)
log.fh.lm.res <- log.fh.lm$residuals
qqPlot(log.fh.lm.res) # Assumption failed
log.gd.lm <- lm(log(gd) ~ spp, data = mem_data_all)
log.gd.lm.res <- log.gd.lm$residuals
qqPlot(log.gd.lm.res) # Better, but unsure if 'passed' assumption

# Since log-transformed data is better for gd and tti, we will proceed with that data for those metrics and stick with the untransformed fh data since that had normally distributed residuals

# Assumption 2: Homogeneity of variance
plot(log.tti.lm) # Passes
plot(fh.lm) # Passes
plot(log.gd.lm) # Passes

tti.aov <- aov(log(tti) ~ spp, data = mem_data_all)
summary(tti.aov) # Significant
fh.aov <- aov(fh ~ spp, data = mem_data_all)
summary(fh.aov) # Significant
gd.aov <- aov(log(gd) ~ spp, data = mem_data_all)
summary(gd.aov) # Significant
```

### Tukey-Kramer Tests
```{r}
TukeyHSD(tti.aov)
TukeyHSD(fh.aov)
TukeyHSD(gd.aov)
```

## ANCOVA Tests
We had previously tried this and the first assumption (independence of the covariate and treatment) was not met, so we shifted gears to the ANOVA test, but we are going to try this again with some data transformations (scaled & centered, log-transformed, and sample-weight normalized)

#### Testing assumptions
```{r}
# No transformation
lfm.lm <- aov(lfm ~ spp, data = mem_data_all)
summary(lfm.lm) # Assumption failed

# Scaling, log-transforming, normalizing
mem_data_all_ancova <- mem_data_all %>% 
  ungroup() %>% 
  mutate(lfm.sc = scale(lfm),
         lfm.log = log(lfm),
         lfm.norm = lfm/sample_wt)

lfm.lm <- aov(lfm.sc ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption failed
lfm.lm <- aov(lfm.log ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption failed
lfm.lm <- aov(lfm.norm ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption failed

# Scaling, centering by species
mem_data_all_ancova <- mem_data_all %>% 
  mutate(lfm.sc = scale(lfm))
lfm.lm <- aov(lfm.sc ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption passed

# Proceeding with this, testing homogeneity of variance for all four flam metrics of interest:
tti.mod <- lm(tti ~ lfm.sc + spp,data = mem_data_all_ancova)
tti.res <- resid(tti.mod)
plot(fitted(tti.mod), tti.res) # Assumption failed
fh.mod <- lm(fh ~ lfm.sc + spp,data = mem_data_all_ancova)
fh.res <- resid(fh.mod)
plot(fitted(fh.mod), fh.res) # Assumption passed
temp.max.mod <- lm(lower_temp_max ~ lfm.sc + spp,data = mem_data_all_ancova)
temp.max.res <- resid(temp.max.mod)
plot(fitted(temp.max.mod), temp.max.res) # Assumption passed
gd.mod <- lm(gd ~ lfm.sc + spp,data = mem_data_all_ancova)
gd.res <- resid(gd.mod)
plot(fitted(gd.mod), gd.res) # Not sure...
```

#### Running tests
```{r}
mem_data_all_ancova <- mem_data_all_ancova %>% 
  mutate(spp = as.factor(spp))

# ANCOVA
tti.ancov <- aov(tti ~ spp + lfm.sc, data = mem_data_all_ancova)
Anova(tti.ancov, type = 'III') # Significant
fh.ancov <- aov(fh ~ lfm.sc + spp, data = mem_data_all_ancova)
Anova(fh.ancov, type = 'III') # Significant
temp.max.ancov <- aov(lower_temp_max ~ lfm.sc + spp, data = mem_data_all_ancova)
Anova(temp.max.ancov, type = 'III') # Significant

# Post-Hoc Test: Pairwise Comparison
tti.post.hoc <- glht(tti.ancov, linfct = mcp(spp = "Tukey"))
summary(tti.post.hoc)
fh.post.hoc <- glht(fh.ancov, linfct = mcp(spp = "Tukey"))
summary(fh.post.hoc)
temp.max.post.hoc <- glht(temp.max.ancov, linfct = mcp(spp = "Tukey"))
summary(temp.max.post.hoc)
```

# ====================
# 8. Extra Things

#### ES Mpa vs. ES LFM
```{r}
ES.lfm.vs.mpa <- function(df, x, y, std.error.x, std.error.y, limits, title){
ggplot(data = df, aes(x = x, y = y, color = species)) +
  labs(color = 'Species',
       x = 'MPa Effect Size', y = 'LFM Effect Size',
       title = title) +
  scale_x_continuous(limits = limits) +
  scale_y_continuous(limits = limits) +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y - 0.5*std.error.y, ymax = y + 0.5*std.error.y)) +
  geom_linerange(aes(xmin = x - 0.5*std.error.x, xmax = x + 0.5*std.error.x)) +
  geom_abline(intercept = 0, slope = 1, color = 'black', alpha = 0.5, size = 0.3) +
  geom_hline(yintercept = 0, alpha = 0.5, size = 0.2, lty = 3) +
  geom_vline(xintercept = 0, alpha = 0.5, size = 0.2, lty = 3) +
  theme_bw() +
  color_noceco+
  theme(legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank())
}

tti.ES.lfm.vs.mpa <- ES.lfm.vs.mpa(df = tti.ES.df, x = tti.ES.mpa, y = tti.ES.lfm,
                                   std.error.x = tti.SE.mpa, std.error.y = tti.SE.lfm,
                                   limits = c(-12.5, 23), title = "TTI") +
  annotate(geom = 'text', x = 20, y = 13.7, label = 'a', size = 5) +
  annotate(geom = 'text', x = 5, y = 18.7, label = 'c', size = 5)
tti.ES.lfm.vs.mpa

fh.ES.lfm.vs.mpa <- ES.lfm.vs.mpa(df = fh.ES.df, x = fh.ES.mpa, y = fh.ES.lfm,
                                   std.error.x = fh.SE.mpa, std.error.y = fh.SE.lfm,
                                   limits = c(-5.5, 3.5), title = "FH") +
  annotate(geom = 'text', x = -0.4, y = 1.3, label = 'c', size = 5) +
  annotate(geom = 'text', x = 2.3, y = -0.35, label = 'c', size = 5) +
  annotate(geom = 'text', x = -0.9, y = -2, label = 'b', size = 5)
fh.ES.lfm.vs.mpa

temp_max.ES.lfm.vs.mpa <- ES.lfm.vs.mpa(df = temp_max.ES.df, x = temp_max.ES.mpa,
                      y = temp_max.ES.lfm, std.error.x = temp_max.SE.mpa,
                      std.error.y = temp_max.SE.lfm, limits = c(-30, 36),
                      title = "Max. Temp.")
temp_max.ES.lfm.vs.mpa

gd.ES.lfm.vs.mpa <- ES.lfm.vs.mpa(df = gd.ES.df, x = gd.ES.mpa,
                      y = gd.ES.lfm, std.error.x = gd.SE.mpa,
                      std.error.y = gd.SE.lfm, limits = c(-29, 30),
                      title = "GD") +
  annotate(geom = 'text', x = -1.6, y = 12.5, label = 'b', size = 5) +
  annotate(geom = 'text', x = -5.5, y = -15.5, label = 'c', size = 5)
gd.ES.lfm.vs.mpa

ggarrange(tti.ES.lfm.vs.mpa, fh.ES.lfm.vs.mpa, temp_max.ES.lfm.vs.mpa, gd.ES.lfm.vs.mpa,
          ncol = 2, nrow = 2, common.legend = T)

ggsave(here('figures', 'ES.plot.lfm.vs.mpa.jpg'), height = 12, width = 12)
```

#### Tidy Dataframe
```{r}
tidy_data <- read_csv(here::here("processed-data", "analysis 2.0", "tidy_all_mems.csv")) %>% 
  add_row(term = c("sppabco", "sppabco", "sppabco", "sppabco", "sppabco", "sppabco"),
          estimate =c(0,0,0,0,0,0), 
          y_var = c("fh", "fd", "tti", "gd", "prop_ignite", "temp_change")) %>% 
  mutate(upr = estimate + (std.error/2), 
         lwr = estimate - (std.error/2)) %>% 
  mutate(species = case_when(
    term == "sppabco" ~ "A. concolor",
       term ==                "spparpa" ~ "A. patula",
        term ==               "sppcade" ~ "C. decurrens", 
         term ==              "sppceco" ~ "C. cordulatus", 
         term ==              "spppije" ~ "P. jefferyi",
          term ==             "sppquke" ~ "Q. kelloggii"
  )) %>% 
    mutate(y_var_name= case_when(
    y_var == "tti" ~ "Time to ignition",
       y_var ==                "fh" ~ "Flame height",
        y_var ==               "fd" ~ "Flame duration", 
         y_var ==              "prop_ignite" ~ "Prop. ignited", 
         y_var ==              "temp_change" ~ "Temp. change",
          y_var ==             "gd" ~ "Glow duration"
  ))
```

### Species Effects (Old Version)
```{r, fig.height=3, fig.width=6}
spp_estimates <- tidy_data  %>% 
  filter(term %in% c("sppabco",
                     "spparpa", 
                     "sppcade" ,
                     "sppceco",
                     "spppije",
                     "sppquke"                 
                     )) %>% 
  ggplot(
    aes(color= species)
    ) + 
  geom_point(aes(x = estimate,y = species), size =3) +
    geom_point(aes(x = upr, y = species), size = 1) +
  geom_point(aes(x = lwr, y = species), size = 1) +
  #geom_line(aes(group = species, y = species, x = upr)) +
  geom_segment(aes(x= lwr, xend = upr, y = species, yend = species, color = species))+
  labs(y = "", 
       color = "Species", 
       x = "Estimate", 
       title = "Spp estimates with CECO") +
    facet_wrap(~y_var_name, scales = "free") + 
theme(
  strip.background = element_blank(),
  strip.text.y = element_blank(), 
  axis.text.y = element_blank(), axis.ticks.y = element_blank()
)+
  geom_vline(xintercept = 0,
             linetype="dotted") +
  color_many2
spp_estimates

#ggsave(plot=spp_estimates, bg = "white" , here::here("figures", "spp_estimates_flam_metrics_withceco.jpeg"), device="jpg")
```