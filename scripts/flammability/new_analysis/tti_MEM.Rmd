---
title: "Mixed Effects Models - Time to Ignition"
author: "Indra Boving & Joe Celebrezze"
date: "6/21/2022"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(cowplot)
library(lmerTest)
library(ggeffects)  
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)

#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data

library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
#library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
#library(memmented)
filter = dplyr::filter
mutate = dplyr::mutate
library(nlme)
library(MetBrewer)
#install.packages("memmented")
#devtools::install_github("hohenstein/remef")
library(remef)
library(kableExtra)

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```


#------------------------------------
# 1. Data wrangling
Reading in dataframe

- For the Sierra analysis, this is combining all species and dropping the august sampling data (not enough samples and it was measured a lil differently). 

```{r}
mem_data_all <- read_csv(here("processed-data", "sierra_flam_data_all.csv"), show_col_types = FALSE) %>% 
  select(lfm, mpa, tti, fh, fd, gd, prop_ignite, temp_change, ignition, sample_wt, dry_wt, fresh_wt, water_wt, location, site, year_month, spp, individual) %>% 
  mutate(dw_flam_sample = sample_wt * (dry_wt/fresh_wt),
         mpa = -1*mpa, 
         ww_flam_sample = sample_wt * (water_wt/fresh_wt),
         excess_water = (ww_flam_sample - dw_flam_sample)
         ) %>% 
  group_by(spp) %>% 
  mutate(dw_flam_sample_scaled = scale(dw_flam_sample), 
         mpa_scaled = scale(mpa),
         sample_wt_scaled = scale(sample_wt), 
         ww_flam_sample_scaled = scale(ww_flam_sample),
         lfm_scaled = scale(lfm), 
         excess_water_scaled = scale(excess_water)) %>% 
  ungroup() %>% 
  filter(!year_month %in% c("2021_august")) %>% 
  mutate(fun_gr = case_when(
    spp == "arpa" ~ "Angiosperm", 
    spp == "abco" ~ "Gymnosperm",
    spp == "cade" ~ "Gymnosperm",
    spp == "ceco" ~ "Angiosperm",
    spp == "pije" ~ "Gymnosperm",
    spp == "quke" ~ "Angiosperm"
  ))  %>% 
  mutate(Species = case_when(
    spp == "arpa" ~ "Ar. patula", 
    spp == "abco" ~ "Ab. concolor",
    spp == "cade" ~ "Ca. decurrens",
    spp == "ceco" ~ "Ce. cordulatus",
    spp == "pije" ~ "Pi. jeffreyi",
    spp == "quke" ~ "Qu. kelloggii"
  )) %>% 
  mutate(site = case_when(
    location %in% c("seki") & site %in% c(1) ~ 4,
    location %in% c("seki") & site %in% c(2) ~ 3,
    TRUE ~ as.numeric(site)
  )) %>% 
  filter(ignition != 2) %>% # Removing manual ignitions
  drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled)  %>% 
  filter(spp != "ceco") %>% 
  mutate(site = as.factor(site))  %>% 
  mutate(Species=fct_relevel(Species,c("Ab. concolor", "Pi. jeffreyi", "Ca. decurrens", "Ar. patula", "Qu. kelloggii"))) %>%
 arrange(Species)

field_data_all <- read_csv(here("processed-data", "field_data_2020_2021.csv"), show_col_types = F)
```

How many datapoints? (This will help determine how many parameters we can have in the model before overfitting). Even though we have a lot of measurements, we actually likely have much fewer since each replicate is the individual. 

```{r}
nr_inds_all <- mem_data_all %>% 
  group_by(individual) %>% 
  summarise() %>% 
  nrow
```
 We have 124 individuals, so if we want between 10 (worse) and 50 (better) datapoints per parameter, then that leaves us with ideally 2-3 parameters and definitely not more than 12.

```{r}
mem_data_all %>% 
ggplot(aes( 
           y = mpa_scaled, 
           x = tti, 
           color = spp)) +
  geom_point()+
  geom_smooth(method = "lm")

mem_data_all %>% 
ggplot(aes( 
           y = lfm_scaled, 
           x = tti, 
           color = spp)) +
  geom_point()+
  geom_smooth(method = "lm")

mem_data_all %>% 
ggplot(aes( 
           y = mpa_scaled, 
           x = tti, 
           color = fun_gr)) +
  geom_point()+
  geom_smooth(method = "lm")

mem_data_all %>% 
ggplot(aes( 
           y = lfm_scaled, 
           x = tti, 
           color = fun_gr)) +
  geom_point()+
  geom_smooth(method = "lm")

mem_data_all %>% 
  ggplot(aes(y = mpa, x = lfm, color = spp)) +
  geom_point() +
  facet_wrap(~year_month)+
  geom_smooth(method = "lm", se = F) +
  ylim(0, -10)
```

#------------------------------------
# 2.0 Predicting flam metrics: TTI, FH, FD, GD, Temp change, prop ignite.
####Dotplot

```{r, warning = F}
df <- mem_data_all_clean %>% 
   mutate(hydration = case_when(
     lfm <= 100 ~ 'dry', 
     lfm > 100 ~ 'wet', 
     TRUE ~ 'something'
   )) %>% 
   #filter(lfm < 150) %>% 
    mutate(ignition2 = case_when(
     ignition == "M" ~ 0, 
     ignition == "1 and M" ~ 1, 
     ignition == "1" ~ 1, 
     ignition == "2" ~ 1, 
     ignition == "3" ~ 0, 
     TRUE ~ as.numeric(ignition))) %>% 
   group_by(spp, individual, hydration) %>% #group by year, model, spp, group column
   add_tally %>% 
   mutate(total = sum(ignition2, na.rm = T), 
          prop_ignite = paste0(round(100 * total/n)), 
          prop_ignite = as.numeric(prop_ignite)) %>% 
  # mutate(prop_dry = ) %>% 
   mutate(spp_props = forcats::fct_relevel(spp, 
                                           "ceco", 
                                           "quke",
                                           "arpa", 
                                           "pije", 
                                           "cade", 
                                           "abco")) %>% 
  ungroup() %>% 
  group_by(spp, individual) %>% 
   add_tally %>% 
   mutate(total_all = sum(ignition2, na.rm = T), 
          prop_ignite_all = paste0(round(100 * total_all/nn)), 
          prop_ignite_all = as.numeric(prop_ignite_all))

df.dotplot.prop.ig <- df %>% 
  group_by(spp) %>% 
  mutate(med_prop_ignite = median(prop_ignite)) %>% 
  mutate(stdev_prop_ignite = sd(prop_ignite))

df.dotplot.prop.ig$Species <- factor(df.dotplot.prop.ig$Species, levels = c("Ab. concolor", "Pi. jeffreyi", "Ca. decurrens", "Ar. patula", "Ce. cordulatus", "Qu. kelloggii"))

dotplot.prop.ig <- df.dotplot.prop.ig %>%
   ggplot(aes(y = med_prop_ignite, 
              x = Species,
              color = Species)) +
   geom_point(alpha = .7, size = 5) +
  geom_abline(intercept = 100, slope = 0, color = 'black', alpha = 0.5, size = 0.3,linetype = "dotted") +
   geom_linerange(aes(ymin = case_when(
     med_prop_ignite - 2*stdev_prop_ignite < 0 ~ 0,
     med_prop_ignite - 2*stdev_prop_ignite > 0 ~ med_prop_ignite - 2*stdev_prop_ignite),
     ymax = case_when(
       med_prop_ignite + 2*stdev_prop_ignite > 100 ~ 100,
       med_prop_ignite + 2*stdev_prop_ignite < 100 ~ med_prop_ignite + 2*stdev_prop_ignite))) +
   labs(y = "Percent Ignited (%)", 
        x = "Species")  +
   scale_y_continuous(limits = c(-.5, 112), breaks = c(0, 20, 40, 60, 80, 100)) +
   #scale_x_discrete(guide = guide_axis(n.dodge=2))+ # if we want axis labelled w/ species
   color_many2 +
   annotate('text', x = .75, y = 110, label = 'e', fontface = 'bold', size = 10) +
   theme(axis.title.y = element_text(face = 'bold', size = 14),
         axis.text.y = element_text(size = 10),
         axis.title.x = element_blank(),
         #axis.text.x = element_text(face = 'italic', size = 11),
         axis.text.x = element_blank(),
         axis.ticks.x = element_blank(),
         legend.position = 'none',
         panel.grid = element_blank())
dotplot.prop.ig

```

```{r}
mem_data_all %>% 
ggplot(aes(y = tti, x = mpa_scaled, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco

mem_data_all %>% 
ggplot(aes(y = fh, x = lfm_scaled, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco
```

#TTI

Model selection: 

```{r}
#check for collinearity: 
noints <- lmer(tti ~ lfm_scaled + mpa_scaled + spp + sample_wt_scaled  + year_month +(1 | individual), data = mem_data_all, REML = F)

performance::multicollinearity(noints)
```

```{r}
mem_data_all_dredge <- mem_data_all %>% 
  drop_na(lfm_scaled, spp, mpa_scaled, year_month, sample_wt_scaled, tti)

topmods.lfm <- MuMIn::dredge(lmer(tti ~ lfm_scaled:spp + lfm_scaled +sample_wt_scaled + spp + year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F)) 

topmods.lfm
#top models here have no interaction between LFM and Species, but that's what we're interested in, so the following is our actual top model: 

top_lfm_tti <- lmer(tti ~ lfm_scaled + spp + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all,  REML = F)

summary(top_lfm_tti
        )

top_lfm_int_tti <- lmer(tti ~ lfm_scaled:spp + spp + lfm_scaled + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all,  REML = F)

summary(top_lfm_tti)
performance::multicollinearity(top_lfm)

topmods.mpa <- MuMIn::dredge(lmer(tti ~ mpa_scaled:spp + mpa_scaled + spp + sample_wt_scaled +year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))

topmods.mpa

top_mpa_noint_tti <- lmer(tti ~ spp + mpa_scaled + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all, REML = F)

top_mpa_int_tti <- lmer(tti ~ mpa_scaled*spp + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all, REML = F)

top_mpa_tti <- lmer(tti ~ mpa_scaled + spp + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all, REML = F)

summary(top_mpa_tti)

df_tti1 <- as.data.frame(aictab(c(top_lfm_tti, top_lfm_int_tti, top_mpa_noint_tti, top_mpa_int_tti)))

df_tti <- df_tti1 %>% 
  mutate(Model = case_when(
    Modnames %in% c("Mod1") ~ "LFM + Spp + Wt.",
    Modnames %in% c("Mod2") ~ "LFM*Spp + Wt.",
    Modnames %in% c("Mod3") ~ "Mpa + Spp + Wt.",
    Modnames %in% c("Mod4") ~ "MPa*Spp + Wt.",
  )) %>% 
  select(Model, K, AICc, Delta_AICc) %>% 
  mutate(Flam = "Time to Ignition")

df_tti
#top model has a few options, we'll use the least complicated one (no site, no date)
```

#Estimates: 

1) Estimates into a df: 
```{r}
summary(top_mpa_tti)
library(sjPlot)

sjPlot::plot_model(top_lfm_int_tti, 
                   colors = c('#6E406E'), 
                   # title = NULL,
                   show.values = TRUE, 
                   # rm.terms = c("spp [arpa, cade, pije, quke]"),
                   title = "",
                 axis.labels = c(
                   "LFM * QUKE", 
                   "LFM * PIJE", 
                   "LFM * CADE",
                   "LFM * ARPA", 
                   "Location",
                   "Sample wt.",
                   "LFM",
                   "QUKE",
                   "PIJE",
                   "CADE",
                   "ARPA"
                 ),
                   value.offset = .3,
                 axis.lim = c(-70, 15)) + 
    theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) # Hide minor gridlines
```

```{r}
#Plots:

ES.plot2 <- function(df, y.var, sig, std.error, mpa = 'no', margins.vector = c(0.1, 0.1, 0.1, 0.1), limits.vector, breaks.vector, axis.title = ' ') 
  { if(mpa == 'no'){
    ggplot(data = df, aes(x = species, y = y.var,
                          color = species, shape = sig)) +
      labs(color = 'Species', shape = 'Significant?') +
      geom_point(size = 5) +
      geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
      geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3,linetype = "dotted") +
      theme_bw() +
      scale_y_continuous(limits = limits.vector, breaks = breaks.vector) +
      color_noceco+
      #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
      scale_shape_manual(values = c(10, 16)) +
      # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
      # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
      # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
      theme(axis.title.x = element_blank(), 
            #axis.text.x = element_text(size = 14),
            axis.text.x = element_blank(),
           # axis.title.y = element_blank(), 
           # axis.text.y = element_blank(),
           # axis.ticks.y = element_blank(),
           axis.title.y = element_text(face = 'bold', size = 14),
            axis.text.y = element_text(size = 12),
            legend.title = element_text(face = 'bold', size = 14),
            legend.text = element_text(face = 'italic'),
            panel.grid = element_blank(), 
            axis.ticks.x = element_blank(),
            plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
            plot.margin = unit(margins.vector, 'cm'),
            legend.position = 'none')
  }
    else{
      ggplot(data = df, aes(x = species, y = y.var,
                            color = species, shape = sig)) +
        labs(color = 'Species', shape = 'Significant?') +
        geom_point(size = 5) +
        geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
        geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3, linetype = "dotted") +
        theme_bw() +
        scale_y_continuous(limits = limits.vector, breaks = breaks.vector,
                           # sec.axis = sec_axis(trans = ~.*1, 
                           #                     name = axis.title,
                           #                     breaks = breaks.vector,
                           #                     labels = breaks.vector)
                           ) +
        color_noceco+
        #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
        scale_shape_manual(values = c(10, 16)) +
        # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
        # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
        # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
        theme(axis.title.x = element_blank(), 
           # axis.text.x = element_text(size = 14),
              axis.text.x = element_blank(),
              axis.ticks.y.left = element_blank(), 
              axis.title.y.left = element_blank(),
              axis.text.y.left = element_blank(),
              axis.title.y.right = element_text(face = 'bold', size = 14),
              axis.text.y.right = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
              legend.text = element_text(face = 'italic',),
              panel.grid = element_blank(), axis.ticks.x = element_blank(),
              plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
              plot.margin = unit(margins.vector, 'cm'),
              legend.position = 'none')
    }
  }
```


```{r}
tti_mod.coef.df1 <- tidy(top_lfm_int_tti) %>% 
 select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')

tti_mod.coef.df2 <- tidy(top_mpa_int_tti) %>% 
 select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')


#tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)

tti_mod_lfm <- top_lfm

species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df1$estimate[6]

tti.ES.lfm <- c(ref, #Abco
                ref + tti_mod.coef.df1$estimate[11], #pije
                ref + tti_mod.coef.df1$estimate[10],
                ref + tti_mod.coef.df1$estimate[9],
                ref + tti_mod.coef.df1$estimate[8])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)

tti.SE.lfm <- c(tti_mod.coef.df1$std.error[c(6,11,10,9,8)])

#p values:

ref <- tti_mod.coef.df1$p.value[6]
tti.p.value.lfm <- c(ref, #Abco
                tti_mod.coef.df1$p.value[11], #pije
                tti_mod.coef.df1$p.value[10],
                tti_mod.coef.df1$p.value[9],
                tti_mod.coef.df1$p.value[8])

tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section


#mpa: 
ref2 <- tti_mod.coef.df2$estimate[2]

tti.ES.mpa <- c(ref2, 
                ref2 + tti_mod.coef.df2$estimate[10],
                ref2 + tti_mod.coef.df2$estimate[9], 
                ref2 + tti_mod.coef.df2$estimate[8], 
                ref2 + tti_mod.coef.df2$estimate[11]) 
tti.SE.mpa <- c(tti_mod.coef.df2$std.error[c(2,10,9,8,11)])

ref <- tti_mod.coef.df2$p.value[2]
tti.p.value.lfm <- c(ref, #Abco
                tti_mod.coef.df2$p.value[10], #pije
                tti_mod.coef.df2$p.value[9],
                tti_mod.coef.df2$p.value[8],
                tti_mod.coef.df2$p.value[11])

tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)

tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))


tti.ES.lfm.plot <- ES.plot2(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           mpa = 'no',
                           #margins.vector = c(0.2, 0.05, 0.8, 0.1),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           limits.vector = c(-1, 20),
                           breaks.vector = c(0, 5, 10, 15, 20, 25, 30)) +
        #scale_y_continuous(limits = c(-1, 15), breaks = c(0, 5, 10, 15)) +
 # theme(axis.title.y.right = element_blank(),
      #  axis.text.y.right = element_blank())+
  annotate(geom = "text", x = .6, y = 18.5, label = 'c',
           fontface = 'bold', size = 10) +
  labs(y = "Standardized Coefficient", 
       x = "LFM")
#+
 # labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot2(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'n',
                           #margins.vector = c(0.2, 0.3, 0.8, 0),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           
                           limits.vector = c(-1,20),
                           breaks.vector = c(0, 5, 10, 15)) +
  theme(axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  annotate(geom = "text", x = 0.6, y = 18.5, label = 'd',
           fontface = 'bold', size = 10) +#+
  # theme( axis.ticks.y = element_blank(),
  #             axis.title.y = element_blank(),
  #             axis.text.y = element_blank(),)# +
  labs(x = 'Water Potential')
tti.ES.mpa.plot

tti_scatterplot <- mem_data_all %>% 
ggplot(aes(y = tti, x = lfm, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(title = "Live Fuel Moisture (%)", 
       y = "Time to Ignition (sec.)") +
  theme(axis.title.x = element_blank(), 
             # axis.text.x = element_blank(),
              # axis.ticks.y.left = element_blank(), 
              # axis.title.y.left = element_blank(),
              # axis.text.y.left = element_blank(),
              axis.title.y = element_text(face = 'bold', size = 14),
              axis.text.y = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
              legend.text = element_text(face = 'italic',),
             # panel.grid = element_blank(), axis.ticks.x = element_blank(),
              plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
              plot.margin = unit(c(.2, 0.05, 0.2, 0.1), 'cm'),
              legend.position = 'none')  +
  annotate(geom = "text", x = -2.5, y = 170, label = 'a',
           fontface = 'bold', size = 10) 
tti_scatterplot
  
tti_scatterplot.mpa <- mem_data_all %>% 
ggplot(aes(y = tti, x = mpa, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(title = "Water Potential (MPa)", 
       #y = "Time to Ignition (sec.)"
       ) +
  theme(axis.title.x = element_blank(),
             # axis.text.x = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.y = element_blank(),
              #axis.title.y = element_text(face = 'bold', size = 14),
              #axis.text.y = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
              legend.text = element_text(face = 'italic',),
             # panel.grid = element_blank(), axis.ticks.x = element_blank(),
              plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
              plot.margin = unit(c(.2, 0.05, 0.2, 0.1), 'cm'),
              legend.position = 'none')  +
  annotate(geom = "text", x = -10, y = 170, label = 'b',
           fontface = 'bold', size = 10) 
#tti_scatterplot.mpa
  
  
legend <- cowplot::get_legend(mem_data_all %>% 
ggplot(aes(y = tti, x = lfm_scaled, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(y = "Live Fuel Moisture (scaled)", 
       x = "Time to Ignition (sec.)") +
  theme(legend.text = element_text(size = 17),  # , face = 'italic'
        legend.title = element_text(size = 20, face = 'bold'),
        legend.key = element_rect(fill = 'white')))
#Put together: 

tti_es <- cowplot::plot_grid(tti.ES.lfm.plot, tti.ES.mpa.plot, 
                                nrow = 1, 
                                rel_widths = c(1, 1
                                               ), 
                                align = "bt")
#tti_es

tti_scatter <- cowplot::plot_grid(tti_scatterplot, tti_scatterplot.mpa, 
                                nrow = 1, 
                                rel_widths = c(1,1), 
                                align = "b")
#tti_scatter

tti_plots1 <- cowplot::plot_grid(tti_scatter, tti_es, 
                                nrow = 2, 
                                rel_widths = c(1,.8),
                                rel_heights = c(1, .5),
                                align = "vh", axis = "l")

#tti_plots1

df.dotplot.prop.ig <- df.dotplot.prop.ig %>% # Making totally arbitrary column to make legend
  mutate(holder.sig = case_when(
    tti > 100 ~ "Yes",
    tti < 100 ~ "No"
  )) %>% 
  drop_na(holder.sig)
df.dotplot.prop.ig$holder.sig <- factor(df.dotplot.prop.ig$holder.sig, levels = c("Yes", "No"))

plot_legend.ES <- ggplot(data = df.dotplot.prop.ig, aes(x = Species, y = med_prop_ignite,
                                                color = Species, shape = holder.sig)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  geom_point(size = 4, cex = 6, alpha = 0.9) +
  geom_linerange(aes(ymin = med_prop_ignite - 2*stdev_prop_ignite, ymax = med_prop_ignite + 2*stdev_prop_ignite)) +
  theme_bw() +
  color_many2 +
  scale_shape_manual(values = c(16, 10)) +
  theme(legend.title = element_text(face = 'bold', size = 20),
        legend.text = element_text(face = 'italic', size = 17))
plot_legend.ES

ES_legend <- cowplot::get_legend(plot_legend.ES)

dotplot <- cowplot::plot_grid(ES_legend, dotplot.prop.ig, nrow = 2, 
                              rel_heights = c(1,1))
#dotplot

tti_plots <- cowplot::plot_grid(tti_plots1, dotplot, ncol = 2, rel_widths = c(1, .3))
#tti_plots

ggsave(plot = tti_plots, bg = 'white', 
       here("figures", "main-figures", "Fig2.tti.vs.hydration.jpg"),
       width = 16, height = 8)
```



#FH

```{r}
top_lfm_fh
mem_data_all_dredge <- mem_data_all %>% 
  drop_na(lfm_scaled, spp, mpa_scaled, year_month, sample_wt_scaled, fh
          )

topmods.lfm <- MuMIn::dredge(lmer(fh ~ lfm_scaled:spp + spp + lfm_scaled + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.lfm

top_lfm_fh <- lmer(fh ~ spp*lfm_scaled + sample_wt_scaled + (1 | individual), data = mem_data_all, REML = F)

top_lfm_int_fh <- lmer(fh ~ lfm_scaled*spp + sample_wt_scaled + (1 | individual), data = mem_data_all, REML = F)

top_lfm_noint_fh <- lmer(fh ~ lfm_scaled + spp + sample_wt_scaled + (1 | individual), data = mem_data_all, REML = F)

summary(top_lfm_fh)

summary(model.avg(topmods.lfm, subset = delta < 2))

topmods.mpa <- MuMIn::dredge(lmer(fh ~ mpa_scaled:spp + spp + mpa_scaled + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.mpa

top_mpa_fh <- lmer(fh ~  mpa_scaled*spp + sample_wt_scaled + (1 | individual), data = mem_data_all, REML = F)

top_mpa_noint_fh <- lmer(fh ~  mpa_scaled + spp + sample_wt_scaled + (1 | individual), data = mem_data_all, REML = F)

summary(top_mpa_fh)

top_mpa_int_fh <- lmer(fh ~ mpa_scaled*spp + sample_wt_scaled + (1 | individual), data = mem_data_all, REML = F)

top_mpa_nosw_fh <- lmer(fh ~ mpa_scaled*spp + (1 | individual), data = mem_data_all, REML = F)

df_fh1 <- as.data.frame(aictab(c(top_lfm_noint_fh, top_lfm_int_fh, top_mpa_noint_fh, top_mpa_int_fh, top_mpa_nosw_fh)))

df_fh <- df_fh1 %>% 
  distinct() %>% 
  mutate(Model = case_when(
   Modnames %in% c("Mod1") ~ "LFM + Spp + Wt.",
    Modnames %in% c("Mod2") ~ "LFM*Spp + Wt.",
    Modnames %in% c("Mod3") ~ "Mpa + Spp + Wt.",
    Modnames %in% c("Mod4") ~ "MPa*Spp + Wt.",
   Modnames %in% c("Mod5") ~ "MPa*Spp",
  )) %>% 
  select(Model, K, AICc, Delta_AICc) %>% 
  mutate(Flam = "Flame Height")
#If model averaging: 
#summary(model.avg(topmods.mpa, subset = delta < 2))
```


```{r}
#Estimate plots: 

tti_mod_lfm <- top_lfm_fh 

tti_mod.coef.df1 <- tidy(tti_mod_lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')

em_tti_lfm <- emmeans::emtrends(tti_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
tti_lfm <- summary(em_tti_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_tti_lfm <- tti_lfm$emtrends %>% 
  as.data.frame()
emtrends_tti_lfm$spp <- factor(emtrends_tti_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_lfm <- emtrends_tti_lfm %>% 
  arrange(spp)
  
emtrends_tti_lfm_list <- emtrends_tti_lfm %>% select(p.value) %>% as.vector()
tti.p.value.lfm <- emtrends_tti_lfm_list$p.value

tti.p.value.lfm

tti_mod_mpa <-top_mpa_fh 

tti_mod.coef.df2 <- tidy(tti_mod_mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')
tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)


em_tti_mpa <- emmeans::emtrends(tti_mod_mpa, pairwise~spp, var = "mpa_scaled")
tti_mpa <- summary(em_tti_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_tti_mpa <- tti_mpa$emtrends %>% 
  as.data.frame()
emtrends_tti_mpa$spp <- factor(emtrends_tti_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_mpa <- emtrends_tti_mpa %>% 
  arrange(spp)
  
emtrends_tti_mpa_list <- emtrends_tti_mpa %>% select(p.value) %>% as.vector()
tti.p.value.mpa <- emtrends_tti_mpa_list$p.value
tti.p.value.mpa

##Plots

species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df1$estimate[2]

tti.ES.lfm <- c(ref, #Abco
                ref + tti_mod.coef.df1$estimate[5], #pije
                ref + tti_mod.coef.df1$estimate[4], #cade
                ref + tti_mod.coef.df1$estimate[3], #arpa
                ref + tti_mod.coef.df1$estimate[6]) #quke
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)

tti.SE.lfm <- c(tti_mod.coef.df1$std.error[c(2,5,4,3,6)])

tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section

#mpa: 
ref2 <- tti_mod.coef.df2$estimate[2]

tti.ES.mpa <- c(ref2, 
                ref2 + tti_mod.coef.df2$estimate[5],
                ref2 + tti_mod.coef.df2$estimate[4], 
                ref2 + tti_mod.coef.df2$estimate[3], 
                ref2 + tti_mod.coef.df2$estimate[6]) 
tti.SE.mpa <- c(tti_mod.coef.df2$std.error[c(2,5,4,3,6)])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)

tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))

tti.ES.lfm.plot <- ES.plot2(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           mpa = 'no',
                           #margins.vector = c(0.2, 0.05, 0.8, 0.1),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           limits.vector = c(-3, 3),
                           breaks.vector = c(-3, -2, -1, 0, 1,2)) +
        #scale_y_continuous(limits = c(-1, 15), breaks = c(0, 5, 10, 15)) +
 # theme(axis.title.y.right = element_blank(),
      #  axis.text.y.right = element_blank())+
  annotate(geom = "text", x = 2, y = 2.5, label = 'Flame Height',
           fontface = 'bold', size = 8) +
  labs(y = "Standardized Coefficient", 
       x = "LFM")
#+
 # labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot2(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'n',
                           #margins.vector = c(0.2, 0.3, 0.8, 0),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           
                           limits.vector = c(-3,3),
                           breaks.vector = c(0, 5, 10, 15)) +
  theme(axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  annotate(geom = "text", x = 0.6, y = 14, label = 'd',
           fontface = 'bold', size = 10) +#+
  # theme( axis.ticks.y = element_blank(),
  #             axis.title.y = element_blank(),
  #             axis.text.y = element_blank(),)# +
  labs(x = 'Water Potential')

tti.ES.mpa.plot

es_plots_fh <- cowplot::plot_grid(tti.ES.lfm.plot,tti.ES.mpa.plot)
es_plots_fh
```

Maybe we don't need to do this for all metrics... 
```{r}
mem_data_all_dredge %>% 
ggplot(aes(y = fd, x = lfm, color = spp)) +
  geom_point()+
  facet_wrap(~site*year_month)
```

#FD

```{r}
mem_data_all_dredge <- mem_data_all %>% 
  drop_na(lfm_scaled, spp, mpa_scaled, fd, year_month
          )

topmods.lfm <- MuMIn::dredge(lmer(fd ~ lfm_scaled:spp + spp + lfm_scaled + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.lfm

top_lfm_fd <- lmer(fd ~ spp + lfm_scaled + sample_wt_scaled + year_month + (1|individual), data = mem_data_all, REML = F)
summary(top_lfm_fd)

top_lfm_int_fd <- lmer(fd ~ spp*lfm_scaled + sample_wt_scaled + year_month + (1|individual), data = mem_data_all, REML = F)
  
topmods.mpa <- MuMIn::dredge(lmer(fd ~ mpa_scaled:spp + spp + mpa_scaled + sample_wt_scaled + year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.mpa

top_mpa_fd <- lmer(fd ~ spp + sample_wt_scaled + year_month + (1|individual), data = mem_data_all, REML = F)

top_mpa_int_fd <- lmer(fd ~ sample_wt_scaled + year_month + mpa_scaled*spp + (1|individual), data = mem_data_all, REML = F)
summary(top_mpa_fd)

top_mpa_noint_fd <- lmer(fd ~ sample_wt_scaled + year_month + spp + mpa_scaled + (1|individual), data = mem_data_all, REML = F)

AIC(fd_wt)


df_fd1 <- as.data.frame(aictab(c(top_lfm_fd, top_lfm_int_fd, top_mpa_fd, top_mpa_int_fd, top_mpa_noint_fd)))
df_fd1

df_fd  <- df_fd1 %>% 
  distinct() %>% 
  mutate(Model = case_when(
   Modnames %in% c("Mod1") ~ "LFM + Spp + Wt.",
    Modnames %in% c("Mod2") ~ "LFM*Spp + Wt.",
    Modnames %in% c("Mod3") ~ "Spp + Wt.",
    Modnames %in% c("Mod4") ~ "MPa*Spp + Wt.",
   Modnames %in% c("Mod5") ~ "MPa + Spp + Wt.",
  )) %>% 
  select(Model, K, AICc, Delta_AICc) %>% 
  mutate(Flam = "Flame Duration")
```


```{r}
#Estimate plots: 


tti_mod_lfm <- top_lfm_fd

tti_mod.coef.df1 <- tidy(tti_mod_lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')

em_tti_lfm <- emmeans::emtrends(tti_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
tti_lfm <- summary(em_tti_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_tti_lfm <- tti_lfm$emtrends %>% 
  as.data.frame()
emtrends_tti_lfm$spp <- factor(emtrends_tti_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_lfm <- emtrends_tti_lfm %>% 
  arrange(spp)
  
emtrends_tti_lfm_list <- emtrends_tti_lfm %>% select(p.value) %>% as.vector()
tti.p.value.lfm <- emtrends_tti_lfm_list$p.value

tti.p.value.lfm

tti_mod_mpa <-top_mpa_fd 

tti_mod.coef.df2 <- tidy(tti_mod_mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')
tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)


em_tti_mpa <- emmeans::emtrends(tti_mod_mpa, pairwise~spp, var = "mpa_scaled")
tti_mpa <- summary(em_tti_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_tti_mpa <- tti_mpa$emtrends %>% 
  as.data.frame()
emtrends_tti_mpa$spp <- factor(emtrends_tti_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_mpa <- emtrends_tti_mpa %>% 
  arrange(spp)
  
emtrends_tti_mpa_list <- emtrends_tti_mpa %>% select(p.value) %>% as.vector()
tti.p.value.mpa <- emtrends_tti_mpa_list$p.value
tti.p.value.mpa

##Plots

species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df1$estimate[2]

tti.ES.lfm <- c(ref, #Abco
                ref + tti_mod.coef.df1$estimate[5], #pije
                ref + tti_mod.coef.df1$estimate[4], #cade
                ref + tti_mod.coef.df1$estimate[3], #arpa
                ref + tti_mod.coef.df1$estimate[6]) #quke
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)

tti.SE.lfm <- c(tti_mod.coef.df1$std.error[c(2,5,4,3,6)])

tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section

#mpa: 
ref2 <- tti_mod.coef.df2$estimate[2]

tti.ES.mpa <- c(ref2, 
                ref2 + tti_mod.coef.df2$estimate[5],
                ref2 + tti_mod.coef.df2$estimate[4], 
                ref2 + tti_mod.coef.df2$estimate[3], 
                ref2 + tti_mod.coef.df2$estimate[6]) 
tti.SE.mpa <- c(tti_mod.coef.df2$std.error[c(2,5,4,3,6)])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)

tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))

tti.ES.lfm.plot <- ES.plot2(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           mpa = 'no',
                           #margins.vector = c(0.2, 0.05, 0.8, 0.1),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           limits.vector = c(-4,5),
                           breaks.vector = c(-4, -3, -2, -1, 0, 1, 2, 3,4,5,6)) +
        #scale_y_continuous(limits = c(-1, 15), breaks = c(0, 5, 10, 15)) +
 # theme(axis.title.y.right = element_blank(),
      #  axis.text.y.right = element_blank())+
  annotate(geom = "text", x = 2, y = 4.5, label = 'Flame Duration',
           fontface = 'bold', size = 8) +
  labs(y = "Standardized Coefficient", 
       x = "LFM")
#+
 # labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot2(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'n',
                           #margins.vector = c(0.2, 0.3, 0.8, 0),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           
                           limits.vector = c(-4, 5),
                           breaks.vector = c(-4, -3, -2, -1, 0, 1, 2, 3, 4, 5)) +
  theme(axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  # annotate(geom = "text", x = 0.6, y = 14, label = 'd',
  #          fontface = 'bold', size = 10) +#+
  # theme( axis.ticks.y = element_blank(),
  #             axis.title.y = element_blank(),
  #             axis.text.y = element_blank(),)# +
  labs(x = 'Water Potential')
tti.ES.mpa.plot

es_plots_fd <- cowplot::plot_grid(tti.ES.lfm.plot,tti.ES.mpa.plot)
es_plots_fd
```


#Temp

```{r}
mem_data_all_dredge <- mem_data_all %>% 
  drop_na(lfm_scaled, spp, mpa_scaled, sample_wt_scaled, temp_change, year_month
          )

topmods.lfm <- MuMIn::dredge(lmer(temp_change ~ lfm_scaled:spp + spp + lfm_scaled + year_month + sample_wt_scaled +(1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.lfm

top_lfm_temp<- lmer(temp_change ~ lfm_scaled + spp + year_month + sample_wt_scaled + (1|individual), data = mem_data_all, REML = F)
summary(top_lfm_temp)

# plot(top_lfm_temp)
# lattice::qqmath(top_lfm_temp)

top_lfm_int_temp <- lmer(temp_change ~ lfm_scaled*spp +year_month + sample_wt_scaled + (1|individual), data = mem_data_all, REML = F)

#-----


topmods.mpa <- MuMIn::dredge(lmer(temp_change ~ mpa_scaled:spp + mpa_scaled + spp +  sample_wt_scaled +year_month + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.mpa

top_mpa_temp<- lmer(temp_change ~ mpa_scaled*spp + sample_wt_scaled + year_month + (1|individual) , data = mem_data_all, REML = F)

summary(top_mpa_temp)

top_mpa_int_temp<- lmer(temp_change ~ mpa_scaled*spp + sample_wt_scaled + year_month +(1|individual) + (1|site), data = mem_data_all, REML = F)

top_mpa_noint_temp<- lmer(temp_change ~ mpa_scaled + spp + sample_wt_scaled + year_month +(1|individual) + (1|site), data = mem_data_all, REML = F)

df_temp1 <- as.data.frame(aictab(c(top_lfm_temp, top_lfm_int_temp, top_mpa_noint_temp, top_mpa_int_temp)))
df_temp1

df_temp <- df_temp1 %>% 
  distinct() %>% 
  mutate(Model = case_when(
   Modnames %in% c("Mod1") ~ "LFM + Spp + Wt.",
    Modnames %in% c("Mod2") ~ "LFM*Spp + Wt.",
    Modnames %in% c("Mod3") ~ "Mpa + Spp + Wt.",
    Modnames %in% c("Mod4") ~ "MPa*Spp + Wt.",
  )) %>% 
  select(Model, K, AICc, Delta_AICc) %>% 
  mutate(Flam = "Temp. Change")
```


```{r}
#Estimate plots: 


tti_mod_lfm <- top_lfm_temp

tti_mod.coef.df1 <- tidy(tti_mod_lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')

em_tti_lfm <- emmeans::emtrends(tti_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
tti_lfm <- summary(em_tti_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_tti_lfm <- tti_lfm$emtrends %>% 
  as.data.frame()
emtrends_tti_lfm$spp <- factor(emtrends_tti_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_lfm <- emtrends_tti_lfm %>% 
  arrange(spp)
  
emtrends_tti_lfm_list <- emtrends_tti_lfm %>% select(p.value) %>% as.vector()
tti.p.value.lfm <- emtrends_tti_lfm_list$p.value

tti.p.value.lfm

tti_mod_mpa <-top_mpa_temp 

tti_mod.coef.df2 <- tidy(tti_mod_mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')
tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)


em_tti_mpa <- emmeans::emtrends(tti_mod_mpa, pairwise~spp, var = "mpa_scaled")

tti_mpa <- summary(em_tti_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_tti_mpa <- tti_mpa$emtrends %>% 
  as.data.frame()

emtrends_tti_mpa$spp <- factor(emtrends_tti_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_mpa <- emtrends_tti_mpa %>% 
  arrange(spp)
  
emtrends_tti_mpa_list <- emtrends_tti_mpa %>% select(p.value) %>% as.vector()
tti.p.value.mpa <- emtrends_tti_mpa_list$p.value
tti.p.value.mpa

##Plots

species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df1$estimate[2]

tti.ES.lfm <- c(ref, #Abco
                ref + tti_mod.coef.df1$estimate[6], #pije
                ref + tti_mod.coef.df1$estimate[5], #cade
                ref + tti_mod.coef.df1$estimate[4], #arpa
                ref + tti_mod.coef.df1$estimate[7]) #quke
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)

tti.SE.lfm <- c(tti_mod.coef.df1$std.error[c(2,6,5,4,7)])

tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section
tti.sig.lfm

#mpa: 
ref2 <- tti_mod.coef.df2$estimate[2]

tti.ES.mpa <- c(ref2, 
                ref2 + tti_mod.coef.df2$estimate[6],
                ref2 + tti_mod.coef.df2$estimate[5], 
                ref2 + tti_mod.coef.df2$estimate[4], 
                ref2 + tti_mod.coef.df2$estimate[7]) 
tti.SE.mpa <- c(tti_mod.coef.df2$std.error[c(2,6,5,4,7)])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)

tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))

tti.ES.lfm.plot <- ES.plot2(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           mpa = 'no',
                           #margins.vector = c(0.2, 0.05, 0.8, 0.1),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           limits.vector = c(-15, 10),
                           breaks.vector = c(-15, -10, -5, 0, 5, 10, 15, 20)) +
        #scale_y_continuous(limits = c(-1, 15), breaks = c(0, 5, 10, 15)) +
 # theme(axis.title.y.right = element_blank(),
      #  axis.text.y.right = element_blank())+
  annotate(geom = "text", x = 2, y = 8, label = 'Temp Change',
           fontface = 'bold', size = 8) +
  labs(y = "Standardized Coefficient", 
       x = "LFM")
#+
 # labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot2(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'n',
                           #margins.vector = c(0.2, 0.3, 0.8, 0),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           
                           limits.vector = c(-15, 10),
                           breaks.vector = c(-15, -10, -5, 0, 5, 10, 15, 20)) +
  theme(axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  # annotate(geom = "text", x = 0.6, y = 14, label = 'd',
  #          fontface = 'bold', size = 10) +#+
  # theme( axis.ticks.y = element_blank(),
  #             axis.title.y = element_blank(),
  #             axis.text.y = element_blank(),)# +
  labs(x = 'Water Potential')
tti.ES.mpa.plot

es_plots_temp <- cowplot::plot_grid(tti.ES.lfm.plot,tti.ES.mpa.plot)
es_plots_temp
```
#GD

```{r}
mem_data_all_dredge <- mem_data_all %>% 
  drop_na(lfm_scaled, spp, mpa_scaled, sample_wt_scaled, site, gd
          )

topmods.lfm <- MuMIn::dredge(lmer(gd ~ lfm_scaled:spp + lfm_scaled + year_month + sample_wt_scaled + spp +(1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.lfm

top_lfm_gd <- lmer(gd ~ sample_wt_scaled + year_month + spp + (1|individual), data = mem_data_all, REML = F)

top_lfm_int_gd <- lmer(gd ~ sample_wt_scaled + year_month + lfm_scaled*spp + (1|individual), data = mem_data_all, REML = F)

top_lfm_noint_gd <- lmer(gd ~ year_month + sample_wt_scaled + spp + lfm_scaled + (1|individual), data = mem_data_all, REML = F)

summary(top_lfm_gd)


topmods.mpa <- MuMIn::dredge(lmer(gd ~ mpa_scaled:spp + mpa_scaled + year_month + sample_wt_scaled + spp + (1 | individual), data = mem_data_all_dredge, na.action = "na.fail", REML = F))
topmods.mpa

top_mpa_gd <- lmer(gd ~ year_month + sample_wt_scaled + spp + (1|individual), data = mem_data_all, REML = F)

top_mpa_noint_gd <- lmer(gd ~ year_month + sample_wt_scaled + spp + mpa_scaled + (1|individual), data = mem_data_all, REML = F)

top_mpa_int_gd <- lmer(gd ~  year_month +sample_wt_scaled + mpa_scaled*spp + (1|individual), data = mem_data_all, REML = F)

summary(top_mpa_gd)

df_gd1 <- as.data.frame(aictab(c(top_lfm_gd, top_lfm_int_gd, top_lfm_noint_gd, #top_mpa_gd, 
                                top_mpa_int_gd, top_mpa_noint_gd)))
df_gd1

df_gd <- df_gd1 %>% 
 # distinct() %>% 
  mutate(Model = case_when(
   Modnames %in% c("Mod1") ~ "Spp + Wt.",
    Modnames %in% c("Mod2") ~ "LFM*Spp + Wt.",
   Modnames %in% c("Mod3") ~ "LFM + Spp + Wt.",
   # Modnames %in% c("Mod4") ~ "Spp + Wt.",
    Modnames %in% c("Mod4") ~ "MPa*Spp + Wt.",
   Modnames %in% c("Mod5") ~ "MPa + Spp + Wt.",
  )) %>% 
  select(Model, K, AICc, Delta_AICc) %>% 
  mutate(Flam = "Glow Duration")
df_gd
```
#Table of AIC: 
```{r}
df_model_selection <- bind_rows(df_tti, df_fh, df_temp, df_fd, df_gd) %>% 
  select(Flam, Model, Delta_AICc)

df_model_selection

knitr::kable(df_model_selection, format = "html") %>% 
  print()
```


```{r}
#Estimate plots: 


tti_mod_lfm <- top_lfm_gd

tti_mod.coef.df1 <- tidy(tti_mod_lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')

em_tti_lfm <- emmeans::emtrends(tti_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
em_tti_lfm
tti_lfm <- summary(em_tti_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_tti_lfm <- tti_lfm$emtrends %>% 
  as.data.frame()

emtrends_tti_lfm$spp <- factor(emtrends_tti_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_lfm <- emtrends_tti_lfm %>% 
  arrange(spp)
  
emtrends_tti_lfm_list <- emtrends_tti_lfm %>% select(p.value) %>% as.vector()
tti.p.value.lfm <- emtrends_tti_lfm_list$p.value

tti.p.value.lfm

tti_mod_mpa <-top_mpa_gd 

tti_mod.coef.df2 <- tidy(tti_mod_mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')
tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)


em_tti_mpa <- emmeans::emtrends(tti_mod_mpa, pairwise~spp, var = "mpa_scaled")
tti_mpa <- summary(em_tti_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_tti_mpa <- tti_mpa$emtrends %>% 
  as.data.frame()
emtrends_tti_mpa$spp <- factor(emtrends_tti_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_mpa <- emtrends_tti_mpa %>% 
  arrange(spp)
  
emtrends_tti_mpa_list <- emtrends_tti_mpa %>% select(p.value) %>% as.vector()
tti.p.value.mpa <- emtrends_tti_mpa_list$p.value
tti.p.value.mpa

##Plots

species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df1$estimate[2]

tti.ES.lfm <- c(ref, #Abco
                ref + tti_mod.coef.df1$estimate[6], #pije
                ref + tti_mod.coef.df1$estimate[5], #cade
                ref + tti_mod.coef.df1$estimate[4], #arpa
                ref + tti_mod.coef.df1$estimate[7]) #quke
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)

tti.SE.lfm <- c(tti_mod.coef.df1$std.error[c(2,6,5,4,7)])

tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section

#mpa: 
ref2 <- tti_mod.coef.df2$estimate[2]

tti.ES.mpa <- c(ref2, 
                ref2 + tti_mod.coef.df2$estimate[6],
                ref2 + tti_mod.coef.df2$estimate[5], 
                ref2 + tti_mod.coef.df2$estimate[4], 
                ref2 + tti_mod.coef.df2$estimate[7]) 
tti.SE.mpa <- c(tti_mod.coef.df2$std.error[c(2,6,5,4,7)])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)

tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))

tti.ES.lfm.plot <- ES.plot2(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           mpa = 'no',
                           #margins.vector = c(0.2, 0.05, 0.8, 0.1),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           limits.vector = c(-25, 20),
                           breaks.vector = c(-25, -20, -15, -10, -5, 0, 5, 10, 15, 20)) +
        #scale_y_continuous(limits = c(-1, 15), breaks = c(0, 5, 10, 15)) +
 # theme(axis.title.y.right = element_blank(),
      #  axis.text.y.right = element_blank())+
  annotate(geom = "text", x = 2, y = 15, label = 'Glow Duration',
           fontface = 'bold', size = 8) +
  labs(y = "Standardized Coefficient", 
       x = "LFM")
#+
 # labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot2(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'n',
                           #margins.vector = c(0.2, 0.3, 0.8, 0),
                           margins.vector = c(0, 0.05, 0.2, 0.1),
                           
                           limits.vector = c(-25, 20),
                           breaks.vector = c(-25, -20, -15, -10, -5, 0, 5, 10, 15, 20)) +
  theme(axis.title.y.right = element_blank(),
        axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank()) +
  # annotate(geom = "text", x = 0.6, y = 14, label = 'd',
  #          fontface = 'bold', size = 10) +#+
  # theme( axis.ticks.y = element_blank(),
  #             axis.title.y = element_blank(),
  #             axis.text.y = element_blank(),)# +
  labs(x = 'Water Potential')
tti.ES.mpa.plot

es_plots_gd <- cowplot::plot_grid(tti.ES.lfm.plot,tti.ES.mpa.plot)
es_plots_gd

#summary(model.avg(topmods.mpa, subset = delta < 2))
```

#Table of final models: 
```{r}
#LFM: 
tab_model(top_lfm_tti, top_lfm_fh, top_lfm_fd, top_lfm_temp, top_lfm_gd,
         # show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
         p.val = "kr",
          show.icc = FALSE, 
          show.p = TRUE,
          auto.label = TRUE,
         string.pred = "Coefficient", 
         dv.labels = c("Time to Ignition", "Flame Height", "Flame Duration", 
                      "Temp Change","Glow Duration"
                      ),
         pred.labels = c("Intercept", "LFM",
         "ARPA", "CADE", "PIJE", "QUKE",
         "Sample Wt.",
                   "Location",
                  "ARPA*LFM",
                  "CADE*LFM",
                  "PIJE*LFM",
                  "QUKE*LFM"

                  ),
         title = "Top Models - LFM",
string.p = "P-Value", 
  p.style = "stars"
  )

#MPa:
tab_model(top_mpa_tti, top_mpa_fh, top_mpa_fd, top_mpa_temp, top_mpa_gd,
          show.reflvl = FALSE, 
         #  heading.padding = 0,
         #  heading.padding.horizontal = NULL,
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
         p.val = "kr",
          show.icc = FALSE, 
          #show.p= FALSE,
         string.pred = "Coefficient", 
         dv.labels = c("Time to Ignition", "Flame Height", "Flame Duration", 
                      "Temp Change","Glow Duration"
                      ),
         pred.labels = c("Intercept", "ARPA", "CADE", "PIJE", "QUKE", "Water Potential",
                  "Sample Wt.",
                  "Location",
                  "ARPA*Water Potential",
                  "CADE*Water Potential",
                  "PIJE*Water Potential",
                  "QUKE*Water Potential"
                  ),
         title = "Top Models - Water Potential",
  string.p = "P-Value", 
  p.style = "stars"
  )


tab_model(top_lfm_int_tti, top_lfm_int_fh, top_lfm_int_fd, top_lfm_int_temp, top_lfm_int_gd,
          show.reflvl = FALSE, 
          digits = 3, 
          p.val = "kr",
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          show.p = TRUE,
         string.pred = "Coefficient", 
         dv.labels = c("Time to Ignition", "Flame Height", "Flame Duration", 
                      "Temp Change","Glow Duration"
                      ),
         title = "Species Interaction Models - LFM",
string.p = "P-Value", 
  p.style = "stars"
  )

#MPa:
tab_model(top_mpa_int_tti, top_mpa_int_fh, top_mpa_int_fd, top_mpa_int_temp, top_mpa_int_gd,
          show.reflvl = FALSE, 
          digits = 3, 
          p.val = "kr",
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          #show.p= FALSE,
         string.pred = "Coefficient", 
         dv.labels = c("Time to Ignition", "Flame Height", "Flame Duration", 
                      "Temp Change","Glow Duration"
                      ),
         title = "Species Interaction Models - Water Potential",
  string.p = "P-Value", 
  p.style = "stars"
  )


tab_model(top_mpa_tti, top_mpa_int_tti, top_mpa_noint_tti, top_lfm_tti, top_lfm_int_tti,
          show.reflvl = FALSE, 
          digits = 3, 
          show.std = NULL,
          p.val = "kr",
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          #show.p= FALSE,
         string.pred = "Coefficient", 
         dv.labels = c("top mpa", 
                       "int mpa", 
                       "noint mpa",
                       "top lfm", 
                       "int lfm"),
         # dv.labels = c("Time to Ignition", "Flame Height", "Flame Duration", 
         #              "Temp Change","Glow Duration"
         #              ),
         title = "Time to Ignition",
  string.p = "P-Value", 
  p.style = "stars"
  )
```

#Figure of final model estimates: 

```{r}
df.dotplot.prop.ig <- df.dotplot.prop.ig %>% # Making totally arbitrary column to make legend
  mutate(holder.sig = case_when(
    tti > 100 ~ "Yes",
    tti < 100 ~ "No"
  )) %>% 
  drop_na(holder.sig)
df.dotplot.prop.ig$holder.sig <- factor(df.dotplot.prop.ig$holder.sig, levels = c("Yes", "No"))


plot_legend.ES <- ggplot(data = df.dotplot.prop.ig, aes(x = Species, y = med_prop_ignite,
                                                color = Species, shape = holder.sig)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  geom_point(size = 4, cex = 6, alpha = 0.9) +
  geom_linerange(aes(ymin = med_prop_ignite - 2*stdev_prop_ignite, ymax = med_prop_ignite + 2*stdev_prop_ignite)) +
  theme_bw() +
  color_many2 +
  scale_shape_manual(values = c(16, 10)) +
  theme(legend.title = element_text(face = 'bold', size = 20),
        legend.text = element_text(face = 'italic', size = 17))
plot_legend.ES

ES_legend <- cowplot::get_legend(plot_legend.ES)
```


```{r}
es_plots_si <- cowplot::plot_grid(es_plots_fh,
                   es_plots_fd,
                   es_plots_temp,
                   es_plots_gd,
                   nrow = 4,
                   align = "v", 
                                   axis = "rlbt"
                  )

es_plots_si2 <- cowplot::plot_grid(es_plots_si, ES_legend,
                                   ncol = 2, 
                                   rel_widths = c(1, .2), 
                                   align = "v", 
                                   axis = "rlbt")
es_plots_si2

ggsave(plot = es_plots_si2, bg = 'white', 
       here("figures", "supp-figures", "FigS3.ES.jpg"),
       width = 12.5, height = 10)
```

#----------------


#3.0 Figures

###3.3. Estimate Plots
For these plots, focusing on TTI, FH, GD, Prop Ignition

####Models: 
```{r}
tti_mod_ang.mpa <- lmer(tti ~ mpa_scaled*spp  + (1 | individual), data = angio_df, REML = F)
fh_mod_ang.mpa <- lmer(fh ~ mpa_scaled*spp + (1 | individual), data = angio_df, REML = F)
tti_mod_ang.mpa <- lmer(tti ~ mpa_scaled*spp  + (1 | individual), data = angio_df, REML = F)

tti_mod_gym.mpa <- lmer(tti ~ mpa_scaled*spp  + (1 | individual), data = gymno_df, REML = F)
fh_mod_gym.mpa <- lmer(fh ~ mpa_scaled*spp + (1 | individual), data = gymno_df, REML = F)
tti_mod_gym.mpa <- lmer(tti ~ mpa_scaled*spp  + (1 | individual), data = gymno_df, REML = F)

tti_mod_gym.lfm <- lmer(tti ~ lfm_scaled*spp + (1 | individual), data = gymno_df, REML = F)
fh_mod_gym.lfm <- lmer(fh ~ lfm_scaled*spp + (1 | individual), data = gymno_df, REML = F)
gd_mod_gym.lfm <- lmer(gd ~ lfm_scaled*spp + (1 | individual), data = gymno_df, REML = F)

tti_mod_ang.lfm <- lmer(tti ~ lfm_scaled*spp + (1 | individual), data = angio_df, REML = F)
fh_mod_ang.lfm <- lmer(fh ~ lfm_scaled*spp + (1 | individual), data = angio_df, REML = F)
gd_mod_ang.lfm <- lmer(gd ~ lfm_scaled*spp + (1 | individual), data = angio_df, REML = F)
```

####Extracting Coefficients: 
```{r}
tti_mod.coef.df <- tidy(tti_mod_ang.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI', 
         pred = 'lfm') 
```

### Extracting Coeffecients
```{r}
tti_mod.coef.df1 <- tidy(tti_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')

tti_mod.coef.df2 <- tidy(tti_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')

tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)

gd_mod.coef.df1 <- tidy(gd_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'GD') %>% 
  mutate(pred = 'lfm')
gd_mod.coef.df2 <- tidy(gd_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'GD') %>% 
  mutate(pred = 'mpa')
gd_mod.coef.df <- rbind(gd_mod.coef.df1, gd_mod.coef.df2)

fh_mod.coef.df1 <- tidy(fh_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FH') %>% 
  mutate(pred = 'lfm')
fh_mod.coef.df2 <- tidy(fh_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FH') %>% 
  mutate(pred = 'mpa')
fh_mod.coef.df <- rbind(fh_mod.coef.df1, fh_mod.coef.df2)

temp_mod.coef.df1 <- tidy(lower_temp_max_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Max Temp') %>% 
  mutate(pred = 'lfm')
temp_mod.coef.df2 <- tidy(lower_temp_max_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Max Temp') %>% 
  mutate(pred = 'mpa')
temp_mod.coef.df <- rbind(temp_mod.coef.df1, temp_mod.coef.df2)

fd_mod.coef.df1 <- tidy(fd_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FD') %>% 
  mutate(pred = 'lfm')
fd_mod.coef.df2 <- tidy(fd_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FD') %>% 
  mutate(pred = 'mpa')
fd_mod.coef.df <- rbind(fd_mod.coef.df1, fd_mod.coef.df2)

temp_change_mod.coef.df1 <- tidy(temp_change_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Temp Change') %>% 
  mutate(pred = 'lfm')
temp_change_mod.coef.df2 <- tidy(temp_change_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Temp Change') %>% 
  mutate(pred = 'mpa')
temp_change_mod.coef.df <- rbind(temp_change_mod.coef.df1, temp_change_mod.coef.df2)

coef.df <- rbind(tti_mod.coef.df, fh_mod.coef.df, temp_mod.coef.df, gd_mod.coef.df, fd_mod.coef.df)
```

Quick visualizations of models:
```{r}
tti_spp <- lmer(tti ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(tti_mod)

fh_spp <- lmer(fh ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(fh_spp)

temp_spp <- lmer(temp_change ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(temp_spp)
```

## Sig. function

```{r}
significance <- function(p.value.df, sig.vector) {
  
  sig.vector <- c(rep("NA", 5))
  
for(i in 1:5){
  
  if(p.value.df[i] < 0.05){
  sig.vector[i] <- 'Yes'
  }
  
  else {
  sig.vector[i] <- 'No'
  }
}
  return(sig.vector)
}
```


## Visualizations
### Function
```{r}
ES.plot <- function(df, y.var, sig, std.error, mpa = 'no', margins.vector = c(0.1, 0.1, 0.1, 0.1), limits.vector, breaks.vector, axis.title = ' ') 
  { if(mpa == 'no'){
  ggplot(data = df, aes(x = species, y = y.var,
                       color = species, shape = sig)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  theme_bw() +
  scale_y_continuous(limits = limits.vector, breaks = breaks.vector) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(10, 16)) +
 # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
 # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
 # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(margins.vector, 'cm'),
        legend.position = 'none')
  }
 else{
   ggplot(data = df, aes(x = species, y = y.var,
                       color = species, shape = sig)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  theme_bw() +
  scale_y_continuous(limits = limits.vector, breaks = breaks.vector,
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = axis.title,
                     breaks = breaks.vector,
                     labels = breaks.vector)) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(10, 16)) +
 # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
 # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
 # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.title.y.left = element_blank(),
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(margins.vector, 'cm'),
        legend.position = 'none')
 }
}
```

### TTI
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df$estimate[6]
tti.ES.lfm <- c(ref, ref + tti_mod.coef.df$estimate[12],
                ref + tti_mod.coef.df$estimate[11],
                ref + tti_mod.coef.df$estimate[10],
                ref + tti_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
tti.SE.lfm <- c(tti_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- tti_mod.coef.df$estimate[21]
tti.ES.mpa <- c(ref2, ref2 + tti_mod.coef.df$estimate[27],
                ref2 + tti_mod.coef.df$estimate[26], 
                ref2 + tti_mod.coef.df$estimate[25], 
                ref2 + tti_mod.coef.df$estimate[28]) 
tti.SE.mpa <- c(tti_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)
tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
tti.ES.lfm.plot <- ES.plot(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           margins.vector = c(0.2, 0.05, 0.1, 0.1),
                           limits.vector = c(-6, 19),
                           breaks.vector = c(-5, 0, 5, 10, 15)) +
  annotate(geom = "text", x = 0.85, y = 17.2, label = 'e',
           fontface = 'bold', size = 10) +
  labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.2, 0.3, 0.1, 0),
                           limits.vector = c(-6, 19),
                           breaks.vector = c(-5, 0, 5, 10, 15)) +
  annotate(geom = "text", x = 0.85, y = 17.2, label = 'h',
           fontface = 'bold', size = 10) +
  labs(title = 'Water Potential')
tti.ES.mpa.plot
```

### FH
Setup:
```{r}
ref <- fh_mod.coef.df$estimate[6]
fh.ES.lfm <- c(ref, ref + fh_mod.coef.df$estimate[12],
                ref + fh_mod.coef.df$estimate[11],
                ref + fh_mod.coef.df$estimate[10],
                ref + fh_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
fh.SE.lfm <- c(fh_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
fh.sig.lfm <- significance(fh.p.value.lfm, fh.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- fh_mod.coef.df$estimate[21]
fh.ES.mpa <- c(ref2, ref2 + fh_mod.coef.df$estimate[27],
                ref2 + fh_mod.coef.df$estimate[26], 
                ref2 + fh_mod.coef.df$estimate[25], 
                ref2 + fh_mod.coef.df$estimate[28]) 
fh.SE.mpa <- c(fh_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
fh.sig.mpa <- significance(fh.p.value.mpa, fh.sig.mpa)
fh.ES.df <- data.frame(species, fh.ES.lfm, fh.SE.lfm, fh.p.value.lfm, fh.sig.lfm, fh.ES.mpa, fh.SE.mpa, fh.p.value.mpa, fh.sig.mpa)

fh.ES.df$species <- factor(fh.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
fh.ES.lfm.plot <- ES.plot(fh.ES.df, fh.ES.lfm, fh.sig.lfm, fh.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-5.5, 5),
                           breaks.vector = c(-4, -2, 0, 2, 4)) +
  annotate(geom = "text", x = 0.85, y = 4.2, label = 'f',
           fontface = 'bold', size = 10)
fh.ES.lfm.plot

fh.ES.mpa.plot <- ES.plot(fh.ES.df, fh.ES.mpa, fh.sig.mpa, fh.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.4, 0.1, 0),
                           limits.vector = c(-5.5, 5),
                           breaks.vector = c(-4, -2, 0, 2, 4),
                          axis.title = 'Hydration x Species Estimate') +
  annotate(geom = "text", x = 0.85, y = 4.2, label = 'i',
           fontface = 'bold', size = 10) 
fh.ES.mpa.plot
```

### Max. Temp.
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- temp_mod.coef.df$estimate[6]
temp_max.ES.lfm <- c(ref, ref + temp_mod.coef.df$estimate[12],
                ref + temp_mod.coef.df$estimate[11],
                ref + temp_mod.coef.df$estimate[10],
                ref + temp_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
temp_max.SE.lfm <- c(temp_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
temp_max.sig.lfm <- significance(temp_max.p.value.lfm, temp_max.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- temp_mod.coef.df$estimate[21]
temp_max.ES.mpa <- c(ref2, ref2 + temp_mod.coef.df$estimate[27],
                ref2 + temp_mod.coef.df$estimate[26], 
                ref2 + temp_mod.coef.df$estimate[25], 
                ref2 + temp_mod.coef.df$estimate[28]) 
temp_max.SE.mpa <- c(temp_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
temp_max.sig.mpa <- significance(temp_max.p.value.mpa, temp_max.sig.mpa)
temp_max.ES.df <- data.frame(species, temp_max.ES.lfm, temp_max.SE.lfm, temp_max.p.value.lfm, temp_max.sig.lfm, temp_max.ES.mpa, temp_max.SE.mpa, temp_max.p.value.mpa, temp_max.sig.mpa)

temp_max.ES.df$species <- factor(temp_max.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
temp_max.ES.lfm.plot <- ES.plot(temp_max.ES.df, temp_max.ES.lfm, temp_max.sig.lfm, temp_max.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-27, 27),
                           breaks.vector = c(-25, -12, 0, 12, 25)) +
  annotate(geom = "text", x = 0.85, y = 23.1, label = 'g',
           fontface = 'bold', size = 10)
temp_max.ES.lfm.plot

temp_max.ES.mpa.plot <- ES.plot(temp_max.ES.df, temp_max.ES.mpa, temp_max.sig.mpa, temp_max.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                          limits.vector = c(-27, 27),
                          breaks.vector = c(-25, -12, 0, 12, 25)) +
  annotate(geom = "text", x = 0.85, y = 23.1, label = 'j',
           fontface = 'bold', size = 10)
temp_max.ES.mpa.plot
```



### Temp. Change
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- temp_change_mod.coef.df$estimate[6]
temp_change.ES.lfm <- c(ref, ref + temp_change_mod.coef.df$estimate[12],
                ref + temp_change_mod.coef.df$estimate[11],
                ref + temp_change_mod.coef.df$estimate[10],
                ref + temp_change_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
temp_change.SE.lfm <- c(temp_change_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
temp_change.sig.lfm <- significance(temp_change.p.value.lfm, temp_change.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- temp_change_mod.coef.df$estimate[21]
temp_change.ES.mpa <- c(ref2, ref2 + temp_change_mod.coef.df$estimate[27],
                ref2 + temp_change_mod.coef.df$estimate[26], 
                ref2 + temp_change_mod.coef.df$estimate[25], 
                ref2 + temp_change_mod.coef.df$estimate[28]) 
temp_change.SE.mpa <- c(temp_change_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
temp_change.sig.mpa <- significance(temp_change.p.value.mpa, temp_change.sig.mpa)
temp_change.ES.df <- data.frame(species, temp_change.ES.lfm, temp_change.SE.lfm, temp_change.p.value.lfm, temp_change.sig.lfm, temp_change.ES.mpa, temp_change.SE.mpa, temp_change.p.value.mpa, temp_change.sig.mpa)

temp_change.ES.df$species <- factor(temp_change.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
temp_change.ES.lfm.plot <- ES.plot(temp_change.ES.df, temp_change.ES.lfm, temp_change.sig.lfm, temp_change.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-16, 10),
                           breaks.vector = c(-10, -5, 0, 5, 10)) +
  annotate(geom = "text", x = 0.85, y = 8.6, label = 'g',
           fontface = 'bold', size = 10)
temp_change.ES.lfm.plot

temp_change.ES.mpa.plot <- ES.plot(temp_change.ES.df, temp_change.ES.mpa, temp_change.sig.mpa, temp_change.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                          limits.vector = c(-16, 10),
                          breaks.vector = c(-10, -5, 0, 5, 10)) +
  annotate(geom = "text", x = 0.85, y = 8.6, label = 'j',
           fontface = 'bold', size = 10)
temp_change.ES.mpa.plot
```

### GD
Setup:
```{r}
species <- c("Ab. concolor", "Pi. jeffreyi", "Ca. decurrens", "Ar. patula", "Qu. kelloggii")
ref <- gd_mod.coef.df$estimate[6]
gd.ES.lfm <- c(ref, ref + gd_mod.coef.df$estimate[12],
                ref + gd_mod.coef.df$estimate[11],
                ref + gd_mod.coef.df$estimate[10],
                ref + gd_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
gd.SE.lfm <- c(gd_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
gd.sig.lfm <- significance(gd.p.value.lfm, gd.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- gd_mod.coef.df$estimate[21]
gd.ES.mpa <- c(ref2, ref2 + gd_mod.coef.df$estimate[27],
                ref2 + gd_mod.coef.df$estimate[26], 
                ref2 + gd_mod.coef.df$estimate[25], 
                ref2 + gd_mod.coef.df$estimate[28]) 
gd.SE.mpa <- c(gd_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
gd.sig.mpa <- significance(gd.p.value.mpa, gd.sig.mpa)
gd.ES.df <- data.frame(species, gd.ES.lfm, gd.SE.lfm, gd.p.value.lfm, gd.sig.lfm, gd.ES.mpa, gd.SE.mpa, gd.p.value.mpa, gd.sig.mpa)

gd.ES.df$species <- factor(gd.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
gd.ES.lfm.plot <- ES.plot(gd.ES.df, gd.ES.lfm, gd.sig.lfm, gd.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-25, 11),
                           breaks.vector = c(-20, -10, 0, 10)) +
  labs(title = 'LFM')
  #annotate(geom = "text", x = 0.9, y = 9, label = 'e', fontface = 'bold', size = 10)
gd.ES.lfm.plot

gd.ES.mpa.plot <- ES.plot(gd.ES.df, gd.ES.mpa, gd.sig.mpa, gd.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                           limits.vector = c(-25, 11),
                           breaks.vector = c(-20, -10, 0, 10)) +
  labs(title = 'MPa')
  #annotate(geom = "text", x = 0.9, y = 9, label = 'f', fontface = 'bold', size = 10)
gd.ES.mpa.plot

ggarrange(gd_plot_lfm_r, gd.ES.lfm.plot, gd.ES.mpa.plot, nrow = 1)
```

### FD
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- fd_mod.coef.df$estimate[6]
fd.ES.lfm <- c(ref, ref + fd_mod.coef.df$estimate[12],
                ref + fd_mod.coef.df$estimate[11],
                ref + fd_mod.coef.df$estimate[10],
                ref + fd_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
fd.SE.lfm <- c(fd_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
fd.sig.lfm <- significance(fd.p.value.lfm, fd.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- fd_mod.coef.df$estimate[21]
fd.ES.mpa <- c(ref2, ref2 + fd_mod.coef.df$estimate[27],
                ref2 + fd_mod.coef.df$estimate[26], 
                ref2 + fd_mod.coef.df$estimate[25], 
                ref2 + fd_mod.coef.df$estimate[28]) 
fd.SE.mpa <- c(fd_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
fd.sig.mpa <- significance(fd.p.value.mpa, fd.sig.mpa)
fd.ES.df <- data.frame(species, fd.ES.lfm, fd.SE.lfm, fd.p.value.lfm, fd.sig.lfm, fd.ES.mpa, fd.SE.mpa, fd.p.value.mpa, fd.sig.mpa)

fd.ES.df$species <- factor(fd.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
fd.ES.lfm.plot <- ES.plot(fd.ES.df, fd.ES.lfm, fd.sig.lfm, fd.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-5, 3),
                           breaks.vector = c(-4, -2, 0, 2)) +
  labs(title = "LFM")
  #annotate(geom = "text", x = 0.9, y = 9, label = 'e', fontface = 'bold', size = 10)
fd.ES.lfm.plot

fd.ES.mpa.plot <- ES.plot(fd.ES.df, fd.ES.mpa, fd.sig.mpa, fd.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                           limits.vector = c(-5, 3),
                           breaks.vector = c(-4, -2, 0, 2)) +
  labs(title = "MPa")
  #annotate(geom = "text", x = 0.9, y = 9, label = 'f', fontface = 'bold', size = 10)
fd.ES.mpa.plot

ggarrange(fd_plot_lfm_r, fd.ES.lfm.plot, fd.ES.mpa.plot, nrow = 1)
```

# 5. Main Figure
Arranging Estimate plots and scatterplots into one figure

Focusing on TTI, FH, and Max Temp.

Set up:
```{r}
blank_plot <- ggplot(data = gd.ES.df, aes(x = species, y = gd.ES.mpa)) +
  geom_point(color = 'white') +
  theme_void()

df.dotplot.prop.ig <- df.dotplot.prop.ig %>% # Making totally arbitrary column to make legend
  mutate(holder.sig = case_when(
    tti > 250 ~ "Yes",
    tti < 250 ~ "No"
  )) %>% 
  drop_na(holder.sig)
df.dotplot.prop.ig$holder.sig <- factor(df.dotplot.prop.ig$holder.sig, levels = c("Yes", "No"))

plot_legend.ES <- ggplot(data = df.dotplot.prop.ig, aes(x = Species, y = med_prop_ignite,
                                                color = Species, shape = holder.sig)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  geom_point(size = 4, cex = 6, alpha = 0.9) +
  geom_linerange(aes(ymin = med_prop_ignite - 2*stdev_prop_ignite, ymax = med_prop_ignite + 2*stdev_prop_ignite)) +
  theme_bw() +
  color_many2 +
  scale_shape_manual(values = c(16, 10)) +
  theme(legend.title = element_text(face = 'bold', size = 20),
        legend.text = element_text(face = 'italic', size = 17))
plot_legend.ES

plot_legend.scatterplot <- mem_data_all_r %>% 
  ggplot(aes(x = fh, y = mpa, group = F.Group)) +
  geom_point(aes(color = F.Group), size = 2.2) +
  geom_smooth(se = F, method = 'lm', aes(color = F.Group, lty = F.fh.sig.mpa)) +
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno
  scale_linetype_manual(values = c(3, 1)) +
  labs(color = "Functional Group", lty = "Significant?") +
  theme(legend.text = element_text(size = 17),  # , face = 'italic'
        legend.title = element_text(size = 20, face = 'bold'),
        legend.key = element_rect(fill = 'white')) +
  guides(lty = guide_legend(override.aes = list(color = 'black')))

ES_legend <- cowplot::get_legend(plot_legend.ES)
SP_legend <- cowplot::get_legend(plot_legend.scatterplot)
```

Arranging:
Note: I had to do some wacky things with blank plots to get the final product to look okay.
```{r}
scatterplots <- cowplot::plot_grid(blank_plot, tti_plot_lfm_r, fh_plot_lfm_r,
                                  # lower_temp_max_plot_lfm_r,
                                   temp_change_plot_lfm_r,
                                   ncol = 1, rel_heights = c(0.78, 10, 9.95, 10))

ES.plots <- cowplot::plot_grid(tti.ES.lfm.plot, tti.ES.mpa.plot,
                              blank_plot, blank_plot,
                              fh.ES.lfm.plot, fh.ES.mpa.plot,
                              blank_plot, blank_plot,
                             # temp_max.ES.lfm.plot, temp_max.ES.mpa.plot,
                              temp_change.ES.lfm.plot, temp_change.ES.mpa.plot,
                              blank_plot, blank_plot,
                              ncol = 2, nrow = 6,
                              rel_widths = c(6,7.5),
                              rel_heights = c(11.3, 1.25, 10.5, 0.93, 9.6, 1.78))

main_figure_no_legend <- cowplot::plot_grid(scatterplots, ES.plots, ncol = 2, rel_widths = c(10,9))
main_figure_no_legend

legend <- cowplot::plot_grid(ES_legend, SP_legend, ncol = 1)

legend_and_dotplot <- cowplot::plot_grid(blank_plot, dotplot.prop.ig, blank_plot, legend, ncol = 1, rel_heights = c(0.29,3.1,0.98,6))

main_figure <- cowplot::plot_grid(legend_and_dotplot, main_figure_no_legend, ncol = 2, rel_widths = c(1.5,5))
main_figure

ggsave(plot = main_figure, bg = 'white', 
       here("figures", "main-figures", "Fig2.Flam.vs.Hydration.jpg"),
       width = 16, height = 10)
```



