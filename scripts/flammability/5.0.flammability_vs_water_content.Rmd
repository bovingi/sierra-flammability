---
title: "5.0.flammability_vs_water_content"
author: "Indra Boving and Joe Celebrezze"
date: "2022-12-27"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(ggpubr)
library(cowplot)
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
#library(strengejacke)
library(sjPlot) # table functions
library(here)
library(effects) #for plofhng model effects
library(sjstats) #use for r2 functions
library("broom.mixed")
library(MuMIn)
library(modelsummary)
library(nlme)
library(lme4)
library(MetBrewer)
library(car)
library(kableExtra)
library(multcomp) # For post-hoc pairwise comparison tests
#devtools::install_github("an-bui/calecopal")
#library(calecopal)
#devtools::install_github("hohenstein/remef")
library(remef)
library(lmerTest)
library(kableExtra)
library(broom)
library(emmeans) #for signifance of interaction terms

tidy = broom::tidy
filter = dplyr::filter
mutate = dplyr::mutate
select = dplyr::select
here = here::here
group_by = dplyr::group_by

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```

#------------------------------------
# 1. Data Wrangling

- For the Sierra analysis, this is combining all species and dropping the august sampling data (not enough samples and it was measured a lil differently). 

```{r}
mem_data_all_raw <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv"), show_col_types = F) 

mem_data_all_clean <- mem_data_all_raw %>% 
  select(lfm, mpa, fh, fh, fd, gd,tti, prop_ignite, temp_change, lower_temp_max, ignition, sample_wt, dry_wt, fresh_wt, water_wt, location, site, year_month, spp, individual, bins10lfm, bins5lfm, bins20lfm, notes_flam) %>% 
  mutate(mpa = -1*mpa) %>% 
  mutate(dw_flam_sample = sample_wt * (dry_wt/fresh_wt),
         ww_flam_sample = sample_wt * (water_wt/fresh_wt)) %>% 
  mutate(excess_water = (ww_flam_sample - dw_flam_sample)) %>% 
  #dplyr::group_by(spp) %>% 
  mutate(mpa_scaled = scale(mpa),
         dw_flam_sample_scaled = scale(dw_flam_sample), 
         sample_wt_scaled = scale(sample_wt), 
         ww_flam_sample_scaled = scale(ww_flam_sample),
         lfm_scaled = scale(lfm), 
         excess_water_scaled = scale(excess_water)) %>% 
  mutate(Species = case_when(
    spp == "arpa" ~ "Ar. patula", 
    spp == "abco" ~ "Ab. concolor",
    spp == "cade" ~ "Ca. decurrens",
    spp == "ceco" ~ "Ce. cordulatus",
    spp == "pije" ~ "Pi. jeffreyi",
    spp == "quke" ~ "Qu. kelloggii"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "arpa" ~ "Angiosperm", 
    spp == "abco" ~ "Gymnosperm",
    spp == "cade" ~ "Gymnosperm",
    spp == "ceco" ~ "Angiosperm",
    spp == "pije" ~ "Gymnosperm",
    spp == "quke" ~ "Angiosperm"
  )) %>% 
  filter(!year_month %in% c("2021_august")) %>% 
  filter(ignition != 2) %>% # Removing manual ignitions
  drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled) 

mem_data_all <- mem_data_all_clean %>% 
  filter(spp != "ceco")

write.csv(mem_data_all, here("processed-data", "analysis 2.0","mem_final_from5.05.csv"))

field_data_all <- read_csv(here("processed-data", "analysis 2.0","field_data_2020_2021.csv"), show_col_types = F)
```

## Specifying significance
The below is based on the mixed effects models used for each flam metric. The tti.sig, fd.sig, etc. are regarding to species significance, while the F.tti.sig are regarding to angio vs gymno functional group significance
```{r}
# Significance by species
mem_data_all <- mem_data_all %>% 
  mutate(tti.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(fh.mpa.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "Yes", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(fh.lfm.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "Yes", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(fd.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(gd.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "Yes", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(prop.ig.mpa.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(prop.ig.lfm.sig = case_when(
    spp == "arpa" ~ "Yes", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "Yes")) %>% 
  mutate(temp.change.sig = case_when(
    spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No", spp == "ceco" ~ "No", 
    spp == "pije" ~ "No", spp == "quke" ~ "No")) %>% 
  mutate(temp.max.sig = case_when(
      spp == "arpa" ~ "No", spp == "abco" ~ "No", spp == "cade" ~ "No",
      spp == "ceco" ~ "No", spp == "pije" ~ "No", spp == "quke" ~ "No"
    ))

# Significance by functional group
mem_data_all <- mem_data_all %>% 
  mutate(F.tti.sig = case_when(
    F.Group == "Angiosperm" ~ "Yes", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.fh.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "Yes")) %>% 
  mutate(F.gd.lfm.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.gd.mpa.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.temp.max.lfm.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.temp.max.mpa.sig = case_when(
    F.Group == "Angiosperm" ~ "No", F.Group == "Gymnosperm" ~ "No")) %>% 
  mutate(F.fd.sig = case_when(
    F.Group == "Angiosperm" ~ "Yes", F.Group == "Gymnosperm" ~ "No"))
```

# -----------------------------
# 2. Scatterplots & Models
Using remef for all scatterplots

## Functional Groups
### TTI
Models:
```{r}
mem_data_all_r <- mem_data_all%>% drop_na(mpa_scaled, lfm_scaled, sample_wt_scaled, fh, gd)
mem_data_all_r$Species <- factor(mem_data_all_r$Species, levels = c('Ab. concolor', 'Pi. jeffreyi', 'Ca. decurrens', 'Ar. patula', 'Qu. kelloggii'))

tti_mod <- lmer(tti ~ spp*mpa_scaled + spp*lfm_scaled + site 
                + year_month 
                + sample_wt_scaled 
                + (1 | individual), data = mem_data_all_r)
```

```{r}
tti_mod.lfm <- lmer(tti ~ spp*lfm_scaled + site + year_month 
                    + sample_wt_scaled 
                    + (1 | individual), data = mem_data_all_r)

tti_mod.mpa <- lmer(tti ~ spp*mpa_scaled + site + year_month 
                    + sample_wt_scaled 
                    + (1 | individual), data = mem_data_all_r)

tti_mod_fgroup <- lmer(tti ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_tti_mpa <- remef(tti_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_tti_lfm <- remef(tti_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_tti_mpa <- r_tti_mpa
mem_data_all_r$r_tti_lfm <- r_tti_lfm
```

Visualizations:
```{r}
tti_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_tti_mpa, 
             x = mpa_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = tti.sig), alpha = .75) + 
  scale_color_manual(values = c('steelblue3', 'darkgreen'))+
  theme(legend.position = "none",                                   
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition") +
  annotate(geom = "text", x = -1.8, y = 235, label = 'a', fontface = 'bold', size = 10)
tti_plot_r

# For MAIN figure:
tti_plot_lfm_r <- mem_data_all_r %>%
  ggplot(aes(y = r_tti_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.tti.sig), alpha = .75, lty = 1) + 
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + 
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Time to Ignition (s)") +
  annotate(geom = "text", x = -2.6, y = 192.5, label = 'b', fontface = 'bold', size = 10)
tti_plot_lfm_r
```

### FH
Models:
```{r}
fh_mod <- lmer(fh ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fh_mod.lfm <- lmer(fh ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
fh_mod.mpa <- lmer(fh ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fh_mod_fgroup <- lmer(fh ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_fh_mpa <- remef(fh_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fh_lfm <- remef(fh_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fh_mpa <- r_fh_mpa
mem_data_all_r$r_fh_lfm <- r_fh_lfm
```

Visualizations:
```{r}
fh_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_mpa, 
             x = mpa_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = fh.mpa.sig), alpha = .75) +
  scale_color_manual(values = c('steelblue3', 'darkgreen'))+
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height") +
  annotate(geom = "text", x = -1.8, y = 53, label = 'b', fontface = 'bold', size = 10)
fh_plot_r

# for MAIN figure
fh_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.fh.sig), alpha = .75) +
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + 
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title.y = element_text(size = 16, face = 'bold', 
                                                   margin = margin(r = 10)),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank())+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -2.6, y = 54, label = 'c', fontface = 'bold', size = 10)
fh_plot_lfm_r
```

### Max. Temp.
Models:
```{r}
lower_temp_max_mod <- lmer(lower_temp_max ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

lower_temp_max_mod.lfm <- lmer(lower_temp_max ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
lower_temp_max_mod.mpa <- lmer(lower_temp_max ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

lower_temp_max_mod_fgroup <- lmer(lower_temp_max ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_lower_temp_max_mpa <- remef(lower_temp_max_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_lower_temp_max_lfm <- remef(lower_temp_max_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_lower_temp_max_mpa <- r_lower_temp_max_mpa
mem_data_all_r$r_lower_temp_max_lfm <- r_lower_temp_max_lfm
```

Visualizations:
```{r}
lower_temp_max_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_lower_temp_max_mpa, 
             x = mpa_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = temp.max.sig), alpha = .75) +
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + 
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold')) +
  labs(x = "", 
       y = "Maximum Temperature") +
  annotate(geom = "text", x = -1.8, y = 500, label = 'c', fontface = 'bold', size = 10)
lower_temp_max_plot_r

# for *MAIN* figure:
lower_temp_max_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_lower_temp_max_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group,
                   lty = F.temp.max.lfm.sig), alpha = .75, lty = 3) +
  scale_y_continuous(limits = c(150,550), breaks = c(200, 300, 400, 500)) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'))+
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + 
  labs(x = "LFM (scaled, centered)", 
       y = "Maximum Temperature (C)") +
  annotate(geom = "text", x = -2.6, y = 515, label = 'd', fontface = 'bold', size = 10) +
  annotate(geom = 'text', x = -2.3, y = 170, label = 'dry', size = 5) +
  annotate(geom = 'text', x = 3.05, y = 170, label = 'wet', size = 5) +
  geom_segment(aes(x = -2, y = 170, xend = 2.75, yend = 170),
     arrow = arrow(ends = 'both', length = unit(1/2, "picas")), 
      size = .5, alpha = 0.8)
lower_temp_max_plot_lfm_r
```

### GD
Models:
```{r}
gd_mod <- lmer(gd ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

gd_mod.lfm <- lmer(gd ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
gd_mod.mpa <- lmer(gd ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

gd_mod_fgroup <- lmer(gd ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_gd_mpa <- remef(gd_mod_fgroup, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_gd_lfm <- remef(gd_mod_fgroup, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_gd_mpa <- r_gd_mpa
mem_data_all_r$r_gd_lfm <- r_gd_lfm
```

Visualizations:
```{r}
#REMEF
gd_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_mpa, 
             x = mpa_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = gd.sig), alpha = .75) +
  scale_color_manual(values = c('steelblue3', 'darkgreen'))+
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Glow Duration") +
  annotate(geom = "text", x = -1.8, y = 430, label = 'c', fontface = 'bold', size = 10)
gd_plot_r

# for *MAIN* figure:
gd_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.gd.lfm.sig),
              alpha = .75, lty = 3) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'))+
  scale_color_manual(values = c('steelblue3', 'darkgreen')) +
  labs(x = "LFM", 
       y = "Glow Duration (s)")
  annotate(geom = "text", x = -2.6, y = 400, label = 'g', fontface = 'bold', size = 10)
gd_plot_lfm_r
```

### FD
Models:
```{r}
fd_mod <- lmer(fd ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fd_mod.lfm <- lmer(fd ~ spp*lfm_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)
fd_mod.mpa <- lmer(fd ~ spp*mpa_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

fd_mod_fgroup <- lmer(fd ~ F.Group*mpa_scaled + F.Group*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_fd_mpa <- remef(fd_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fd_lfm <- remef(fd_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fd_mpa <- r_fd_mpa
mem_data_all_r$r_fd_lfm <- r_fd_lfm
```

Visualizations:
```{r}
fd_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fd_mpa, 
             x = mpa_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = fd.sig), alpha = .75) + 
  scale_color_manual(values = c('steelblue3', 'darkgreen'))+
  theme(#legend.position = "none",
                       axis.text = element_text(size = 14),
                       axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration") +
  annotate(geom = "text", x = -1.8, y = 87, label = 'd', fontface = 'bold', size = 10)
fd_plot_r

# for MAIN figure:
fd_plot_lfm_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_fd_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = F.fd.sig), alpha = .75) + 
  scale_color_manual(values = c('steelblue3', 'darkgreen')) +
  scale_linetype_manual(values = c(3, 1)) + # For significance
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 22, face = 'bold'))+
  labs(x = "", 
       y = "Flame Duration")
  annotate(geom = "text", x = -2.6, y = 88, label = 'd', fontface = 'bold', size = 10)
fd_plot_lfm_r
```

### Temp Change
Models:
```{r}
temp_change_mod <- lmer(temp_change ~ spp*mpa_scaled + spp*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r) 

temp_change_mod.fgroup <- lmer(temp_change ~ F.Group*mpa_scaled + F.Group*lfm_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all_r)

temp_change_mod.lfm <- lmer(temp_change ~ spp*lfm_scaled + site + year_month 
                    + sample_wt_scaled 
                    + (1 | individual), data = mem_data_all_r)

temp_change_mod.mpa <- lmer(temp_change ~ spp*mpa_scaled + site + year_month 
                    + sample_wt_scaled 
                    + (1 | individual), data = mem_data_all_r)

```

Remef:
```{r}
r_temp_change_mpa <- remef(temp_change_mod, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_temp_change_lfm <- remef(temp_change_mod, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_temp_change_mpa <- r_temp_change_mpa
mem_data_all_r$r_temp_change_lfm <- r_temp_change_lfm
```

Visualizations:
```{r}
temp_change_plot_r <- mem_data_all_r %>% 
  ggplot(aes(y = r_temp_change_mpa, 
             x = mpa_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group, lty = temp.change.sig), alpha = .75) + 
  scale_color_manual(values = c('steelblue3', 'darkgreen'))+ # For color by F.Group w/o CECO
  theme(legend.position = "none",
        axis.text = element_text(size = 14),
        axis.title.x = element_text(size = 18, face = 'bold'),
        axis.title.y = element_text(size = 22, face = 'bold')) +
  labs(x = "Water Potential (Scaled)", 
       y = "Temp. Change") +
  annotate(geom = "text", x = -1.8, y = 255, label = 'e', fontface = 'bold', size = 10)
temp_change_plot_r

# For MAIN figure:
temp_change_plot_lfm_r<- mem_data_all_r %>% 
  filter(r_temp_change_lfm > 0) %>% 
  ggplot(aes(y = r_temp_change_lfm, 
             x = lfm_scaled, 
             group = F.Group)) +
  geom_point(alpha= .4, aes(color = F.Group))+
  geom_smooth(method = "lm", se = F, aes(color = F.Group,
                   lty = F.temp.max.lfm.sig), alpha = .75, lty = 3) +
  scale_y_continuous(limits = c(-20, 250), breaks = c(0, 50, 100, 150, 200, 250)) +
  theme(legend.position = "none",
                       axis.text = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'))+
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + 
  labs(x = "LFM (scaled, centered)", 
       y = "Temp. Change (C)") +
  annotate(geom = "text", x = -2.75, y = 230, label = 'd', fontface = 'bold', size = 10) +
  annotate(geom = 'text', x = -2.3, y = -13, label = 'dry', size = 5) +
  annotate(geom = 'text', x = 3.05, y = -13, label = 'wet', size = 5) +
  geom_segment(aes(x = -2, y = -13, xend = 2.75, yend = -13),
     arrow = arrow(ends = 'both', length = unit(1/2, "picas")), 
      size = .5, alpha = 0.8)
temp_change_plot_lfm_r
```

## Species
### TTI
Model:
```{r}
tti_mod_spp <- lmer(tti ~ spp*mpa_scaled + spp*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_tti_mpa_spp <- remef(tti_mod_spp, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_tti_lfm_spp <- remef(tti_mod_spp, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_tti_mpa_spp <- r_tti_mpa_spp
mem_data_all_r$r_tti_lfm_spp <- r_tti_lfm_spp
```

Visualizations:
```{r}
tti_plot_r_spp <- mem_data_all_r %>% 
  ggplot(aes(y = r_tti_mpa_spp, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  color_noceco+ # For color by species w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none", 
        axis.text = element_text(size = 13),
        axis.title = element_text(size = 16, face = 'bold'))+
  labs(x = "", 
       y = "Time to Ignition") +
  annotate(geom = "text", x = -2.9, y = 225, label = 'a', fontface = 'bold', size = 10)
tti_plot_r_spp

# For MAIN figure:
tti_plot_lfm_r_spp <- mem_data_all_r %>%
  ggplot(aes(y = r_tti_lfm_spp, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = tti.sig), alpha = .75) + 
  color_noceco + # For color by spp w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Time to Ignition (s)") +
  annotate(geom = "text", x = -2.4, y = 230, label = 'a', fontface = 'bold', size = 10)
tti_plot_lfm_r_spp
```

### FH
Model:
```{r}
fh_mod_spp <- lmer(fh ~ spp*mpa_scaled + spp*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_fh_mpa_spp <- remef(fh_mod_spp, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_fh_lfm_spp <- remef(fh_mod_spp, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_fh_mpa_spp <- r_fh_mpa_spp
mem_data_all_r$r_fh_lfm_spp <- r_fh_lfm_spp
```

Visualizations:
```{r}
fh_plot_r_spp <- mem_data_all_r %>% 
  ggplot(aes(y = r_fh_mpa_spp, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.mpa.sig), alpha = .75) + 
  color_noceco+ # For color by species w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
        axis.text = element_text(size = 13),
        axis.title = element_text(size = 16, face = 'bold'))+
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -2.8, y = 55, label = 'b', fontface = 'bold', size = 10)
fh_plot_r_spp

# For MAIN figure:
fh_plot_lfm_r_spp <- mem_data_all_r %>%
  ggplot(aes(y = r_fh_lfm_spp, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = fh.lfm.sig), alpha = .75) + 
  color_noceco + # For color by spp w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Flame Height (cm)") +
  annotate(geom = "text", x = -2.3, y = 60, label = 'b', fontface = 'bold', size = 10)
fh_plot_lfm_r_spp
```

### Max. Temp.
Model:
```{r}
lower_temp_max_mod_spp <- lmer(lower_temp_max ~ spp*mpa_scaled + spp*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_lower_temp_max_mpa_spp <- remef(lower_temp_max_mod_spp, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_lower_temp_max_lfm_spp <- remef(lower_temp_max_mod_spp, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_lower_temp_max_mpa_spp <- r_lower_temp_max_mpa_spp
mem_data_all_r$r_lower_temp_max_lfm_spp <- r_lower_temp_max_lfm_spp
```

Visualizations:
```{r}
lower_temp_max_plot_r_spp <- mem_data_all_r %>% 
  ggplot(aes(y = r_lower_temp_max_mpa_spp, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.max.sig), alpha = .75) + 
  color_noceco+ # For color by species w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",                                   
        axis.text = element_text(size = 13),
        axis.title = element_text(size = 16, face = 'bold'))+
  labs(x = "", 
       y = "Maximum Temperature") +
  annotate(geom = "text", x = -2.9, y = 480, label = 'd', fontface = 'bold', size = 10)
lower_temp_max_plot_r_spp

# For MAIN figure:
lower_temp_max_plot_lfm_r_spp <- mem_data_all_r %>%
  ggplot(aes(y = r_lower_temp_max_lfm_spp, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.max.sig), alpha = .75) +
  color_noceco + # For color by spp w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Maximum Temperature") +
  annotate(geom = "text", x = -2.4, y = 480, label = 'd', fontface = 'bold', size = 10)
lower_temp_max_plot_lfm_r_spp
```

### GD
Model:
```{r}
gd_mod_spp <- lmer(gd ~ spp*mpa_scaled + spp*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_gd_mpa_spp <- remef(gd_mod_spp, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_gd_lfm_spp <- remef(gd_mod_spp, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_gd_mpa_spp <- r_gd_mpa_spp
mem_data_all_r$r_gd_lfm_spp <- r_gd_lfm_spp
```

Visualizations:
```{r}
gd_plot_r_spp <- mem_data_all_r %>% 
  ggplot(aes(y = r_gd_mpa_spp, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) + 
  color_noceco+ # For color by species w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",                                   
        axis.text = element_text(size = 13), 
        axis.title = element_text(size = 16, face = 'bold'))+
  labs(x = "Water Potential (scaled)", 
       y = "Glow Duration (s)") +
  annotate(geom = "text", x = -2.9, y = 400, label = 'e', fontface = 'bold', size = 10)
gd_plot_r_spp

gd_plot_lfm_r_spp <- mem_data_all_r %>%
  ggplot(aes(y = r_gd_lfm_spp, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) + 
  color_noceco + # For color by spp w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold')) +
  labs(x = "Live Fuel Moisture (scaled)", 
       y = "Glow Duration (s)") +
  annotate(geom = "text", x = -2.4, y = 400, label = 'e', fontface = 'bold', size = 10)
gd_plot_lfm_r_spp
```

### Temp. Change
Model:
```{r}
temp_change_mod_spp <- lmer(temp_change ~ spp*mpa_scaled + spp*lfm_scaled + site + year_month + sample_wt_scaled + (1|individual), data = mem_data_all_r)
```

Remef:
```{r}
r_temp_change_mpa_spp <- remef(temp_change_mod_spp, fix = c("sample_wt_scaled", "lfm_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with MPa
r_temp_change_lfm_spp <- remef(temp_change_mod_spp, fix = c("mpa_scaled", "sample_wt_scaled", "site"), ran = list(individual = c("(Intercept)"))) # Using Remef for plots with LFM

mem_data_all_r$r_temp_change_mpa_spp <- r_temp_change_mpa_spp
mem_data_all_r$r_temp_change_lfm_spp <- r_temp_change_lfm_spp
```

Visualizations:
```{r}
temp_change_plot_r_spp <- mem_data_all_r %>% 
  ggplot(aes(y = r_temp_change_mpa_spp, 
             x = mpa_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  color_noceco+ # For color by species w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",                                   
        axis.text = element_text(size = 13),
        axis.title = element_text(size = 16, face = 'bold'))+
  labs(x = "", 
       y = "Temperature Change (C)") +
  annotate(geom = "text", x = -2.9, y = 220, label = 'c', fontface = 'bold', size = 10)
temp_change_plot_r_spp

# For MAIN figure:
temp_change_plot_lfm_r_spp <- mem_data_all_r %>%
  ggplot(aes(y = r_temp_change_lfm_spp, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .4, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = temp.change.sig), alpha = .75) + 
  color_noceco + # For color by spp w/o CECO
  scale_linetype_manual(values = c(3, 1)) +
  theme(legend.position = "none",
                       axis.text.y = element_text(size = 13),
                       axis.title = element_text(size = 16, face = 'bold'),
                       axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  labs(x = "", 
       y = "Temperature Change (C)") +
  annotate(geom = "text", x = -2.4, y = 220, label = 'c', fontface = 'bold', size = 10)
temp_change_plot_lfm_r_spp
```

### Arranging
Legend:
```{r}
mem_data_all_r$gd.sig <- factor(mem_data_all_r$gd.sig, levels = c("Yes", "No"))

spp_legend_plot <- mem_data_all_r %>%
  ggplot(aes(y = r_gd_lfm_spp, 
             x = lfm_scaled, 
             group = spp)) +
  geom_point(alpha= .6, size = 2.5, aes(color = Species))+
  geom_smooth(method = "lm", se = F, aes(color = Species, lty = gd.sig), alpha = .75) + 
  color_noceco +
  scale_linetype_manual(values = c(1, 3)) +
  guides(lty = guide_legend(override.aes = list(color = 'black'))) +
  labs(lty = "Significant?") +
  theme(legend.text = element_text(size = 17, face = 'italic'),
        legend.title = element_text(size = 20, face = 'bold'),
        legend.key = element_rect(fill = 'white'))
spp_legend_plot

spp_legend <- get_legend(spp_legend_plot)
```

#### LFM
```{r}
lfm_spp_plots <- cowplot::plot_grid(tti_plot_lfm_r_spp, fh_plot_lfm_r_spp, temp_change_plot_lfm_r_spp, lower_temp_max_plot_lfm_r_spp, gd_plot_lfm_r_spp, ncol = 1)

lfm_spp_plots_w_legend <- cowplot::plot_grid(lfm_spp_plots, spp_legend, ncol = 2, rel_widths = c(3, 1))

ggsave(here('figures', 'lfm_flam_metrics.jpeg'), plot = lfm_spp_plots_w_legend, height = 15, width = 8)
```

#### MPa
```{r}
mpa_spp_plots <- cowplot::plot_grid(tti_plot_r_spp, fh_plot_r_spp, temp_change_plot_r_spp, lower_temp_max_plot_r_spp, gd_plot_r_spp, ncol = 1)

mpa_spp_plots_w_legend <- cowplot::plot_grid(mpa_spp_plots, spp_legend, ncol = 2, rel_widths = c(3, 1))

ggsave(here('figures', 'mpa_flam_metrics.jpeg'), plot = mpa_spp_plots_w_legend, height = 15, width = 8)
```


# 3. Significance Tests

## TTI
```{r}
tti_mod_lfm <- lmer(tti ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_tti_lfm <- emmeans::emtrends(tti_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
tti_lfm <- summary(em_tti_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_tti_lfm <- tti_lfm$emtrends %>% 
  as.data.frame()
emtrends_tti_lfm$spp <- factor(emtrends_tti_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_lfm <- emtrends_tti_lfm %>% 
  arrange(spp)
  
emtrends_tti_lfm_list <- emtrends_tti_lfm %>% select(p.value) %>% as.vector()
tti.p.value.lfm <- emtrends_tti_lfm_list$p.value
```

```{r}
tti_mod_lfm <- lmer(tti ~ F.Group*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_tti_lfm <- emmeans::emtrends(tti_mod_lfm, pairwise~F.Group, var = c("lfm_scaled"))
summary(em_tti_lfm, infer=c(TRUE,TRUE),null=0)
```

```{r}
tti_mod_mpa <- lmer(tti ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_tti_mpa <- emmeans::emtrends(tti_mod_mpa, pairwise~spp, var = "mpa_scaled")
tti_mpa <- summary(em_tti_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_tti_mpa <- tti_mpa$emtrends %>% 
  as.data.frame()
emtrends_tti_mpa$spp <- factor(emtrends_tti_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_tti_mpa <- emtrends_tti_mpa %>% 
  arrange(spp)
  
emtrends_tti_mpa_list <- emtrends_tti_mpa %>% select(p.value) %>% as.vector()
tti.p.value.mpa <- emtrends_tti_mpa_list$p.value
```

```{r}
tti_mod_mpa <- lmer(tti ~ F.Group*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_tti_mpa <- emmeans::emtrends(tti_mod_mpa, pairwise~F.Group, var = "mpa_scaled")
summary(em_tti_mpa, infer=c(TRUE,TRUE),null=0)
```

## FH
```{r}
fh_mod_lfm <- lmer(fh ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fh_lfm <- emmeans::emtrends(fh_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
fh_lfm <- summary(em_fh_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_fh_lfm <- fh_lfm$emtrends %>% 
  as.data.frame()
emtrends_fh_lfm$spp <- factor(emtrends_fh_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_fh_lfm <- emtrends_fh_lfm %>% 
  arrange(spp)

emtrends_fh_lfm_list <- emtrends_fh_lfm %>% select(p.value) %>% as.vector()
fh.p.value.lfm <- emtrends_fh_lfm_list$p.value
```

```{r}
fh_mod_lfm <- lmer(fh ~ F.Group*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fh_lfm <- emmeans::emtrends(fh_mod_lfm, pairwise~F.Group, var = c("lfm_scaled"))
summary(em_fh_lfm, infer=c(TRUE,TRUE),null=0)
```

```{r}
fh_mod_mpa <- lmer(fh ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fh_mpa <- emmeans::emtrends(fh_mod_mpa, pairwise~spp, var = "mpa_scaled")
fh_mpa <- summary(em_fh_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_fh_mpa <- fh_mpa$emtrends %>% 
  as.data.frame()
emtrends_fh_mpa$spp <- factor(emtrends_fh_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_fh_mpa <- emtrends_fh_mpa %>% 
  arrange(spp)
  
emtrends_fh_mpa_list <- emtrends_fh_mpa %>% select(p.value) %>% as.vector()
fh.p.value.mpa <- emtrends_fh_mpa_list$p.value
```

```{r}
fh_mod_mpa <- lmer(fh ~ F.Group*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fh_mpa <- emmeans::emtrends(fh_mod_mpa, pairwise~F.Group, var = "mpa_scaled")
summary(em_fh_mpa, infer=c(TRUE,TRUE),null=0)
```

## FD
```{r}
fd_mod_lfm <- lmer(fd ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fd_lfm <- emmeans::emtrends(fd_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
fd_lfm <- summary(em_fd_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_fd_lfm <- fd_lfm$emtrends %>% 
  as.data.frame()
emtrends_fd_lfm$spp <- factor(emtrends_fd_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_fd_lfm <- emtrends_fd_lfm %>% 
  arrange(spp)

emtrends_fd_lfm

emtrends_fd_lfm_list <- emtrends_fd_lfm %>% select(p.value) %>% as.vector()
fd.p.value.lfm <- emtrends_fd_lfm_list$p.value
```

```{r}
fd_mod_lfm <- lmer(fd ~ F.Group*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fd_lfm <- emmeans::emtrends(fd_mod_lfm, pairwise~F.Group, var = c("lfm_scaled"))
summary(em_fd_lfm, infer=c(TRUE,TRUE),null=0)
```

```{r}
fd_mod_mpa <- lmer(fd ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fd_mpa <- emmeans::emtrends(fd_mod_mpa, pairwise~spp, var = "mpa_scaled")
fd_mpa <- summary(em_fd_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_fd_mpa <- fd_mpa$emtrends %>% 
  as.data.frame()
emtrends_fd_mpa$spp <- factor(emtrends_fd_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_fd_mpa <- emtrends_fd_mpa %>% 
  arrange(spp)
  
emtrends_fd_mpa_list <- emtrends_fd_mpa %>% select(p.value) %>% as.vector()
fd.p.value.mpa <- emtrends_fd_mpa_list$p.value
```

```{r}
fd_mod_mpa <- lmer(fd ~ F.Group*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fd_mpa <- emmeans::emtrends(fd_mod_mpa, pairwise~F.Group, var = "mpa_scaled")
summary(em_fd_mpa, infer=c(TRUE,TRUE),null=0)
```


## Max. Temp.
```{r}
tmp_mod_lfm <- lmer(lower_temp_max ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_temp_max_lfm <- emmeans::emtrends(tmp_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
temp_max_lfm <- summary(em_temp_max_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_temp_max_lfm <- temp_max_lfm$emtrends %>% 
  as.data.frame()
emtrends_temp_max_lfm$spp <- factor(emtrends_temp_max_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_temp_max_lfm <- emtrends_temp_max_lfm %>% 
  arrange(spp)
  
emtrends_temp_max_lfm_list <- emtrends_temp_max_lfm %>% select(p.value) %>% as.vector()
temp_max.p.value.lfm <- emtrends_temp_max_lfm_list$p.value
```

```{r}
tmp_mod_lfm <- lmer(lower_temp_max ~ F.Group*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_temp_max_lfm <- emmeans::emtrends(tmp_mod_lfm, pairwise~F.Group, var = c("lfm_scaled"))
summary(em_temp_max_lfm, infer=c(TRUE,TRUE),null=0)
```

```{r}
tmp_mod_mpa <- lmer(lower_temp_max ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_temp_max_mpa <- emmeans::emtrends(tmp_mod_mpa, pairwise~spp, var = "mpa_scaled")
temp_max_mpa <- summary(em_temp_max_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_temp_max_mpa <- temp_max_mpa$emtrends %>% 
  as.data.frame()
emtrends_temp_max_mpa$spp <- factor(emtrends_temp_max_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_temp_max_mpa <- emtrends_temp_max_mpa %>% 
  arrange(spp)
  
emtrends_temp_max_mpa_list <- emtrends_temp_max_mpa %>% select(p.value) %>% as.vector()
temp_max.p.value.mpa <- emtrends_temp_max_mpa_list$p.value
```

```{r}
tmp_mod_mpa <- lmer(lower_temp_max ~ F.Group*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_temp_max_mpa <- emmeans::emtrends(tmp_mod_mpa, pairwise~F.Group, var = "mpa_scaled")
summary(em_temp_max_mpa, infer=c(TRUE,TRUE),null=0)
```

## Temp Change
```{r}
temp_change_mod_lfm <- lmer(temp_change ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_temp_change_lfm <- emmeans::emtrends(temp_change_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
temp_change_lfm <- summary(em_temp_change_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_temp_change_lfm <- temp_change_lfm$emtrends %>% 
  as.data.frame()
emtrends_temp_change_lfm$spp <- factor(emtrends_temp_change_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_temp_change_lfm <- emtrends_temp_change_lfm %>% 
  arrange(spp)
  
emtrends_temp_change_lfm_list <- emtrends_temp_change_lfm %>% select(p.value) %>% as.vector()
temp_change.p.value.lfm <- emtrends_temp_change_lfm_list$p.value
```

```{r}
#temp_change_mod_lfm <- lmer(temp_change ~ F.Group*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
#em_temp_change_lfm <- emmeans::emtrends(temp_change_mod_lfm, pairwise~F.Group, var = c("lfm_scaled"))
#summary(em_temp_change_lfm, infer=c(TRUE,TRUE),null=0)
```

```{r}
temp_change_mod_mpa <- lmer(temp_change ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_temp_change_mpa <- emmeans::emtrends(temp_change_mod_mpa, pairwise~spp, var = "mpa_scaled")
temp_change_mpa <- summary(em_temp_change_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_temp_change_mpa <- temp_change_mpa$emtrends %>% 
  as.data.frame()
emtrends_temp_change_mpa$spp <- factor(emtrends_temp_change_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_temp_change_mpa <- emtrends_temp_change_mpa %>% 
  arrange(spp)
  
emtrends_temp_change_mpa_list <- emtrends_temp_change_mpa %>% select(p.value) %>% as.vector()
temp_change.p.value.mpa <- emtrends_temp_change_mpa_list$p.value
```

```{r}
#temp_change_mod_mpa <- lmer(temp_change ~ F.Group*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
#em_temp_change_mpa <- emmeans::emtrends(temp_change_mod_mpa, pairwise~F.Group, var = "mpa_scaled")
#summary(em_temp_change_mpa, infer=c(TRUE,TRUE),null=0)
```

## GD
```{r}
gd_mod_lfm <- lmer(gd ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_gd_lfm <- emmeans::emtrends(gd_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
gd_lfm <- summary(em_gd_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_gd_lfm <- gd_lfm$emtrends %>% 
  as.data.frame()
emtrends_gd_lfm$spp <- factor(emtrends_gd_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_gd_lfm <- emtrends_gd_lfm %>% 
  arrange(spp)
  
emtrends_gd_lfm_list <- emtrends_gd_lfm %>% select(p.value) %>% as.vector()
gd.p.value.lfm <- emtrends_gd_lfm_list$p.value
```

```{r}
gd_mod_mpa <- lmer(gd ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_gd_mpa <- emmeans::emtrends(gd_mod_mpa, pairwise~spp, var = "mpa_scaled")
gd_mpa <- summary(em_gd_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_gd_mpa <- gd_mpa$emtrends %>% 
  as.data.frame()
emtrends_gd_mpa$spp <- factor(emtrends_gd_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_gd_mpa <- emtrends_gd_mpa %>% 
  arrange(spp)

emtrends_gd_mpa_list <- emtrends_gd_mpa %>% select(p.value) %>% as.vector()
gd.p.value.mpa <- emtrends_gd_mpa_list$p.value
```

## FD
```{r}
fd_mod_lfm <- lmer(fd ~ spp*lfm_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fd_lfm <- emmeans::emtrends(fd_mod_lfm, pairwise~spp, var = c("lfm_scaled"))
fd_lfm <- summary(em_fd_lfm, infer=c(TRUE,TRUE),null=0)

emtrends_fd_lfm <- fd_lfm$emtrends %>% 
  as.data.frame() 
emtrends_fd_lfm$spp <- factor(emtrends_fd_lfm$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_fd_lfm <- emtrends_fd_lfm %>% 
  arrange(spp)
  
emtrends_fd_lfm_list <- emtrends_fd_lfm %>% select(p.value) %>% as.vector()
fd.p.value.lfm <- emtrends_fd_lfm_list$p.value
```

```{r}
fd_mod_mpa <- lmer(fd ~ spp*mpa_scaled +  site + year_month  + (1 | individual), data = mem_data_all_r)
em_fd_mpa <- emmeans::emtrends(fd_mod_mpa, pairwise~spp, var = "mpa_scaled")
fd_mpa <- summary(em_fd_mpa, infer=c(TRUE,TRUE),null=0)

emtrends_fd_mpa <- fd_mpa$emtrends %>% 
  as.data.frame()
emtrends_fd_mpa$spp <- factor(emtrends_fd_mpa$spp, levels = c("abco", "pije", "cade", "arpa", "quke"))
emtrends_fd_mpa <- emtrends_fd_mpa %>% 
  arrange(spp)
  
emtrends_fd_mpa_list <- emtrends_fd_mpa %>% select(p.value) %>% as.vector()
fd.p.value.mpa <- emtrends_fd_mpa_list$p.value
```

# 3. Dotplot: % Ignition

## Data Wrangling
```{r, warning = F}
df <- mem_data_all_clean %>% 
   mutate(hydration = case_when(
     lfm <= 100 ~ 'dry', 
     lfm > 100 ~ 'wet', 
     TRUE ~ 'something'
   )) %>% 
   #filter(lfm < 150) %>% 
    mutate(ignition2 = case_when(
     ignition == "M" ~ 0, 
     ignition == "1 and M" ~ 1, 
     ignition == "1" ~ 1, 
     ignition == "2" ~ 1, 
     ignition == "3" ~ 0, 
     TRUE ~ as.numeric(ignition))) %>% 
   group_by(spp, individual, hydration) %>% #group by year, model, spp, group column
   add_tally %>% 
   mutate(total = sum(ignition2, na.rm = T), 
          prop_ignite = paste0(round(100 * total/n)), 
          prop_ignite = as.numeric(prop_ignite)) %>% 
  # mutate(prop_dry = ) %>% 
   mutate(spp_props = forcats::fct_relevel(spp, 
                                           "ceco", 
                                           "quke",
                                           "arpa", 
                                           "pije", 
                                           "cade", 
                                           "abco")) %>% 
  ungroup() %>% 
  group_by(spp, individual) %>% 
   add_tally %>% 
   mutate(total_all = sum(ignition2, na.rm = T), 
          prop_ignite_all = paste0(round(100 * total_all/nn)), 
          prop_ignite_all = as.numeric(prop_ignite_all))

```

## Visualization
```{r}
df.dotplot.prop.ig <- df %>% 
  group_by(spp) %>% 
  mutate(med_prop_ignite = median(prop_ignite)) %>% 
  mutate(stdev_prop_ignite = sd(prop_ignite))

df.dotplot.prop.ig$Species <- factor(df.dotplot.prop.ig$Species, levels = c("Ab. concolor", "Pi. jeffreyi", "Ca. decurrens", "Ar. patula", "Ce. cordulatus", "Qu. kelloggii"))

dotplot.prop.ig <- df.dotplot.prop.ig %>%
   ggplot(aes(y = med_prop_ignite, 
              x = Species,
              color = Species)) +
   geom_point(alpha = .7, size = 5) +
   geom_linerange(aes(ymin = case_when(
     med_prop_ignite - 2*stdev_prop_ignite < 0 ~ 0,
     med_prop_ignite - 2*stdev_prop_ignite > 0 ~ med_prop_ignite - 2*stdev_prop_ignite),
     ymax = case_when(
       med_prop_ignite + 2*stdev_prop_ignite > 100 ~ 100,
       med_prop_ignite + 2*stdev_prop_ignite < 100 ~ med_prop_ignite + 2*stdev_prop_ignite))) +
   labs(y = "Percent Ignited (%)", 
        x = "Species")  +
   scale_y_continuous(limits = c(0, 120), breaks = c(0, 20, 40, 60, 80, 100)) +
   #scale_x_discrete(guide = guide_axis(n.dodge=2))+ # if we want axis labelled w/ species
   color_many2 +
   annotate('text', x = 1, y = 115, label = 'a', fontface = 'bold', size = 10) +
   theme(axis.title.y = element_text(face = 'bold', size = 14),
         axis.text.y = element_text(size = 10),
         axis.title.x = element_blank(),
         #axis.text.x = element_text(face = 'italic', size = 11),
         axis.text.x = element_blank(),
         axis.ticks.x = element_blank(),
         legend.position = 'none',
         panel.grid = element_blank())
dotplot.prop.ig
```

# 4. Effect Size Plots
For these plots, focusing on TTI, FH, GD, Prop Ignition

## MEM Tables

### By F. Group
```{r}
tab_model(tti_mod_fgroup, fh_mod_fgroup, gd_mod_fgroup,temp_change_mod.fgroup,
          fd_mod_fgroup,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
         string.pred = "Coeffcient", 
        dv.labels = c("Time to Ignition", "Flame Height","Glow Duration", "Temp Change", "Flame Duration"),
         title = "Effect Size Plots: MEM Table",
  string.p = "P-Value", 
  p.style = "stars")
```

### By Species 
```{r}
tab_model(tti_mod, fh_mod, gd_mod, lower_temp_max_mod, fd_mod, temp_change_mod,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
         string.pred = "Coefficient", 
        dv.labels = c("Time to Ignition", "Flame Height", "Max Temp", "Glow Duration",
                      "Flame Duration", "Temp Change"),
         title = "Effect Size Plots: MEM Table",
  string.p = "P-Value", 
  p.style = "stars")
```

### Extracting Coeffecients
```{r}
tti_mod.coef.df1 <- tidy(tti_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'lfm')
tti_mod.coef.df2 <- tidy(tti_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'TTI') %>% 
  mutate(pred = 'mpa')
tti_mod.coef.df <- rbind(tti_mod.coef.df1, tti_mod.coef.df2)

gd_mod.coef.df1 <- tidy(gd_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'GD') %>% 
  mutate(pred = 'lfm')
gd_mod.coef.df2 <- tidy(gd_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'GD') %>% 
  mutate(pred = 'mpa')
gd_mod.coef.df <- rbind(gd_mod.coef.df1, gd_mod.coef.df2)

fh_mod.coef.df1 <- tidy(fh_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FH') %>% 
  mutate(pred = 'lfm')
fh_mod.coef.df2 <- tidy(fh_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FH') %>% 
  mutate(pred = 'mpa')
fh_mod.coef.df <- rbind(fh_mod.coef.df1, fh_mod.coef.df2)

temp_mod.coef.df1 <- tidy(lower_temp_max_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Max Temp') %>% 
  mutate(pred = 'lfm')
temp_mod.coef.df2 <- tidy(lower_temp_max_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Max Temp') %>% 
  mutate(pred = 'mpa')
temp_mod.coef.df <- rbind(temp_mod.coef.df1, temp_mod.coef.df2)

fd_mod.coef.df1 <- tidy(fd_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FD') %>% 
  mutate(pred = 'lfm')
fd_mod.coef.df2 <- tidy(fd_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'FD') %>% 
  mutate(pred = 'mpa')
fd_mod.coef.df <- rbind(fd_mod.coef.df1, fd_mod.coef.df2)

temp_change_mod.coef.df1 <- tidy(temp_change_mod.lfm) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Temp Change') %>% 
  mutate(pred = 'lfm')
temp_change_mod.coef.df2 <- tidy(temp_change_mod.mpa) %>% 
  select(term, estimate, std.error, p.value)%>% 
  mutate(metric = 'Temp Change') %>% 
  mutate(pred = 'mpa')
temp_change_mod.coef.df <- rbind(temp_change_mod.coef.df1, temp_change_mod.coef.df2)

coef.df <- rbind(tti_mod.coef.df, fh_mod.coef.df, temp_mod.coef.df, gd_mod.coef.df, fd_mod.coef.df)
```

Quick visualizations of models:
```{r}
tti_spp <- lmer(tti ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(tti_mod)

fh_spp <- lmer(fh ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(fh_spp)

temp_spp <- lmer(temp_change ~ spp + lfm_scaled + (1 | individual), data = mem_data_all_r)

sjPlot::plot_model(temp_spp)
```

## Sig. function

```{r}
significance <- function(p.value.df, sig.vector) {
  
  sig.vector <- c(rep("NA", 5))
  
for(i in 1:5){
  
  if(p.value.df[i] < 0.05){
  sig.vector[i] <- 'Yes'
  }
  
  else {
  sig.vector[i] <- 'No'
  }
}
  return(sig.vector)
}
```


## Visualizations
### Function
```{r}
ES.plot <- function(df, y.var, sig, std.error, mpa = 'no', margins.vector = c(0.1, 0.1, 0.1, 0.1), limits.vector, breaks.vector, axis.title = ' ') 
  { if(mpa == 'no'){
  ggplot(data = df, aes(x = species, y = y.var,
                       color = species, shape = sig)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  theme_bw() +
  scale_y_continuous(limits = limits.vector, breaks = breaks.vector) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(10, 16)) +
 # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
 # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
 # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), axis.text.x = element_blank(),
        axis.title.y = element_blank(), 
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic'),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(margins.vector, 'cm'),
        legend.position = 'none')
  }
 else{
   ggplot(data = df, aes(x = species, y = y.var,
                       color = species, shape = sig)) +
  labs(color = 'Species', shape = 'Significant?') +
  geom_point(size = 5) +
  geom_linerange(aes(ymin = y.var - 0.5*std.error, ymax = y.var + 0.5*std.error)) +
  geom_abline(intercept = 0, slope = 0, color = 'black', alpha = 0.5, size = 0.3) +
  theme_bw() +
  scale_y_continuous(limits = limits.vector, breaks = breaks.vector,
                     sec.axis = sec_axis(trans = ~.*1, 
                     name = axis.title,
                     breaks = breaks.vector,
                     labels = breaks.vector)) +
  color_noceco+
  #scale_color_manual(values = c('black', '#FDD358', 'black', 'black', '#FDD358')) + # For color by angio vs gymno (version 1)
  scale_shape_manual(values = c(10, 16)) +
 # geom_vline(xintercept = 3.4, alpha = 0.5, size = 0.3, lty = 2) +
 # annotate(geom = "text", x = 2, y = 14, label = 'Gymnosperms', size = 4) +
 # annotate(geom = "text", x = 4.52, y = 14, label = 'Angiosperms', size = 4) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.y.left = element_blank(), 
        axis.title.y.left = element_blank(),
        axis.text.y.left = element_blank(),
        axis.title.y.right = element_text(face = 'bold', size = 14),
        axis.text.y.right = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(face = 'italic',),
        panel.grid = element_blank(), axis.ticks.x = element_blank(),
        plot.title = element_text(hjust = 0.5, face = 'bold', size = 14),
        plot.margin = unit(margins.vector, 'cm'),
        legend.position = 'none')
 }
}
```

### TTI
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- tti_mod.coef.df$estimate[6]
tti.ES.lfm <- c(ref, ref + tti_mod.coef.df$estimate[12],
                ref + tti_mod.coef.df$estimate[11],
                ref + tti_mod.coef.df$estimate[10],
                ref + tti_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
tti.SE.lfm <- c(tti_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
tti.sig.lfm <- significance(tti.p.value.lfm, tti.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- tti_mod.coef.df$estimate[21]
tti.ES.mpa <- c(ref2, ref2 + tti_mod.coef.df$estimate[27],
                ref2 + tti_mod.coef.df$estimate[26], 
                ref2 + tti_mod.coef.df$estimate[25], 
                ref2 + tti_mod.coef.df$estimate[28]) 
tti.SE.mpa <- c(tti_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
tti.sig.mpa <- significance(tti.p.value.mpa, tti.sig.mpa)
tti.ES.df <- data.frame(species, tti.ES.lfm, tti.SE.lfm, tti.p.value.lfm, tti.sig.lfm, tti.ES.mpa, tti.SE.mpa, tti.p.value.mpa, tti.sig.mpa)

tti.ES.df$species <- factor(tti.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
tti.ES.lfm.plot <- ES.plot(tti.ES.df, tti.ES.lfm, tti.sig.lfm, tti.SE.lfm,
                           margins.vector = c(0.2, 0.05, 0.1, 0.1),
                           limits.vector = c(-6, 19),
                           breaks.vector = c(-5, 0, 5, 10, 15)) +
  annotate(geom = "text", x = 0.85, y = 17.2, label = 'e',
           fontface = 'bold', size = 10) +
  labs(title = 'LFM')
tti.ES.lfm.plot

tti.ES.mpa.plot <- ES.plot(tti.ES.df, tti.ES.mpa, tti.sig.mpa, tti.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.2, 0.3, 0.1, 0),
                           limits.vector = c(-6, 19),
                           breaks.vector = c(-5, 0, 5, 10, 15)) +
  annotate(geom = "text", x = 0.85, y = 17.2, label = 'h',
           fontface = 'bold', size = 10) +
  labs(title = 'Water Potential')
tti.ES.mpa.plot
```

### FH
Setup:
```{r}
ref <- fh_mod.coef.df$estimate[6]
fh.ES.lfm <- c(ref, ref + fh_mod.coef.df$estimate[12],
                ref + fh_mod.coef.df$estimate[11],
                ref + fh_mod.coef.df$estimate[10],
                ref + fh_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
fh.SE.lfm <- c(fh_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
fh.sig.lfm <- significance(fh.p.value.lfm, fh.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- fh_mod.coef.df$estimate[21]
fh.ES.mpa <- c(ref2, ref2 + fh_mod.coef.df$estimate[27],
                ref2 + fh_mod.coef.df$estimate[26], 
                ref2 + fh_mod.coef.df$estimate[25], 
                ref2 + fh_mod.coef.df$estimate[28]) 
fh.SE.mpa <- c(fh_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
fh.sig.mpa <- significance(fh.p.value.mpa, fh.sig.mpa)
fh.ES.df <- data.frame(species, fh.ES.lfm, fh.SE.lfm, fh.p.value.lfm, fh.sig.lfm, fh.ES.mpa, fh.SE.mpa, fh.p.value.mpa, fh.sig.mpa)

fh.ES.df$species <- factor(fh.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
fh.ES.lfm.plot <- ES.plot(fh.ES.df, fh.ES.lfm, fh.sig.lfm, fh.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-5.5, 5),
                           breaks.vector = c(-4, -2, 0, 2, 4)) +
  annotate(geom = "text", x = 0.85, y = 4.2, label = 'f',
           fontface = 'bold', size = 10)
fh.ES.lfm.plot

fh.ES.mpa.plot <- ES.plot(fh.ES.df, fh.ES.mpa, fh.sig.mpa, fh.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.4, 0.1, 0),
                           limits.vector = c(-5.5, 5),
                           breaks.vector = c(-4, -2, 0, 2, 4),
                          axis.title = 'Hydration x Species Effect Size') +
  annotate(geom = "text", x = 0.85, y = 4.2, label = 'i',
           fontface = 'bold', size = 10) 
fh.ES.mpa.plot
```

### Max. Temp.
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- temp_mod.coef.df$estimate[6]
temp_max.ES.lfm <- c(ref, ref + temp_mod.coef.df$estimate[12],
                ref + temp_mod.coef.df$estimate[11],
                ref + temp_mod.coef.df$estimate[10],
                ref + temp_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
temp_max.SE.lfm <- c(temp_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
temp_max.sig.lfm <- significance(temp_max.p.value.lfm, temp_max.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- temp_mod.coef.df$estimate[21]
temp_max.ES.mpa <- c(ref2, ref2 + temp_mod.coef.df$estimate[27],
                ref2 + temp_mod.coef.df$estimate[26], 
                ref2 + temp_mod.coef.df$estimate[25], 
                ref2 + temp_mod.coef.df$estimate[28]) 
temp_max.SE.mpa <- c(temp_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
temp_max.sig.mpa <- significance(temp_max.p.value.mpa, temp_max.sig.mpa)
temp_max.ES.df <- data.frame(species, temp_max.ES.lfm, temp_max.SE.lfm, temp_max.p.value.lfm, temp_max.sig.lfm, temp_max.ES.mpa, temp_max.SE.mpa, temp_max.p.value.mpa, temp_max.sig.mpa)

temp_max.ES.df$species <- factor(temp_max.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
temp_max.ES.lfm.plot <- ES.plot(temp_max.ES.df, temp_max.ES.lfm, temp_max.sig.lfm, temp_max.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-27, 27),
                           breaks.vector = c(-25, -12, 0, 12, 25)) +
  annotate(geom = "text", x = 0.85, y = 23.1, label = 'g',
           fontface = 'bold', size = 10)
temp_max.ES.lfm.plot

temp_max.ES.mpa.plot <- ES.plot(temp_max.ES.df, temp_max.ES.mpa, temp_max.sig.mpa, temp_max.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                          limits.vector = c(-27, 27),
                          breaks.vector = c(-25, -12, 0, 12, 25)) +
  annotate(geom = "text", x = 0.85, y = 23.1, label = 'j',
           fontface = 'bold', size = 10)
temp_max.ES.mpa.plot
```



### Temp. Change
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- temp_change_mod.coef.df$estimate[6]
temp_change.ES.lfm <- c(ref, ref + temp_change_mod.coef.df$estimate[12],
                ref + temp_change_mod.coef.df$estimate[11],
                ref + temp_change_mod.coef.df$estimate[10],
                ref + temp_change_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
temp_change.SE.lfm <- c(temp_change_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
temp_change.sig.lfm <- significance(temp_change.p.value.lfm, temp_change.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- temp_change_mod.coef.df$estimate[21]
temp_change.ES.mpa <- c(ref2, ref2 + temp_change_mod.coef.df$estimate[27],
                ref2 + temp_change_mod.coef.df$estimate[26], 
                ref2 + temp_change_mod.coef.df$estimate[25], 
                ref2 + temp_change_mod.coef.df$estimate[28]) 
temp_change.SE.mpa <- c(temp_change_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
temp_change.sig.mpa <- significance(temp_change.p.value.mpa, temp_change.sig.mpa)
temp_change.ES.df <- data.frame(species, temp_change.ES.lfm, temp_change.SE.lfm, temp_change.p.value.lfm, temp_change.sig.lfm, temp_change.ES.mpa, temp_change.SE.mpa, temp_change.p.value.mpa, temp_change.sig.mpa)

temp_change.ES.df$species <- factor(temp_change.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
temp_change.ES.lfm.plot <- ES.plot(temp_change.ES.df, temp_change.ES.lfm, temp_change.sig.lfm, temp_change.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-16, 10),
                           breaks.vector = c(-10, -5, 0, 5, 10)) +
  annotate(geom = "text", x = 0.85, y = 8.6, label = 'g',
           fontface = 'bold', size = 10)
temp_change.ES.lfm.plot

temp_change.ES.mpa.plot <- ES.plot(temp_change.ES.df, temp_change.ES.mpa, temp_change.sig.mpa, temp_change.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                          limits.vector = c(-16, 10),
                          breaks.vector = c(-10, -5, 0, 5, 10)) +
  annotate(geom = "text", x = 0.85, y = 8.6, label = 'j',
           fontface = 'bold', size = 10)
temp_change.ES.mpa.plot
```

### GD
Setup:
```{r}
species <- c("Ab. concolor", "Pi. jeffreyi", "Ca. decurrens", "Ar. patula", "Qu. kelloggii")
ref <- gd_mod.coef.df$estimate[6]
gd.ES.lfm <- c(ref, ref + gd_mod.coef.df$estimate[12],
                ref + gd_mod.coef.df$estimate[11],
                ref + gd_mod.coef.df$estimate[10],
                ref + gd_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
gd.SE.lfm <- c(gd_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
gd.sig.lfm <- significance(gd.p.value.lfm, gd.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- gd_mod.coef.df$estimate[21]
gd.ES.mpa <- c(ref2, ref2 + gd_mod.coef.df$estimate[27],
                ref2 + gd_mod.coef.df$estimate[26], 
                ref2 + gd_mod.coef.df$estimate[25], 
                ref2 + gd_mod.coef.df$estimate[28]) 
gd.SE.mpa <- c(gd_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
gd.sig.mpa <- significance(gd.p.value.mpa, gd.sig.mpa)
gd.ES.df <- data.frame(species, gd.ES.lfm, gd.SE.lfm, gd.p.value.lfm, gd.sig.lfm, gd.ES.mpa, gd.SE.mpa, gd.p.value.mpa, gd.sig.mpa)

gd.ES.df$species <- factor(gd.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
gd.ES.lfm.plot <- ES.plot(gd.ES.df, gd.ES.lfm, gd.sig.lfm, gd.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-25, 11),
                           breaks.vector = c(-20, -10, 0, 10)) +
  labs(title = 'LFM')
  #annotate(geom = "text", x = 0.9, y = 9, label = 'e', fontface = 'bold', size = 10)
gd.ES.lfm.plot

gd.ES.mpa.plot <- ES.plot(gd.ES.df, gd.ES.mpa, gd.sig.mpa, gd.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                           limits.vector = c(-25, 11),
                           breaks.vector = c(-20, -10, 0, 10)) +
  labs(title = 'MPa')
  #annotate(geom = "text", x = 0.9, y = 9, label = 'f', fontface = 'bold', size = 10)
gd.ES.mpa.plot

ggarrange(gd_plot_lfm_r, gd.ES.lfm.plot, gd.ES.mpa.plot, nrow = 1)
```

### FD
Setup:
```{r}
species <- c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii")
ref <- fd_mod.coef.df$estimate[6]
fd.ES.lfm <- c(ref, ref + fd_mod.coef.df$estimate[12],
                ref + fd_mod.coef.df$estimate[11],
                ref + fd_mod.coef.df$estimate[10],
                ref + fd_mod.coef.df$estimate[13])
  # Following this order: ABCO, PIJE, CADE, ARPA, QUKE (no CECO)
fd.SE.lfm <- c(fd_mod.coef.df$std.error[c(6, 12, 11, 10, 13)])
fd.sig.lfm <- significance(fd.p.value.lfm, fd.sig.lfm) # Gathering p-values from vectors made in 2.5 section
ref2 <- fd_mod.coef.df$estimate[21]
fd.ES.mpa <- c(ref2, ref2 + fd_mod.coef.df$estimate[27],
                ref2 + fd_mod.coef.df$estimate[26], 
                ref2 + fd_mod.coef.df$estimate[25], 
                ref2 + fd_mod.coef.df$estimate[28]) 
fd.SE.mpa <- c(fd_mod.coef.df$std.error[c(21, 27, 26, 25, 28)])
fd.sig.mpa <- significance(fd.p.value.mpa, fd.sig.mpa)
fd.ES.df <- data.frame(species, fd.ES.lfm, fd.SE.lfm, fd.p.value.lfm, fd.sig.lfm, fd.ES.mpa, fd.SE.mpa, fd.p.value.mpa, fd.sig.mpa)

fd.ES.df$species <- factor(fd.ES.df$species, levels = c("A. concolor", "P. jeffreyi", "C. decurrens", "A. patula", "Q. kelloggii"))
```

Plots:
```{r}
fd.ES.lfm.plot <- ES.plot(fd.ES.df, fd.ES.lfm, fd.sig.lfm, fd.SE.lfm,
                           margins.vector = c(0.1, 0.05, 0.1, 0.1),
                           limits.vector = c(-5, 3),
                           breaks.vector = c(-4, -2, 0, 2)) +
  labs(title = "LFM")
  #annotate(geom = "text", x = 0.9, y = 9, label = 'e', fontface = 'bold', size = 10)
fd.ES.lfm.plot

fd.ES.mpa.plot <- ES.plot(fd.ES.df, fd.ES.mpa, fd.sig.mpa, fd.SE.mpa,
                           mpa = 'y',
                           margins.vector = c(0.1, 0.2, 0.1, 0),
                           limits.vector = c(-5, 3),
                           breaks.vector = c(-4, -2, 0, 2)) +
  labs(title = "MPa")
  #annotate(geom = "text", x = 0.9, y = 9, label = 'f', fontface = 'bold', size = 10)
fd.ES.mpa.plot

ggarrange(fd_plot_lfm_r, fd.ES.lfm.plot, fd.ES.mpa.plot, nrow = 1)
```

# 5. Main Figure
Arranging effect size plots and scatterplots into one figure

Focusing on TTI, FH, and Max Temp.

Set up:
```{r}
blank_plot <- ggplot(data = gd.ES.df, aes(x = species, y = gd.ES.mpa)) +
  geom_point(color = 'white') +
  theme_void()

df.dotplot.prop.ig <- df.dotplot.prop.ig %>% # Making totally arbitrary column to make legend
  mutate(holder.sig = case_when(
    tti > 250 ~ "Yes",
    tti < 250 ~ "No"
  )) %>% 
  drop_na(holder.sig)
df.dotplot.prop.ig$holder.sig <- factor(df.dotplot.prop.ig$holder.sig, levels = c("Yes", "No"))

plot_legend.ES <- ggplot(data = df.dotplot.prop.ig, aes(x = Species, y = med_prop_ignite,
                                                color = Species, shape = holder.sig)) +
  labs(y = '', color = 'Species', shape = 'Significant?') +
  geom_point(size = 4, cex = 6, alpha = 0.9) +
  geom_linerange(aes(ymin = med_prop_ignite - 2*stdev_prop_ignite, ymax = med_prop_ignite + 2*stdev_prop_ignite)) +
  theme_bw() +
  color_many2 +
  scale_shape_manual(values = c(16, 10)) +
  theme(legend.title = element_text(face = 'bold', size = 20),
        legend.text = element_text(face = 'italic', size = 17))
plot_legend.ES

plot_legend.scatterplot <- mem_data_all_r %>% 
  ggplot(aes(x = fh, y = mpa, group = F.Group)) +
  geom_point(aes(color = F.Group), size = 2.2) +
  geom_smooth(se = F, method = 'lm', aes(color = F.Group, lty = F.fh.sig)) +
  scale_color_manual(values = c('steelblue3', 'darkgreen')) + # For color by angio vs gymno
  scale_linetype_manual(values = c(3, 1)) +
  labs(color = "Functional Group", lty = "Significant?") +
  theme(legend.text = element_text(size = 17),  # , face = 'italic'
        legend.title = element_text(size = 20, face = 'bold'),
        legend.key = element_rect(fill = 'white')) +
  guides(lty = guide_legend(override.aes = list(color = 'black')))

ES_legend <- cowplot::get_legend(plot_legend.ES)
SP_legend <- cowplot::get_legend(plot_legend.scatterplot)
```

Arranging:
Note: I had to do some wacky things with blank plots to get the final product to look okay.
```{r}
scatterplots <- cowplot::plot_grid(blank_plot, tti_plot_lfm_r, fh_plot_lfm_r,
                                  # lower_temp_max_plot_lfm_r,
                                   temp_change_plot_lfm_r,
                                   ncol = 1, rel_heights = c(0.78, 10, 9.95, 10))

ES.plots <- cowplot::plot_grid(tti.ES.lfm.plot, tti.ES.mpa.plot,
                              blank_plot, blank_plot,
                              fh.ES.lfm.plot, fh.ES.mpa.plot,
                              blank_plot, blank_plot,
                             # temp_max.ES.lfm.plot, temp_max.ES.mpa.plot,
                              temp_change.ES.lfm.plot, temp_change.ES.mpa.plot,
                              blank_plot, blank_plot,
                              ncol = 2, nrow = 6,
                              rel_widths = c(6,7.5),
                              rel_heights = c(11.3, 1.25, 10.5, 0.93, 9.6, 1.78))

main_figure_no_legend <- cowplot::plot_grid(scatterplots, ES.plots, ncol = 2, rel_widths = c(10,9))
main_figure_no_legend

legend <- cowplot::plot_grid(ES_legend, SP_legend, ncol = 1)

legend_and_dotplot <- cowplot::plot_grid(blank_plot, dotplot.prop.ig, blank_plot, legend, ncol = 1, rel_heights = c(0.29,3.1,0.98,6))

main_figure <- cowplot::plot_grid(legend_and_dotplot, main_figure_no_legend, ncol = 2, rel_widths = c(1.5,5))
main_figure

ggsave(plot = main_figure, bg = 'white', 
       here("figures", "species.x.hydration.effect.and.scatterplots.jpg"),
       width = 16, height = 10)
```

# 6. Summary Table
Comparing slopes, intercepts, and R^2 values of different linear regressions post-remef

Note: this is not looking at slopes, intercepts, etc. of linear mixed effects models. Instead, it is looking at the remef(flam metric) ~ lfm or plots that we included in the main figure

```{r}
ST.spp <- c(rep(c('A. concolor', 'C. decurrens', 'P. jeffreyii', 'A. patula', 'Q. kelloggii'), 3))
ST.flam.metric <- c('Time to Ignition', ' ', ' ', ' ', ' ',
                    'Flame Height', ' ', ' ', ' ', ' ',
                    'Glow Duration', ' ', ' ', ' ', ' ')
ST.slopes <- c(7.4, -0.057, 6.4, 9.3, 0.55, -1.7, -4.5, -2.3, -1.2, -3.7, 16, 18, 12, 16, -4.7)
ST.yints <- c(93, 78, 90, 73, 24, 37, 43, 43, 32, 38, 130, 140, 140, 190, 130)
ST.r2 <- c(0.089, 0.0000071, 0.11, 0.077, 0.006, 0.065, 0.35, 0.16, 0.025, 0.35, 0.14, 0.14, 0.032, 0.043, 0.0028)
ST.df <- data.frame(ST.flam.metric, ST.spp, ST.slopes, ST.yints, ST.r2)
ST.df
```

```{r}
ST.df %>% kable(format = 'html', escape = F, col.names = c('Flam. Metric', 'Species', 'Slope',                                'Y Intercept', 'R2 Value')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T, font_size = 30) %>% 
  save_kable(here('figures', 'interspecific.differences.summary.table.html'))
```

# 7. MEM Table
## By Species
Tidy:
```{r}
tti_est.df <- tidy(tti_mod)
tti_est.df <- tti_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
fh_est.df <- tidy(fh_mod)
fh_est.df <- fh_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
mt_est.df <- tidy(lower_temp_max_mod)
mt_est.df <- mt_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
gd_est.df <- tidy(gd_mod)
gd_est.df <- gd_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
fd_est.df <- tidy(fd_mod)
fd_est.df <- fd_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
temp_change_est.df <- tidy(temp_change_mod)
temp_change_est.df <- temp_change_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
```

Setup:
```{r}
coef <- c("Intercept", "Live Fuel Moisture (LFM)", "Water Potential (MPa)", "Sample Weight", "Site", "Ab. concolor", "Pi. jeffreyii", "Ca. decurrens", "Ar. patula", "Qu. kelloggii", "October 2020", "September 2020", "Interaction Effects", "Pi. jeffreyii x LFM", "Pi. jeffreyii x MPa", "Ca. decurrens x LFM", "Ca. decurrens x MPa", "Ar. patula x LFM", "Ar. patula x MPa", "Qu. kelloggii x LFM", "Qu. kelloggii x MPa", "Random Effects", paste("\U03C3", "\U00B2"), paste("\U03C4", "\U2080", "\U2080"), "N", "Model Summary Statistics", "Observations", paste("Marginal R", "\U00B2", "/", "Conditional R", "\U00B2"))
tti.est <- c(tti_est.df$estimate[c(1,7,6,10,8)], 'Reference', tti_est.df$estimate[c(4,3,2,5)],'Reference', tti_est.df$estimate[9], ' ', tti_est.df$estimate[c(17,13,16,12,15,11, 18, 13)], ' ', '440.16', paste('64.43', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.578 / 0.632')
tti.p <- c(tti_est.df$p.value[c(1,7,6,10,8)], 1, tti_est.df$p.value[c(4,3,2,5)],1, tti_est.df$p.value[9], 1, tti_est.df$p.value[c(17,13,16,12,15,11, 18, 13)], 1, 1, 1, 1, 1, 1, 1)
fh.est <- c(fh_est.df$estimate[c(1,7,6,10,8)], 'Reference', fh_est.df$estimate[c(4,3,2,5)],'Reference', fh_est.df$estimate[9], ' ', fh_est.df$estimate[c(17,13,16,12,15,11, 18, 13)],  ' ', '34.90', paste('6.31', "\U1D62"), paste('101', "\U1D62"),' ', '580', '0.272 / 0.383')
fh.p <- c(fh_est.df$p.value[c(1,7,6,10,8)], 1, fh_est.df$p.value[c(4,3,2,5)],1, fh_est.df$p.value[9], 1, fh_est.df$p.value[c(17,13,16,12,15,11, 18, 13)], 1, 1, 1, 1, 1, 1, 1)
gd.est <- c(gd_est.df$estimate[c(1,7,6,10,8)], 'Reference', gd_est.df$estimate[c(4,3,2,5)], 'Reference', gd_est.df$estimate[9], ' ', gd_est.df$estimate[c(17,13,16,12,15,11, 18, 13)], ' ', '1780.64', paste('16.61', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.312 / 0.319')
gd.p <- c(gd_est.df$p.value[c(1,7,6,10,8)], 1, gd_est.df$p.value[c(4,3,2,5)], 1, gd_est.df$p.value[9], 1, gd_est.df$p.value[c(17,13,16,12,15,11, 18, 13)], 1, 1, 1, 1, 1, 1, 1)
fd.est <- c(fd_est.df$estimate[c(1,7,6,10,8)], 'Reference', fd_est.df$estimate[c(4,3,2,5)], 'Reference', fd_est.df$estimate[9], ' ', fd_est.df$estimate[c(17,13,16,12,15,11, 18, 13)], ' ', '85.58', paste('10.65', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.474 / 0.533')
fd.p <- c(fd_est.df$p.value[c(1,7,6,10,8)], 1, fd_est.df$p.value[c(4,3,2,5)], 1, fd_est.df$p.value[9], 1, fd_est.df$p.value[c(17,13,16,12,15,11, 18, 13)], 1, 1, 1, 1, 1, 1, 1)
temp_change.est <- c(temp_change_est.df$estimate[c(1,7,6,10,8)], 'Reference', temp_change_est.df$estimate[c(4,3,2,5)], 'Reference', temp_change_est.df$estimate[9], ' ', temp_change_est.df$estimate[c(17,13,16,12,15,11, 18, 13)], ' ', '1337.42', paste('40.95', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.255 / 0.277')
temp_change.p <- c(temp_change_est.df$p.value[c(1,7,6,10,8)], 1, temp_change_est.df$p.value[c(4,3,2,5)], 1, temp_change_est.df$p.value[9], 1, temp_change_est.df$p.value[c(17,13,16,12,15,11, 18, 13)], 1, 1, 1, 1, 1, 1, 1)
# Decided against max. temp. and instead used temp. change
mt.est <- c(mt_est.df$estimate[c(1,7,6,10,8)], 'Reference', mt_est.df$estimate[c(4,3,2,5)],'Reference', mt_est.df$estimate[9], ' ', mt_est.df$estimate[c(17,13,16,12,15,11, 18, 13)], ' ', '3614.55', paste('167.75', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.238 / 0.383')
mt.p <- c(mt_est.df$p.value[c(1,7,6,10,8)], 1, mt_est.df$p.value[c(4,3,2,5)], 1, mt_est.df$p.value[9], 1, mt_est.df$p.value[c(17,13,16,12,15,11, 18, 13)], 1, 1, 1, 1, 1, 1, 1)
mem.table.df <- data.frame(coef, tti.est, tti.p, fh.est, fh.p, gd.est, gd.p, fd.est, fd.p, temp_change.est, temp_change.p)
```

Kable:
```{r}
mem.table.df %>%
  mutate(coef = cell_spec(coef, 'html', italic = ifelse(coef == c("Ab. concolor", "Pi. jeffreyii", "Ca. decurrens", "Ar. patula", "Qu. kelloggii"), T, F), color = 'black')) %>% 
  mutate(tti.est = cell_spec(tti.est, 'html', bold = ifelse(tti.p < 0.05, T, F), color = 'black')) %>% 
  mutate(fh.est = cell_spec(fh.est, 'html', bold = ifelse(fh.p < 0.05, T, F), color = 'black')) %>% 
  mutate(gd.est = cell_spec(gd.est, 'html', bold = ifelse(gd.p < 0.05, T, F), color = 'black')) %>% 
  mutate(fd.est = cell_spec(fd.est, 'html', bold = ifelse(fd.p < 0.05, T, F), color = 'black')) %>% 
  mutate(temp_change.est = cell_spec(temp_change.est, 'html', bold = ifelse(temp_change.p < 0.05, T, F), color = 'black')) %>% 
  select(coef, tti.est, fh.est, gd.est, fd.est, temp_change.est) %>% 
  kable(format = 'html', escape = F, digits = 5, col.names = c('Coefficients', 'Time to Ignition', 'Flame Height', 'Glow Duration', 'Flame Duration', 'Temperature Change')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T, font_size = 30) %>% 
  row_spec(0, background = '#B3B3B3', bold = T, color = 'black') %>% 
  row_spec(c(6, 11), italic = T) %>% 
  row_spec(c(13,22,26), bold = T, background = '#D3D3D3') %>% 
  save_kable(here('figures', 'MAIN_mem_table.html'))
```

## Angios vs Gymnos
Tidy:
```{r}
tti_est.df <- tidy(tti_mod_fgroup)
tti_est.df <- tti_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
fh_est.df <- tidy(fh_mod_fgroup)
fh_est.df <- fh_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
mt_est.df <- tidy(lower_temp_max_mod_fgroup)
mt_est.df <- mt_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
gd_est.df <- tidy(gd_mod_fgroup)
gd_est.df <- gd_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
fd_est.df <- tidy(fd_mod_fgroup)
fd_est.df <- fd_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
temp_change_est.df <- tidy(temp_change_mod.fgroup)
temp_change_est.df <- temp_change_est.df %>% 
  mutate_if(is.numeric, round, digits = 3)
```

Setup:
```{r}
coef <- c("Intercept", "Live Fuel Moisture (LFM)", "Water Potential (MPa)", "Sample Weight", "Site", "Angiosperm", "Gymnosperm", "October 2020", "September 2020", "Interaction Effects", "Gymnosperm x LFM", "Gymnosperm x MPa", "Random Effects", paste("\U03C3", "\U00B2"), paste("\U03C4", "\U2080", "\U2080"), "N", "Model Summary Statistics", "Observations", paste("Marginal R", "\U00B2", "/", "Conditional R", "\U00B2"))
tti.est <- c(tti_est.df$estimate[c(1,4,3,7,5)], 'Reference', tti_est.df$estimate[2],'Reference', tti_est.df$estimate[6], ' ', tti_est.df$estimate[c(9, 8)], ' ', '436.09', paste('259.03', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.411 / 0.631')
tti.p <- c(tti_est.df$p.value[c(1,4,3,7,5)], 1, tti_est.df$p.value[2],1, tti_est.df$p.value[6], 1, tti_est.df$p.value[c(9, 8)], 1, 1, 1, 1, 1, 1, 1)
fh.est <- c(fh_est.df$estimate[c(1,4,3,7,5)], 'Reference', fh_est.df$estimate[2],'Reference', fh_est.df$estimate[6], ' ', fh_est.df$estimate[c(9, 8)], ' ', '35.71', paste('8.91', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.191 / 0.353')
fh.p <- c(fh_est.df$p.value[c(1,4,3,7,5)], 1, fh_est.df$p.value[2],1, fh_est.df$p.value[6], 1, fh_est.df$p.value[c(9, 8)], 1, 1, 1, 1, 1, 1, 1)
gd.est <- c(gd_est.df$estimate[c(1,4,3,7,5)], 'Reference', gd_est.df$estimate[2],'Reference', gd_est.df$estimate[6], ' ', gd_est.df$estimate[c(9, 8)], ' ', '3661.92', paste('540.48', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.163 / 0.270')
gd.p <- c(gd_est.df$p.value[c(1,4,3,7,5)], 1, gd_est.df$p.value[2],1, gd_est.df$p.value[6], 1, gd_est.df$p.value[c(9, 8)], 1, 1, 1, 1, 1, 1, 1)
fd.est <- c(fd_est.df$estimate[c(1,4,3,7,5)], 'Reference', fd_est.df$estimate[2],'Reference', fd_est.df$estimate[6], ' ', fd_est.df$estimate[c(9, 8)], ' ', '87.92', paste('12.59', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.421 / 0.493')
fd.p <- c(fd_est.df$p.value[c(1,4,3,7,5)], 1, fd_est.df$p.value[2],1, fd_est.df$p.value[6], 1, fd_est.df$p.value[c(9, 8)], 1, 1, 1, 1, 1, 1, 1)
temp_change.est <- c(temp_change_est.df$estimate[c(1,4,3,7,5)], 'Reference', temp_change_est.df$estimate[2],'Reference', temp_change_est.df$estimate[6], ' ', temp_change_est.df$estimate[c(9, 8)], ' ', '1367.41', paste('31.74', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.242 / 0.259')
temp_change.p <- c(temp_change_est.df$p.value[c(1,4,3,7,5)], 1, temp_change_est.df$p.value[2],1, temp_change_est.df$p.value[6], 1, temp_change_est.df$p.value[c(9, 8)], 1, 1, 1, 1, 1, 1, 1)
# Decided against max. temp. and instead used temp. change
mt.est <- c(mt_est.df$estimate[c(1,4,3,7,5)], 'Reference', mt_est.df$estimate[2],'Reference', mt_est.df$estimate[6], ' ', mt_est.df$estimate[c(9, 8)], ' ', '1888.12', paste('52.50', "\U1D62"), paste('101', "\U1D62"), ' ', '580', '0.249 / 0.269')
mt.p <- c(mt_est.df$p.value[c(1,4,3,7,5)], 1, mt_est.df$p.value[2],1, mt_est.df$p.value[6], 1, mt_est.df$p.value[c(9, 8)], 1, 1, 1, 1, 1, 1, 1)
mem.table.df <- data.frame(coef, tti.est, tti.p, fh.est, fh.p, gd.est, gd.p, fd.est, fd.p, temp_change.est, temp_change.p)
```

```{r}
mem.table.df %>%
  mutate(coef = cell_spec(coef, 'html', color = 'black')) %>% 
  mutate(tti.est = cell_spec(tti.est, 'html', bold = ifelse(tti.p < 0.05, T, F), color = 'black')) %>% 
  mutate(fh.est = cell_spec(fh.est, 'html', bold = ifelse(fh.p < 0.05, T, F), color = 'black')) %>% 
  mutate(gd.est = cell_spec(gd.est, 'html', bold = ifelse(gd.p < 0.05, T, F), color = 'black')) %>% 
  mutate(fd.est = cell_spec(fd.est, 'html', bold = ifelse(fd.p < 0.05, T, F), color = 'black')) %>% 
  mutate(temp_change.est = cell_spec(temp_change.est, 'html', bold = ifelse(temp_change.p < 0.05, T, F), color = 'black')) %>% 
  select(coef, tti.est, fh.est, gd.est, fd.est, temp_change.est) %>% 
  kable(format = 'html', escape = F, digits = 5, col.names = c('Coefficients', 'Time to Ignition', 'Flame Height', 'Glow Duration', 'Flame Duration', 'Temperature Change')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T, font_size = 30) %>% 
  row_spec(0, background = '#B3B3B3', bold = T, color = 'black') %>% 
  row_spec(c(6, 8), italic = T) %>% 
  row_spec(c(10,13,17), bold = T, background = '#D3D3D3') %>% 
  save_kable(here('figures', 'F.Group_mem_table.html'))
```

# ------------------------------

# 8. Statistical tests
## ANOVA Tests
```{r}
# Testing Assumptions: Normally distributed residuals
tti.lm <- lm(tti ~ spp, data = mem_data_all)
tti.lm.res <- tti.lm$residuals
qqPlot(tti.lm.res) # Assumption failed
fh.lm <- lm(fh ~ spp, data = mem_data_all)
fh.lm.res <- fh.lm$residuals
qqPlot(fh.lm.res) # Assumption passed
gd.lm <- lm(gd ~ spp, data = mem_data_all)
gd.lm.res <- gd.lm$residuals
qqPlot(gd.lm.res) # Assumption failed

# Try log-transformation
log.tti.lm <- lm(log(tti) ~ spp, data = mem_data_all)
log.tti.lm.res <- log.tti.lm$residuals
qqPlot(log.tti.lm.res) # Better, but unsure if 'passed' assumption
log.fh.lm <- lm(log(fh) ~ spp, data = mem_data_all)
log.fh.lm.res <- log.fh.lm$residuals
qqPlot(log.fh.lm.res) # Assumption failed
log.gd.lm <- lm(log(gd) ~ spp, data = mem_data_all)
log.gd.lm.res <- log.gd.lm$residuals
qqPlot(log.gd.lm.res) # Better, but unsure if 'passed' assumption

# Since log-transformed data is better for gd and tti, we will proceed with that data for those metrics and stick with the untransformed fh data since that had normally distributed residuals

# Assumption 2: Homogeneity of variance
plot(log.tti.lm) # Passes
plot(fh.lm) # Passes
plot(log.gd.lm) # Passes

tti.aov <- aov(log(tti) ~ spp, data = mem_data_all)
summary(tti.aov) # Significant
fh.aov <- aov(fh ~ spp, data = mem_data_all)
summary(fh.aov) # Significant
gd.aov <- aov(log(gd) ~ spp, data = mem_data_all)
summary(gd.aov) # Significant
```

### Tukey-Kramer Tests
```{r}
TukeyHSD(tti.aov)
TukeyHSD(fh.aov)
TukeyHSD(gd.aov)
```

## ANCOVA Tests
We had previously tried this and the first assumption (independence of the covariate and treatment) was not met, so we shifted gears to the ANOVA test, but we are going to try this again with some data transformations (scaled & centered, log-transformed, and sample-weight normalized)

#### Testing assumptions
```{r}
# No transformation
lfm.lm <- aov(lfm ~ spp, data = mem_data_all)
summary(lfm.lm) # Assumption failed

# Scaling, log-transforming, normalizing
mem_data_all_ancova <- mem_data_all %>% 
  ungroup() %>% 
  mutate(lfm.sc = scale(lfm),
         lfm.log = log(lfm),
         lfm.norm = lfm/sample_wt)

lfm.lm <- aov(lfm.sc ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption failed
lfm.lm <- aov(lfm.log ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption failed
lfm.lm <- aov(lfm.norm ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption failed

# Scaling, centering by species
mem_data_all_ancova <- mem_data_all %>% 
  mutate(lfm.sc = scale(lfm))
lfm.lm <- aov(lfm.sc ~ spp, data = mem_data_all_ancova)
summary(lfm.lm) # Assumption passed

# Proceeding with this, testing homogeneity of variance for all four flam metrics of interest:
tti.mod <- lm(tti ~ lfm.sc + spp,data = mem_data_all_ancova)
tti.res <- resid(tti.mod)
plot(fitted(tti.mod), tti.res) # Assumption failed
fh.mod <- lm(fh ~ lfm.sc + spp,data = mem_data_all_ancova)
fh.res <- resid(fh.mod)
plot(fitted(fh.mod), fh.res) # Assumption passed
temp.max.mod <- lm(lower_temp_max ~ lfm.sc + spp,data = mem_data_all_ancova)
temp.max.res <- resid(temp.max.mod)
plot(fitted(temp.max.mod), temp.max.res) # Assumption passed
gd.mod <- lm(gd ~ lfm.sc + spp,data = mem_data_all_ancova)
gd.res <- resid(gd.mod)
plot(fitted(gd.mod), gd.res) # Not sure...
```

#### Running tests
```{r}
mem_data_all_ancova <- mem_data_all_ancova %>% 
  mutate(spp = as.factor(spp))

# ANCOVA
tti.ancov <- aov(tti ~ spp + lfm.sc, data = mem_data_all_ancova)
Anova(tti.ancov, type = 'III') # Significant
fh.ancov <- aov(fh ~ lfm.sc + spp, data = mem_data_all_ancova)
Anova(fh.ancov, type = 'III') # Significant
temp.max.ancov <- aov(lower_temp_max ~ lfm.sc + spp, data = mem_data_all_ancova)
Anova(temp.max.ancov, type = 'III') # Significant

# Post-Hoc Test: Pairwise Comparison
tti.post.hoc <- glht(tti.ancov, linfct = mcp(spp = "Tukey"))
summary(tti.post.hoc)
fh.post.hoc <- glht(fh.ancov, linfct = mcp(spp = "Tukey"))
summary(fh.post.hoc)
temp.max.post.hoc <- glht(temp.max.ancov, linfct = mcp(spp = "Tukey"))
summary(temp.max.post.hoc)
```