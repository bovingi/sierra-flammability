---
title: "Mixed Effects Models"
author: "Indra Boving & Joe Celebrezze"
date: "6/21/2022"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(cowplot)
library(lmerTest)
library(ggeffects)  
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)

#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data

library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
#library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
#library(memmented)
filter = dplyr::filter
mutate = dplyr::mutate
library(nlme)
library(MetBrewer)
#install.packages("memmented")
#devtools::install_github("hohenstein/remef")
library(remef)
library(kableExtra)
```


#------------------------------------
# 1. Data wrangling
Reading in dataframe

- For the Sierra analysis, this is combining all species and dropping the august sampling data (not enough samples and it was measured a lil differently). 

```{r}
mem_data_all <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv")) %>% 
  select(lfm, mpa, tti, fh, fd, gd, prop_ignite, temp_change, ignition, sample_wt, dry_wt, fresh_wt, water_wt, location, site, year_month, spp, individual) %>% 
  mutate(dw_flam_sample = sample_wt * (dry_wt/fresh_wt),
         ww_flam_sample = sample_wt * (water_wt/fresh_wt)) %>% 
  mutate(excess_water = (ww_flam_sample - dw_flam_sample)) %>% 
  mutate(mpa_scaled = scale(mpa)) %>% 
  group_by(spp) %>% 
  mutate(dw_flam_sample_scaled = scale(dw_flam_sample), 
         sample_wt_scaled = scale(sample_wt), 
         ww_flam_sample_scaled = scale(ww_flam_sample),
         lfm_scaled = scale(lfm), 
         excess_water_scaled = scale(excess_water)) %>% 
  filter(!year_month %in% c("2021_august"))
```

```{r}
mem_data_all %>% 
ggplot(aes( 
           y = mpa_scaled, 
           x = tti, 
           color = spp)) +
  geom_point()+
  geom_smooth(method = "lm")
```

Maxs and mins from the field data: 

```{r}
# adfa_min <- 55
# adfa_max <- 110
# 
# ceme_min <- 55
# ceme_max <- 140
```

### All dates datasets

```{r, message=FALSE, warning=FALSE, include=FALSE}
# mem.adfa.subset <- mem_data_all  %>% 
#   filter(spp == "ADFA") %>% 
#   filter(ignition == "1")
# 
# mem.CEME.subset <- mem_data_all  %>% 
#   filter(spp == "CEME")%>% 
#   filter(ignition == "1")
# 
# mem.adfa.subset.allignitions <- mem_data_all  %>% 
#   filter(spp == "ADFA")
# 
# mem.CEME.subset.allignitions <- mem_data_all %>% 
#   filter(spp == "CEME")
# 
# mem.adfa.subset.limited <- mem.adfa.subset %>% 
#   filter(lfm < adfa_max, lfm > adfa_min)
# 
# mem.CEME.subset <- mem_data_all %>% 
#   filter(spp == "CEME")
# 
# mem.CEME.subset.limited <- mem.CEME.subset %>% 
#   filter(lfm < ceme_max, lfm > ceme_min)
```

#------------------------------------
# 2.0 Predicting flam metrics: TTI, FH, FD, GD, Temp change, prop ignite. 

## 2.0.1 TTI: Figures of models

```{r}
tti_mpa_m1 <- lmer(tti ~ mpa + spp + year_month + (1 | individual), data =  mem_data_all)
summary(tti_mpa_m1)

#remove fixed effect of spp:
#     see what names are associated: 
term2coef(tti_mpa_m1, "spp")

r1_1 <- remef(tti_mpa_m1 , fix = c("spparpa", "sppcade", "sppceco", "spppije", "sppquke"))
summary(r1_1)
head(r1_1)

# remove fixed effect of 'Days' and the intercept
#r1_2 <- remef(fm1, fix = "Days", keep.intercept = FALSE)
```

```{r}
# (pp <- plot_model(mpa_mod_fig.mpa,type="pred",
#        terms=c("mpa","year_month"),pred.type="re"))
# 
# (pp <- plot_model(mpa_mod_fig.mpa,type="pred",
#        terms=c("mpa","spp"),pred.type="re"))
```

#### Check assumptions

```{r}
plot(tti_mpa_m1)
#qqnorm(mpa_mod_fig.mpa, ~ranef(., level=2))
#https://stats.stackexchange.com/questions/77891/checking-assumptions-lmer-lme-mixed-models-in-r for above code - getting an error right now though
```

# ---------------------------------
# MODEL SELECTION 1
What covariates to include?

## Site, spp, year_month, sample_wt
```{r}
sw_mpa_mod_fig.mpa <- lmer(tti ~ mpa + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_mpa_mod_fig.mpa)
```

```{r}
sw_max_model <- lmer(tti ~ spp + dw_flam_sample_scaled + ww_flam_sample_scaled +  mpa_scaled + lfm_scaled + excess_water_scaled + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_max_model)
```

```{r}
sw_max_model_nolfm <- lmer(tti ~ spp + dw_flam_sample_scaled +  ww_flam_sample_scaled +  mpa_scaled + excess_water_scaled + site +  year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_max_model_nolfm)
```

```{r}
sw_max_model_nompa <- lmer(tti ~ spp + dw_flam_sample_scaled +  ww_flam_sample_scaled +  lfm+ excess_water_scaled + site +  year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_max_model_nompa)
```

```{r}
sw_m3 <- lmer(tti ~ spp + ww_flam_sample_scaled +  site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m3)
```

```{r}
sw_m6 <- lmer(tti ~ dw_flam_sample_scaled +  spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m6)
```

```{r}
sw_m6.5 <- lmer(tti ~ dw_flam_sample_scaled +  ww_flam_sample_scaled +  spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m6.5)
```

```{r}
sw_m7 <- lmer(tti ~ mpa_scaled + lfm_scaled+ spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m7)
```

```{r}
sw_m10 <- lmer(tti ~ lfm_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m10)

```

```{r}
sw_m11 <- lmer(tti ~ mpa_scaled*spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m11)
```

```{r}
sw_m12 <- lmer(tti ~ excess_water_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m12)
```

```{r}
sw_m12.5 <- lmer(tti ~ excess_water_scaled + mpa_scaled + lfm_scaled+ spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m12.5) ##High correlation! Don't use
```

```{r}
sw_m13 <- lmer(tti ~ excess_water_scaled + lfm_scaled+ spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m13) ##High correlation! Don't use
```

```{r}
sw_m14 <- lmer(tti ~ excess_water_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m14)
```

```{r}
sw_m15 <- lmer(tti ~ excess_water_scaled * spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(sw_m15)
```

```{r}
tab_model(sw_mpa_mod_fig.mpa, 
          sw_m11, 
          sw_m7, 
          sw_m10,
          sw_m3, 
          sw_m6, 
          sw_m6.5, 
          sw_m12, 
          sw_m12.5, 
          sw_m13, 
          sw_m14,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (scaled)', 
                         # 'spp Effect (C. megacarpus)',
                          'Water Potential x spp Effect
                          (interaction)',
                          'LFM (%)',
                          'Water Weight (g)', 
                          'Dry Weight (g)',
                          'Site Effect (Site 1)',
                          'Excess Water (scaled)',
                          'Excess Water x spp Effect
                          (interaction)'),
         dv.labels = c("mpa_spp", 
                       "sw_m11", 
                       "sw_m7", 
                       #"m10",
                       "sw_m10",
                       "sw_m3", 
                       "sw_m6", 
                       "sw_m6.5", 
                       "sw_m12",
                       "sw_m12.5", 
                       "sw_m13", 
                       "sw_m14"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity; site + spp + year_month + sample wt",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','site_yearmonth_samplewt.html')) # saving _html into figures folder
```
#####TTI top models
```{r}
tab_model(sw_m11, sw_m12.5, sw_m13, sw_m7,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (scaled)', 
                         # 'spp Effect (C. megacarpus)',
                          'Water Potential x spp Effect
                          (interaction)',
                          'LFM (%)',
                          'Water Weight (g)', 
                          'Dry Weight (g)',
                          'Site Effect (Site 1)',
                          'Excess Water (scaled)',
                          'Excess Water x spp Effect
                          (interaction)'),
         dv.labels = c(#"mpa_spp", 
                       "sw_m11", 
                       #"m7", 
                       #"m10",
                      # "m10",
                       #"m3", 
                       #"m6", 
                       #"m6.5", 
                      # "m12",
                       "sw_m12.5", 
                       "sw_m13", 
                       "sw_m7"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity; site + spp + year_month + sample wt",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','site_yearmonth_samplewt_topAIC.html')) # saving _html into figures folder
```

## Site, spp, year_month

```{r}
mpa_mod_fig.mpa <- lmer(tti ~ mpa + spp + site + year_month + (1 | individual), data = mem_data_all)

qqnorm(resid(mpa_mod_fig.mpa))
r <- resid(mpa_mod_fig.mpa)
plot(fitted(mpa_mod_fig.mpa), r)

performance::multicollinearity(mpa_mod_fig.mpa)
```

```{r}
max_model <- lmer(tti ~ spp + dw_flam_sample_scaled +  ww_flam_sample_scaled +  mpa_scaled + lfm_scaled+ excess_water_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(max_model)
```

```{r}
max_model_noww <- lmer(tti ~ spp + dw_flam_sample_scaled +  mpa_scaled + lfm_scaled+ excess_water_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(max_model_noww)
```

```{r}
max_model_nolfm <- lmer(tti ~ spp + dw_flam_sample_scaled +  ww_flam_sample_scaled +  mpa_scaled + excess_water_scaled + site +  year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(max_model_nolfm)
```

```{r}
max_model_nompa <- lmer(tti ~ spp + dw_flam_sample_scaled +  ww_flam_sample_scaled +  lfm+ excess_water_scaled + site +  year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(max_model_nompa)
```

```{r}
m3 <- lmer(tti ~ spp + ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m3)
```

```{r}
m6 <- lmer(tti ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

qqnorm(resid(m6))
r <- resid(m6)
plot(fitted(m6), r)

performance::multicollinearity(m6)
```

```{r}
m6.5 <- lmer(tti ~ dw_flam_sample_scaled +  ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m6.5)
```

```{r}
m7 <- lmer(tti ~ mpa_scaled + lfm_scaled+ spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m7)
```

```{r}
m10 <- lmer(tti ~ lfm_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

qqnorm(resid(m10))
r <- resid(m10)
plot(fitted(m10), r)

performance::multicollinearity(m10)
```

```{r}
m11 <- lmer(tti ~ mpa_scaled*spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m11)
```

```{r}
m12 <- lmer(tti ~ excess_water_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m12)
```

```{r}
m12.5 <- lmer(tti ~ dw_flam_sample_scaled +  mpa_scaled + lfm_scaled+ spp + site + year_month + (1 | individual), data = mem_data_all)

qqnorm(resid(m12.5))
r <- resid(m12.5)
plot(fitted(m12.5), r)

performance::multicollinearity(m12.5) ##High correlation! Don't use
```

```{r}
m13 <- lmer(tti ~ excess_water_scaled + lfm_scaled+ spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m13) ##High correlation! Don't use
```

```{r}
m14 <- lmer(tti ~ excess_water_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m14)
```

```{r}
m15 <- lmer(tti ~ excess_water_scaled * spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m15)
```

```{r}
tab_model(mpa_mod_fig.mpa, m11, m7, m10, m3, m6, m6.5, m12, m15, m10, m13, m14,max_model_noww,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (scaled)', 
                          'spp Effect (C. megacarpus)',
                          'Water Potential x spp Effect
                          (interaction)',
                          'LFM (%)',
                          'Water Weight (g)', 
                          'Dry Weight (g)',
                          'Site Effect (Site 1)',
                          'Excess Water (scaled)',
                          'Excess Water x spp Effect
                          (interaction)'),
         dv.labels = c("mpa_spp", 
                       "m11", 
                       "m7", 
                       "m7",
                       "m10",
                       "m3", 
                       "m6", 
                       "m6.5", 
                       "m12",
                       "m15", 
                       "m10",
                       "m13", 
                       "m14",
                       "max_model_noww"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity; site, spp, year_month",
        # caption = "site, spp, year_month",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','site_yearmonth.html')) # saving .html into figures folder
```
######TTI top models: 

The following models are the best models: 
```{r}
tab_model(m7, m11, m12.5, m13,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (scaled)', 
                          'spp Effect (C. megacarpus)',
                          'Water Potential x spp Effect
                          (interaction)',
                          'LFM (%)',
                          'Water Weight (g)', 
                          'Dry Weight (g)',
                          'Site Effect (Site 1)',
                          'Excess Water (scaled)',
                          'Excess Water x spp Effect
                          (interaction)'),
         dv.labels = c("m7", 
                       "m11", 
                       "m12.5",
                       "m13"),
         string.pred = "Coeffcient", 
         title = "BEST models with no collinearity; site, spp, year_month",
        # caption = "site, spp, year_month",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','site_yearmonth_topAIC.html')) # saving .html into figures folder
```

#TTI best model in table: 
```{r}
tab_model(m11, sw_m12.5,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'MPa (scaled)', 
                         # 'Dry weight (scaled)',
                          'A. patula',
                          "C. decurrens", 
                          "C. cordulatus", 
                          "P. jeffryii", 
                          "Q. kelloggii", 
                          "Plot",
                          "SEKI", 
                          'MPa x A. patula',
                          "MPa x C. decurrens", 
                          "MPa x C. cordulatus", 
                          "MPa x P. jeffryii", 
                          "MPa x Q. kelloggii",
                          'Excess Water (scaled)',
                          'LFM (scaled)',
                          "Sample weight (scaled"),
         dv.labels = c("sw_m11", 
                       #"m11", 
                       "sw_m12.5"),
         string.pred = "Coeffcient", 
         title = "BEST models with no collinearity; site, spp, year_month",
        # caption = "site, spp, year_month",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','tti_topAIC.html')) # saving
```



# -*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*

# MAIN MODEL SELECTION
From our first round of model selection, it appears that site, spp, and year_month are all important variables to include, and sample_wt should probably be included as well despite worsening the models slightly.

Below, I am going to perform another round of model selection with all possible permutations of the following metrics: mpa, lfm, dw_flam_sample, ww_flam_sample, excess_water_scaled with the caveat that some combinations of metrics absolutely do NOT work. Those combinations are as follows:
  - dw_flam_sample, ww_flam_sample and sample_wt
  - dw_flam_sample, lfm, ww_flam_sample
  - lfm, dw_flam_sample
  - lfm, ww_flam_sample
  - lfm, excess_water_scaled
  - ww_flam_sample, excess_water_scaled
  - dw_flam_sample, excess_water_scaled (with sample_wt)
  - dw_flam_sample, ww_flam_sample (with sample_wt)
These do not work, as live fuel moisture was used in the calculations of these metrics, therefore they return very high VIF values that signal to us that they cannot be used in the mixed effects models together




# KableExtra Table
Setting up dataframe:
```{r}
# dep.var <- c("Intercept", "spp Effect (C. megacarpus)", "Site (St. Mary's)", "Date (Jan. 2018)", "Date (Dec. 2019)","Date (Jan. 2020)", "Date (Sept. 2020)", "Sample Weight (g)", "LFM (%)", "Water Potential", "Dry Weight (g)", "Water Weight (g)", "Excess Water", "Random Effects", paste("\U03C3", "2"), paste("\U03C4", "00"), " ", "Marginal R2/Conditional R2", "AIC")
# m1.est <- c("0.599*", "-0.913***", "0.452*", "-0.547", "-0.506", "0.022", "-0.977***", "-0.153*", "-0.240**", " ", " ", " ", " ", " ", "2.36", "0.08ind", " ", "0.192/0.219", "1696.552")
# m2.est <- c("-0.060", "-0.835***", "0.471*", "-0.573*", "-0.748*", "-0.269", "-0.965***", "-0.137"," ", "-0.137***", " ", " ", " ", " ", "2.29", "0.02ind", " ", "0.230/0.238", "1676.524")
# m3.est <- c("0.596*", "-0.965***", "0.437*", "-0.563", "-0.408", "0.134", "-0.965***", "-0.289***"," ", " ", "0.347***", " ", " ", " ", "2.34", "0.07ind", " ", "0.202/0.224", "1690.926")
# m4.est <- c("0.594*", "-0.956***", "0.439*", "-0.562", "-0.412", "0.118", "-0.965***", "-0.050"," ", " ", " ", "-0.343***", " ", " ", "2.35", "0.07ind", " ", "0.201/0.223", "1691.375")
# m5.est <- c("0.595*", "-0.961***", "0.438*", "-0.561", "-0.407", "0.129", "-0.965***", "-0.169*", " ", " ", " ", " ", "-0.324***", " ", "2.34", "0.07ind", " ", "0.201/0.223", "1691.249")
# m6.est <- c("-0.101", "-0.823***", "0.474*", "-0.555", "-0.763*", "-0.293", "-0.952***", "-0.137", "0.034", "-0.143***", " ", " ", " ", " ", "2.30", "0.02ind", " ", "0.230/0.236", "1681.234")
# m7.est <- c("-0.081", "-0.828***", "0.473*", "-0.567*", "-0.761", "-0.286", "-0.962***", "-0.129", " ", "-0.141***", "-0.019", " ", " ", " ", "2.30", "0.02ind", " ", "0.230/0.237", "1680.822")
# m8.est <- c("-0.090", "-0.825***", "0.474*", "-0.565*", "-0.766*", "-0.292", "-0.960***", "-0.145", " ", "-0.142***", " ", "0.027", " ", " ", "2.30", "0.02ind", " ",  "0.230/0.237", "1680.798")
# m9.est <- c("-0.085", "-0.826***", "0.473*", "-0.566*", "-0.764*", "-0.289", "-0.961***", "-0.136", " ", "-0.142***", " ", " ", "0.021", " ", "2.30", "0.02ind", " ", "0.230/0.237", "1680.941")
# m10.est <- c("-0.087", "-0.823***", "0.474*", "-0.567*", "-0.769*", "-0.298", "-0.963***", " ", " ", "-0.142***", "-0.202", "-0.178", " ", " ", "2.30", "0.02ind", " ", "2.30/2.37", "1680.284")
# m11.est <- c("0.595*", "-0.959***", "0.439*", "-0.561", "-0.408", "0.124", "-0.967***", " ", " ", " ", "-0.470*", " ", "-0.765***", " ", "2.35", "0.07ind", " ", "0.201/0.223", "1689.435")
# m12.est <- c("0.596*", "-0.956***", "0.439*", "-0.564", "-0.415", "0.118", "-0.968***", " ", " ", " ", "-0.062", "-0.408***", " ", " ", "2.35", "0.07ind", " ", "0.201/0.223", "1690.743")
# main.mem.table.df <- data.frame(dep.var, m1.est, m2.est, m3.est, m4.est, m5.est, m6.est, m7.est, m8.est, m9.est, m10.est, m11.est, m12.est)
```

Kable table:
```{r}
# main.mem.table.df %>%
#   kable(format = 'html', escape = F, col.names = c(' ', 'Model 1', 'Model 2','Model 3', 'Model 4', 'Model 5', 'Model 6', 'Model 7', 'Model 8', 'Model 9', 'Model 10', 'Model 11', 'Model 12')) %>% 
#   kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T, stripe_color = "black") %>% 
#   row_spec(c(14), background = "#D3D3D3", bold = T) %>%
#   row_spec(c(17), background = "black") %>% 
#   row_spec(c(18:19), bold = T) %>%
#   row_spec(c(1:19), color = "black") %>% 
#   column_spec(c(1), bold = T, border_right = T) %>% 
#   save_kable(here('figures', 'MEM_figures', 'Main_MEM_Selection_kable.html'))
```

# -------------------------------
# Splitting by spp (Supplemental Table)
## tti
```{r}
# c.p1 <- lmer(tti ~ mpa_scaled + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.p2 <- lmer(tti ~ lfm + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.p3 <- lmer(tti ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.p4 <- lmer(tti ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.p5 <- lmer(tti ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt   + site + year_month + (1 | individual), data = mem.CEME.subset)
# ```
# 
# ```{r}
# a.p1 <- lmer(tti ~ mpa_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.p2 <- lmer(tti ~ lfm + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.p3 <- lmer(tti ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.p4 <- lmer(tti ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.p5 <- lmer(tti ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# ```
# 
# ### Table
# ```{r}
# tab_model(a.p1, a.p5, a.p3, a.p2, a.p4, c.p1, c.p3, c.p4, c.p5, c.p2,
#           show.reflvl = FALSE, 
#           digits = 3, 
#           show.aic = TRUE,
#           show.ci = FALSE,
#           show.icc = FALSE, 
#           pred.labels = c(),
#          dv.labels = c("Model 1 (ADFA)", "Model 5 (ADFA)", "Model 3 (ADFA)", "Model 2 (ADFA)",  "Model 4 (ADFA)", "Model 1 (CEME)", "Model 3 (CEME)",  "Model 4 (CEME)", "Model 5 (CEME)",  "Model 2 (CEME)"),
#          string.pred = "Coeffcient", 
#          title = "models with no collinearity",
#   string.p = "P-Value", 
#   p.style = "stars",
#   file = here('figures', 'MEM_figures','tti_by_spp.html')) # saving .html into figures folder
# ```
# 
# ## Time to Ignition
# ```{r}
# c.t1 <- lmer(tti ~ mpa_scaled + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.t2 <- lmer(tti ~ lfm + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.t3 <- lmer(tti ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.t4 <- lmer(tti ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.t5 <- lmer(tti ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt   + site + year_month + (1 | individual), data = mem.CEME.subset)
# ```
# 
# ```{r}
# a.t1 <- lmer(tti ~ mpa_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.t2 <- lmer(tti ~ lfm + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.t3 <- lmer(tti ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.t4 <- lmer(tti ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.t5 <- lmer(tti ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# ```
# 
# ### Table
# ```{r}
# tab_model(a.t5, a.t1, a.t3, a.t2, a.t4, c.t5, c.t1, c.t3, c.t4, c.t2,
#           show.reflvl = FALSE, 
#           digits = 3, 
#           show.aic = TRUE, 
#           show.ci = FALSE,
#           show.icc = FALSE, 
#           pred.labels = c(),
#          dv.labels = c("Model 5 (ADFA)", "Model 1 (ADFA)", "Model 3 (ADFA)", "Model 2 (ADFA)",   "Model 4 (ADFA)", "Model 5 (CEME)", "Model 1 (CEME)", "Model 3 (CEME)",  "Model 4 (CEME)", "Model 2 (CEME)"),
#          string.pred = "Coeffcient", 
#          title = "models with no collinearity",
#   string.p = "P-Value", 
#   p.style = "stars",
#   file = here('figures', 'MEM_figures','TTI_by_spp.html')) # saving .html into figures folder
# ```
# 
# ## Flame Duration
# ```{r}
# c.f1 <- lmer(fd ~ mpa_scaled + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.f2 <- lmer(fd ~ lfm + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.f3 <- lmer(fd ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.f4 <- lmer(fd ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.f5 <- lmer(fd ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt   + site + year_month + (1 | individual), data = mem.CEME.subset)
# ```
# 
# ```{r}
# a.f1 <- lmer(fd ~ mpa_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.f2 <- lmer(fd ~ lfm + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.f3 <- lmer(fd ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.f4 <- lmer(fd ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.f5 <- lmer(fd ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# ```
# 
# ### Table
# ```{r}
# tab_model(a.f1, a.f4, a.f2, a.f3, a.f5, c.f4, c.f2, c.f1, c.f3, c.f5,
#           show.reflvl = FALSE, 
#           digits = 3, 
#           show.aic = TRUE, 
#           show.ci = FALSE,
#           show.icc = FALSE, 
#           pred.labels = c(),
#          dv.labels = c("Model 1 (ADFA)",  "Model 4 (ADFA)", "Model 2 (ADFA)", "Model 3 (ADFA)", "Model 5 (ADFA)",  "Model 4 (CEME)", "Model 2 (CEME)", "Model 1 (CEME)", "Model 3 (CEME)", "Model 5 (CEME)"),
#          string.pred = "Coeffcient", 
#          title = "models with no collinearity",
#   string.p = "P-Value", 
#   p.style = "stars",
#   file = here('figures', 'MEM_figures','FD_by_spp.html')) # saving .html into figures folder
# ```
# 
# ## Glow Duration
# ```{r}
# c.g1 <- lmer(gd ~ mpa_scaled + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.g2 <- lmer(gd ~ lfm + site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.g3 <- lmer(gd ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.g4 <- lmer(gd ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.CEME.subset)
# 
# c.g5 <- lmer(gd ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt   + site + year_month + (1 | individual), data = mem.CEME.subset)
# ```
# 
# ```{r}
# a.g1 <- lmer(gd ~ mpa_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.g2 <- lmer(gd ~ lfm + site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.g3 <- lmer(gd ~ ww_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.g4 <- lmer(gd ~ dw_flam_sample_scaled +  site + year_month + (1 | individual), data = mem.adfa.subset)
# 
# a.g5 <- lmer(gd ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + site + year_month + (1 | individual), data = mem.adfa.subset)
# ```
# 
# ### Table
# ```{r}
# tab_model(a.g5, a.g4, a.g2, a.g3, a.g1, c.g5, c.g4, c.g1, c.g2, c.g3,
#           show.reflvl = FALSE, 
#           digits = 3, 
#           show.aic = TRUE, 
#           show.ci = FALSE,
#           show.icc = FALSE, 
#           pred.labels = c(),
#          dv.labels = c("Model 5 (ADFA)", "Model 4 (ADFA)", "Model 2 (ADFA)",  "Model 3 (ADFA)", "Model 1 (ADFA)", "Model 5 (CEME)", "Model 4 (CEME)", "Model 1 (CEME)",  "Model 2 (CEME)", "Model 3 (CEME)"),
#          string.pred = "Coeffcient", 
#          title = "models with no collinearity",
#   string.p = "P-Value", 
#   p.style = "stars",
#   file = here('figures', 'MEM_figures','GD_by_spp.html')) # saving _html into figures folder
# ```
# 
# ## SUPP: Kable Table
# ```{r}
# dep.var <- c("tti", " ", " ", " ", " ",  " ", " ", " ", " ", " ", "Time to Ignition (s)", " ", " ", " ", " "," ", " ", " ", " ",  " ", "Flame Duration (s)", " ", " ", " ", " "," ", " ", " ", " ",  " ", "Glow Duration (s)", " ", " ", " "," ", " ", " ", " ",  " ", " ")
# sp.lab <- c("Adenostoma fasciculatum", " ", " ", " ", " ", "Ceanothus megacarpus", " ", " ", " ", " ", "Adenostoma fasciculatum", " ", " ", " ", " ", "Ceanothus megacarpus", " ", " ", " ", " ", "Adenostoma fasciculatum", " ", " ", " ", " ", "Ceanothus megacarpus", " ", " ", " ", " ", "Adenostoma fasciculatum", " ", " ", " ", " ", "Ceanothus megacarpus", " ", " ", " ", " ")
# fix.fx <- c("Water Potential", "Water Potential, Sample Weight & Dry Weight", "Wet Weight", "Live Fuel Moisture", "Dry Weight", "Water Potential", "Wet Weight", "Dry Weight", "Water Potential, Sample Weight & Dry Weight", "Live Fuel Moisture", "Water Potential, Sample Weight & Dry Weight", "Water Potential", "Wet Weight", "Live Fuel Moisture", "Dry Weight", "Water Potential, Sample Weight & Dry Weight", "Water Potential", "Wet Weight", "Dry Weight", "Live Fuel Moisture", "Water Potential", "Dry Weight", "Live Fuel Moisture", "Wet Weight", "Water Potential, Sample Weight & Dry Weight", "Dry Weight", "Live Fuel Moisture", "Water Potential", "Wet Weight", "Water Potential, Sample Weight & Dry Weight", "Water Potential, Sample Weight & Dry Weight", "Dry Weight", "Live Fuel Moisture", "Wet Weight", "Water Potential", "Water Potential, Sample Weight & Dry Weight", "Dry Weight", "Water Potential", "Live Fuel Moisture", "Wet Weight")
# est <- c('-0.419***',	'-0.477***', '-0.314**', '-0.186', '0.107', '-0.430***', '-0.427***', '0.363***', '-0.317*', '-0.347**', "4.578***",	'4.239***', '3.329***', '2.013**', '-1.452', '5.159***',	'5.501***', '4.798***', '-3.901***', '3.714***', '0.677*', '0.642*', '-0.566', '-0.574', '-0.561', '0.646', '-0.569', '-0.475', '-0.324', '-0.296', '0.065', '5.119**', '-2.799', '-2.381', '-1.922', '-2.357', '3.973', '-2.619', '-2.084', '-0.411')
# aic.values <- c(1002.567, 1006.955,	1011.885,	1015.979,	1018.052,	675.567,	679.110,	682.000,	682.408,	683.557, 1943.187,	1948.918,	1970.582,	1980.425,	1984.906,	1381.167,	1382.278,	1403.649,	1411.852,	1415.261, 1514.945,	1516.389,	1516.763,	1517.257,	1518.621,	1054.163,	1055.065,	1055.530,	1056.797,	1057.601, 2403.453,	2406.658,	2411.868,	2412.876,	2413.393,	1735.668,	1741.923,	1743.649,	1744.252,	1745.063)
# bic.values <- c(1027.5186, 1039.0352, 1036.8362, 1040.9305, 1043.0035,  698.1477,  701.6903, 704.5801,  711.4394,  706.1369, 1975.2679, 1973.8693, 1995.5338, 2005.3769, 2009.8577, 1410.1989, 1404.8579, 1426.2289, 1434.4318, 1437.8416, 1539.8966,1541.3407, 1541.7144, 1542.2083, 1550.7014, 1076.7429, 1077.6451, 1078.1099, 1079.3774, 1086.6325, 2435.5335, 2431.6095, 2436.8196, 2437.8279, 2438.3448, 1764.7001, 1764.5028, 1766.2295, 1766.8324, 1767.6434)
# r2.values <- c('0.154 / NA','	0.166 / NA',	'0.122 / 0.125',	'0.110 / 0.116',	'0.101 / NA',	'0.150 / 0.230',	'0.130 / 0.232',	'0.115 / 0.233',	'0.155 / 0.238',	'0.107 / 0.224', '0.250 / NA',	'0.232 / 0.237',	'0.167 / 0.202',	'0.136 / 0.185',	'0.118 / 0.156',	'0.286 / 0.308',	'0.282 / 0.313',	'0.190 / 0.246',	'0.151 / 0.244',	'0.133 / 0.239', '0.063 / 0.162',	'0.056 / 0.157',	'0.055 / 0.174',	'0.053 / 0.174',	'0.066 / 0.160',	'0.043 / 0.162',	'0.037 / 0.129',	'0.037 / 0.135',	'0.028 / 0.107',	'0.047 / 0.177', '0.249 / 0.290',	'0.247 / 0.289',	'0.233 / 0.283',	'0.230 / 0.282',	'0.230 / 0.280',	'0.125 / 0.171',	'0.113 / 0.131',	'0.106 / 0.126',	'0.101 / 0.112',	'0.098 / 0.110')
# d.aic <- c(0, 4.388, 9.318, 13.412, 15.485, 0, 3.543, 6.433, 6.841, 7.990, 0, 5.731, 27.395, 37.238, 41.719, 0, 1.111, 22.482, 30.685, 34.094, 0, 1.444, 1.818, 2.312, 3.676, 0, 0.902, 1.367, 2.634, 3.438, 0, 3.205, 8.415, 9.423, 9.940, 0, 6.255, 7.981, 8.584, 9.395)
# mem.spp.table.df <- data.frame(dep.var, sp.lab, fix.fx, est, d.aic, r2.values)
# ```
# 
# ```{r}
# mem.spp.table.df %>%
#   kable(format = 'html', escape = F, col.names = c('Dependent Variable', 'spp', 'Model Fixed Effects', 'Water Estimate','\U0394 AIC', expression('Marginal R2/Conditional R2'))) %>% 
#   kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T) %>% 
#   row_spec(c(1, 6, 11, 16, 21, 26, 31, 36), background = "#D3D3D3") %>%
#   row_spec(c(1:40), color = 'black') %>% 
#   row_spec(c(1, 6, 11, 16:17, 21:23, 26:28, 31, 36), bold = T) %>% 
#   column_spec(2, italic = T) %>% 
#   column_spec(1, width = "0.1in") %>% 
#   save_kable(here('figures', 'supp-figures', 'Supp_spp_Split_MEM_kable.html'))
```

# -----------------------------------
# Predicting fh
From our first round of model selection, it appears that site, spp, and year_month are all important variables to include, and sample_wt should probably be included as well despite worsening the models slightly.

Below, I am going to perform another round of model selection with all possible permutations of the following metrics: mpa, lfm, dw_flam_sample, ww_flam_sample, excess_water_scaled with the caveat that some combinations of metrics absolutely do NOT work. Those combinations are as follows:
  - dw_flam_sample, ww_flam_sample and sample_wt
  - dw_flam_sample, lfm, ww_flam_sample
  - lfm, dw_flam_sample
  - lfm, ww_flam_sample
  - lfm, excess_water_scaled
  - ww_flam_sample, excess_water_scaled
  - dw_flam_sample, excess_water_scaled (with sample_wt)
  - dw_flam_sample, ww_flam_sample (with sample_wt)
These do not work, as live fuel moisture was used in the calculations of these metrics, therefore they return very high VIF values that signal to us that they cannot be used in the mixed effects models together

```{r}
m1 <- lmer(fh ~ lfm + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m1)
```

```{r}
m2 <- lmer(fh ~ mpa_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m2)
```

```{r}
m3 <- lmer(fh ~ dw_flam_sample_scaled +  spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m3)
```

```{r}
m4 <- lmer(fh ~ ww_flam_sample_scaled +  spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m4)
```

```{r}
m5 <- lmer(fh ~ excess_water_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m5)
```

```{r}
m6 <- lmer(fh ~ lfm + mpa_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m6)
```

```{r}
m7 <- lmer(fh ~ mpa_scaled + dw_flam_sample_scaled +  spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m7)
```

```{r}
m8 <- lmer(fh ~ mpa_scaled + ww_flam_sample_scaled +  spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m8)
```

```{r}
m9 <- lmer(fh ~ mpa_scaled + excess_water_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)

performance::multicollinearity(m9)
```

```{r}
m10 <- lmer(fh ~ mpa_scaled + dw_flam_sample_scaled +  ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m10)
```

```{r}
m11 <- lmer(fh ~ dw_flam_sample_scaled +  excess_water_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m11)
```

```{r}
m12 <- lmer(fh ~ dw_flam_sample_scaled +  ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m12)
```

```{r}
tab_model(m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 'LFM (%)',
                          'spp Effect (C. megacarpus)',
                          'Site Effect (Site 1)',
                          'Sampling Date Effect (Jan 2018)',
                          'Sampling Date Effect (Dec 2019)',
                          'Sampling Date Effect (Jan 2020)',
                          'Sampling Date Effect (Sept 2020)',
                          'Sample Weight (g)',
                          'Water Potential (scaled)',
                          'Dry Weight (g)',
                          'Water Weight (g)',
                          'Excess Water (scaled)'),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4",
                       "Model 5", "Model 6", "Model 7", "Model 8", 
                       "Model 9","Model 10", 'Model 11', 'Model 12'),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','fh.html')) # saving .html into figures folder
```
# -----------------------------------
# Visualizations
## Dry Weight Effect
### Models
```{r}
m.p1 <- lmer(tti ~ mpa_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)
  
m.p2 <- lmer(fh ~ mpa_scaled + spp + site + year_month + sample_wt_scaled + (1 | individual), data = mem_data_all)
```

```{r}
r_tti <- remef(m.p1, fix = 2, ran = list(individual = c("(Intercept)")))

r_fh <- remef(m.p2, fix = 2, ran = list(individual = c("(Intercept)")))

r_mem_data_all <- mem_data_all

r_mem_data_all$r_tti <- r_tti
r_mem_data_all$r_fh <- r_fh
```
### Plots
```{r}
p1 <- ggplot(r_mem_data_all, aes(x = dw_flam_sample, y = r_tti)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Dry Weight (scaled, centered)", y = "tti (Effects Removed)") +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~spp) + 
  th

p2 <- ggplot(r_mem_data_all, aes(x = dw_flam_sample, y = tti)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Dry Weight (scaled, centered)") +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~spp) + 
  th

p3 <- ggplot(r_mem_data_all, aes(x = dw_flam_sample, y = r_fh)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Dry Weight (scaled, centered)", y = "fh (Effects Removed)") +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~spp) + 
  th

p4 <- ggplot(r_mem_data_all, aes(x = dw_flam_sample, y = fh)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Dry Weight (scaled, centered)") +
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~spp) + 
  th

ggarrange(p1, p3, p2, p4)

ggsave(here('figures', 'MEM_figures', 'remef.dry.weight.jpg'), height = 8, width = 13)
```

## Composite Model
```{r}
comp.model.df <- mem_data_all %>% 
  mutate(site.n = case_when(
    site == "St. Marys" ~ 1,
    site == "Painted Caves" ~ 2)) %>% 
  mutate(spp.n = case_when(
    spp == "ADFA" ~ 1,
    spp == "CEME" ~ 2))
  

model <- lmer(tti ~ mpa_scaled + dw_flam_sample_scaled +  spp.n + site.n + year_month + sample_wt_scaled + (1 | individual), data = comp.model.df)

comp.model.df$r_tti <- remef(model, fix = c("mpa", "sample_wt", "spp.n", "site.n"))
```

### Plots
```{r}
p1 <- ggplot(comp.model.df, aes(x = mpa, y = r_tti)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Water Potential (scaled, centered)", y = "tti (Effects Removed)") +
  geom_smooth(method = 'lm', color = 'black') +
  th

p2 <- ggplot(comp.model.df, aes(x = dw_flam_sample, y = r_tti)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Dry Weight (scaled, centered)", y = "tti (Effects Removed)") +
  geom_smooth(method = 'lm', color = 'black') +
  theme(axis.title.y = element_blank()) +
  th

p3 <- ggplot(comp.model.df, aes(x = sample_wt, y = r_tti)) +
  geom_point(alpha = 0.6, size = 1) +
  labs(x = "Sample Weight (scaled, centered)", y = "tti (Effects Removed)") +
  geom_smooth(method = 'lm', color = 'black') +
  theme(axis.title.y = element_blank()) +
  th

ggarrange(p1,p2,p3, nrow = 1)
```


# -----------------------------------
## 2.0.2 Tables of models

"The variance inflation factor is a measure to analyze the magnitude of multicollinearity of model terms. A VIF less than 5 indicates a low correlation of that predictor with other predictors. A value between 5 and 10 indicates a moderate correlation, while VIF values larger than 10 are a sign for high, not tolerable correlation of model predictors.

The Increased SE column in the output indicates how much larger the standard error is due to the correlation with other predictors." (https://easystats.github.io/blog/posts/performance_check_collinearity/)
https://strengejacke.github.io/sjPlot/articles/tab_model_estimates.html 
##### Tables
```{r}
tab_model(mpa_mod_fig.mpa, m11, m7, m10, m3, m6, m6.5, m12, m15,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (scaled)', 
                          'spp Effect (C. megacarpus)',
                          'Water Potential x spp Effect
                          (interaction)',
                          'LFM (%)',
                          'Water Weight (g)', 
                          'Dry Weight (g)',
                          'Site Effect (Site 1)',
                          'Excess Water (scaled)',
                          'Excess Water x spp Effect
                          (interaction)'),
         dv.labels = c("mpa_spp", 
                       "m11", 
                       "m7", 
                       "m7",
                       "m10",
                       "m3", 
                       "m6", 
                       "m6.5", 
                       "m12",
                       "m15"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures','MEM_figures','site.yearmonth.samplewt')) # saving .html into figures folder
```

```{r}
#tab_model(top_model, m7, m10, m3, m6) 
tab_model(max_model, m7, mpa_mod_fig.mpa, max_model_nolfm, max_model_nompa, m12.5, m13,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'spp Effect (C. megacarpus)',
                          'Dry Weight (g)',
                          'Water Weight (g)',
                          'Water Potential (scaled)',
                          'LFM (%)',
                          'Excess Water (scaled)',
                          'Site Effect (Site 1)',
                          'Water Potential (MPa, unscaled)'),
         dv.labels = c("max_model", 
                       "m7**", 
                       "mpa_spp**", 
                       "max_model_nolfm", 
                      "max_model_nompa", 
                      "m12.5", 
                      "m13"),
         string.pred = "Coeffcient", 
         title = "models WITH collinearity (except **)",
  string.p = "P-Value", 
  p.style = "stars")
```

The intra-class correlation coefficient (ICC) is a related statistic that quantifies the proportion of variance explained by a grouping (random) factor in multilevel/hierarchical data.

##### kableExtra Table
First, making dataframe with fixed effects, water estimate, spp estimate, AIC, marginal and conditional R2 values, and deltaAIC (for barebones models with only one water-related fixed effect:
```{r}
fix.fx <- c("spp & Water Potential", "spp & LFM", "spp & Dry Weight", "spp & Wet Weight")
est1 <- c('-0.121***', '-0.084', '0.072','-0.061')
est2 <- c('-1.112***', '-1.035***', '-0.072***', '-0.061***')
aic.values <- c(1682.036, 1703.207, 1703.476, 1703.673)
r2.values <- c('0.189/0.196', '0.145/0.161', '0.145/0.163', '0.144/0.161')
d.aic <- c(0, 21.171, 21.44, 21.637)
mem.table.df <- data.frame(fix.fx, est1, est2, aic.values, r2.values, d.aic)
```
there was probably a more elegant way to do that (just like PCA table), but since there aren't too many numbers to enter in by hand, I thought it would be quicker to just go ahead and do so.

Now, using kableExtra package to visualize how each component is weighted by each flam. metric
```{r}
mem.table.df %>%
  kable(format = 'html', escape = F, col.names = c('Model Fixed Effects', 'Water Estimate', 'spp Estimate', 'AIC', expression('Marginal R2/Conditional R2'), 'Change in AIC')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T) 
```


## 2.0.3 Other figures
### Predicted vs. Observed tti
```{r}
predicted_tti_df <- data.frame(predicted_tti = predict(mpa_mod_fig.mpa), observed_tti = mem_data_all$tti)

ggplot(data = predicted_tti_df, aes(x = predicted_tti, y = observed_tti)) +
  geom_point(color = "lightblue", size = .7) +
  geom_abline() +
  labs(title = "Predicted vs. Observed tti", subtitle = "All dates, mpa model",
       x = "Predicted tti", y = "Observed tti") +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) +
  ylim(-3, 3) +
  xlim(-3, 3) +
  coord_equal()
```

```{r}
effects_mpa_fig.mpa <- effects::effect(term= "mpa", 
                                   mod= mpa_mod_fig.mpa, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_mpa_fig.mpa <- as.data.frame(effects_mpa_fig.mpa)
```

### MPa vs. tti Visualization

**Figure X.** Model estimate of flammability (principle component 1) from water potential. 
##### spp separation
```{r, message=FALSE, results='hide',fig.height= 4, fig.length = 8}
# Separating by spp
p <- ggplot() + 
  geom_point(data= mem_data_all, aes(mpa, tti, color = spp), size = 1) + 
  geom_line(data=x_mpa_fig.mpa, aes(x=mpa, y=fit), color="#db8872") +
  geom_ribbon(data= x_mpa_fig.mpa, aes(x=mpa, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Potential (-Mpa)", y="Principle Component 1") +
  scale_color_manual(values = c("#b08ba5", "#ffb178"))
  th 

p +
  annotate("segment",x = -11, xend = -11, y = -3, yend = 3,
           colour = "#db8872", size = 1, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
  annotate("text", x= -11, y= 4, label= "More", size = 3) +
  annotate("text", x= -11, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= -11, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= -11, y= -4, label= "Flammable", size = 3)  +
  scale_x_continuous(limits = c(-11.5, 0), breaks= c(-10, -8, -6, -4, -2, 0)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 

ggsave(here("figures", 'extra-figures', "tti.vs.mpa.jpg"))
```

##### Water status separation
```{r, message=FALSE, results='hide',fig.height= 4, fig.length = 8}
# Separating by spp
p <- ggplot() + 
  geom_point(data= mem_data_all, aes(mpa, tti, color = hydration), size = .5) + 
  geom_line(data=x_mpa_fig.mpa, aes(x=mpa, y=fit), color="#db8872") +
  geom_ribbon(data= x_mpa_fig.mpa, aes(x=mpa, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Potential (-Mpa)",
       y="Principle Component 1", 
       color = "Timing")+
  scale_color_manual(values=met.brewer("Morgenstern", 7)) +
  th 
p +
  annotate("segment", x = -11, xend = -11, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
  annotate("text", x= -11, y= 4, label= "More", size = 3) +
  annotate("text", x= -11, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= -11, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= -11, y= -4, label= "Flammable", size = 3)  +
  scale_x_continuous(limits = c(-11.5, 0), breaks= c(-10, -8, -6, -4, -2, 0)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) 
```


#------------------------------------
# 2.1. Predicting raw metrics (part 2)
## Time to Ignition
Models
```{r}
m1 <- lmer(tti ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(tti ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(tti ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(tti ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(tti ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures','MEM_figures','mem_TTI.html')) # saving .html into figures folder
```

## Flame Height
Models
```{r}
m1 <- lmer(fh ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(fh ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(fh ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(fh ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(fh ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures','MEM_figures','mem.FH.html')) # saving .html into figures folder
```

## Glow Duration
Models
```{r}
m1 <- lmer(gd ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(gd ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(gd ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(gd ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(gd ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures','MEM_figures','mem.GD.html')) # saving .html into figures folder
```

## Flame Duration
Models
```{r}
m1 <- lmer(fd ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(fd ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(fd ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(fd ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(fd ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','mem.FD.html')) # saving .html into figures folder
```

## Max. Temp.
Models
```{r}
m1 <- lmer(temp.max ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(temp.max ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(temp.max ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(temp.max ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(temp.max ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','mem.MAXTEMP.html')) # saving .html into figures folder
```

## Post-Flame Glow
Models
```{r}
m1 <- lmer(pfg ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(pfg ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(pfg ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(pfg ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(pfg ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','mem.PFG.html')) # saving .html into figures folder
```

## Time to First Glow
Models
```{r}
m1 <- lmer(ttfg ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(ttfg ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(ttfg ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(ttfg ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(ttfg ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','mem.TTFG.html')) # saving .html into figures folder
```

## Glow to Ignition
Models
```{r}
m1 <- lmer(gti ~ mpa_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)

m2 <- lmer(gti ~ lfm + spp + site + year_month + (1 | individual), data = mem_data_all)

m3 <- lmer(gti ~ ww_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m4 <- lmer(gti ~ dw_flam_sample_scaled +  spp + site + year_month + (1 | individual), data = mem_data_all)

m5 <- lmer(gti ~ mpa_scaled + dw_flam_sample_scaled +  sample_wt_scaled + spp + site + year_month + (1 | individual), data = mem_data_all)
```

Table
```{r}
tab_model(m1, m2, m3, m4, m5,
          show.reflvl = FALSE, 
          digits = 3, 
          show.aic = TRUE,
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c(),
         dv.labels = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','mem.GTI.html')) # saving .html into figures folder
```

# MAIN TABLE
Only looking at tti, TTI, FD and GD
```{r}
mem.table2.df <- data.frame(dep.var, fix.fx, est1, d.aic, r2.values)
mem.table2.df %>%
  mutate(dep.var = cell_spec(dep.var, 'html', color = 'black', bold = T), fix.fx = cell_spec(fix.fx, 'html', color = 'black'), est1 = cell_spec(est1, 'html', color = 'black'), d.aic = cell_spec(d.aic, 'html', color = 'black'), r2.values = cell_spec(r2.values, 'html', color = 'black')) %>% 
  kable(format = 'html', escape = F, col.names = c('Dependent Variable', 'Model Fixed Effects', 'Water Estimate','\U0394 AIC', expression('Marginal R2/Conditional R2'))) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T) %>% 
  row_spec(c(1, 7, 13, 19), background = "#D3D3D3", bold = T, font_size = 16) %>% 
  row_spec(c(2, 8, 14, 15, 16, 20), bold = T) %>% 
  save_kable(here('figures', 'main-figures', 'Table2_MEM_kable.html'))
```

## BIC, AIC included
```{r}
dep.var <- c("tti", " ", " ", " ", " ", " ", "Time to Ignition (s)", " ", " ", " ", " ", " ", "Flame Duration (s)", " ", " ", " ", " ", " ", "Glow Duration (s)", " ", " ", " ", " ", " ")
fix.fx <- c(" ", "Water Potential","Composite Model", "Wet Weight", "Live Fuel Moisture", "Dry Weight",
            " ", "Composite Model", "Water Potential",  "Wet Weight", "Live Fuel Moisture", "Dry Weight",
            " ", "Water Potential",  "Dry Weight", "Live Fuel Moisture",  "Composite Model", "Wet Weight",
             " ", "Composite Model", "Dry Weight", "Live Fuel Moisture", "Water Potential", "Wet Weight")
est1 <- c(" ", '-0.140***', '-0.141***', '-0.364***', '-0.246**','-0.215*',
           " ", '4.890***','4.776***', '3.955***', '2.636***', '-2.502***',
          " ", '-0.591**',  '0.645**', '-0.570*', '-0.455', '-0.468*',
          " ", '-0.879', '4.668***','-2.567', '-2.261', '-1.544')
aic.values <- c(" ", '1674.577', '1680.822', '1686.568', '1695.289', '1697.884',
                " ", '3327.326', '3332.028',	'3375.534',	'3397.523',	'3400.992',
                " ", '2566.495',	'2566.660',	'2567.954',	'2569.929',	'2570.455',
              	" ", '4147.778', '4152.387',	'4159.953', '4160.481',	'4162.278')
bic.values <- c(" ", '1715.603', '1730.053', '1727.594', '1736.315', '1738.909',
                " ", '3376.557', '3373.053', '3416.559', '3438.548', '3442.017', 
                " ", '2607.521', '2607.685', '2608.980', '2619.160', '2611.481',
               " ",  '4197.009', '4193.413', '4200.978', '4201.506', '4203.303')
r2.values <- c(" ", '0.225/0.237','0.230/0.237', '0.201/0.224', '0.185/0.217', '0.180/0.206',
              	" ", '0.345 / 0.345', '0.336 / 0.346',	'0.269 / 0.306',	'0.233 / 0.293', '0.225 / 0.273',
               " ", '0.059 / 0.154',	'0.058 / 0.156',	'0.055 / 0.156',	'0.063 / 0.160',	'0.049 / 0.149',
               " ", '0.238 / 0.275', '0.233 / 0.269', '0.220 / 0.259',	'0.220 / 0.260',	'0.216 / 0.258')
d.aic <- c(" ", '0', '6.25', '11.99', '20.71', '23.31',
           " ", '0', '4.702', '48.208', '70.197', '73.666',
           " ", '0', '0.165', '1.459', '3.434', '3.960',
           " ", '0', '4.609', '12.175', '12.703', '14.500')
deltaAIC <- c('\U0394 AIC')

mem.table.df <- data.frame(dep.var, fix.fx, est1, d.aic, aic.values, bic.values, r2.values)
mem.table.df %>%
  mutate(dep.var = cell_spec(dep.var, 'html', color = 'black', bold = T), fix.fx = cell_spec(fix.fx, 'html', color = 'black'), est1 = cell_spec(est1, 'html', color = 'black'), d.aic = cell_spec(d.aic, 'html', color = 'black'), aic.values = cell_spec(aic.values, 'html', color = 'black'), bic.values = cell_spec(bic.values, 'html', color = 'black'), r2.values = cell_spec(r2.values, 'html', color = 'black')) %>% 
  kable(format = 'html', escape = F, col.names = c('Dependent Variable', 'Model Fixed Effects', 'Water Estimate','\U0394 AIC', 'AIC', 'BIC', expression('Marginal R2/Conditional R2'))) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T) %>% 
  row_spec(c(1, 7, 13, 19), background = "#D3D3D3", bold = T, font_size = 16) %>% 
  row_spec(c(2, 8, 14, 15, 16, 20), bold = T) %>% 
  save_kable(here('figures', 'extra-figures', 'expanded_MEM_kable.html'))
```

## Shortened Table (for presentation)
```{r}
dep.var.s <- c("Ignitability-Combustibility Proxy (tti)", "Time to Ignition (s)", "Flame Duration (s)", " ", " ", "Glow Duration (s)", "Flame Height (cm)", " ")
top.models <- c("Water Potential", "Dry Weight, Sample Weight & Water Potential", "Water Potential", "Dry Weight", "LFM", "Dry Weight, Sample Weight & Water Potential", "Water Potential", "Dry Weight, Sample Weight & Water Potential")
significance <- c("p<0.001", "p<0.001", "p<0.01", "p<0.01", "p<0.05", "non-significant", "p<0.001", "p<0.01")
shortened.table.df <- data.frame(dep.var.s, top.models, significance)

shortened.table.df %>%
  mutate(dep.var.s = cell_spec(dep.var.s, 'html', color = 'black', bold = T), top.models = cell_spec(top.models, 'html', color = 'black'), significance = cell_spec(significance, 'html', color = 'black')) %>% 
  kable(format = 'html', escape = F, col.names = c('Dependent Variable', 'Top Model(s)', 'Significance')) %>% 
  kable_styling(bootstrap_options = c('hover', 'bordered', 'condensed'), fixed_thead = T) %>% 
  save_kable(here('figures', 'extra-figures', 'shortened_MEM_kable.html'))
```

# ----------------------------------
# Residuals of flam ~ sample_wt, flam ~ dry weight
Based on Lee's suggestion, doing a variety of models and checking their residuals
```{r}
m1 <- lm(tti ~ sample_wt, data = mem_data_all)
res.m1 <- resid(m1)

plot(fitted(m1), res.m1)
abline(0,0)

qqnorm(res.m1)
```

```{r}
m2 <- lm(tti ~ dw_flam_sample, data = mem_data_all)
res.m2 <- resid(m2)

plot(fitted(m2), res.m2)
abline(0,0)

qqnorm(res.m2)
```

```{r}
m3 <- lm(tti ~ mpa_scaled + sample_wt_scaled + dw_flam_sample, data = mem_data_all)
res.m3 <- resid(m3)

plot(fitted(m3), res.m3)
abline(0,0)

qqnorm(res.m3)
```

Note the effects of site, spp, sampling date on residuals
```{r}
m4 <- lm(tti ~ mpa_scaled + site + spp + year_month, data = mem_data_all)
res.m4 <- resid(m4)

plot(fitted(m4), res.m4)
abline(0,0)

qqnorm(res.m4)
```



# -----------------------------------
# Excess dry weight metric
In an attempt to capture the dry weight (effectively, woodiness), wet weight and total sample weight of each datapoint, trying to transform dry weight metric so that it is not colinear with sample weight

```{r}
mem_data_all <- mem_data_all %>% 
  mutate(excess_dw_centered = dw_flam_sample - mean(dw_flam_sample)) %>% 
  mutate(excess_dw_percent = (dw_flam_sample - mean(dw_flam_sample))/mean(dw_flam_sample))
```

```{r}
m1 <- lmer(tti ~ spp + excess.dw.centered + excess_water + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m1)

# High correlation
```

```{r}
m2 <- lmer(tti ~ spp + excess.dw.centered + excess_water + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m2)

# Moderate correlation
```

```{r}
m3 <- lmer(tti ~ spp + excess.dw.percent + excess_water + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m3)

# High correlation
```

```{r}
m4 <- lmer(tti ~ spp + excess.dw.percent + excess_water + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m4)

# Moderate correlation
```

```{r}
m5 <- lmer(tti ~ spp + excess.dw.centered + mpa_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m5)

# LOW correlation
```

```{r}
m6 <- lmer(tti ~ spp + excess.dw.centered + lfm_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m6)

# Moderate correlation
```

```{r}
m7 <- lmer(tti ~ spp + dw_flam_sample_scaled +  excess_water_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m7)

# VERY High correlation
```

```{r}
m8 <- lmer(tti ~ spp + dw_flam_sample_scaled +  mpa_scaled + sample_wt_scaled + site + year_month + (1 | individual), data = mem_data_all)

performance::multicollinearity(m8)

# LOW correlation
```


```{r}
tab_model(m1, m2, m3, m4, m5, m6, m7, m8,
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (scaled)', 
                          'spp Effect (C. megacarpus)',
                          'Water Potential x spp Effect
                          (interaction)',
                          'LFM (%)',
                          'Water Weight (g)', 
                          'Dry Weight (g)',
                          'Site Effect (Site 1)',
                          'Excess Water (scaled)',
                          'Excess Water x spp Effect
                          (interaction)'),
         dv.labels = c("mpa_spp", 
                       "m11", 
                       "m7", 
                       "m7",
                       "m10",
                       "m3", 
                       "m6", 
                       "m6.5", 
                       "m12",
                       "m15"),
         string.pred = "Coeffcient", 
         title = "models with no collinearity",
  string.p = "P-Value", 
  p.style = "stars",
  file = here('figures', 'MEM_figures','excess.dry.weight.html')) # saving .html into figures folder
```
