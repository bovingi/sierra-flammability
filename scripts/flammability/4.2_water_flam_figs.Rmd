---
title: "Mixed Effects Models - Time to Ignition"
author: "Indra Boving & Joe Celebrezze"
date: "6/21/2022"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(cowplot)
library(lmerTest)
library(ggeffects)  
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)

#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data

library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
#library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
#library(memmented)
filter = dplyr::filter
mutate = dplyr::mutate
library(nlme)
library(MetBrewer)
#install.packages("memmented")
#devtools::install_github("hohenstein/remef")
library(remef)
library(kableExtra)

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```

#Legend: 
```{r}
legend <- cowplot::get_legend(mem_data_all %>% 
ggplot(aes(y = tti, x = lfm_scaled, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(y = "Live Fuel Moisture (scaled)", 
       x = "Time to Ignition (sec.)") +
  theme(legend.text = element_text(size = 17),  # , face = 'italic'
        legend.title = element_text(size = 20, face = 'bold'),
        legend.key = element_rect(fill = 'white')))
```

#------------

#Scatterplots

####TTI

```{r}
tti_scatterplot.lfm <- mem_data_all %>% 
ggplot(aes(y = tti, x = lfm, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(title = "Live Fuel Moisture (%)", 
       y = "Time to Ignition (sec.)") +
  theme(axis.title.x = element_blank(), 
             # axis.text.x = element_blank(),
              # axis.ticks.y.left = element_blank(), 
              # axis.title.y.left = element_blank(),
              # axis.text.y.left = element_blank(),
              axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              axis.title.y = element_text(face = 'bold', size = 18),
              axis.text.y = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
              legend.text = element_text(face = 'italic',),
             # panel.grid = element_blank(), axis.ticks.x = element_blank(),
              plot.title = element_text(hjust = 0.5, face = 'bold', size = 18),
              plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm'),
              legend.position = 'none')  +
  annotate(geom = "text", x = -2.5, y = 170, label = 'a',
           fontface = 'bold', size = 10) 
tti_scatterplot.lfm
  
tti_scatterplot.mpa <- mem_data_all %>% 
ggplot(aes(y = tti, x = mpa, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(title = "Water Potential (MPa)", 
       #y = "Time to Ignition (sec.)"
       ) +
  # theme(axis.title.x = element_blank(), 
  #            # axis.text.x = element_blank(),
  #             # axis.ticks.y.left = element_blank(), 
  #             # axis.title.y.left = element_blank(),
  #             # axis.text.y.left = element_blank(),
  #            axis.ticks.x = element_blank(),
  #            # axis.text.x = element_blank(),
  #             axis.ticks.y = element_blank(),
  #             axis.title.y = element_blank(),
  #             axis.text.y = element_blank(),
  #            # panel.grid = element_blank(), axis.ticks.x = element_blank(),
  #             plot.title = element_text(hjust = 0.5, face = 'bold', size = 18),
  #             plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm'),
  #             legend.position = 'none') +
   theme(axis.title.x = element_blank(),
       axis.text.x = element_blank(),
               axis.ticks.x = element_blank(),
              # axis.text.x = element_blank(),
               axis.ticks.y = element_blank(),
               axis.title.y = element_blank(),
               axis.text.y = element_blank(),
               #axis.title.y = element_text(face = 'bold', size = 16),
               #axis.text.y = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
               legend.text = element_text(face = 'italic',),
              # panel.grid = element_blank(), axis.ticks.x = element_blank(),
               plot.title = element_text(hjust = 0.5, face = 'bold', size = 18),
         plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm'),
              # plot.margin = unit(c(.2, 0.05, 0.2, 0.1), 'cm'),
               legend.position = 'none')  +
  annotate(geom = "text", x = -10, y = 170, label = 'b',
           fontface = 'bold', size = 10) 
#tti_scatterplot.mpa
```

###Temp
```{r}
temp_scatterplot.lfm <- mem_data_all %>% 
ggplot(aes(y = temp_change, x = lfm, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(#title = "Live Fuel Moisture (%)", 
       y = expression(bold('Temp Change ('~degree~'C)'))) +
  theme(axis.title.x = element_blank(), 
             # axis.text.x = element_blank(),
              # axis.ticks.y.left = element_blank(), 
              # axis.title.y.left = element_blank(),
              # axis.text.y.left = element_blank(),
              axis.title.y = element_text(face = 'bold', size = 18),
         axis.text.x = element_text(size = 14),
              axis.text.y = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
              legend.text = element_text(face = 'italic',),
             # panel.grid = element_blank(), axis.ticks.x = element_blank(),
              plot.title = element_text(hjust = 0.5, face = 'bold', size = 18),
              plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm'),
              legend.position = 'none')  +
  annotate(geom = "text", x = -2.5, y = 250, label = 'd',
           fontface = 'bold', size = 10) 
temp_scatterplot.lfm
```


```{r}
temp_scatterplot.mpa <- mem_data_all %>% 
ggplot(aes(y = temp_change, x = mpa, color = Species)) +
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F) +
  color_noceco +
  labs(#title = "Water Potential (MPa)", 
       #y = "Time to Ignition (sec.)"
       ) +
  theme(axis.title.x = element_blank(),
             # axis.text.x = element_blank(),
              axis.ticks.y = element_blank(),
              axis.title.y = element_blank(),
              axis.text.y = element_blank(),
              #axis.title.y = element_text(face = 'bold', size = 16),
              #axis.text.y = element_text(size = 12),
              legend.title = element_text(face = 'bold', size = 14),
              legend.text = element_text(face = 'italic',),
        axis.text.x = element_text(size = 14),
             # panel.grid = element_blank(), axis.ticks.x = element_blank(),
              plot.title = element_text(hjust = 0.5, face = 'bold', size = 18),
              plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm'),
              legend.position = 'none')  +
  annotate(geom = "text", x = -10, y = 250, label = 'e',
           fontface = 'bold', size = 10) 
temp_scatterplot.mpa
```

#----------------------

#Pred plots:

####TTI

```{r}
tti_df <- mem_data_all_6 %>% 
  drop_na(lfm_scaled, sample_wt_scaled, tti, spp)

tti_mod <- lm(tti ~ spp*lfm_scaled + sample_wt_scaled, data = tti_df)
summary(tti_mod)

tti_df <- field_data_all_means %>% 
  modelr::add_predictions(tti_mod) %>% 
   drop_na(pred) 

# To get standard deviations
tti_df_stdev <- field_data_all_6 %>% 
  drop_na(lfm_scaled, sample_wt_scaled, spp) %>% 
  add_predictions(tti_mod)

tti_df_stdev <- tti_df_stdev %>% 
  drop_na(pred) %>% 
  group_by(spp, month) %>% 
  mutate(stdev.pred = sd(pred))

tti_df <- tti_df %>% 
  mutate(stdev.pred = tti_df_stdev$stdev.pred)

tti_pred <- tti_df %>%
  filter(year == 2021) %>% 
  ggplot(aes(y = pred, x = date, color = spp)) +
   geom_point(alpha = 1, size = 2) +
   #geom_smooth(se = F) +
   geom_line() +
  geom_linerange(aes(ymin = pred - 0.5*stdev.pred, ymax = pred + 0.5*stdev.pred)) +
  scale_y_continuous(breaks = c(20, 40, 60, 80, 100, 120)) +
 # ylim(20, 120)+
  # scale_y_continuous(breaks = c(-100, -80, -60, -40, -20, 0)) +
 # ylim(-120, -20)+
    theme(legend.position = "none",
        axis.text.y = element_text(size = 14),
        #axis.text.x = element_text(size = 18, angle = 20),
       # axis.title = element_text(size = 14, face = 'bold'),
        axis.text.x = element_blank(),
       axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
      #  axis.text.y = element_blank(),
       axis.title.y = element_blank(),
      # axis.ticks.y = element_blank(),
      plot.title = element_text(hjust = 0.5, face = 'bold', size = 18),
       # title = element_text(size = 14, face = 'bold'),
      plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm')) +
       # plot.margin = unit(c(0.05, 0.1, 0, 0.1), 'cm')) +
    labs(#y = "Ignitability (-1*sec)", 
      # x = "", 
       title = "Predicted Flammability")  +
  annotate(geom = "text", x = as.Date('2023-04-24'), y = 110, label = 'c',
           fontface = 'bold', size = 10) +
    # geom_text(data = subset(labelData, subset = plot == 'tti'),
    #           aes(x, y, label = labs, group = NULL, color = NULL),
    #           size = 12, fontface = 'bold') +
    color_noceco
tti_pred
```

#For labels:
```{r}
x <- as.Date(c(rep('2023-04-24', 5)))
y <- c(-25, 49.5, 49.5, 365, 105)
labs <- c('a', 'b', 'c', ' ', 'd')
plot <- c('tti', 'fh', 'fd', 'mt', 'tc')
labelData <- data.frame(x, y, labs, plot)
```

####Temp change

```{r}
temp_change_df <- mem_data_all_6 %>% 
  drop_na(mpa, lfm, temp_change)

temp_change_mod <- lm(temp_change ~ spp*lfm_scaled +
                           sample_wt_scaled, data = temp_change_df)
summary(temp_change_mod)

temp_change_df <- field_data_all_means %>% 
  modelr::add_predictions(temp_change_mod)
#To get standard deviations
temp_change_df_stdev <- field_data_all_6 %>% 
  add_predictions(temp_change_mod)
temp_change_df_stdev <- temp_change_df_stdev %>% 
  drop_na(pred) %>% 
  group_by(spp, month) %>% 
  mutate(stdev.pred = sd(pred))
temp_change_df <- temp_change_df %>% 
  mutate(stdev.pred = temp_change_df_stdev$stdev.pred)

temp_change_pred <- temp_change_df %>%
  filter(year == 2021) %>% 
  ggplot(aes(y = pred, x = date, color = spp)) +
   geom_point(alpha = 1, size = 2) +
  # geom_smooth(se = F) +
   geom_line() +
    scale_y_continuous(limits = c(0,110), breaks = c(0, 50, 100, 150)) +
 # scale_x_reverse() +
   geom_linerange(aes(ymin = pred - 0.5*stdev.pred, ymax = pred + 0.5*stdev.pred)) +
    theme(legend.position = "none",
          axis.title.x = element_blank(),
        axis.text.y = element_text(size = 14),
        axis.text.x = element_text(size = 14, #angle = 20, 
                                   hjust = 0.5),
       # axis.text.y = element_blank(),
       axis.title.y = element_blank(),
      # axis.ticks.y = element_blank(),
       # axis.title = element_text(size = 14, face = 'bold'),
        plot.margin = unit(c(.05, 0.05, 0.05, 0.05), 'cm'))+
    labs(y = "Temp. Change (C)") +
  annotate(geom = "text", x = as.Date('2023-04-24'), y = 107, label = 'f',
           fontface = 'bold', size = 10) +
    # geom_text(data = subset(labelData, subset = plot == 'tc'),
    #           aes(x, y, label = labs, group = NULL, color = NULL),
    #           size = 12, fontface = 'bold') +
    color_noceco
temp_change_pred
```
#------

#Combine: 

```{r}
fig2 <- cowplot::plot_grid(tti_scatterplot.lfm, tti_scatterplot.mpa, tti_pred, 
                                  temp_scatterplot.lfm, temp_scatterplot.mpa, 
                                  temp_change_pred,
                                nrow = 2,
                                ncol = 3,
                                rel_widths = c(1,.9,1), 
                                align = "btlr")
fig2

fig2_legend <- cowplot::plot_grid(fig2, legend,
                               # nrow = 2,
                                ncol = 2,
                                rel_widths = c(1, .2), 
                                align = "btlr")

fig2_legend

ggsave(plot = fig2_legend, here('figures', 'main-figures', 'Fig2_new.jpg'), height = 10, width = 15)
```

