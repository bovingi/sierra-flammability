---
title: "SEKI Figures"
author: "Indra Boving"
date: "12/17/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#lots of extra here, but oh well... 
library(ggplot2)
library(gapminder)
library(data.table)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(devtools)
library(ggfortify)
library(ggpubr)
library(jtools)
library(lmerTest)
library(ggeffects)  # install the package first if you haven't already, then load it
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
require(AICcmodavg) # has the aictab function
library(psych)
#devtools::install_github("strengejacke/strengejacke")
library(strengejacke)
library(sjPlot) # table functions
library(sjmisc) # sample data
library(lme4) # fitting models
library(here)
library(effects) #for plotting model effects
library(sjstats) #use for r2 functions
library(TMB)
library(glmmTMB)
library(lattice)
library(equatiomatic)
library("broom.mixed")
library(ggbiplot)
select = dplyr::select
here = here::here
library(MuMIn)
library(modelsummary)
#install_github("BlakeRMills/MetBrewer") 
#library("BlakeRMills/MetBrewer")
library(segmented)
filter = dplyr::filter
library(tmaptools)
library(wesanderson)
```

Set global options for color palettes and themes: 

```{r}
# scale_colour_continuous <- function(...) scale_color_brewer(palette="Dark2")
# scale_colour_discrete   <- function(...) scale_color_brewer(palette="Dark2")
# scale_colour_binned     <- function(...) scale_color_brewer(palette="Dark2")
th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank())

Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c(7, 5, 4, 6, 3, 2, 1), colorblind=TRUE)
```

#Data wrangling: 

```{r}
mem.data <- read_csv(here("processed-data", "pca_flam_data_seki.csv"), show_col_types = FALSE)
                     
mem.data.raw <- mem.data %>%
  mutate(mpa = (-1*mpa)) %>% 
  mutate(year = as.factor(year)) %>%
  mutate(month = as.factor(month)) %>% 
  mutate(mpa.unscaled = mpa) %>% 
  mutate(lfm = lfm.NAs.imputed)  %>% 
  mutate(water_status = case_when(
    precip.2mo < 1 ~ "Dry", 
    precip.2mo > 1 ~ "Wet")
  ) 

#Parsing out the variables of interest for the mixed effects modelling

scaled.mem.data.alldates.dependant <- mem.data.raw %>% 
select('PC1', 'PC2', 'PC3', 'PC4', "fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max", 'flam.index', 'year', 'month', 'prop.ignite' #'prop.ignite.bins5'
                                                                  )
  
scaled.mem.data.predictors <- mem.data.raw %>%
    dplyr::select('lfm.NAs.imputed', 'lfm.outliers.out', 'mpa', 'dw.flam.sample', 'sample.wt', 'ww.flam.sample', 'gww.gdw.saturated', 'gdw.gww.saturated') %>%
  scale()

mem.data.predictors <- mem.data.raw %>%
    dplyr::select('spp', 'year.month', 'individual', 'site', 'start.temp', 'precip.2mo','mpa.unscaled', 'lfm', 'hydration', 'water_status') 

scaled.mem.data <- cbind(scaled.mem.data.predictors, 
                         mem.data.predictors,
                         scaled.mem.data.alldates.dependant) 
  
scaled.mem.data <- scaled.mem.data %>% 
  mutate(Species = case_when(
    spp == "ABCO" ~ "Abies concolor",
    spp == "PIJE" ~ "Pinus jeffreyi", 
    spp == "CADE" ~ "Calocedrus decurrens", 
    spp == "CECO" ~ "Ceanothus cordulatus", 
    spp == "ARPA" ~ "Arctostaphylos patula", 
    spp == "QUKE" ~ "Quercus kelloggii"
    )) %>% 
  mutate(type = case_when(
    spp == "PIJE" ~ "tree", 
    spp == "QUKE" ~ "tree", 
    spp == "CECO" ~ "shrub", 
    spp == "ARPA" ~ "shrub", 
    spp == "ABCO" ~ "tree", 
    spp == "CADE" ~ "tree"
  )) %>% 
  mutate("Hydration" = hydration, 
            "Timing" = year.month)
```

Seasonal mins and maxs:

```{r}
df_2020 <- read_csv(here("raw-data", "field.summer.2020.csv"))
df_2021 <- read_csv(here("raw-data", "CZO_alldata_compiled.csv"))

abco_min <- df_2021 %>% filter(spp == "ABCO") %>%  select(lfm) %>% drop_na() %>% summarise(min = min(lfm)) %>% pull()
abco_min

abco_max <- df_2021 %>% filter(spp == "ABCO")%>% select(lfm) %>% drop_na() %>% summarise(max = max(lfm)) %>% pull()
abco_max

arpa_min <- df_2021 %>% filter(spp == "ARPA") %>%  select(lfm) %>% drop_na() %>% summarise(min = min(lfm)) %>% pull()
arpa_min

arpa_max <- df_2021 %>% filter(spp == "ARPA")%>% select(lfm) %>% drop_na() %>% summarise(max = max(lfm)) %>% pull()
arpa_max

cade_min <- df_2021 %>% filter(spp == "CADE") %>%  select(lfm) %>% drop_na() %>% summarise(min = min(lfm)) %>% pull()
cade_min

cade_max <- df_2021 %>% filter(spp == "CADE")%>% select(lfm) %>% drop_na() %>% summarise(max = max(lfm)) %>% pull()
cade_max

ceco_min <- df_2021 %>% filter(spp == "CECO") %>%  select(lfm) %>% drop_na() %>% summarise(min = min(lfm)) %>% pull()
ceco_min

ceco_max <- df_2021 %>% filter(spp == "CECO")%>% select(lfm) %>% drop_na() %>% summarise(max = max(lfm)) %>% pull()
ceco_max

pije_min <- df_2021 %>% filter(spp == "PIJE") %>%  select(lfm) %>% drop_na() %>% summarise(min = min(lfm)) %>% pull()
pije_min

pije_max <- df_2021 %>% filter(spp == "PIJE")%>% select(lfm) %>% drop_na() %>% summarise(max = max(lfm)) %>% pull()
pije_max

quke_min <- df_2021 %>% filter(spp == "QUKE") %>%  select(lfm) %>% drop_na() %>% summarise(min = min(lfm)) %>% pull()
quke_min

quke_max <- df_2021 %>% filter(spp == "QUKE")%>% select(lfm) %>% drop_na() %>% summarise(max = max(lfm)) %>% pull()
quke_max
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
seg.data.subset <- scaled.mem.data %>% 
  mutate(id = individual) 

seg.data.subset<-seg.data.subset[order(seg.data.subset$id),]

seg.pije.subset <- seg.data.subset %>% 
  filter(spp == "PIJE")

seg.pije.subset.limited <- seg.pije.subset %>% 
  filter(lfm < pije_max, lfm > pije_min)

seg.quke.subset <- seg.data.subset %>% 
  filter(spp == "QUKE")

seg.quke.subset.limited <- seg.quke.subset %>% 
  filter(lfm < quke_max, lfm > quke_min)

seg.ceco.subset <- seg.data.subset %>% 
  filter(spp == "CECO")

seg.ceco.subset.limited <- seg.ceco.subset %>% 
  filter(lfm < ceco_max, lfm > ceco_min)

seg.arpa.subset <- seg.data.subset %>% 
  filter(spp == "ARPA")

seg.arpa.subset.limited <- seg.arpa.subset %>% 
  filter(lfm < arpa_max, lfm > arpa_min)

seg.abco.subset <- seg.data.subset %>% 
  filter(spp == "ABCO")

seg.abco.subset.limited <- seg.abco.subset %>% 
  filter(lfm < abco_max, lfm > abco_min)

seg.cade.subset <- seg.data.subset %>% 
  filter(spp == "CADE")

seg.cade.subset.limited <- seg.cade.subset %>% 
  filter(lfm < cade_max, lfm > cade_min)
```


# 1.1. PCA on all species together

```{r warning=FALSE}
### Note: This dataset includes only Epiradiator and Ignited samples
seki.hp.flamdata <- scaled.mem.data

figure_epi_pca_quant <- (seki.hp.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max")]) %>%  
  transmute(
    "Flame Height" = fh,
     "Max. Temp" = temp.max,
     "\n\nTime to Ignition" = tti, #space is added in front of TTI so that the labels dont overlap in the figure
     "Flame Duration" = fd,
    "\nTime to First Glow" = ttfg,
   "Glow to Ignition" = gti,
    "Glow Duration" = gd,
    "Post-flame Glow" = pfg)
  
## Changing the order of the variables changes the PCA ordering: 
  
  # transmute("\nTime to First Glow" = ttfg,
  #           "Glow to Ignition" = gti,
  #           "\n\nTime to Ignition" = tti,
  #           "Flame Height" = fh,
  #           "Flame Duration" = fd,
  #           "Max. Temp" = temp.max,
  #         "Post-flame Glow" = pfg,
  #          "Glow Duration" = gd,
  #         )
  # transmute(
  #           "Glow Duration" = gd, 
  #         "Post-flame Glow" = pfg,
  #          "Max. Temp" = temp.max,
  #         "Flame Duration" = fd,
  #          "Flame Height" = fh,
  #         "\n\nTime to Ignition" = tti, 
  #         "Glow to Ignition" = gti, 
  #         "\nTime to First Glow" = ttfg
  #         )
  
  

figure_epi_pca_cat <- (seki.hp.flamdata[c("Hydration", "Species")]) 

figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE, retx=TRUE)
```

#### biplot PCA plot

```{r warning=FALSE}
# g <- ggbiplot(figure_prcomp, 
#                         groups = figure_epi_pca_cat$Species, 
#                         obs.scale = 0, 
#                         var.scale = 1,  
#                         circle = TRUE, 
#                         #ellipse = TRUE,
#                         size = .5,
#                         varname.size = 2.7, 
#                         alpha = 0, 
#                         labels.size = 2.7,
#                         varname.adjust = 1.5, 
#                         expand= TRUE) +
#   geom_point(aes(colour=figure_epi_pca_cat$Species), size = .5) +# by spp
# ggtitle("Flammability metrics only") +
#   scale_color_brewer(palette = "Dark2") +
#   #scale_color_manual(values=met.brewer("Morgenstern", 2)) +
#  # geom_text_repel(data=filter(results, padj<0.05), aes(label=Gene))
#   th
# g
```

### *ggplot PCA plot (USE THIS)

###On all species: 

Setting up plotting data: 

```{r}
#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_epi_pca_cat)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("Flame Height", "Max. Temp","Flame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("\n\nTime to Ignition", "Glow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))

# Plot
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  #stat_ellipse(level = 0.95, size = 1, show.legend = FALSE) +
  geom_point(size = 1.3, alpha = .2, aes(shape = Species
                                       #, color = Species
                                       ), data = PCAvalues) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .8, 
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 1.5), 
          y = (PCA_combustability$PC2 * 1.5),
          label = PCA_combustability$Variables, size = 3) +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.6), 
           y = (PCA_ignitability$PC2 * 1.7), 
           label = PCA_ignitability$Variables, size = 3) +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.5),
           y = (PCA_consumability$PC2 * 1.3), 
           label = PCA_consumability$Variables, size = 3) + 
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
        axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "italic")) +
  #th +
  scale_color_manual(values = c("#b08ba5","#db8872")) + 
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) + 
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()

```
### URS Version (Joe)
```{r}
#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_epi_pca_cat)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("Flame Height", "Max. Temp"))
         
PCA_sustainability <- df.v %>% 
  filter(Variables %in% c("Flame Duration"))

PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("\n\nTime to Ignition", "Glow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))

# Plot
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  #stat_ellipse(level = 0.95, size = 1, show.legend = FALSE) +
  geom_point(size = 1.3, alpha = .2, aes(shape = Species
                                       #, color = Species
                                       ), data = PCAvalues) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .95, alpha = 0.85,
     color = "#801100") +
  geom_segment(data = PCA_sustainability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .95, alpha = 0.7,
     color = "#d73502") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .95, alpha = 0.7,
     color = "#fb9a24") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .95, alpha = 0.6,
     color = "#fede17") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 1.5), 
          y = (PCA_combustability$PC2 * 1.5),
          label = PCA_combustability$Variables, size = 3.5) +
  annotate("text", 
           x = (PCA_sustainability$PC1 * 1.5), 
          y = (PCA_sustainability$PC2 * 1.5),
          label = PCA_sustainability$Variables, size = 3.5) +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.6), 
           y = (PCA_ignitability$PC2 * 1.7), 
           label = PCA_ignitability$Variables, size = 3.5) +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.5),
           y = (PCA_consumability$PC2 * 1.3), 
           label = PCA_consumability$Variables, size = 3.5) + 
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
        axis.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        legend.text = element_text(face = "italic")) +
  #th +
  scale_color_manual(values = c("#b08ba5","#db8872")) + 
  scale_y_continuous(limits = c(-2,2.5)) +
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) + 
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
```


###Just on conifers: 

```{r}
figure_epi_pca_cat_conifers <- figure_epi_pca_cat %>% 
  filter(Species %in% c("Abies concolor", "Calocedrus decurrens", "Pinus jefferyi"))

figure_epi_pca_quant_conifers <- (seki.hp.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg", "temp.max", "Species")])%>% 
   filter(Species %in% c("Abies concolor", "Calocedrus decurrens", "Pinus jefferyi")) %>%  
  transmute(
    "Flame Height" = fh,
     "Max. Temp" = temp.max,
     "\n\nTime to Ignition" = tti, #space is added in front of TTI so that the labels dont overlap in the figure
     "Flame Duration" = fd,
    "\nTime to First Glow" = ttfg,
   "Glow to Ignition" = gti,
    "Glow Duration" = gd,
    "Post-flame Glow" = pfg, 
  )


#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant_conifers), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_epi_pca_cat_conifers)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("Flame Height", "Max. Temp","Flame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("\n\nTime to Ignition", "Glow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))

 #Plot
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  #stat_ellipse(level = 0.95, size = 1, show.legend = FALSE) +
  geom_point(size = 1, alpha = .2, aes(shape = Species
                                       #, color = Species
                                       ), data = PCAvalues) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .8, 
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 1.2), 
          y = (PCA_combustability$PC2 * 1.2),
          label = PCA_combustability$Variables, size = 2.6) +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.4), 
           y = (PCA_ignitability$PC2 * 1.5), 
           label = PCA_ignitability$Variables, size = 2.6) +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.3),
           y = (PCA_consumability$PC2 * 1.1), 
           label = PCA_consumability$Variables, size = 3) + 
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) +
  #th +
  scale_color_manual(values = c("#b08ba5","#db8872")) + 
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) + 
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
```

###Just on angiosperms: 

```{r}
figure_epi_pca_cat_ang <- figure_epi_pca_cat %>% 
  filter(Species %in% c("Ceanothus cordulatus","Arctostaphylos patula","Quercus kelloggii")
    )

figure_epi_pca_quant_ang <- (seki.hp.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg", "temp.max", "Species")])%>% 
   filter(Species %in% c("Ceanothus cordulatus","Arctostaphylos patula","Quercus kelloggii")) %>%  
  transmute(
    "Flame Height" = fh,
     "Max. Temp" = temp.max,
     "\n\nTime to Ignition" = tti, #space is added in front of TTI so that the labels dont overlap in the figure
     "Flame Duration" = fd,
    "\nTime to First Glow" = ttfg,
   "Glow to Ignition" = gti,
    "Glow Duration" = gd,
    "Post-flame Glow" = pfg, 
  )


#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_epi_pca_quant_ang), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

  #dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_epi_pca_cat_ang)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_combustability <- df.v %>% 
  filter(Variables %in% c("Flame Height", "Max. Temp","Flame Duration"))
         
PCA_ignitability <- df.v %>% 
  filter(Variables %in% c("\n\nTime to Ignition", "Glow to Ignition"))

PCA_consumability <- df.v %>% 
  filter(Variables %in% c("Glow Duration", "Post-flame Glow", "\nTime to First Glow"))

# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))

 #Plot
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  #stat_ellipse(level = 0.95, size = 1, show.legend = FALSE) +
  geom_point(size = 1, alpha = .2, aes(shape = Species
                                       #, color = Species
                                       ), data = PCAvalues) +
  geom_segment(data = PCA_combustability, aes(x = 0, y = 0, 
                                              xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
      size = .8, 
     color = "#a56457") +
  geom_segment(data = PCA_consumability, aes(x = 0, y = 0,
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#b08ba5") +
  geom_segment(data = PCA_ignitability, aes(x = 0, y = 0, 
                                             xend = PC1, yend = PC2),
     arrow = arrow(length = unit(1/2, "picas")), 
     size = .8, 
     color = "#ffb178") +
  annotate("text", 
           x = (PCA_combustability$PC1 * 1.2), 
          y = (PCA_combustability$PC2 * 1.2),
          label = PCA_combustability$Variables, size = 2.6) +
  annotate("text",
           x = (PCA_ignitability$PC1 * 1.4), 
           y = (PCA_ignitability$PC2 * 1.5), 
           label = PCA_ignitability$Variables, size = 2.6) +
  annotate("text",
           x = (PCA_consumability$PC1 * 1.3),
           y = (PCA_consumability$PC2 * 1.1), 
           label = PCA_consumability$Variables, size = 3) + 
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) +
  #th +
  scale_color_manual(values = c("#b08ba5","#db8872")) + 
  geom_path(data = circle, color = "black",  size = 1/2, alpha = 1/3) + 
  xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
```

#1.2. PCA Table

```{r warning=FALSE}
figure_epi_pca_quant <- (seki.hp.flamdata[, c("fh", "ttfg", "tti", "fd", "gd", "gti", "pfg",
         "temp.max")]) %>% 
  # transmute("\nTime to First Glow" = ttfg,
  #           "Glow to Ignition" = gti,
  #           "\n\nTime to Ignition" = tti,
  #           "Flame Height" = fh,
  #           "Flame Duration" = fd,
  #           "Max. Temp" = temp.max,
  #         "Post-flame Glow" = pfg,
  #          "Glow Duration" = gd,
  #         )
  # transmute(
  #           "Glow Duration" = gd, 
  #         "Post-flame Glow" = pfg,
  #          "Max. Temp" = temp.max,
  #         "Flame Duration" = fd,
  #          "Flame Height" = fh,
  #         "\n\nTime to Ignition" = tti, 
  #         "Glow to Ignition" = gti, 
  #         "\nTime to First Glow" = ttfg
  #         )
  transmute(
    "Flame Height" = fh,
     "Max. Temp" = temp.max,
     "\n\nTime to Ignition" = tti,
     "Flame Duration" = fd,
    "\nTime to First Glow" = ttfg,
    "Glow to Ignition" = gti,
    "Glow Duration" = gd,
    "Post-flame Glow" = pfg)
  

#colnames(wine_subset)[2] <- "\nFlav"  # new line

figure_prcomp <- prcomp(na.omit(figure_epi_pca_quant), center = TRUE, scale = TRUE, retx=TRUE)

figure_varimax <- varimax(figure_prcomp$rotation[,1:3])
figure_varimax
#summary(seki.hp.flamdata.pca) #importance of components
#plot(seki.hp.flamdata.pca)

tab_pca(figure_prcomp, 
        rotation = c("varimax"), 
        digits = 2,
        show.var = TRUE,
  string.pov = "Proportion of Variance",
  string.cpov = "Cumulative Proportion") 

```
#------------------------------------
#2.1 Model Figures

#### 2.1.1 Figure of model 

###### Water Potential vs. PC1

```{r}
mpa_mod_fig.mpa <- lmer(PC1 ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data)
```

## Predicted vs. Observed PC1
```{r}
predicted_pc1_df <- data.frame(predicted_pc1 = predict(mpa_mod_fig.mpa), observed_pc1 = scaled.mem.data$PC1)

ggplot(data = predicted_pc1_df, aes(x = predicted_pc1, y = observed_pc1)) +
  geom_point(color = "lightblue", size = .7) +
  geom_abline() +
  labs(title = "Predicted vs. Observed PC1", 
       subtitle = "All dates, mpa model",
       x = "Predicted PC1", 
       y = "Observed PC1") +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()) +
  ylim(-3, 3) +
  xlim(-3, 3) +
  coord_equal()
```

```{r}
effects_mpa_fig.mpa <- effects::effect(term= "mpa.unscaled", 
                                   mod= mpa_mod_fig.mpa, 
                                   se = TRUE, 
                                   confidence.level=.95
                                   )
# Save the effects values as a df:
x_mpa_fig.mpa <- as.data.frame(effects_mpa_fig.mpa)
```

**Figure X.** Model estimate of flammability (principle component 1) from water potential. 

```{r, message=FALSE, results='hide',fig.height= 4, fig.length = 8}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, PC1, color = Species), size = 1) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit), color="#db8872") +
  geom_ribbon(data= x_mpa_fig.mpa, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Potential (-Mpa)", y="Principle Component 1") +
 # scale_color_brewer(name = "Species", palette  = "Dark2") +
  scale_color_brewer() +
  th 

p +
  annotate("segment", x = -9, xend = -9, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
 # annotate("segment", x = -9, xend = -1, y = -4, yend = -4,
          # colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm")))  +
  annotate("text", x= -9, y= 4, label= "More", size = 3) +
  annotate("text", x= -9, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= -9, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= -9, y= -4, label= "Flammable", size = 3)  +
  #th +
  scale_x_continuous(limits = c(-9.5, 0), breaks= c(-8, -6, -4, -2, 0)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 
```
####Color by water status: (need to find these still)

```{r, message=FALSE, results='hide',fig.height= 4, fig.length = 8}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, PC1, color = water_status), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  geom_line(data=x_mpa_fig.mpa, aes(x=mpa.unscaled, y=fit), color="#db8872") +
  geom_ribbon(data= x_mpa_fig.mpa, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#db8872") +
  labs(x="Water Potential (-Mpa)",
       y="Principle Component 1", 
       color = "Timing") +
  scale_color_brewer(palette  = "Dark2") +
 # scale_color_manual(values = c("#b08ba5", "#ffb178"))
  th 

p +
  annotate("segment", x = -11, xend = -11, y = -3, yend = 3,
           colour = "#db8872", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
 # annotate("segment", x = -9, xend = -1, y = -4, yend = -4,
          # colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm")))  +
  annotate("text", x= -11, y= 4, label= "More", size = 3) +
  annotate("text", x= -11, y= 3.5, label= "Flammable", size = 3)+
annotate("text", x= -11, y= -3.5, label= "Less", size = 3) +
  annotate("text", x= -11, y= -4, label= "Flammable", size = 3)  +
  #th +
  scale_x_continuous(limits = c(-11.5, 0), breaks= c(-10, -8, -6, -4, -2, 0)) + 
  theme(
    legend.position = c(.99, .99),
    legend.justification = c("right", "top"),
    legend.box.just = "right",
    legend.margin = margin(4,4,4,4), 
    panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank()
    ) 
```


######Water Potential vs. TTI

```{r}
mpa_mod_fig <- lmer(tti ~ mpa.unscaled + Species + (1 | individual), data = scaled.mem.data)

effects_mpa_fig <- effects::effect(term= "mpa.unscaled", 
                                   mod= mpa_mod_fig, 
                                   se = TRUE, 
                                   confidence.level=.95)
# Save the effects values as a df:
x_mpa_fig <- as.data.frame(effects_mpa_fig)
```


```{r}
# Separating by Species
p <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, tti, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Water Potential (-Mpa)", 
       y="Time to Ignition (sec)") +
  scale_color_brewer(name = "Species", palette  = "Dark2") +
  th 


p +
  annotate("segment", x = -11, xend = -11, y = 20, yend = 135,
           colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm"))) +
 # annotate("segment", x = -9, xend = -1, y = -4, yend = -4,
          # colour = "#7570b3", size = .7, arrow = arrow(ends = "last", angle = 25, type = "closed", length = unit(.2,"cm")))  +
  annotate("text", x= -11, y= 145, label= "Less", size = 3) +
  annotate("text", x= -11, y= 140, label= "Flammable", size = 3)+
annotate("text", x= -11, y= 15, label= "More", size = 3) +
  annotate("text", x= -11, y= 10, label= "Flammable", size = 3) +
  th +
  scale_x_continuous(limits = c(-12, 0), breaks= c(-10, -8, -6, -4, -2, 0))
```
##TTI x LFM, species faceted: 
```{r}
# Separating by Species
scaled.mem.data %>% 
  #filter(spp != "CECO") %>% 
  mutate(Species = case_when(
    spp == "ABCO" ~ "Abies concolor",
    spp == "PIJE" ~ "Pinus jeffreyi", 
    spp == "CADE" ~ "Calocedrus decurrens", 
    spp == "CECO" ~ "Ceanothus cordulatus", 
    spp == "ARPA" ~ "Arctostaphylos patula", 
    spp == "QUKE" ~ "Quercus kelloggii"
    )) %>% 
  mutate(Species = fct_relevel(Species, 
                           "Abies concolor",
                           "Pinus jeffreyi",
                           "Calocedrus decurrens",
                           "Ceanothus cordulatus", 
                           "Arctostaphylos patula",
                           "Quercus kelloggii"))  %>% 
ggplot(aes(lfm, tti)) + 
  geom_point(size = 1, alpha = .7) + 
  facet_wrap(~Species, scales = "free_y") +
  labs(x="Live Fuel Moisture (%)", 
       y="Time to Ignition (sec)") +
  #scale_color_brewer(name = "Species", palette  = "Dark2") +
  geom_smooth(method = "lm", se = FALSE, color = "#7c668c")+
  #ggpubr::stat_regline_equation(size = 4) +
  #ggpubr::stat_cor(label.y = 4.4) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
   th +
  #scale_x_continuous(limits = c(-8, 0), breaks= c(-8, -6, -4, -2, 0))  +
  theme(legend.position = "none",
        axis.title = element_text(face = "bold"),
        strip.background = element_rect(fill = "gray90"),
        strip.text = element_text(face = "italic"))
```

##TTI all species faceted: 
```{r}
# Separating by Species
scaled.mem.data %>% 
  #filter(spp != "CECO") %>% 
  mutate(Species = case_when(
     spp == "ABCO" ~ "Abies concolor",
    spp == "PIJE" ~ "Pinus jeffreyi", 
    spp == "CADE" ~ "Calocedrus decurrens", 
    spp == "CECO" ~ "Ceanothus cordulatus", 
    spp == "ARPA" ~ "Arctostaphylos patula", 
    spp == "QUKE" ~ "Quercus kelloggii"
    )) %>% 
  mutate(Species = fct_relevel(Species, 
                           "Abies concolor",
                           "Pinus jeffreyi",
                           "Calocedrus decurrens",
                           "Ceanothus cordulatus", 
                           "Arctostaphylos patula",
                           "Quercus kelloggii"))  %>% 
ggplot(aes(mpa.unscaled, tti)) + 
  geom_point(size = 1, alpha = .7) + 
  facet_wrap(~Species, scales = "free_y") +
  labs(x="Water Potential (-Mpa)", 
       y="Time to Ignition (sec)") +
  scale_color_brewer(name = "Species", palette  = "Dark2") +
  geom_smooth(method = "lm", se = FALSE, color = "#7c668c")+
  #ggpubr::stat_regline_equation(size = 4) +
  #ggpubr::stat_cor(label.y = 4.4) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
   th +
  scale_x_continuous(limits = c(-8, 0), breaks= c(-8, -6, -4, -2, 0))  +
  theme(legend.position = "none",
        axis.title = element_text(face = "bold"),
        strip.background = element_rect(fill = "gray90"), 
        strip.text = element_text(face = "italic"))
```

##FH x LFM, species faceted: 
```{r}
# Separating by Species
scaled.mem.data %>% 
  #filter(spp != "CECO") %>% 
  mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(Species = fct_relevel(Species, 
                           "A. concolor",
                           "P. jeffreyi",
                           "C. decurrens",
                           "C. cordulatus", 
                           "A. patula",
                           "Q. kelloggii"))  %>% 
ggplot(aes(lfm, fh)) + 
  geom_point(size = 1, alpha = .7) + 
  facet_wrap(~Species, scales = "free_y") +
  labs(x="Live Fuel Moisture (%)", 
       y="Flame Height (cm)") +
  #scale_color_brewer(name = "Species", palette  = "Dark2") +
  geom_smooth(method = "lm", se = FALSE, color = "#7c668c")+
  #ggpubr::stat_regline_equation(size = 4) +
  #ggpubr::stat_cor(label.y = 4.4) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
   th +
  #scale_x_continuous(limits = c(-8, 0), breaks= c(-8, -6, -4, -2, 0))  +
  theme(legend.position = "none")
```
##FH all species faceted: 
```{r}
# Separating by Species
scaled.mem.data %>% 
  #filter(spp != "CECO") %>% 
  mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(Species = fct_relevel(Species, 
                           "A. concolor",
                           "P. jeffreyi",
                           "C. decurrens",
                           "C. cordulatus", 
                           "A. patula",
                           "Q. kelloggii"))  %>% 
ggplot(aes(mpa.unscaled, fh)) + 
  geom_point(size = 1, alpha = .7) + 
  facet_wrap(~Species, scales = "free_y") +
  labs(x="Water Potential (-Mpa)", 
       y="Flame Height (cm)") +
  #scale_color_brewer(name = "Species", palette  = "Dark2") +
  geom_smooth(method = "lm", se = FALSE, color = "#7c668c")+
  #ggpubr::stat_regline_equation(size = 4) +
  #ggpubr::stat_cor(label.y = 4.4) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
   th +
  scale_x_continuous(limits = c(-8, 0), breaks= c(-8, -6, -4, -2, 0))  +
  theme(legend.position = "none")
```

##PC1 x MPa, all species faceted: 
```{r}
# Separating by Species
scaled.mem.data %>% 
  #filter(spp != "CECO") %>% 
  mutate(Species = case_when(
    spp == "ABCO" ~ "Abies concolor",
    spp == "PIJE" ~ "Pinus jeffreyi", 
    spp == "CADE" ~ "Calocedrus decurrens", 
    spp == "CECO" ~ "Ceanothus cordulatus", 
    spp == "ARPA" ~ "Arctostaphylos patula", 
    spp == "QUKE" ~ "Quercus kelloggii"
    )) %>% 
  mutate(Species = fct_relevel(Species, 
                           "Abies concolor",
                           "Pinus jeffreyi",
                           "Calocedrus decurrens",
                           "Ceanothus cordulatus", 
                           "Arctostaphylos patula",
                           "Quercus kelloggii"))  %>% 
ggplot(aes(mpa.unscaled, PC1)) + 
  geom_point(size = 1, alpha = .7) + 
  facet_wrap(~Species, scales = "free_y") +
  labs(x="Water Potential (-Mpa)", 
       y="PC1") +
  #scale_color_brewer(name = "Species", palette  = "Dark2") +
  geom_smooth(method = "lm", se = FALSE, color = "#7c668c")+
  #ggpubr::stat_regline_equation(size = 4) +
  #ggpubr::stat_cor(label.y = 4.4) +
  stat_regline_equation(label.x = -8, label.y = 2,
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
   th +
  scale_x_continuous(limits = c(-8, 0), breaks= c(-8, -6, -4, -2, 0))  +
  theme(legend.position = "none",
        axis.title = element_text(face = "bold"),
        strip.background = element_rect(fill = "gray90"),
        strip.text = element_text(face = "italic"))

```

##PC1 all species faceted: 
```{r}
# Separating by Species
scaled.mem.data %>% 
  #filter(spp != "CECO") %>% 
  mutate(Species = case_when(
     spp == "ABCO" ~ "Abies concolor",
    spp == "PIJE" ~ "Pinus jeffreyi", 
    spp == "CADE" ~ "Calocedrus decurrens", 
    spp == "CECO" ~ "Ceanothus cordulatus", 
    spp == "ARPA" ~ "Arctostaphylos patula", 
    spp == "QUKE" ~ "Quercus kelloggii"
    )) %>% 
  mutate(Species = fct_relevel(Species, 
                           "Abies concolor",
                           "Pinus jeffreyi",
                           "Calocedrus decurrens",
                           "Ceanothus cordulatus", 
                           "Arctostaphylos patula",
                           "Quercus kelloggii"))  %>% 
ggplot(aes(lfm, PC1)) + 
  geom_point(size = 1, alpha = .7) + 
  facet_wrap(~Species, scales = "free_y") +
  labs(x="Live Fuel Moisture (%)", 
       y="PC1") +
  #scale_color_brewer(name = "Species", palette  = "Dark2") +
  geom_smooth(method = "lm", se = FALSE, color = "#7c668c")+
  #ggpubr::stat_regline_equation(size = 4) +
  #ggpubr::stat_cor(label.y = 4.4) +
  stat_regline_equation(label.x = -8, label.y = 2,
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~"))
  ) +
   th +
 # scale_x_continuous(limits = c(-8, 0), breaks= c(-8, -6, -4, -2, 0))  +
  theme(legend.position = "none", 
        axis.title = element_text(face = "bold"),
        strip.background = element_rect(fill = "gray90"),
        strip.text = element_text(face = "italic"))
```

#### 2.1.2 Table of model

```{r}
mpa_mod_fig.mpa <- lmer(PC1 ~ mpa.unscaled + Species+ (1 | individual), data = scaled.mem.data) #mpa model

m3 <- lmer(PC1 ~ spp + ww.flam.sample + (1 | individual), data = scaled.mem.data) #ww model
  
m6 <- lmer(PC1 ~ dw.flam.sample + spp + (1 | individual), data = scaled.mem.data) #dw model

m7 <- lmer(PC1 ~ mpa + lfm.NAs.imputed + spp + (1 | individual), data = scaled.mem.data) #mpa nad lfm model
m7

m10 <- lmer(PC1 ~ lfm.NAs.imputed + spp + (1 | individual), data = scaled.mem.data) #lfm model
```

```{r}
# models <- list(top_model, m7, m10, m3, m6)
# 
# # build table with `modelsummary` 
# cm <- c( '(Intercept)' = 'Intercept', 
#          'mpa' = 'Water Potential (-Mpa)', 
#          'lfm.NAs.imputed' = 'LFM (%)',
#          'ww.flam.sample' = 'Water weight (g)', 
#          'dw.flam.sample' = 'Dry weight (g)', 
#          'sppCEME' = 'C. megacarpus')
# cap <- 'Candidate models for predicting flammability (PC1)'
# 
# 
# modelsummary <- modelsummary(models,
#                              statistic = "p = {p.value}",
#                              stars = TRUE, 
#                              coef_map = cm, 
#                              title = cap, 
#                              output = 'flextable') %>% 
#   flextable::autofit()
# modelsummary
```

https://strengejacke.github.io/sjPlot/articles/tab_model_estimates.html 

```{r}

#tab_model(top_model, m7, m10, m3, m6) 

tab_model(mpa_mod_fig.mpa, m7, m10, m3, m6, 
          show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
          pred.labels = c('Intercept', 
                          'Water Potential (-Mpa)', 
                          'C. megacarpus',
                           'LFM (%)',
                          'Water weight (g)', 
                          'Dry weight (g)'), 
         dv.labels = c("Model 1", 
                       "Model 2", 
                       "Model 3", 
                       "Model 4", 
                       "Model 5"),
         string.pred = "Coeffcient",
  string.p = "P-Value", 
  p.style = "stars")
         
```

The intra-class correlation coefficient (ICC) is a related statistic that quantifies the proportion of variance explained by a grouping (random) factor in multilevel/hierarchical data.

#------------------------------------
#2.2. Raw values plots

#####Prior Precip
```{r}
scaled.mem.data %>%
  ggplot(aes(y = PC1, x = lfm, color = as.factor(precip.2mo))) +
  geom_point(size = .7, alpha = .5) +
  geom_smooth(method = lm, size = .7, alpha = .5, se = FALSE) +
 # ggpubr::stat_regline_equation() +
  labs(x = "LFM", 
       y = "PC1 ", 
       color = "Precip (inches)\nprev. 2 mo.") +
 # scale_color_discrete(name = "Site")+
  th +
  scale_color_brewer(palette = "Dark2") +
  facet_wrap(~spp) +
  theme(legend.position = "bottom")
```

#### MPa vs. TTI, FH, GD


```{r}
tti.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, tti, color = Species), size = .5) + 
  geom_smooth(method = "lm", data= scaled.mem.data, aes(mpa.unscaled, tti, color = Species), se = FALSE, size = .7) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Water Potential (-Mpa)", 
       y="Time to Ignition (sec)")  +
 # scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
tti.mpa


fh.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, fh, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(mpa.unscaled, fh, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Water Potential (-Mpa)", 
       y="Flame Height (cm)")  +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
fh.mpa

gd.mpa <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(mpa.unscaled, gd, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=mpa.unscaled, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(mpa.unscaled, gd, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=mpa.unscaled, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Water Potential (-Mpa)", 
       y="Glow Duration (sec)")  +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 8), 
        legend.position = "bottom")
gd.mpa
```


```{r, fig1, fig.height = 9, fig.width = 4}
cowplot::plot_grid(tti.mpa, fh.mpa, gd.mpa, 
          ncol = 1)
```


#### LFM vs. TTI, FH, GD

```{r}
tti <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, tti, color = Species), size = .5) + 
  geom_smooth(method = "lm", 
              data= scaled.mem.data, 
              aes(lfm, tti, color = Species), se = FALSE, size = .7) +
  #geom_line(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3") +
  #geom_ribbon(data= x_mpa_fig, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Live Fuel Moisture (%)", 
       y="Time to Ignition (sec)")  +
 # scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
tti


fh <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, fh, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(lfm, fh, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(
    #x="Live Fuel Moisture (%)", 
       y="Flame Height (cm)")  +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.title.x=element_blank(),
        legend.position = "none") 
fh

gd <- ggplot() + 
  geom_point(data= scaled.mem.data, aes(lfm, gd, color = Species), size = .5) + 
  #geom_point(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3", size = 1) +
  #geom_line(data=x_mpa_fig, aes(x=lfm, y=fit), color="#7570b3") +
  geom_smooth(method = "lm", data= scaled.mem.data, aes(lfm, gd, color = Species), se = FALSE, size = .7) +
  #geom_ribbon(data= x_mpa_fig, aes(x=lfm, ymin=lower, ymax=upper), alpha= 0.3, fill="#7570b3") +
  labs(x="Live Fuel Moisture (%)", 
       y="Glow Duration (sec)")  +
  #scale_color_manual(values = c("#b08ba5", "#ffb178")) +
  th +
  theme(legend.title = element_text(size = 10), 
        legend.text = element_text(size = 8), 
        legend.position = "bottom")
gd
```


```{r, fig1, fig.height = 9, fig.width = 4.5}
cowplot::plot_grid(tti, fh, gd, 
          ncol = 1)
```
