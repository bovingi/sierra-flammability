---
title: "PV Curves"
author: "Indra Boving"
date: "11/8/2022"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(datapasta)
library(ggplot2)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(ggpubr)
library(cowplot)
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
#library(strengejacke)
library(sjPlot) # table functions
library(here)
library(effects) #for plofhng model effects
library(sjstats) #use for r2 functions
library("broom.mixed")
library(MuMIn)
library(modelsummary)
library(nlme)
library(lme4)
library(MetBrewer)
library(remef)
library(kableExtra)
library(janitor)
library(lubridate)
library(specr)
#install.packages("specr")

filter = dplyr::filter
mutate = dplyr::mutate
select = dplyr::select
here = here::here

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```
# Section 1: Pressure Volume Curves

```{r,warning=FALSE}
pv_all_df <- read_csv(here("processed-data", "analysis 2.0", "all_pv_curves_clean_v2.csv"), show_col_types = FALSE) %>%
  mutate(spp == species) %>% 
  filter(!spp %in% c("ADFA", "CEME")) %>% 
  mutate(sample = as.factor(sample)) %>% 
  mutate(month = as.factor(month)) %>% 
  mutate(date = ymd(date), 
        year_month = str_c(year, '_', month), 
        year = as.factor(year),
        individual = str_c(spp, '_', sample, '_', year, '_', timing)) %>% 
  clean_names() %>% 
  group_by(spp) %>% 
  mutate(plant = udpipe::unique_identifier(individual), 
         plant = as.factor(plant),
         fresh_weight_saturated = as.numeric(fresh_weight_saturated)) %>% 
  group_by(spp, plant) %>% 
  mutate(maxLFM = ((fresh_weight_saturated - dry_weight)/dry_weight)*100) %>% 
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE")) %>% 
  mutate(strategy = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "Isohydric", 
    spp == "PIJE" ~ "Isohydric", 
     spp == "CADE" ~ "Isohydric", 
    spp == "CECO" ~ "Anisohydric", 
    spp == "ARPA" ~ "Anisohydric", 
    spp == "QUKE" ~ "Anisohydric"
  )) %>% 
   mutate(strategy_binary = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "1", 
    spp == "ARPA" ~ "2", 
    spp == "CADE" ~ "1", 
    spp == "CECO" ~ "2", 
    spp == "PIJE" ~ "1", 
    spp == "QUKE" ~ "2"
  )) %>% 
   mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(type = case_when(
    spp == "PIJE" ~ "tree", 
    spp == "QUKE" ~ "tree", 
    spp == "CECO" ~ "shrub", 
    spp == "ARPA" ~ "shrub", 
    spp == "ABCO" ~ "tree", 
    spp == "CADE" ~ "tree"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "ARPA" ~ "Angiosperm", 
    spp == "ABCO" ~ "Gymnosperm",
    spp == "CADE" ~ "Gymnosperm",
    spp == "CECO" ~ "Angiosperm",
    spp == "PIJE" ~ "Gymnosperm",
    spp == "QUKE" ~ "Angiosperm"
  )) %>% 
  filter(timing == "fall") %>% 
  filter(!(spp == "QUKE" & sample %in% c(2,4) & year == 2020)) #these had their dry weights switched, 

write_csv(pv_all_df, (here("processed-data", "analysis 2.0", "all_pv_curves_clean_vardecomp_2.csv")))
```

###PV Summaries
```{r}
pv_summaries_2 <- read_csv(here("raw-data", "PV_sierra_summaries.csv")) %>% 
  clean_names() %>% 
   mutate(spp = fct_relevel(species, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"), 
          tlp = ytlp_m_pa, 
          lfmtlp = lf_mtlp)  %>% 
  mutate(strategy = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "Isohydric", 
    spp == "PIJE" ~ "Isohydric", 
     spp == "CADE" ~ "Isohydric", 
    spp == "CECO" ~ "Anisohydric", 
    spp == "ARPA" ~ "Anisohydric", 
    spp == "QUKE" ~ "Anisohydric"
  )) %>% 
   mutate(strategy_binary = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "1", 
    spp == "ARPA" ~ "2", 
    spp == "CADE" ~ "1", 
    spp == "CECO" ~ "2", 
    spp == "PIJE" ~ "1", 
    spp == "QUKE" ~ "2"
  )) %>% 
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
   mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(type = case_when(
    spp == "PIJE" ~ "tree", 
    spp == "QUKE" ~ "tree", 
    spp == "CECO" ~ "shrub", 
    spp == "ARPA" ~ "shrub", 
    spp == "ABCO" ~ "tree", 
    spp == "CADE" ~ "tree"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "ARPA" ~ "Angiosperm", 
    spp == "ABCO" ~ "Gymnosperm",
    spp == "CADE" ~ "Gymnosperm",
    spp == "CECO" ~ "Angiosperm",
    spp == "PIJE" ~ "Gymnosperm",
    spp == "QUKE" ~ "Angiosperm"
  )) %>% 
  mutate(date = lubridate::mdy(date), 
         year = year(date))

fgroup_pv_summaries <- pv_summaries_2 %>% 
 # filter(year == 2021) %>% 
  select(F.Group, tlp, lfmtlp) %>% 
  group_by(F.Group) %>% 
  mutate(mean_tlp_group = mean(tlp), 
         sd_tlp_group = sd(tlp), 
         mean_lfm_tlp_group = mean(lfmtlp), 
         sd_lfm_tlp_group = sd(lfmtlp), 
         .keep = "unused") %>% 
  distinct()
fgroup_pv_summaries

write_csv(fgroup_pv_summaries, (here("processed-data", "analysis 2.0", "fgroup_pv_summaries_2.csv")))

stats_df <- pv_summaries_2 %>% 
  select(spp, lfmtlp, tlp, F.Group, year, spp, date)

summary(aov(lfmtlp ~ F.Group + year + spp + date, data = stats_df))
summary(aov(tlp ~ F.Group + year + spp + date, data = stats_df))
```

```{r}
unique(pv_all_df$year)
```

####- PV plot

```{r}
dat_text <- data.frame(
  F.Group = c("Angiosperm", "Gymnosperm"),
  label   = c(NA, "b")
)

pv_plot <- pv_all_df %>%
  filter(!spp %in% c("ADFA", "CEME")) %>%
  ggplot(aes(
    x = -1 * water_potential,
    y = lfm,
    color = spp,
   # shape = as.factor(year)
  )) +
  geom_vline(aes(xintercept = -1*mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5, 
              aes(shape = as.factor(year))
             ) +
  color_many +
  theme(legend.position = "none",
        axis.title.x = element_text("")) +
  labs(title = "PV Curves",
       x = "",
       y = "LFM") +
  xlim(0, 10) +
  # annotate(
  #   geom = "text",
  #   x = 9,
  #   y = 232,
  #   label = 'b',
  #   fontface = 'bold',
  #   size = 10
  # ) +  
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 9, y = 232, label = label))+
  facet_wrap(~F.Group)+
  theme(plot.margin = unit(c(.2, .5,-.5, .25), "cm")) #margin(t = 0, r = 0, b = 0, l = 0, unit = "pt")
  
pv_plot
```
F.test: 
Allowa us to compare the variance between two groups, in this case angiosperms and gymnosperms:
```{r}

res.ftest <- var.test(lfm ~ F.Group, data = pv_all_df)
res.ftest
#There is a significant difference between the variaance 
```
Var decomp: 

https://cran.r-project.org/web/packages/specr/vignettes/decompose_var.html 
```{r}
pv_mod <- lmer(lfm~(1|water_potential) + (1|F.Group) + (1|plant), data = pv_all_df)
summary(pv_mod)
anova(pv_mod)

specr::icc_specs(pv_mod) %>%
  mutate_if(is.numeric, round, 2)
```

#MEM!

```{r}
m10.5 <- lmer(lfm~ water_potential*F.Group + (1|plant), data = pv_all_df)
summary(m10.5)
AIC(m10.5)

m10 <- lmer(lfm~ water_potential + F.Group + (1|plant), data = pv_all_df)
summary(m10)
AIC(m10)

anova(m10, m10.5) #don't need interaction

m10.75 <- lmer(lfm~ water_potential + F.Group + as.factor(year) + (1|plant), data = pv_all_df)
summary(m10.75) #yes add year

anova(m10, m10.75)

m10.757 <- lmer(lfm~ water_potential*as.factor(year) + F.Group + (1|plant), data = pv_all_df)
summary(m10.757)

anova(m10.75, m10.757) # dont need year interaction

qqnorm(resid(m10.75))
r <- resid(m10.75)
plot(fitted(m10.75), r)

anova(m10.75)
car::Anova(m10.75)

specr::icc_specs(m10.75) %>%
  mutate_if(is.numeric, round, 2)
```


####- PV plot, neg mpa
```{r}
dat_text <- data.frame(
  F.Group = c("Angiosperm", "Gymnosperm"),
  label   = c(NA, "b")
)

pv_plot_neg <- pv_all_df %>%
  filter(!spp %in% c("ADFA", "CEME")) %>%
  ggplot(aes(
    x = -1/water_potential,
    y = lfm,
    color = spp
  )) +
  geom_vline(aes(xintercept = -1/mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5) +
  color_many +
  theme(legend.position = "none",
        axis.title.x = element_text("")) +
  labs(title = "PV Curves",
       x = "",
       y = "LFM") +
  xlim(0, 15) +
  # annotate(
  #   geom = "text",
  #   x = 9,
  #   y = 232,
  #   label = 'b',
  #   fontface = 'bold',
  #   size = 10
  # ) +  
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 14, y = 232, label = label))+
  facet_wrap(~F.Group)+
  theme(plot.margin = unit(c(.2, .5,-.5, .25), "cm")) #margin(t = 0, r = 0, b = 0, l = 0, unit = "pt")
  
pv_plot_neg
```

Variance decomposition: 

Variance decomp. of max LFM (int of LFM at 0 mpa), look at prop variance due to spp, time, rest resid. 

to do it, a few possible ways: 

Way 1: 
fit lmer(maxLFM ~ 1|spp + 1|time)
Will tell you relative and total variance, will sum to >1
```{r}
m1 <- lmer(water_potential ~ lfm + (1|spp) + (1|month), data = pv_all_df)
m1
# 
r.squaredGLMM(m1)
```

OR
#####Max LFM
Way 2: 
do it with fixed effects, which will sum to 1
lm(maxLFM ~ spp * time)
lm(maxLFM ~ spp)
lm(maxLFM ~ time)

R^2 full = R^2 spp + R^2 time + R^2 spp * time)

```{r}
m1 <- lmer(maxLFM ~ spp * year + (1|plant), data = pv_all_df) 
# NOTE: Did we decide against or for an interaction term? I believe the following is how to caclulate the relative contributions of variables to the R2 with an interaction term, but I am not sure how to do it with spp + year...
m2 <- lmer(maxLFM ~ spp + (1|plant), data = pv_all_df)
m3 <- lmer(maxLFM ~ year + (1|plant), data = pv_all_df)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1]) #vector of r2s
mods <- c("m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m3, #m2, #week + mpa mod - mpa mod
         spp_effect = m1 - m2, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    spp_AND_time_effects =  m1 - (time_effect + spp_effect),
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects") ~ "PV Curve", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long

mod_all_long %>% 
  filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```
#####LFMtlp

```{r}
m1 <- lmer(lfm_at_tlp~ spp * year + (1|plant), data = pv_all_df) 
# NOTE: Did we decide against or for an interaction term? I believe the following is how to caclulate the relative contributions of variables to the R2 with an interaction term, but I am not sure how to do it with spp + year...
m2 <- lmer(lfm_at_tlp~ spp + (1|plant), data = pv_all_df)
m3 <- lmer(lfm_at_tlp~ year + (1|plant), data = pv_all_df)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1]) #vector of r2s
mods <- c("m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m3, #m2, #week + mpa mod - mpa mod
         spp_effect = m1 - m2, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    spp_AND_time_effects =  m1 - (time_effect + spp_effect),
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects") ~ "PV Curve", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long

mod_all_long %>% 
  filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```

#####JustLFM
```{r}
m1 <- lmer(lfm ~ spp * year + (1|plant), data = pv_all_df)
m2 <- lmer(lfm ~ spp + (1|plant), data = pv_all_df)
m3 <- lmer(lfm ~ year + (1|plant), data = pv_all_df)
m4 <- lmer(lfm ~ water_potential + (1|plant), data = pv_all_df)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3, m4)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1]) #vector of r2s
mods <- c("m1", "m2", "m3", "m4")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m2 - m4, #week + mpa mod - mpa mod
         spp_effect = m1 - m3 - m4, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    mpa_effect = m1 - m2 - m3,
    #spp_AND_time_effects =  m1 - time_effect - spp_effect - mpa_effect,
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long_lfm <- mod_all_df %>%
  select(time_effect,
         spp_effect,
         full_mod,
         #spp_AND_time_effects,
         mpa_effect) %>%
  pivot_longer(
    cols = c(
      time_effect,
      spp_effect,
      full_mod,
     # spp_AND_time_effects,
      mpa_effect
    ),
    names_to = "effect"
  ) %>%
  distinct() %>%
  mutate(
    analysis = case_when(
      effect %in% c("time_effect", 
                    "spp_effect",
                    #"spp_AND_time_effects",
                    "mpa_effect") ~ "PV Curve",
      effect %in% c("full_mod") ~ "Full Mod.",
      TRUE ~ as.character(effect)
    ),
    decomp = "After Leafout"
  )
mod_all_long_lfm

mod_all_long_lfm %>% 
  filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill

mod_all_long_lfm %>% 
  #filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```


OR (other method):
#### Way 3: 
psi ~ spp * year * LFM
(LFM + spp + year + LFM:spp + LFM:year + spp:year + LFM:spp:year)
Drop each component and look R^2, and build back up to model 

```{r}
full <- lmer(water_potential ~ lfm + spp + year + lfm:spp + lfm:year + spp:year + lfm:spp:year +(1|plant), data = pv_all_df)
full

drop_lfm <- lmer(water_potential ~ spp + year + lfm:spp + lfm:year + spp:year + lfm:spp:year +(1|plant), data = pv_all_df)

drop_spp <- lmer(water_potential ~ lfm + year + lfm:spp + lfm:year + spp:year + lfm:spp:year +(1|plant), data = pv_all_df)

drop_year <- lmer(water_potential ~ lfm + spp + lfm:spp + lfm:year + spp:year + lfm:spp:year +(1|plant), data = pv_all_df)

drop_lfmspp <- lmer(water_potential ~ lfm + spp + year + lfm:year + spp:year + lfm:spp:year +(1|plant), data = pv_all_df)

drop_lfmyear <- lmer(water_potential ~ lfm + spp + year + lfm:spp + spp:year + lfm:spp:year +(1|plant), data = pv_all_df)

drop_sppyear <- lmer(water_potential ~ lfm + spp + year + lfm:spp + lfm:year  + lfm:spp:year +(1|plant), data = pv_all_df)

drop_lfmsppyear <- lmer(water_potential ~ lfm + spp + year + lfm:spp + lfm:year + spp:year +(1|plant), data = pv_all_df)

mods_list <- list(full, 
                  drop_lfm, 
                  drop_lfmspp, 
                  drop_lfmsppyear, 
                  drop_lfmyear, 
                  drop_spp, 
                  drop_sppyear,
                  drop_year)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1], r2[[5]][1], r2[[6]][1], r2[[7]][1], r2[[8]][1]) #vector of r2s
mods <- c("full", "drop_lfm",
                  "drop_lfmspp", "drop_lfmsppyear", "drop_lfmyear",
                  "drop_spp", "drop_sppyear",
                  "drop_year")

mod_all_df1 <-  data.frame(mods, r2m)
mod_all_df1

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(lfm = full - drop_lfm, 
         spp = full - drop_spp, 
         year = full - drop_year, 
         lfmspp = full - drop_lfmspp, 
         lfmsppyear = full - drop_lfmsppyear, 
         lfmyear = full - drop_lfmyear, 
         sppyear = full - drop_sppyear, 
         other = full - (lfm + spp + year + lfmspp + lfmsppyear + lfmyear + sppyear)) #full minus the effects of mpa and week alone
mod_all_df

mod_all_long_lfm <- mod_all_df %>%
  select(lfm, 
         full,
         spp, 
         year, 
         lfmspp, 
         lfmsppyear, 
         lfmyear, 
         sppyear, 
         other) %>%
  pivot_longer(
    cols = c(
      lfm, 
         spp, 
         year, 
         lfmspp, 
         lfmsppyear, 
         lfmyear, 
         sppyear, 
        full, 
      other
    ),
    names_to = "effect"
  ) %>%
  distinct() %>%
  mutate(
    analysis = case_when(
      effect %in% c("lfm",
                    "spp",
                    "year",
                    "lfmspp",
                    "lfmsppyear",
                    "lfmyear",
                    "sppyear", 
                    "other") ~ "PV Mod.",
      effect %in% c("full") ~ "Full Mod.",
      TRUE ~ as.character(effect)
    ),
    decomp = "After Leafout"
  )
mod_all_long_lfm

mod_all_long_lfm %>% 
  #filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") 

mod_all_long_lfm %>% 
  filter(analysis == "PV Mod.") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") 
```

# Section 2: Flam curve phys data

```{r, warning=FALSE}
# flam_curve_phys_all_raw <- read_csv(here("processed-data", "analysis 2.0", "flam_curve_phys_all.csv"), show_col_types = FALSE)
flam_curve_phys_all_raw <- read_csv(here("processed-data", "analysis 2.0", "sierra_flam_data_all.csv"), show_col_types = FALSE)

flam_curve_df <- flam_curve_phys_all_raw %>% 
   filter(!spp %in% c("ADFA", "CEME")) %>% 
  mutate(water_potential = -1*pos_mpa, 
         swc = swc_sat, 
         month = as.factor(month)) %>% 
  group_by(spp) %>% 
  mutate(plant = udpipe::unique_identifier(individual), 
         maxLFM = gww_gdw_saturated * 100) %>% 
  mutate(spp = toupper(spp)) %>% 
  mutate(strategy = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "Isohydric", 
    spp == "PIJE" ~ "Isohydric", 
     spp == "CADE" ~ "Isohydric", 
    spp == "CECO" ~ "Anisohydric", 
    spp == "ARPA" ~ "Anisohydric", 
    spp == "QUKE" ~ "Anisohydric"
  )) %>% 
   mutate(strategy_binary = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "1", 
    spp == "ARPA" ~ "2", 
    spp == "CADE" ~ "1", 
    spp == "CECO" ~ "2", 
    spp == "PIJE" ~ "1", 
    spp == "QUKE" ~ "2"
  )) %>% 
   mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(type = case_when(
    spp == "PIJE" ~ "tree", 
    spp == "QUKE" ~ "tree", 
    spp == "CECO" ~ "shrub", 
    spp == "ARPA" ~ "shrub", 
    spp == "ABCO" ~ "tree", 
    spp == "CADE" ~ "tree"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "ARPA" ~ "Angiosperm", 
    spp == "ABCO" ~ "Gymnosperm",
    spp == "CADE" ~ "Gymnosperm",
    spp == "CECO" ~ "Angiosperm",
    spp == "PIJE" ~ "Gymnosperm",
    spp == "QUKE" ~ "Angiosperm"
  )) %>% 
  select(lfm, water_potential, mpa, year, month, year_month, plant, F.Group, spp)
#%>% 
 # select(spp, swc, lfm, mpa, month, tlp, water_potential, po, individual, plant)

write_csv(flam_curve_df, here("processed-data", "analysis 2.0", "flam_curve_vardecomp_2.csv"))
```

#MEM!

```{r}
m11.5 <- lmer(lfm~ water_potential + F.Group + (1|plant), data = flam_curve_df)
summary(m11)

m11 <- lmer(lfm~ water_potential*F.Group + (1|plant), data = flam_curve_df)

anova(m11, m11.5) #Yes interaction between mpa and f group

m11.75  <- lmer(lfm~ water_potential*F.Group + as.factor(year) + (1|plant), data = flam_curve_df)
m11.75 #there shouldn't be an interaction between year and f group, so dont include
summary(m11.75)

anova(m11, m11.75) 

qqnorm(resid(m11.75))
r <- resid(m11.75)
plot(fitted(m11.75
            ), r)

anova(m11.75)
car::Anova(m11.75)

performance::multicollinearity(m11.75)

specr::icc_specs(m11) %>%
  mutate_if(is.numeric, round, 2)
```

#####- Flam plot
```{r}
dat_text <- data.frame(
  F.Group = c("Angiosperm", "Gymnosperm"),
  label   = c(NA, "c")
)

flam_plot <- flam_curve_df %>% 
  filter(lfm < 300, 
         lfm > 50) %>% 
  filter(!spp %in% c("ADFA", "CEME")) %>% 
  ggplot(aes(y = lfm, 
             x = -1*water_potential, 
             color = spp)) +
  geom_vline(aes(xintercept = -1*mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5, 
             aes( shape = as.factor(year))
             ) +
 # geom_smooth(method = "lm", se = F) +
  color_many +
  theme(legend.position = "none")+
  labs(title = "Flam", 
       x = "Water Potential", 
       y = "LFM")+
  theme(plot.margin = unit(c(.2, .5, .3, .25), "cm")) +
 # xlim(0, 9) + 
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 9, y = 210, label = label))+
 # annotate(geom = "text", x = 9, y = 225, label = 'c', fontface = 'bold', size = 10)+
  facet_wrap(~F.Group)
flam_plot
```

#####- Flam plot, neg
```{r}
dat_text <- data.frame(
  F.Group = c("Angiosperm", "Gymnosperm"),
  label   = c(NA, "c")
)

flam_plot_neg <- flam_curve_df %>% 
  filter(lfm < 300, 
         lfm > 50) %>% 
  filter(!spp %in% c("ADFA", "CEME")) %>% 
  ggplot(aes(y = lfm, 
             x = -1/water_potential, 
             color = spp)) +
  geom_vline(aes(xintercept = -1/mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5) +
 # geom_smooth(method = "lm", se = F) +
  color_many +
  theme(legend.position = "none")+
  labs(title = "Flam", 
       x = "Water Potential", 
       y = "LFM")+
  theme(plot.margin = unit(c(.2, .5, .3, .25), "cm")) +
  xlim(0, 15) + 
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 14, y = 210, label = label))+
 # annotate(geom = "text", x = 9, y = 225, label = 'c', fontface = 'bold', size = 10)+
  facet_wrap(~F.Group)
flam_plotNeg
```

####MaxLFM
```{r}
m1 <- lmer(maxLFM ~ spp*year_month + (1|plant), data = flam_curve_df)
m2 <- lmer(maxLFM ~ spp + (1|plant), data = flam_curve_df)
m3 <- lmer(maxLFM ~ year_month + (1|plant), data = flam_curve_df)

anova(m1)
summary(m1)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1]) #vector of r2s
mods <- c("m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m2, #week + mpa mod - mpa mod
         spp_effect = m1 - m3, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    spp_AND_time_effects =  m1 - (time_effect + spp_effect)
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long_flam <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects") ~ "Flam Curve", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long_flam

mod_all_long_flam %>% 
  filter(analysis == "Flam Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```

#####LFMtlp

```{r}
m1 <- lmer(lfm_at_tlp~ spp * year + (1|plant), data = pv_all_df) 
# NOTE: Did we decide against or for an interaction term? I believe the following is how to caclulate the relative contributions of variables to the R2 with an interaction term, but I am not sure how to do it with spp + year...
m2 <- lmer(lfm_at_tlp~ spp + (1|plant), data = pv_all_df)
m3 <- lmer(lfm_at_tlp~ year + (1|plant), data = pv_all_df)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1]) #vector of r2s
mods <- c("m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m3, #m2, #week + mpa mod - mpa mod
         spp_effect = m1 - m2, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    spp_AND_time_effects =  m1 - (time_effect + spp_effect),
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects") ~ "PV Curve", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long

mod_all_long %>% 
  filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```

###Just LFM
```{r}
m1 <- lmer(lfm ~ spp + water_potential + year_month + (1|plant), data = flam_curve_df)

m2 <- lmer(lfm ~ spp + (1|plant), data = flam_curve_df)
m2.5 = lmer(lfm ~ spp + water_potential + (1|plant), data = flam_curve_df)

m3 <- lmer(lfm ~ year_month + (1|plant), data = flam_curve_df)
m4 <- lmer(lfm ~ water_potential + (1|plant), data = flam_curve_df)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3, m4)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1]) #vector of r2s
mods <- c("m1", "m2", "m3", "m4")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - (m2 - m4), #week + mpa mod - mpa mod
         spp_effect = m1 - (m3 - m4), #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    mpa_effect= m1 - (m2 - m3),
    spp_AND_time_effects =  m1 - time_effect - spp_effect - mpa_effect
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long_flam_lfm <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects, mpa_effect) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects, mpa_effect), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects", "mpa_effect") ~ "Flam Curve", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long_flam_lfm

mod_all_long_flam_lfm %>% 
  filter(analysis == "Flam Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```

```{r}
full <- lmer(water_potential ~ lfm + spp + year_month + lfm:spp + lfm:year_month + spp:year_month + lfm:spp:year_month +(1|plant), data = flam_curve_df)
full

drop_lfm <- lmer(water_potential ~ spp + year_month + lfm:spp + lfm:year_month + spp:year_month + lfm:spp:year_month +(1|plant), data = flam_curve_df)

drop_spp <- lmer(water_potential ~ lfm + year_month + lfm:spp + lfm:year_month + spp:year_month + lfm:spp:year_month +(1|plant), data = flam_curve_df)

drop_year_month <- lmer(water_potential ~ lfm + spp + lfm:spp + lfm:year_month + spp:year_month + lfm:spp:year_month +(1|plant), data = flam_curve_df)

drop_lfmspp <- lmer(water_potential ~ lfm + spp + year_month + lfm:year_month + spp:year_month + lfm:spp:year_month +(1|plant), data = flam_curve_df)

drop_lfmyear_month <- lmer(water_potential ~ lfm + spp + year_month + lfm:spp + spp:year_month + lfm:spp:year_month +(1|plant), data = flam_curve_df)

drop_sppyear_month <- lmer(water_potential ~ lfm + spp + year_month + lfm:spp + lfm:year_month  + lfm:spp:year_month +(1|plant), data = flam_curve_df)

drop_lfmsppyear_month <- lmer(water_potential ~ lfm + spp + year_month + lfm:spp + lfm:year_month + spp:year_month +(1|plant), data = flam_curve_df)

mods_list <- list(full, 
                  drop_lfm, 
                  drop_lfmspp, 
                  drop_lfmsppyear_month, 
                  drop_lfmyear_month, 
                  drop_spp, 
                  drop_sppyear_month,
                  drop_year_month)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1], r2[[5]][1], r2[[6]][1], r2[[7]][1], r2[[8]][1]) #vector of r2s
mods <- c("full", "drop_lfm",
                  "drop_lfmspp", "drop_lfmsppyear_month", "drop_lfmyear_month",
                  "drop_spp", "drop_sppyear_month",
                  "drop_year_month")

mod_all_df1 <-  data.frame(mods, r2m)
mod_all_df1

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(lfm = full - drop_lfm, 
         spp = full - drop_spp, 
         year_month = full - drop_year_month, 
         lfmspp = full - drop_lfmspp, 
         lfmsppyear_month = full - drop_lfmsppyear_month, 
         lfmyear_month = full - drop_lfmyear_month, 
         sppyear_month = full - drop_sppyear_month) #full minus the effects of mpa and week alone
mod_all_df

mod_all_long_lfm <- mod_all_df %>%
  select(lfm, 
         full,
         spp, 
         year_month, 
         lfmspp, 
         lfmsppyear_month, 
         lfmyear_month, 
         sppyear_month) %>%
  pivot_longer(
    cols = c(
      lfm, 
         spp, 
         year_month, 
         lfmspp, 
         lfmsppyear_month, 
         lfmyear_month, 
         sppyear_month, 
        full
    ),
    names_to = "effect"
  ) %>%
  distinct() %>%
  mutate(
    analysis = case_when(
      effect %in% c("lfm",
                    "spp",
                    "year_month",
                    "lfmspp",
                    "lfmsppyear_month",
                    "lfmyear_month",
                    "sppyear_month") ~ "PV Mod.",
      effect %in% c("full") ~ "Full Mod.",
      TRUE ~ as.character(effect)
    ),
    decomp = "After Leafout"
  )
mod_all_long_lfm

mod_all_long_lfm %>% 
  #filter(analysis == "PV Curve") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```


# Section 3: Field data

```{r}
field_data_all <- read_csv(here("processed-data", "analysis 2.0", "field_data_2020_2021.csv"), show_col_types = FALSE) %>% 
  mutate(tlp = mean_tlp_spp, 
         po = mean_po_date) %>% 
 # select(-mpa, -water_potential) %>% 
  mutate(water_potential = midday, 
         unique_id2 = str_c(spp, "_",pod, '_', site),
         plant = udpipe::unique_identifier(unique_id2)) %>% 
  mutate(year_month = str_c(year, '_', month)) %>% 
 # group_by(spp, plant) %>% 
  mutate(maxLFM = wettest_lfm)  %>% 
  mutate(strategy = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "Isohydric", 
    spp == "PIJE" ~ "Isohydric", 
     spp == "CADE" ~ "Isohydric", 
    spp == "CECO" ~ "Anisohydric", 
    spp == "ARPA" ~ "Anisohydric", 
    spp == "QUKE" ~ "Anisohydric"
  )) %>% 
   mutate(strategy_binary = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "1", 
    spp == "ARPA" ~ "2", 
    spp == "CADE" ~ "1", 
    spp == "CECO" ~ "2", 
    spp == "PIJE" ~ "1", 
    spp == "QUKE" ~ "2"
  )) %>% 
   mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(type = case_when(
    spp == "PIJE" ~ "tree", 
    spp == "QUKE" ~ "tree", 
    spp == "CECO" ~ "shrub", 
    spp == "ARPA" ~ "shrub", 
    spp == "ABCO" ~ "tree", 
    spp == "CADE" ~ "tree"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "ARPA" ~ "Angiosperm", 
    spp == "ABCO" ~ "Gymnosperm",
    spp == "CADE" ~ "Gymnosperm",
    spp == "CECO" ~ "Angiosperm",
    spp == "PIJE" ~ "Gymnosperm",
    spp == "QUKE" ~ "Angiosperm"
  )) 

field_data_all_2 <- field_data_all %>% 
  drop_na(lfm, water_potential, plant, F.Group, year)

write_csv(field_data_all, (here("processed-data", "analysis 2.0", "field_data_vardecomp_2.csv")))
```

#MEM!
```{r}
o1 <-lme(lconc ~ lTime*group, random=~1|Subject, data=Cefamandole)

o1 <- lme(lfm~ water_potential*as.factor(year) + water_potential*F.Group + F.Group, random = ~1|plant, 
          data = field_data_all_2)


os1 <- segmented(o1, ~water_potential, x.diff=~F.Group, z.psi=~water_potential)

slope(os1, by=list(z=.1)) #the slope estimates when z=.1
```


```{r}
m12 <- lmer(sqrt(lfm)~ water_potential*F.Group*as.factor(year) + (1|plant), data = field_data_all)
summary(m12) #doenst make sense to have year and F group interaction, don't use!

m12.5 <- lmer(lfm~ water_potential*F.Group + as.factor(year) + (1|plant), data = field_data_all)
summary(m12.5)

#anova(m12, m12.5) #m12 is better

#remove interaction between F.Group and year: 
m12.45<- lmer(lfm~ water_potential*as.factor(year) + F.Group + (1|plant), data = field_data_all)
summary(m12.45)
```


```{r}
m12.4<- lmer(log(lfm)~ water_potential*as.factor(year) + water_potential*F.Group + F.Group + (1|plant), data = field_data_all)

summary(m12.4)

anova(m12.5, m12.4, m12.45) #with all interactions is better\

qqnorm(resid(m12.4))
r <- resid(m12.4)
plot(fitted(m12.4
            ), r) #right skewed

car::Anova(m12.4)

performance::multicollinearity(m12.4)

specr::icc_specs(m12) %>%
  mutate_if(is.numeric, round, 2)
```

#####- Field plot

```{r}
dat_text <- data.frame(
  F.Group = c("Angiosperm", "Gymnosperm"),
  label   = c(NA, "a")
)

field_plot <- field_data_all %>% 
  filter(lfm < 300, 
         lfm > 50) %>% 
  ggplot(aes(y = lfm, 
             x = -1*water_potential, 
             color = spp)) +
  geom_vline(aes(xintercept = -1*mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_jitter(alpha = .5, 
              #size = 2,
             aes(shape = as.factor(year))
             )+
  facet_wrap(~F.Group) +
 # geom_smooth(method = "lm", se = F) +
  color_many +
  theme(legend.position = "none") +
  labs(title = "Field", 
       x = "", 
       y = "LFM") +
  theme(plot.margin = unit(c(.2, .5, -.5, .25), "cm")) +
  xlim(0, 10) +
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 9, 
                y = 300, 
                #y = 2,
                label = label)
 )
  #annotate(geom = "text", x = 9, y = 300, label = 'a', fontface = 'bold', size = 10) 
field_plot
```
##### Field plot, log(lfm)
```{r}
field_plot_logged<- field_data_all %>% 
  filter(lfm < 300, 
         lfm > 50) %>% 
  ggplot(aes(y = log(lfm), 
             x = -1*water_potential, 
             color = spp)) +
  geom_vline(aes(xintercept = -1*mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5, 
             aes(shape = as.factor(year))
             )+
  facet_wrap(~F.Group) +
 # geom_smooth(method = "lm", se = F) +
  color_many +
  theme(legend.position = "none") +
  labs(title = "Field", 
       x = "", 
       y = "LFM") +
  theme(plot.margin = unit(c(.2, .5, -.5, .25), "cm")) +
  xlim(0, 10) +
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 9, 
               # y = 300, 
                y = 2,
                label = label)
 )
  #annotate(geom = "text", x = 9, y = 300, label = 'a', fontface = 'bold', size = 10) 
field_plot_logged
```

#####- Field plot, neg

```{r}
dat_text <- data.frame(
  F.Group = c("Angiosperm", "Gymnosperm"),
  label   = c(NA, "a")
)

field_plot_neg <- field_data_all %>% 
  filter(lfm < 300, 
         lfm > 50) %>% 
  ggplot(aes(y = lfm, 
             x = -1/water_potential, 
             color = spp)) +
  geom_vline(aes(xintercept = -1/mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5)+
  facet_wrap(~F.Group) +
 # geom_smooth(method = "lm", se = F) +
  color_many +
  theme(legend.position = "none") +
  labs(title = "Field", 
       x = "", 
       y = "LFM") +
  theme(plot.margin = unit(c(.2, .5, -.5, .25), "cm")) +
  xlim(0, 2) +
  geom_text(
  data    = dat_text,
  color = "black",
  fontface = 'bold', size = 10,
  mapping = aes(x = 1.7, y = 300, label = label))
  #annotate(geom = "text", x = 9, y = 300, label = 'a', fontface = 'bold', size = 10) 
field_plot_neg
```
m1 <- lmer(lfm ~ water_potential*spp * month + (1|plant), data = field_data_all)
m2 <- lmer(lfm ~ spp + (1|plant), data = field_data_all)
m3 <- lmer(lfm ~ month + (1|plant), data = field_data_all)
m4 <- lmer(lfm ~ water_potential + (1|plant), data = field_data_all)

#####try using r.squaredGLMM:
mods_list <- list(m1, m2, m3, m4)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1]) #vector of r2s
mods <- c("m1", "m2", "m3", "m4")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m2, #week + mpa mod - mpa mod
         spp_effect = m1 - m3, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
        mpa_effect = m1 - m4,
    spp_AND_time_effects =  m1 - time_effect - spp_effect - mpa_effect,
         ) #full minus the effects of mpa and week alone
mod_all_df

######for plotting (maybe?)
mod_all_long_field_lfm <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects, mpa_effect) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects, mpa_effect), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects", "mpa_effect") ~ "Field", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout") 

mod_all_long_field_lfm

mod_all_long_field_lfm %>% 
  filter(analysis == "Field") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill +
  ylim(0, 1)
  
#####MaxLFM
```{r}
m1 <- lmer(maxLFM ~ spp * year_month + (1|plant), data = field_data_all)
m2 <- lmer(maxLFM ~ spp + (1|plant), data = field_data_all)
m3 <- lmer(maxLFM ~ year_month + (1|plant), data = field_data_all)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1]) #vector of r2s
mods <- c("m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m2, #week + mpa mod - mpa mod
         spp_effect = m1 - m3, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
    spp_AND_time_effects =  m1 - (time_effect + spp_effect)
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long_field <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects") ~ "Field", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout")
mod_all_long_field

mod_all_long_field %>% 
  filter(analysis == "Field") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill
```
#####Just LFM:

```{r}
m1 <- lmer(lfm ~ water_potential + spp + month + (1|plant), data = field_data_all)
m2 <- lmer(lfm ~ spp + (1|plant), data = field_data_all)
m3 <- lmer(lfm ~ month + (1|plant), data = field_data_all)
m4 <- lmer(lfm ~ water_potential + (1|plant), data = field_data_all)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3, m4)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1], r2[[4]][1]) #vector of r2s
mods <- c("m1", "m2", "m3", "m4")

mod_all_df1 <-  data.frame(mods, r2m)

mod_all_df <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m2 -m4, #week + mpa mod - mpa mod
         spp_effect = m1 - m3 - m4, #week + mpa mod - week mod
         full_mod = m1, #week + mpa mod 
        mpa_effect = m1 - m3 - m2,
    spp_AND_time_effects =  m1 - time_effect - spp_effect - mpa_effect,
         ) #full minus the effects of mpa and week alone
mod_all_df

#for plotting (maybe?)
mod_all_long_field_lfm <- mod_all_df %>% 
  select(time_effect, spp_effect, full_mod, spp_AND_time_effects, mpa_effect) %>% 
  pivot_longer(cols = c(time_effect, spp_effect, full_mod, spp_AND_time_effects, mpa_effect), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "spp_effect", "spp_AND_time_effects", "mpa_effect") ~ "Field", 
    effect %in% c("full_mod") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout") 

mod_all_long_field_lfm

mod_all_long_field_lfm %>% 
  filter(analysis == "Field") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill +
  ylim(0, 1)
```

#Combine to compare: 

```{r}
var_decomp_df <- bind_rows(mod_all_long_field,mod_all_long_flam, mod_all_long)

var_decomp_df <- var_decomp_df %>% 
  mutate(Effect = case_when(
    effect == 'time_effect' ~ "Timing",
    effect == 'spp_effect' ~ "Species",
    effect == 'spp_AND_time_effects' ~ "Species & Timing",
    effect == 'full_mod' ~ "Full Model"
  ))
var_decomp_df$Effect <- factor(var_decomp_df$Effect, levels = c("Species & Timing", "Timing", "Species", "Full Model"))

var_decomp_df %>% 
  filter(analysis %in% c("PV Curve", "Flam Curve", "Field")) %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = Effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor", 
       title = "LFMmax",
       fill = "Contribution") +
  color_fill
```

```{r}
var_decomp_df_lfm <- bind_rows(mod_all_long_field_lfm, mod_all_long_flam_lfm, mod_all_long_lfm)

var_decomp_df_lfm %>% 
  filter(analysis %in% c("PV Curve", "Flam Curve", "Field")) %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared", 
       x = "Predictor", 
       title ="LFM") +
  color_fill
```
#-MEMs combine:
```{r}
tab_model <- sjPlot::tab_model(m10.75, m11.75, m12.4,
                               show.reflvl = TRUE, 
          digits = 3, 
          show.aic = TRUE, 
          show.ci = FALSE,
          show.icc = FALSE, 
         string.pred = "Coeffcient", 
        dv.labels = c("PV", "Flam", "Field"),
         title = "LFM ~ MPa",
  string.p = "P-Value", 
  p.style = "stars")
tab_model
```

#- Scatterplots, combine
```{r}
field_plot_leg <- field_data_all %>% 
  filter(lfm < 300, 
         lfm > 50) %>% 
  ggplot(aes(y = lfm, 
             x = -1*water_potential, 
             color = spp)) +
  geom_vline(aes(xintercept = -1*mean_tlp_group, 
                 lty = F.Group), data = fgroup_pv_summaries) +
  geom_point(alpha = .5, 
             aes(shape = as.factor(year))) +
  labs(color = "Species", 
       lty = "TLP", 
       shape = "Year") +
 # geom_smooth(method = "lm", se = F) +
  color_many 
legend <- cowplot::get_legend(field_plot_leg)
```
####combine
```{r, fig.height=6, fig.width=5}
#Mpas:
plots <- cowplot::plot_grid(field_plot, pv_plot, flam_plot,
          ncol = 1, 
         nrow = 3
          )
plots_legend <- cowplot::plot_grid(plots, legend, rel_widths = c(5, 1), rel_heights = c(-.1, -0.1, -.1))
plots_legend

#ggsave(plot=plots_legend, bg = "white" , here::here("figures", "mpa_flam_metrics_unscaled"), device="jpg")

ggsave(plot=plots_legend, bg = "white" , here::here("figures", "flam_pv_field"), device="jpg")
#ggsave(plot=plots_legend, bg = "white" , here::here("figures", "flam_pv_field_fgroups"), device="jpg")
```

####combine, neg
```{r, fig.height=6, fig.width=5}
#Mpas:
plots_neg <- cowplot::plot_grid(field_plot_neg, pv_plot_neg, flam_plot_neg,
          ncol = 1, 
         nrow = 3
          )
plots_legend_neg <- cowplot::plot_grid(plots_neg, legend, rel_widths = c(5, 1), rel_heights = c(-.1, -0.1, -.1))
plots_legend_neg

#ggsave(plot=plots_legend, bg = "white" , here::here("figures", "mpa_flam_metrics_unscaled"), device="jpg")

ggsave(plot=plots_legend, bg = "white" , here::here("figures", "flam_pv_field"), device="jpg")
#ggsave(plot=plots_legend, bg = "white" , here::here("figures", "flam_pv_field_fgroups"), device="jpg")
```
#-------------

#Separate species: 

####field_data_all
```{r}
field_data_all <- field_data_all %>% 
  drop_na(spp)
for (i in unique(field_data_all$spp)) {
  
 df <- field_data_all %>% 
   drop_na(spp, lfm, water_potential) %>% 
  filter(spp == i) 
 
m1 <- lmer(lfm ~ water_potential + location + (1|plant), data =df)
m2 <- lmer(lfm ~ water_potential + (1|plant), data =df)
m3 <- lmer(lfm ~ location + (1|plant), data =df)

#try using r.squaredGLMM:
mods_list <- list(m1, m2, m3)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1], r2[[2]][1], r2[[3]][1]) #vector of r2s
mods <- c("m1", "m2", "m3")

mod_all_df1 <-  data.frame(mods, r2m)

p <- mod_all_df1 %>%
  pivot_wider(names_from = mods,
              values_from = r2m) %>%
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - m2,
    #week + mpa mod - mpa mod
    mpa_effect = m1 - m3,
    #week + mpa mod - week mod
    time_mpa_effect = m1,
    #week + mpa mod
    mpa_AND_time_effects =  m1 - (time_effect - mpa_effect),
  ) %>% #full minus the effects of mpa and week alone
  select(time_effect,
         mpa_effect,
         time_mpa_effect,
         mpa_AND_time_effects) %>%
  pivot_longer(
    cols = c(
      time_effect,
      mpa_effect,
      time_mpa_effect,
      mpa_AND_time_effects
    ),
    names_to = "effect"
  ) %>%
  distinct() %>%
  mutate(
    analysis = case_when(
      effect %in% c("time_effect", "mpa_effect", "mpa_AND_time_effects") ~ "Field",
      effect %in% c("time_mpa_effect") ~ "Full Mod.",
      TRUE ~ as.character(effect)
    ),
    decomp = "After Leafout"
  ) %>%
  filter(analysis == "Field") %>%
  ggplot(aes(x = analysis,
             y = value,
             fill = effect)) +
  geom_col(stat = "identity") +
  # geom_text(aes(label = value)) +
  color_many +
  labs(y = "R squared",
       x = "Predictor") +
  color_fill +
  labs(title = i)
p

if (!is.null(p))
  plot(p)

}
```
####flam_curve_df

```{r}
flam_curve_df <-flam_curve_df %>% 
  drop_na(spp)

for (i in unique(flam_curve_df$spp)) {
  
 df <-flam_curve_df %>% 
   drop_na(spp, lfm, water_potential) %>% 
  filter(spp == i) 
 
m1 <- lmer(lfm ~ water_potential + year_month + (1|plant), data = df)
#m2 <- lmer(lfm ~ spp + (1|plant), data = df)
m3 <- lmer(lfm ~ year_month + (1|plant), data = df)
m4 <- lmer(lfm ~ water_potential + (1|plant), data = df)

#try using r.squaredGLMM:
mods_list <- list(m1, m3, m4)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1],r2[[3]][1], r2[[3]][1])#vector of r2s
mods <- c("m1", "m3", "m4")

mod_all_df1 <-  data.frame(mods, r2m)

p <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - (m4), #week + mpa mod - mpa mod
         mpa_effect = m1 - (m3), #week + mpa mod - week mod
        # spp_effect = m1 - (m4 - m3), #week + mpa mod 
    mpa_AND_time_effects =  m1 - (time_effect + mpa_effect),
    time_mpa_effect = m1
         ) %>% #full minus the effects of mpa and week alone  
  select(time_effect, mpa_effect, time_mpa_effect, mpa_AND_time_effects, #spp_effect
         ) %>% 
  pivot_longer(cols = c(time_effect, mpa_effect, time_mpa_effect, mpa_AND_time_effects, #spp_effect
                        ), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "mpa_effect", "mpa_AND_time_effects") ~ "PV", 
    effect %in% c("time_mpa_effect") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout") %>% 
  filter(analysis == "PV") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  #color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill +
    labs(title = i)
p
  
  if (!is.null(p)) plot(p)
  
}
```

####pv_all_df
```{r}
pv_all_df <- pv_all_df %>% 
  drop_na(spp)

for (i in unique(pv_all_df$spp)) {
  
 df <- pv_all_df %>% 
   drop_na(spp, lfm, water_potential) %>% 
  filter(spp == i) 
 
m1 <- lmer(lfm ~ water_potential + year + (1|plant), data = df)
#m2 <- lmer(lfm ~ spp + (1|plant), data = df)
m3 <- lmer(lfm ~ year + (1|plant), data = df)
m4 <- lmer(lfm ~ water_potential + (1|plant), data = df)

#try using r.squaredGLMM:
mods_list <- list(m1, m3, m4)

r2 <- lapply(mods_list, r.squaredGLMM)
r2

r2m <- c(r2[[1]][1],r2[[3]][1], r2[[3]][1])#vector of r2s
mods <- c("m1", "m3", "m4")

mod_all_df1 <-  data.frame(mods, r2m)

p <- mod_all_df1 %>% 
  pivot_wider(names_from = mods, 
              values_from = r2m) %>% 
  mutate(
    #spp_AND_time_effects =  m3 - week_effect - mpa_effect,
    time_effect = m1 - (m4), #week + mpa mod - mpa mod
         mpa_effect = m1 - (m3), #week + mpa mod - week mod
        # spp_effect = m1 - (m4 - m3), #week + mpa mod 
    mpa_AND_time_effects =  m1 - (time_effect - mpa_effect),
    time_mpa_effect = m1
         ) %>% #full minus the effects of mpa and week alone  
  select(time_effect, mpa_effect, time_mpa_effect, mpa_AND_time_effects, #spp_effect
         ) %>% 
  pivot_longer(cols = c(time_effect, mpa_effect, time_mpa_effect, mpa_AND_time_effects, #spp_effect
                        ), 
    names_to = "effect") %>% 
  distinct() %>% 
  mutate(analysis = case_when(
    effect %in% c("time_effect", "mpa_effect", "mpa_AND_time_effects") ~ "PV", 
    effect %in% c("time_mpa_effect") ~ "Full Mod.", 
    TRUE ~ as.character(effect)), 
    decomp = "After Leafout") %>% 
  filter(analysis == "PV") %>% 
  ggplot(aes(x = analysis, 
             y = value, 
         fill = effect)) +
  geom_col(stat = "identity") +
 # geom_text(aes(label = value)) +
  #color_many +
  labs(y = "R squared", 
       x = "Predictor") +
  color_fill +
    labs(title = i)
p
  
  if (!is.null(p)) plot(p)
  
}
```
