---
title: "RWC x LFM"
author: "Indra Boving"
date: "10/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(janitor)
library(tidyverse)
library(plotly)
library(DT)
library(broom)
library(lubridate)
library(udpipe)
```

### Section 1: Pressure Volume Curves

# Subsection 1.1: Read in data

```{r}
data <- read_csv(here("data", "processed-data", "allcurves_clean.csv"), show_col_types = FALSE) %>% 
  mutate(sample = as.factor(sample)) %>% 
  mutate(month = as.factor(month))
```
 
## Subsection 1.2
 
Look at just one species and timepoint: CECO and fall

```{r}
pv.ceco.all <- data %>% 
  filter(spp == "CECO")

ggplot(pv.ceco.all) +
  geom_point(aes(y = rwd, x = neg_mpa)) +
  theme_bw()

pv.ceco.fall.summary <- data %>%
  group_by(date) %>% 
  filter(spp == "CECO" & timing == "fall" ) %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))
```

```{r}
ggplot(pv.ceco.fall.summary) +
    geom_bar(aes(y = mean, x = date), position="dodge", stat="identity") +
    geom_errorbar(aes(x=date, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="black", alpha=0.9) +
   labs(title = "ceco TLP, fall dates") +
   theme_bw()
```

In fall and spring: 

- fall both dates combined:

```{r}
pv.ceco.summary <- data %>%
  group_by(timing) %>% 
  filter(spp == "CECO") %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))

 ggplot(pv.ceco.summary) +
    geom_bar(aes(y = mean, x = timing), position="dodge", stat="identity") +
    geom_errorbar(aes(x=timing, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="black", alpha=0.9) +
   labs(title = "ceco TLP, all dates", 
        y = "TLP (-Mpa)", 
        x = "timing") +
   theme_bw()
```

See if sig. difference in TLPs

```{r}
#Split df into groups, then pull sample vectors
fall.ceco <- pv.ceco.all %>% 
  filter(timing == "fall") %>% 
  group_by(sample) %>% 
  arrange(water_potential) %>%
  filter(row_number()==1) %>% 
  pull(tlp)

spring.ceco <- pv.ceco.all %>% 
  filter(timing == "spring") %>% 
   group_by(sample) %>% 
  arrange(water_potential) %>%
  filter(row_number()==1) %>% 
  pull(tlp)

ceco_tlp_t <- t.test(spring.ceco, fall.ceco)
ceco_tlp_t
```


# Subsection 1.3: Try to predict Mpa from LFM with just one species

1.  Get datasets in order:

-   select for just the species and date we are interested in
-   pull the TLP as a value
-   use the value we created to select just the points above the TLP and make one dataset, and also another dataset with just the points below the TLP

```{r message=FALSE, warnings=F}
pv.ceco.fall <- data %>%
  filter(spp == "CECO" & timing == "fall" ) %>% 
  filter(sample != 3)

ceco.tlp <- pv.ceco.fall %>% 
  summarise(mean(tlp)) %>% pull()
ceco.tlp
```

```{r, message=FALSE, warnings=F}
pv.ceco.fall %>% 
  ggplot(aes(y = water_potential, x = lfm, color = as.factor(date))) +
  geom_point() +
  geom_hline(yintercept = ceco.tlp,
             colour = "cyan") +
  labs(title = "ceco Pressure Volume Curves, LFM x Mpa")
  theme_bw()
```

Bar chart of TLP and sd:

```{r}
pv.ceco.fall.summary <- data %>%
  group_by(date) %>% 
  filter(spp == "CECO" & timing == "fall" ) %>% 
  summarise(n=n(), mean=mean(tlp),sd=sd(tlp))

 ggplot(pv.ceco.fall.summary) +
    geom_bar(aes(y = mean, x = date), position="dodge", stat="identity") +
    geom_errorbar(aes(x=date, ymin=mean-sd, ymax=mean+sd), width=0.4, colour="orange", alpha=0.9, size=1.3) +
   labs(title = "ceco TLP with sd") +
   theme_bw()
```
Subset data based on TLP: 

```{r}
ceco.above.tlp <- pv.ceco.fall %>% 
  filter(water_potential > tlp) %>% 
  filter(lfm < 200, lfm > 90)

ceco.below.tlp <- pv.ceco.fall %>% 
  filter(water_potential < tlp)%>% 
  filter(lfm < 200, lfm > 90)
```

2.  For points below the TLP, there should be a linear relationship between -1/Mpa and LFM

```{r}
ceco.below.tlp %>% 
ggplot(aes(y = -1/water_potential, x = lfm, color = as.factor(sample), shape = as.factor(month))) +
  geom_jitter(alpha = .6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, size = .5, alpha = .5) +
  theme_bw()

fit.below <-lm(-1/water_potential~lfm, ceco.below.tlp)
summary(fit.below)

mpa.predicted.r <- predict.lm(fit.below, newdata = data_frame(lfm = 180)) %>% as.numeric() #use this to extract lfm
mpa.predicted.r
```

3.  For points above the TLP, there should be a linear relationship between Mpa and lfm

```{r}
ggplot(data = ceco.above.tlp, aes(y = water_potential, x = lfm, color = sample, shape = as.factor(date))) +
  geom_jitter(alpha = .6, size = 1) +
  geom_smooth(method = "lm", se = FALSE, size = .5, alpha = .5) +
  theme_bw()

fit.above <- lm(water_potential ~ lfm, ceco.above.tlp)
summary(fit.above)

lfm.predicted.r.fit1 <- predict.lm(fit.above, newdata = data_frame(lfm = 150, swc = 1.3)) %>% as.numeric() #use this to extract lfm
lfm.predicted.r.fit1
```

Adding in SWC might help model?

```{r}
fit2 <- lm(water_potential ~ lfm + swc, ceco.above.tlp)
summary(fit2)

lfm.predicted.r <- predict.lm(fit2, newdata = data_frame(lfm = 150, swc = 1.3)) %>% as.numeric() #use this to extract lfm
lfm.predicted.r
```

Cool! We have some linear models that should be able to predict Mpa from LFM. Now, to test it out...

# Section 2: Can we predict field- or flam-collected values using the models built from the PV curves?

## Subsection 2.1: 

- Read in flam curve data: 

```{r}
flam_curve_phys_all <- read_csv(here("data", "processed-data", "flam_curve_phys_all.csv"), show_col_types = FALSE)
```

## Subsection 2.2
- Use `predict()` to see if we can use PV curve models to get values collected during flammability curve testing. 

```{r}
#Our models: 
fit.below
fit.above
```

We're just interested in ceco, so just look there: 

```{r}
flam_curve_phys_ceco_above <- flam_curve_phys_all %>% 
  filter(rwc_new < 100) %>% 
  filter(spp == "CECO") %>% 
  filter(mpa > tlp)

flam_curve_phys_ceco_below <- flam_curve_phys_all %>% 
  filter(rwc_new < 100) %>% 
  filter(spp == "CECO") %>% 
  filter(mpa < tlp)
```

```{r}
predict.below <- predict(fit.below, newdata = flam_curve_phys_ceco_below, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.below <- data.frame(flam_curve_phys_ceco_below, predict.below)

predict.df.below %>% 
  ggplot(aes(y = -1/water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, 1) +
  xlim(0, 1) +
  labs(title = "CECO.Actual vs. predicted water potential for points BELOW the TLP", 
       y = "Actual -1/Mpa", 
       x = "Predicted -1/Mpa")

predict.df.below %>% 
  ggplot(aes(y = water_potential, x = -1/fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -5) +
  xlim(0, -5) +
  labs(title = "CECO. Actual vs. predicted water potential for points BELOW the TLP", 
       y = "Actual Mpa", 
       x = "Predicted Mpa")
```

Then visualize it!

```{r graph, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_below <- ggplot(predict.df.below, aes(x = lfm, y = -1/fit.fit)) +
  geom_point(color = "cyan", alpha = 0.5) +
  geom_point(data = flam_curve_phys_ceco_below, aes(x = lfm, y = mpa), alpha = 0.5) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (cyan) vs. observed (black) LFM and Mpa (CECO)") +
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_below
```

```{r}
predict.above <- predict(fit.above, newdata = flam_curve_phys_ceco_above, se.fit = TRUE, interval = "confidence") #make prediction

# Bind to the data to make it actually useful:

predict.df.above <- data.frame(flam_curve_phys_ceco_above, predict.above)

predict.df.above %>% 
  ggplot(aes(y = water_potential, x = fit.fit)) +
  geom_point() +
  geom_abline(method = lm) +
  geom_abline(color = "red") +
  ylim(0, -3) +
  xlim(0, -3) +
  labs(title = "Actual vs. predicted water potential for points above the TLP", 
       y = "Actual Mpa", 
       x = "Predicted Mpa")
```
```{r graph, echo = FALSE, messages = "hide", warning = FALSE}
predict_graph_above <- ggplot(predict.df.above, aes(x = lfm, y = fit.fit)) +
  geom_point(color = "cyan", alpha = 0.5) +
  geom_point(data = flam_curve_phys_ceco_above, aes(x = lfm, y = mpa), alpha = 0.5) +
 # facet_wrap(~St) +
  labs(x = "LFM (%)", 
       y = "Water Potential (Mpa)", 
       title = "Predicted (cyan) vs. observed (black) LFM and Mpa (CECO)")
 # scale_x_continuous(limits = c(500,3500), breaks = seq(500, 3500, by = 1000)) +
 # scale_y_continuous(limits = c(0,1.5e6))
  theme_light() 
predict_graph_above
```
