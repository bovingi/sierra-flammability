---
title: "PV Curves"
author: "Indra Boving"
date: "11/8/2022"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(datapasta)
library(ggplot2)
library(purrr) #for visualizing all variables in one big plot
library(naniar) #for dealing with NAs nicely 
library(tidyverse)
library(ggpubr)
library(cowplot)
library(GGally) #for corr plots
require(kimisc) # has the nlist function to create a named list
#library(strengejacke)
library(sjPlot) # table functions
library(here)
library(effects) #for plofhng model effects
library(sjstats) #use for r2 functions
library("broom.mixed")
library(MuMIn)
library(modelsummary)
library(nlme)
library(lme4)
library(MetBrewer)
library(remef)
library(kableExtra)
library(janitor)
library(lubridate)
library(specr)
#install.packages("specr")

filter = dplyr::filter
mutate = dplyr::mutate
select = dplyr::select
here = here::here

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here

# if (!require("BiocManager", quietly = TRUE))
#     install.packages("BiocManager")
# 
# BiocManager::install("variancePartition")
library('variancePartition')
```

based on this paper: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8930200/#DS1 

#Data: 

```{r}
flam_curve_df_2.1 <- read_csv(here("processed-data", "analysis 2.0", "flam_curve_vardecomp_2.csv"), show_col_types = FALSE) %>% 
  drop_na(lfm, water_potential, spp, plant, year_month, F.Group) %>% 
  mutate(plant = as.factor(plant), 
         F.Group = as.factor(F.Group), 
         year = as_factor(year))

pv_all_df_2.1 <-  read_csv(here("processed-data", "analysis 2.0", "all_pv_curves_clean_vardecomp_2.csv"), show_col_types = FALSE) %>% 
  mutate(plant = as.factor(plant))

field_data_all_2.1 <- read_csv(here("processed-data", "analysis 2.0", "field_data_vardecomp_2.csv"), show_col_types = FALSE) %>% 
  drop_na(lfm, water_potential, spp, plant, year_month) %>% 
  mutate(plant = as.factor(plant))
```

#Pressure Volume Curves

Try using variancePartition:

```{r}
pv_mod <- lmer(lfm ~ water_potential  + (1|spp) + (1|date), pv_all_df_2.1)

form <- ~ water_potential  + (1|year_month) + (1|plant) + (1|F.Group) + (1|spp)


lfm_matrix <- pv_all_df_2.1 %>% 
  ungroup() %>% 
  mutate(id = row_number()) %>% 
  select(id, lfm) %>% 
  pivot_wider(names_from = id, 
              values_from = lfm) 

varPart <- fitExtractVarPartModel(lfm_matrix, form, pv_all_df_2.1 )
varPart

plotVarPart(varPart)

pvflam_decomp <- plotPercentBars(varPart) +
  labs(x = "PV")
pvflam_decomp
```

#Flam curves

```{r}
#pv_mod <- lmer(lfm ~ water_potential  + (1|spp) + (1|date), flam_curve_df_2.1)

form <- ~ water_potential  + (1|spp) + (1|year) + (1|plant)  + (1|F.Group)

lfm_matrix <- flam_curve_df_2.1 %>% 
  ungroup() %>% 
  mutate(id = row_number()) %>% 
  select(id, lfm) %>% 
  pivot_wider(names_from = id, 
              values_from = lfm) 

varPart <- fitExtractVarPartModel(lfm_matrix, form, flam_curve_df_2.1)
varPart

plotVarPart(varPart)

flam_vardecomp <- plotPercentBars(varPart) +
  labs(x = "Flam curve") 
flam_vardecomp
```

#FIeld data

(split at TLP)

Above tlp:
```{r}
above <- field_data_all_2.1 %>% 
  group_by(spp) %>% 
  filter(lfm > lfm_tlp)

below <- field_data_all_2.1 %>% 
  group_by(spp) %>% 
  filter(lfm < lfm_tlp)
```


```{r}
form <- ~ water_potential  + (1|spp) + (1|year_month) + (1|plant) + (1|F.Group) + (1|age_new)

lfm_matrix <- field_data_all_2.1 %>% 
  ungroup() %>% 
  mutate(id = row_number()) %>% 
  select(id, lfm) %>% 
  pivot_wider(names_from = id, 
              values_from = lfm) 

varPart <- fitExtractVarPartModel(lfm_matrix, form, field_data_all_2.1)
varPart

plotVarPart(varPart)

field_vardecomp <- plotPercentBars(varPart)+
  labs(x = "Feild data", 
       title = "all together")  
field_vardecomp
```

```{r}
lfm_matrix <- above %>% 
  ungroup() %>% 
  mutate(id = row_number()) %>% 
  select(id, lfm) %>% 
  pivot_wider(names_from = id, 
              values_from = lfm) 

varPart <- fitExtractVarPartModel(lfm_matrix, form, above)
varPart

plotVarPart(varPart)

field_vardecomp <- plotPercentBars(varPart)+
  labs(x = "Feild data", 
       title = "Above")  
field_vardecomp
```

```{r}
lfm_matrix <- below %>% 
  ungroup() %>% 
  mutate(id = row_number()) %>% 
  select(id, lfm) %>% 
  pivot_wider(names_from = id, 
              values_from = lfm) 

varPart <- fitExtractVarPartModel(lfm_matrix, form, below)
varPart

plotVarPart(varPart)

field_vardecomp <- plotPercentBars(varPart)+
  labs(x = "Feild data", 
       title = "Below")  
field_vardecomp
```

