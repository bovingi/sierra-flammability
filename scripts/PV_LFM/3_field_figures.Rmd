---
title: "Field Figures"
author: "Indra Boving"
date: "1/29/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#install.packages("ggplot2")
library(ggplot2)
library(dplyr)
library(ggpubr)
library(tidyverse)
#install.packages("cowplot")
library(cowplot)
library(here)
library(lubridate)
month = lubridate::month
library(janitor)
library(tidytext)
library(grid)
library(gridExtra)
library(ggbeeswarm)
library(wesanderson)
library(MetBrewer)
library(RColorBrewer)

source(here::here("scripts", "scripts_functions", "figure_info_sierra_flammability.R")) #color and theme info is here
```
#Setup
This dataset has field-collected LFM and Mpa data, and LFM at TLP and MPa at TLP from PV Curves

```{r, pretty colors, include = FALSE}
# Morgenstern = list(c("#7c668c", "#b08ba5", "#dfbbc8", "#ffc680", "#ffb178", "#db8872", "#a56457"), c("darkpurp", "medpurp", "lightpurp", "yellow", "golden", "orange", "darkorange"), colorblind=TRUE)
# 
# my_colors_3 <- MetBrewer::met.brewer("Morgenstern", n = 3)
# 
# morg_diverge <- list(c("#7c668c",  "#db8872", "#ffc680","#a56457"), colorblind=TRUE)
# 
# th <- theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
#           panel.grid.major = element_blank(),  # Hide major gridlines
#           panel.grid.minor = element_blank())
```
#-----------------------------------------------
#Data 

###Field Data
From 0_water_content_all.Rmd

```{r}
field_data_all_3 <- read_csv(here("processed-data", "analysis 2.0","field_data_2020_2021.csv"), show_col_types = FALSE) %>% 
  drop_na(spp) %>% 
  filter(lfm < 350)
```

###Phenology Data

```{r}
pheno_df <- read_csv(here("processed-data", "compiled-datasets", "phenology_czo_2021.csv"), show_col_types = FALSE) %>% 
  select(-observation_id, -observation_time, -observation_date, -raw_abundance_value) %>% 
   mutate(spp = fct_relevel(code, "ABCO","PIJE","CADE","ARPA", "CECO", "QUKE"))  
```

###PV Summaries
```{r}
pv_summaries <- read_csv(here("raw-data", "PV_sierra_summaries.csv")) %>% 
  clean_names() %>% 
   mutate(spp = fct_relevel(species, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
  mutate(strategy = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "Isohydric", 
    spp == "PIJE" ~ "Isohydric", 
     spp == "CADE" ~ "Isohydric", 
    spp == "CECO" ~ "Anisohydric", 
    spp == "ARPA" ~ "Anisohydric", 
    spp == "QUKE" ~ "Anisohydric"
  )) %>% 
   mutate(strategy_binary = case_when( #based on slope of predawn~midday line
    spp == "ABCO" ~ "1", 
    spp == "ARPA" ~ "2", 
    spp == "CADE" ~ "1", 
    spp == "CECO" ~ "2", 
    spp == "PIJE" ~ "1", 
    spp == "QUKE" ~ "2"
  )) %>% 
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
   mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(type = case_when(
    spp == "PIJE" ~ "tree", 
    spp == "QUKE" ~ "tree", 
    spp == "CECO" ~ "shrub", 
    spp == "ARPA" ~ "shrub", 
    spp == "ABCO" ~ "tree", 
    spp == "CADE" ~ "tree"
  )) %>% 
  mutate(F.Group = case_when(
    spp == "ARPA" ~ "Angiosperm", 
    spp == "ABCO" ~ "Gymnosperm",
    spp == "CADE" ~ "Gymnosperm",
    spp == "CECO" ~ "Angiosperm",
    spp == "PIJE" ~ "Gymnosperm",
    spp == "QUKE" ~ "Angiosperm"
  )) %>% 
  mutate(date = lubridate::mdy(date), 
         year = year(date))
```
#-----------------------------------------------
# Hydroscapes! 
Based on Hartmann 2020

```{r}
p1 <- field_data_all_3 %>% 
 filter(age == "new", strategy == "Isohydric") %>% #filtering to 'old' so that we dont have duplicate MPa datapoints
  #filter(site == 1) %>% 

   mutate(Species = fct_relevel(spp,
                "A. concolor",
    "P. jeffreyi", 
    "C. decurrens")) %>% 
  ggplot(aes(y = midday, x = predawn,
            # shape = as.factor(site)
             )) +
  geom_point(size = 1, 
             alpha = .5
             #aes(color = doy)
             ) +
  facet_wrap(~Species) +
 #annotate("text", x= -1, y= -5, aes(label=strategy), size = 3) +
  geom_abline(size = 1) +
  geom_smooth(method = "lm", 
              color = "#7c668c", 
              size = 1, se = FALSE)+
  ggpubr::stat_regline_equation(size = 4) +
  geom_hline(aes(yintercept = mean_tlp_spp), size = 1, 
             color = "#db8872", 
             linetype = "dotted")+
  
  labs(y= "", 
      x = "", 
      # color = "Day of Year",
       title = "More Isohydric"
      ) +
  theme(legend.position = "none", plot.margin = unit(c(0,0,0,0), "cm"))  + 
  scale_x_continuous(labels = NULL, breaks = NULL) +
  coord_equal()
p1

p2 <- field_data_all_3 %>% 
 filter(age == "new", strategy == "Anisohydric") %>% #filtering to 'old' so that we dont have duplicate MPa datapoints
  #filter(site == 1) %>% 
   mutate(Species = fct_relevel(spp,
         "C. cordulatus", 
         "A. patula", 
        "Q. kelloggii")) %>% 
  ggplot(aes(y = midday, x = predawn,
            # shape = as.factor(site)
             )) +
  geom_point(size = 1, 
             alpha = .5
             #aes(color = doy)
             ) +
  facet_wrap(~Species) +
 #annotate("text", x= -1, y= -5, aes(label=strategy), size = 3) +
  geom_abline(size = 1) +
  geom_smooth(method = "lm", color = "#7c668c", size = 1, se = FALSE) +
  ggpubr::stat_regline_equation(size = 4) +
  geom_hline(aes(yintercept = mean_tlp_spp), 
             linewidth = 1, 
             color = "#db8872", 
             linetype = "dotted")+
  labs(y= "", 
       x = "", 
      # color = "Day of Year", 
       title = "More Anisohydric"
      ) +
  theme(legend.position = "none", 
        plot.margin = unit(c(0,0,0,0), "cm"), 
        plot.title = element_text(hjust = 1)) +
  coord_equal()
p2

plot <- cowplot::plot_grid(p1, p2,
          nrow = 2,
  label_size = 12,
  align = "hv"
  
  #labels = c("Isohydric", "Anisohydric")  
)

#create common x and y labels
y.grob <- textGrob("Midday Water Potential (MPa)", 
                   gp=gpar(col="black", fontsize=15), rot=90)

x.grob <- textGrob("Predawn Water Potential (MPa)", 
                   gp=gpar(col="black", fontsize=15))

#add to plot
grid.arrange(arrangeGrob(plot, 
                         left = y.grob, 
                         bottom = x.grob))

```

```{r}
field_data_all_3 %>%
  filter(age == "old") %>% #filtering to 'old' so that we dont have duplicate MPa datapoints
  #filter(site == 1) %>%
  #filter(month < 10) %>%
  ggplot(aes(y = midday, x = lfm)) +
             geom_point(size = .5, aes(color = week(date))) +
               facet_wrap( ~ spp) +
               #annotate("text", x= -1, y= -5, aes(label=strategy), size = 3) +
               geom_abline(size = .5) +
               geom_smooth(
                 method = "lm",
                 color = "maroon",
                 size = .5,
                 se = FALSE
               ) +
               #geom_smooth(method = "lm", aes(color = site), size = .5, se = FALSE) +
               ggpubr::stat_regline_equation(size = 3) +
               geom_hline(
                 aes(yintercept = mean_tlp_spp),
                 size = .5,
                 color = "olivedrab",
                 type = "dashed"
               ) 
```

```{r}
field_data_all_3 %>% 
 filter(age == "old") %>% #filtering to 'old' so that we dont have duplicate MPa datapoints
  #filter(site == 1) %>% 
  #filter(month < 10) %>% 
  ggplot(aes(y = predawn, x = lfm,
            # shape = as.factor(site)
             )) +
  geom_point(size = .5, aes(color = as.factor(date))) +
  facet_wrap(~spp) +
 #annotate("text", x= -1, y= -5, aes(label=strategy), size = 3) +
  geom_abline(size = .5) +
  geom_smooth(method = "lm", color = "maroon", size = .5, se = FALSE) +
  #geom_smooth(method = "lm", aes(color = site), size = .5, se = FALSE) +
   ggpubr::stat_regline_equation(size = 3) +
  geom_hline(aes(yintercept = mean_tlp_spp), size = .5, color = "olivedrab", type = "dashed")
```

#Hydroscapes, but remove up to June:

```{r}
spp.labs <- c(" Abies concolor","Pinus jeffreyi","Calocedrus decurrens","Ceanothus cordulatus","Arctostaphylos patula","Quercus kelloggii")
names(spp.labs) <- c("ABCO","PIJE","CADE","CECO", "ARPA","QUKE")

p1 <- field_data_all_3 %>% 
 filter(age == "new",
        strategy == "Isohydric",
        month > 7
        ) %>% 
  ggplot(aes(y = midday, x = predawn,
            # shape = as.factor(site)
             )) +
  geom_point(size = 1, 
             alpha = .5
             #aes(color = doy)
             ) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs)) +
 #annotate("text", x= -1, y= -5, aes(label=strategy), size = 3) +
  geom_abline(size = 1) +
  geom_smooth(method = "lm", 
              color = "#7c668c", 
              size = 1, se = FALSE)+
  ggpubr::stat_regline_equation(size = 4) +
  geom_hline(aes(yintercept = mean_tlp_spp), size = 1, 
             color = "#db8872", 
             linetype = "dotted")+
  
  labs(y= "", 
      x = "", 
      # color = "Day of Year",
      # title = "More Isohydric"
      ) +
  theme(legend.position = "none", plot.margin = unit(c(0,0,0,0), "cm"),
        strip.text = element_text(face = "italic", size = 12))  + 
  scale_x_continuous(labels = NULL, breaks = NULL) 
p1

p2 <- field_data_all_3 %>% 
 filter(age == "new", 
        strategy == "Anisohydric", 
         month > 7
        ) %>% #filtering to 'old' so that we dont have duplicate MPa datapoints
  #filter(site == 1) %>% 
  ggplot(aes(y = midday, x = predawn,
            # shape = as.factor(site)
             )) +
  geom_point(size = 1, 
             alpha = .5
             #aes(color = doy)
             ) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs)) +
 #annotate("text", x= -1, y= -5, aes(label=strategy), size = 3) +
  geom_abline(size = 1) +
  geom_smooth(method = "lm", color = "#7c668c", size = 1, se = FALSE) +
  ggpubr::stat_regline_equation(size = 4) +
  geom_hline(aes(yintercept = mean_tlp_spp), 
             size = 1, 
             color = "#db8872", 
             linetype = "dotted")+
  
  labs(y= "", 
       x = "", 
      # color = "Day of Year", 
       # title = "More Anisohydric"
      ) +
  theme(legend.position = "none", 
        plot.margin = unit(c(0,0,0,0), "cm"), 
        plot.title = element_text(hjust = 1),
        strip.text = element_text(face = "italic", size = 12))
p2

#?element_text

plot <- cowplot::plot_grid(p1, p2,
          nrow = 2,
  label_size = 12,
  align = "hv"
  
  #labels = c("Isohydric", "Anisohydric")  
)

#create common x and y labels
y.grob <- textGrob("Midday Water Potential (MPa)", 
                   gp=gpar(col="black", fontsize=15), rot=90)

x.grob <- textGrob("Predawn Water Potential (MPa)", 
                   gp=gpar(col="black", fontsize=15, face = "bold"))

#add to plot
grid.arrange(arrangeGrob(plot, 
                         left = y.grob, 
                         bottom = x.grob))

```


```{r}
# mean_tlp_spp <- field_data_all_3 %>% 
#   select(tlp) %>% 
#   drop_na() %>% 
#   summarise(mean(tlp)) %>% 
#   pull()

field_data_all_3 %>%
  #filter(age == "new") %>% 
  ggplot(aes(
    x = midday,
    y = lfm,
    color = month,
    shape = spp
  )) +
  geom_point(size = 1) +
  geom_vline(
    aes(xintercept = mean_tlp_spp),
    size = .5,
    color = "olivedrab",
    linetype = "dotted"
  ) +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm")
  xlim(-5, 0) +
  labs(
    y = "Live Fuel Moisture",
    x = "Midday (-MPa)",
    color = "Month",
    shape = "Species"
  ) +
  ylim(50, 300) +
  facet_wrap(~ interaction(year, age))
```


```{r}
field_data_all_3 %>%
  ggplot(aes(x = midday, y = lfm, color = age, shape = spp)) +
  geom_point(size = 1) +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") +
  #geom_vline(aes(xintercept = mean_tlp_spp_allspp, size = .5, color = "olivedrab"))+
  xlim(-5,0) + 
  labs( y = "Live Fuel Moisture", 
        x = "Midday (-MPa)", 
        color = "Tissue Age", 
        shape = "Species") +
  ylim(50,300) 
  #facet_wrap(~age)+
  #ggtitle("Outliers removed (outlierKD)") +
   #scale_color_manual(values = c("olivedrab","darkblue")) +
  
```
#-----------------------------------------------
#Nice FIgures
```{r}
unique(field_data_all_3$year)
```

#### LFM by MPa (species, time)
```{r}
field_data_all_3 <- field_data_all_3 %>% 
  mutate(Age = case_when(
    age == 'new' ~ 'New',
    age == 'old' ~ 'Old'
  ))

field_data_all_3 %>%
  #filter(month < 10) %>% #removing post-rain values (October sample collection)
  mutate(spp = fct_relevel(spp, "ABCO", "PIJE", "CADE", "CECO", "ARPA", "QUKE"))  %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  ggplot(aes(
    x = midday,
    y = lfm,
    shape = Age
  )) +
  geom_point(size = 1.4, alpha = .65, aes(color = as.factor(month))) +
 # geom_smooth(se = F, method = 'lm', size = 0.5, alpha = .6, color = 'black', aes(lty = Age), show_guide = F) +
  geom_vline(
    aes(xintercept = mean_tlp_spp, #lty = Species
        ),
    size = 0.7,
    color = 'black',
    alpha = .6,
    show_guide = F
  ) +
  # geom_hline(
  #   aes(yintercept = mean_lfm_fall_spp, lty = Species),
  #   size = 0.7,
  #   color = 'black',
  #   alpha = .6,
  #   show_guide = F
  # ) +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm")
  xlim(-5, 0) +
  labs(
    y = "Live Fuel Moisture",
    x = "Midday Water Potential (MPa)",
    color = "Month"
  ) +
  ylim(50, 300) +
  facet_wrap( ~ spp, labeller = labeller(spp = spp.labs)) +
 color_all +
  theme(
    strip.text = element_text(face = "italic"),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    strip.background = element_rect(fill = "gray90")
  ) 
  #scale_color_gradientn(colors=met.brewer("Morgenstern"))
```
#### LFM by MPa (species, age)
```{r}
field_data_all_3 <- field_data_all_3 %>% 
  mutate(Age = case_when(
    age == 'new' ~ 'New',
    age == 'old' ~ 'Old'
  ))

field_data_all_3 %>%
  #filter(month < 10) %>% #removing post-rain values (October sample collection)
  mutate(spp = fct_relevel(spp, "ABCO", "PIJE", "CADE", "CECO", "ARPA", "QUKE"))  %>%
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>%
  ggplot(aes(
    x = midday,
    y = lfm,
    #shape = Age
  )) +
  geom_point(size = 1.4, alpha = .65, 
             aes(color = Age)) +
  geom_vline(
    aes(xintercept = mean_tlp_spp, #lty = Species
        ),
    size = 0.7,
    color = 'black',
    alpha = .6,
    show_guide = F
  ) +
  xlim(-5, 0) +
  labs(
    y = "Live Fuel Moisture",
    x = "Midday Water Potential (MPa)",
    color = "Tissue Age"
  ) +
  ylim(50, 300) +
  facet_wrap( ~ spp, labeller = labeller(spp = spp.labs)) +
 color_two +
  theme(
    strip.text = element_text(face = "italic"),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    strip.background = element_rect(fill = "gray90")
  ) 
  #scale_color_gradientn(colors=met.brewer("Morgenstern"))
```

####LFM by MPa (date)
NOTE: Error popping up here -- 'seg_psi_df not found'
```{r}
#ribbon values: 
mpa_summs <- pv_summaries %>% 
  filter(!(spp %in% c("CECO") & year %in% c(2020))) %>% 
  group_by(F.Group) %>% 
  mutate(mean_tlp = mean(ytlp_m_pa), 
         sd_tlp = sd(ytlp_m_pa), 
         mpa_lwr = mean_tlp - (sd_tlp/2), 
         mpa_upr = mean_tlp + (sd_tlp/2)) %>% 
  select(spp, year, mean_tlp, mpa_lwr, mpa_upr)

unique(mpa_summs$mean_tlp)

angio <- mpa_summs %>% 
  filter(F.Group == "Angiosperm")

gymno <- mpa_summs %>% 
  filter(F.Group == "Gymnosperm")

#df:
fig_df <- field_data_all_3 %>%
   filter(month < 10) %>%  #removing post-rain values (October sample collection)
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
   mutate(Species = fct_relevel(Species,
                              "A. concolor",
                              "P. jeffreyi",
                              "C. decurrens",
                              "C. cordulatus",
                              "A. patula", 
                              "Q. kelloggii"
    )) %>% 
  filter(age != "both", 
         age == "new") %>% 
  mutate(month = month(date, label = TRUE, abbr = TRUE)) 

#plot:
ggplot() +
  geom_point(
    aes(
      x = midday,
      y = lfm,
      color = as.factor(month),
      shape = Age
    ),
    size = 1.1,
    alpha = .7,
    data = fig_df
  ) +
  #geom_smooth(se = F, method = 'lm', aes(lty = Species),
  #size = .7, alpha = .7, color = 'black') +
  geom_vline( #TLP line
    data = mpa_summs,
    aes(xintercept = mean_tlp,
        lty = F.Group),
    size = 1,
    alpha = .6,
    color = "purple",
    show.legend = F
  ) +
  geom_vline( #lower SD
    data = mpa_summs,
    aes(xintercept = mpa_summs$mpa_lwr,
        lty = F.Group, ),
    #inherit.aes = F,
    size = .5,
    alpha = .6,
    color = "darkgreen",
    show.legend = F
  ) +
  geom_vline( #Upr SD
    data = mpa_summs,
    aes(xintercept = mpa_summs$mpa_upr,
        lty = F.Group, ),
    #inherit.aes = F,
    size = .5,
    alpha = .6,
    color = "darkblue",
    show.legend = F
  ) +
  ggplot2::geom_ribbon( #Segmented estimate
    aes(
      y = fig_df$midday,
      x = fig_df$lfm,
      ymin = seg_psi_df$lwr,
      ymax = seg_psi_df$upr
    ),
    fill = "grey80",
    color = "grey80"
  )  +
  geom_hline(yintercept  = seg_psi_df$lfm_psi, linetype = "dotted") +
    geom_vline(xintercept  = -2.86 , linetype = "dotted", color = "pink") +
xlim(-5, 0) +
  labs(
    y = "Live Fuel Moisture",
    x = "Midday (-MPa)",
    color = "Month",
    shape = "Age"
  ) +
  ylim(50, 300) +
  # facet_wrap(~strategy) +
  color_all +
  theme(
    strip.text = element_text(face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    strip.background = element_rect(fill = "gray90")
  )

ggsave(here('figures', 'lfm.x.mpa.fx.group.split.jpg'), height = 8, width = 11)
```


```{r}
field_data_all_3 %>%
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
   mutate(Species = fct_relevel(Species,
                              "A. concolor",
                              "P. jeffreyi",
                              "C. decurrens",
                              "C. cordulatus",
                              "A. patula", 
                              "Q. kelloggii"
    )) %>% 
  filter(age != "both") %>% 
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>% 
  ggplot(aes(x = predawn, 
             y = lfm, 
             color = as.factor(month), 
             shape = age)) +
  geom_point(size = 1, alpha = .7) +
  geom_vline(aes(xintercept = mean_tlp_spp), size = .5, alpha = .6,
             color = "black", linetype = "dotted") +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") 
  xlim(-5,0) + 
  labs( y = "Live Fuel Moisture", 
        x = "Predawn (-MPa)", 
        color = "Month", 
        shape = "Age") +
  ylim(50,300) +
  facet_wrap(~strategy) +
  color_all
```
```{r}
field_data_all_3 %>%
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
   mutate(Species = fct_relevel(Species,
                              "A. concolor",
                              "P. jeffreyi",
                              "C. decurrens",
                              "C. cordulatus",
                              "A. patula", 
                              "Q. kelloggii"
    )) %>% 
  filter(age != "both") %>% 
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>% 
  ggplot(aes(x = midday, 
             y = lfm, 
             color = as.factor(month), 
             shape = age)) +
  geom_point(size = 1, alpha = .7) +
  geom_vline(aes(xintercept = mean_tlp_spp), size = .5, alpha = .6,
             color = "black", linetype = "dotted") +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") 
  xlim(-5,0) + 
  labs( y = "Live Fuel Moisture", 
        x = "Midday (-MPa)", 
        color = "Month", 
        shape = "Age") +
  ylim(50,300) +
  facet_wrap(~F.Group) +
  color_all

ggsave(here('figures', 'lfm_midday_tlplines_group.jpg'), height = 8, width = 11)
```

####LFM by MPa (age)
```{r}
field_data_all_3 %>%
   mutate(spp = fct_relevel(spp, "ABCO","PIJE","CADE","CECO", "ARPA","QUKE"))  %>% 
   mutate(Species = fct_relevel(Species,
                              "A. concolor",
                              "P. jeffreyi",
                              "C. decurrens",
                              "C. cordulatus",
                              "A. patula", 
                              "Q. kelloggii"
    )) %>% 
  filter(age != "both") %>% 
  mutate(month = month(date, label = TRUE, abbr = TRUE)) %>% 
  ggplot(aes(x = midday, 
             y = lfm, 
             #color = as.factor(month), 
             color = age)) +
  geom_point(size = 1, alpha = .7) +
  geom_vline(aes(xintercept = mean(mean_tlp_spp)), size = .5, alpha = .6,
             color = "black", linetype = "dotted") +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") 
  xlim(-5,0) + 
  labs( y = "Live Fuel Moisture", 
        x = "Midday (-MPa)", 
        color = "Age", 
        shape = "") +
  ylim(50,300) +
  facet_wrap(~strategy) 
  
```

###LFM by MPa (tree v shrub)

```{r}
field_data_all_3 %>%
  ggplot(aes(x = midday, y = lfm, color = month, shape = spp)) +
  geom_point(size = 1) +
  geom_vline(aes(xintercept = mean_tlp_spp), size = .5, 
             color = "olivedrab", 
             linetype = "dotted"
             ) +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") 
  xlim(-5,0) + 
  labs( y = "Live Fuel Moisture", 
        x = "Midday (-MPa)", 
        color = "Month", 
        shape = "Species") +
  ylim(50,300) +
  facet_wrap(~type)+
  #ggtitle("Outliers removed (outlierKD)") +
  #scale_color_gradient(low = "darkblue", high = "goldenrod") +
  scale_color_gradient(low = "maroon", high = "goldenrod") 
```


#-----------------------------------------------

#Boxplots over time

####Setup:
```{r}
pheno_df_leaves <- pheno_df %>% 
  filter(category %in% c("Leaves", "Needles"), 
         phenophase_status == "Yes") %>% 
  mutate(lfm = case_when(
    phenophase_name == "Young leaves" ~ 60, 
    phenophase_name == "Young needles" ~ 55, 
    phenophase_name == "Breaking leaf buds" ~ 40,
    phenophase_name == "Breaking needle buds" ~ 35,
    phenophase_name == "Emerging needles" ~ 45, 
    phenophase_name == "Increasing leaf size" ~ 50, 
    phenophase_name == "Leaves" ~ 70, 
    phenophase_name == "Colored leaves" ~ 80
  )) %>% 
  mutate(phenophase_name = fct_relevel(phenophase_name,
                                      "Breaking needle buds",
                                       "Emerging needles",
                                       "Young needles",
                                       "Breaking leaf buds",
                                       "Increasing leaf size",
                                       "Young leaves", 
                                       "Leaves", 
                                       "Colored leaves"
  )) %>% 
  mutate(week = week(date)) 

pheno_df_all <- pheno_df %>% 
  filter(#category %in% c("Leaves", "Needles"), 
         phenophase_status == "Yes") %>% 
  mutate(line_position = case_when(
    phenophase_name == "Young leaves" ~ 60, 
    phenophase_name == "Young needles" ~ 55, 
    phenophase_name == "Breaking leaf buds" ~ 40,
    phenophase_name == "Breaking needle buds" ~ 35,
    phenophase_name == "Emerging needles" ~ 45, 
    phenophase_name == "Increasing leaf size" ~ 50, 
    phenophase_name == "Leaves" ~ 55, 
    phenophase_name == "Colored leaves" ~ 57,
    phenophase_name == "Flowers or flower buds" ~ 75, 
    phenophase_name == "Open flowers" ~ 76,
    phenophase_name == "Pollen cones" ~ 85,
    phenophase_name == "Pollen release" ~ 87, 
    phenophase_name == "Fruits" ~ 78, 
    phenophase_name == "Open pollen cones" ~ 86,
    phenophase_name == "Unripe seed cones" ~ 90,
    phenophase_name == "Recent fruit of seed drop" ~95,
    phenophase_name == "Ripe fruits" ~ 92.5,
    phenophase_name == "Ripe seed codes" ~ 91
   ## phenophase_name == ""
   # phenophase_name == ""
  )) %>% 
  mutate(week = week(date)) 

unique(pheno_df_all$phenophase_name)
```
```{r}
phenoplot1 <- ggplot() +
  geom_line(aes(y = line_position, 
                x = week,
                #x = cut(date, breaks = "week"),
                color = phenophase_name),
            alpha = .4, 
            data  = pheno_df_all, 
            size = 4,
            position=position_dodge(w=1)) +
   #scale_color_manual(values=met.brewer("Morgenstern", 3)) +
  labs(color = "Phenophase") +
  facet_wrap(~scientific_name)

phenoplot1
```

For figure with lfm boxplots: 
# Pheno_fig df wrangle
```{r}
pheno_fig <- pheno_df %>% 
  filter(#category %in% c("Leaves", "Needles"), 
         phenophase_status == "Yes") %>% 
  mutate(lfm = case_when(
    phenophase_name == "Young leaves" ~ 20, 
    phenophase_name == "Young needles" ~ 20, 
    phenophase_name == "Breaking leaf buds" ~ 10,
    phenophase_name == "Breaking needle buds" ~ 10,
    phenophase_name == "Emerging needles" ~ 30, 
    phenophase_name == "Increasing leaf size" ~ 30, 
    phenophase_name == "Leaves" ~ 40, 
    phenophase_name == "Colored leaves" ~ 50,
    phenophase_name == "Flowers or flower buds" ~ 30, 
   # phenophase_name == "Open flowers" ~ 76,
    phenophase_name == "Pollen cones" ~ 40,
    phenophase_name == "Pollen release" ~ 50, 
   # phenophase_name == "Fruits" ~ 78, 
   # phenophase_name == "Open pollen cones" ~ 86,
   # phenophase_name == "Unripe seed cones" ~ 90,
   # phenophase_name == "Recent fruit of seed drop" ~95,
    phenophase_name == "Ripe fruits" ~ 40,
  #  phenophase_name == "Ripe seed codes" ~ 91
  TRUE ~ NA_real_
  )) %>% 
  mutate(week = week(date)) %>% 
  select(phenophase_name, lfm, date, week, spp) %>% 
  drop_na(lfm) %>% mutate(Species = case_when(
    spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    ))  %>% 
  mutate(data_source = "mlab")
  
field_data_2021_fig <- field_data_all_3 %>% 
  select(age, year, date, lfm, Species, spp)

field_data_fig_2 <- bind_rows(field_data_2021_fig, pheno_fig) %>% 
  mutate(year = year(date), 
         doy = day(date))
field_data_fig_2
```

#***LFM and phenology plot: 
```{r}
field_data_2021 <- field_data_fig_2 %>%
  filter(year == 2021,
         age != "both") %>% 
 # select(date, lfm, spp, Species, age) %>% 
  mutate(week = week(date)) %>% 
    mutate(age_new = case_when(
    age %in% c("new") & 
      spp %in% c("ABCO") & 
      week %in% c(17, 20, 24)
      ~ "old",
     age %in% c("old") & 
      spp %in% c("CADE") & 
      week > 24
      ~ "new",
    age %in% c("old") & 
      spp %in% c("CECO") & 
      week > 24
      ~ "new",
    age %in% c("new") & 
      spp %in% c("PIJE") & 
      week %in% c(17, 20)
      ~ "old",
     age %in% c("old") & 
      spp %in% c("ARPA") & 
      week > 25
      ~ "new",
    TRUE ~ as.character(age))
  ) %>% 
 drop_na(spp, Species) %>% 
  mutate(age_labs = case_when(
    age_new %in% c("new") ~ "Current Year", 
    age_new %in% c("old") ~ "Previous Year", 
    TRUE ~ as.character(age)
  )
  ) %>% 
  mutate(day = day(date), 
         month = month(date))

####Plot:

field_data_2021 %>%
  filter(age != "both",
         lfm < 350) %>%
  #filter(year == 2021) %>%
  ggplot() +
  geom_boxplot(aes(
    y = lfm,
    x = cut(date, breaks = "week"),
    #x = week,
   # x = as.numeric(week),
    #x = week,
    #color = age
    fill = age_labs
  ),
  data = field_data_2021) +
  geom_hline(aes(yintercept  = mean_lfm_fall_spp), field_data_all_3,
             linetype = "dotted") +
  # geom_line(aes(y = lfm, 
  #               #x = cut(date, breaks = "week"),
  #                x = week,
  #               color = phenophase_name),
  #           alpha = 1, 
  #           data  = field_data_fig_2,
  #           size = 4,
  #           position=position_dodge(w=1)) +
  facet_wrap( ~ spp, 
              labeller = labeller(spp = spp.labs), 
              scales = "free"
              ) +
  theme(axis.ticks.x = element_blank(),
    #axis.title.x = element_blank(),
    axis.text.x = element_text(
      angle = 30,
      hjust = 1,
      size = 10),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold"),
    strip.text = element_text(face = "italic")) +
  labs(
    y = "Live Fuel Moisture",
    x = "Date",
    color = "Phenophase",
    fill = "Tissue Status"
  ) 
```


```{r}
phenoplot2 <- ggplot() +
  geom_line(aes(y = lfm,
                #x = week,
                #x = cut(date, breaks = "week"),
               x = date,
                color = phenophase_name),
            alpha = 1, 
            #data  = pheno_df_leaves, 
            data  = pheno_fig, 
            size = 4,
            position=position_dodge(w=1)) +
   #scale_color_manual(values=met.brewer("Morgenstern", 3)) +
  labs(color = "Phenophase") +
  facet_wrap(~Species)

phenoplot2
```

### Combining Phenology and Boxplots

Phenology df data wrangling:
```{r}
pheno_fig_npn <- read_csv(here("processed-data", "analysis 2.0", "npn_data.csv"), show_col_types = F) %>% 
  select(phenophase_description, observation_date, common_name) %>% 
  mutate(date = observation_date,
         year = year(date), 
         month = month(date),
         week = week(date),
         phenophase_name = phenophase_description, 
         spp = case_when(
           common_name %in% c("white fir") ~ "ABCO", 
           common_name %in% c("incense cedar") ~ "CADE", 
           common_name %in% c("California black oak") ~ "QUKE", 
           common_name %in% c("greenload manzanita") ~ "ARPA", 
           common_name %in% c("whitethord ceanothus") ~ "CECO", 
           common_name %in% c("Jeffrey pine") ~ "PIJE"
         )) %>% 
  mutate(phenophase_name = case_when(
    phenophase_name == "Breaking needle buds" ~ "Breaking buds",
    phenophase_name == "Breaking leaf buds" ~ "Breaking buds",
    phenophase_name == "Young needles" ~ "Young leaves",
    phenophase_name == "Young leaves" ~ "Young leaves",
    phenophase_name == "Emerging needles" ~ "Increasing leaf size",
    phenophase_name == "Pollen cones" ~ "Pollen cones",
    phenophase_name == "Pollen release" ~ "Pollen release",
    #phenophase_name == "Recent co" ~ "Ripe fruits",
    phenophase_name == "Increasing leaf size" ~ "Increasing leaf size",
    phenophase_name == "Flowers or flower buds" ~ "Flowers or flower buds",
    phenophase_name == "Fruits" ~ "Fruits",
    phenophase_name == "Ripe fruits" ~ "Ripe fruits", 
    TRUE ~ as.character(phenophase_name)
    ), 
    data_source = "npn") %>% 
  drop_na(date) %>% 
  mutate(Species = case_when(
    spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  mutate(lfm = case_when(
    phenophase_name == "Young leaves" ~ 20, 
    phenophase_name == "Young needles" ~ 20, 
    phenophase_name == "Breaking leaf buds" ~ 10,
    phenophase_name == "Breaking needle buds" ~ 10,
    phenophase_name == "Emerging needles" ~ 30, 
    phenophase_name == "Increasing leaf size" ~ 30, 
    phenophase_name == "Leaves" ~ 40, 
    phenophase_name == "Colored leaves" ~ 50,
    phenophase_name == "Flowers or flower buds" ~ 30, 
    phenophase_name == "Open flowers" ~ 35,
    phenophase_name == "Pollen cones" ~ 40,
    phenophase_name == "Pollen release" ~ 50, 
    phenophase_name == "Fruits" ~ 50, 
   # phenophase_name == "Open pollen cones" ~ 86,
   # phenophase_name == "Unripe seed cones" ~ 90,
   # phenophase_name == "Recent fruit of seed drop" ~95,
    phenophase_name == "Ripe fruits" ~ 40,
  #  phenophase_name == "Ripe seed codes" ~ 91
  TRUE ~ NA_real_
  )) %>% 
  select(phenophase_name, lfm, date, week, spp, Species)
```


```{r}
pheno_fig2 <- pheno_fig %>% 
  filter(phenophase_name %in% c("Breaking needle buds", "Young needles", "Emerging needles", "Pollen cones", "Pollen release", "Breaking leaf buds", "Young leaves", "Increasing leaf size", "Flowers or flower buds", "Fruits", "Ripe fruits")) %>% 
  mutate(phenophase_name = case_when(
    phenophase_name == "Breaking needle buds" ~ "Breaking buds",
    phenophase_name == "Breaking leaf buds" ~ "Breaking buds",
    phenophase_name == "Young needles" ~ "Young leaves",
    phenophase_name == "Young leaves" ~ "Young leaves",
    phenophase_name == "Emerging needles" ~ "Increasing leaf size",
    phenophase_name == "Pollen cones" ~ "Pollen cones",
    phenophase_name == "Pollen release" ~ "Pollen release",
    phenophase_name == "Increasing leaf size" ~ "Increasing leaf size",
    phenophase_name == "Flowers or flower buds" ~ "Flowers or flower buds",
    phenophase_name == "Fruits" ~ "Fruits",
    phenophase_name == "Ripe fruits" ~ "Ripe fruits"))
```

####***Combine NPN and our data: 
```{r}
pheno_fig3 <- bind_rows(pheno_fig_npn, pheno_fig2) %>% 
  mutate(month = month(date), 
         day = mday(date)) %>% 
   mutate(phenophase_name = case_when(
    phenophase_name %in% c("Breaking needle buds (conifers)", "Breaking needle buds", "Breaking leaf buds") ~ "Breaking buds",
    phenophase_name %in% c("Young needles", "Young needles (conifers)","Young leaves", "Young needles (pines)", "Young leaves (tree/shrub)")  ~ "Young leaves",
    phenophase_name %in% c("Emerging needles (pines)","Emerging needles") ~ "Increasing leaf size",
    phenophase_name %in% c("Pollen cones (conifers)", "Pollen cones") ~ "Pollen cones",
    phenophase_name %in% c("Pollen release (flowers)", "Pollen release (conifers)" ,"Pollen release", "Open pollen cones (conifers)" ) ~ "Pollen release",
    phenophase_name == "Increasing leaf size" ~ "Increasing leaf size",
    phenophase_name == "Flowers or flower buds" ~ "Flowers or flower buds",
    phenophase_name %in% c("Ripe fruits", "Fruits") ~ "Fruits",
    phenophase_name == "Ripe fruits" ~ "Ripe fruits", 
    phenophase_name %in% c("Recent cone or seed drop",  "Recent fruit or seed drop") ~ "Recent seed drop",
    TRUE ~ as.character(phenophase_name))) %>% 
  mutate(lfm =  case_when(
    phenophase_name == "Breaking buds" ~
    phenophase_name== "Young leaves",
    phenophase_name == "Increasing leaf size"),
    phenophase_name== "Pollen cones",
    phenophase_name =="Pollen release",
    phenophase_name == "Increasing leaf size",
    phenophase_name == "Flowers or flower buds",
    phenophase_name == "Fruits",
    phenophase_name == "Ripe fruits", 
    phenophase_name == "Recent seed drop" ~
    TRUE ~ as.character(phenophase_name)))
  ))
  
unique(pheno_fig3$phenophase_name)


```

For aspect ratio of phenophases plots:
```{r}
two <- c(1/20, 4)
three <- c(1/13, 3)
four <- c(1/10, 2.75)
```

#Function:
```{r}
pheno.boxplot.vis <- function(species, phenophases, max.y = 350, colors, no.phenophases = two){
  
df1 <- field_data_2021 %>%
  mutate(month_char = case_when(
    date == '2021-04-24' ~ "April",
    date == '2021-05-14' ~ "May",
    date == '2021-05-15' ~ "May",
    date == '2021-06-15' ~ "June",
    date == '2021-06-16' ~ "June",
    date == '2021-07-08' ~ "E. July",
    date == '2021-07-09' ~ "E. July",
    date == '2021-07-30' ~ "L. July",
    date == '2021-07-31' ~ "L. July",
    date == '2021-08-19' ~ "Aug.",
    date == '2021-08-20' ~ "Aug.",
    date == '2021-09-16' ~ "Sept.",
    date == '2021-09-17' ~ "Sept.",
    date == '2021-10-16' ~ "Oct.",
    date == '2021-10-17' ~ "Oct."
  )) %>%
  mutate(month_char2 = case_when(
   day < 15 & month == 4 ~ "E. April",
   day > 15 & month == 4 ~ "L. April", 
   day < 15 & month == 5 ~ "E. May",
   day > 15 & month == 5 ~ "L. May",
     day < 15 & month == 6 ~ "E. June",
     day > 15 & month == 6 ~ "L. June",
     day < 15 & month == 7 ~ "E. July",
     day > 15 & month == 7 ~ "L. July",
     day < 15 & month == 8 ~ "E. Aug.",
     day > 15 & month == 8 ~ "L. Aug.",
    day < 15 & month == 9 ~ "E. Sept.",
     day > 15 & month == 9 ~ "L. Sept.",
     day < 15 & month == 10 ~ "E. Oct.",
     day > 15 & month == 10 ~ "L. Oct.", 
   TRUE ~ as.character(month_char)
  ))%>% 
  filter(age != "both",
         lfm < 350, 
         spp == species) 

df1$month_char2 <- factor(df1$month_char2, levels = c("E. April", "L. April", "E. May", "L. May", 
                                          "E. June", "L. June","E. July",
                                          "L. July", "E. Aug.", "L. Aug.", "E. Sept.",
                                          "L. Sept.", "E. Oct.", "L. Oct."))

df2 <- field_data_2021 %>% 
  filter(spp == species)
mean_lfm <- mean(df2$mean_lfm_fall_spp)

df3 <- pheno_fig3 %>%
  filter(spp == species) %>% 
  filter(phenophase_name %in% phenophases)

p1 <- ggplot(data = df1, aes(x = month_char2, y = lfm)) +
  geom_boxplot(aes(fill = age_labs)) +
  geom_hline(aes(yintercept  = mean_lfm),
             linetype = "dotted") +
  scale_y_continuous(limits = c(0, max.y)) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs)) +
  theme(axis.ticks.x = element_blank(),
    axis.text.x = element_text(
      angle = 30,
      hjust = 1,
      size = 16),
    axis.title.x = element_blank(),
    axis.title.y = element_text(face = "bold", size = 16),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(face = "bold"),
    strip.text = element_text(face = "italic", size = 14),
    legend.position = 'none') +
  labs(y = "Live Fuel Moisture",
       fill = "Tissue Status")

p2 <- ggplot2::ggplot(data = df3, aes(x = date, y = lfm, color = phenophase_name)) +
  geom_line(alpha = 1, size = no.phenophases[2]) +
  scale_color_manual(values = colors) +
  theme(aspect.ratio = no.phenophases[1],
        legend.position = 'none',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = 'white'))

p3 <- p1 + annotation_custom(ggplotGrob(p2), xmin = "E. April", xmax = "L. Oct.",
                       ymin = -10, ymax = 30)
return(p3)
  }
```

#QUKE:
QUKE wasn't working in the function because of the lack of samples in April
```{r}
df1 <- field_data_2021 %>%
  mutate(month_char = case_when(
    date == '2021-05-14' ~ "May",
    date == '2021-05-15' ~ "May",
    date == '2021-06-15' ~ "June",
    date == '2021-06-16' ~ "June",
    date == '2021-07-08' ~ "E. July",
    date == '2021-07-09' ~ "E. July",
    date == '2021-07-30' ~ "L. July",
    date == '2021-07-31' ~ "L. July",
    date == '2021-08-19' ~ "Aug.",
    date == '2021-08-20' ~ "Aug.",
    date == '2021-09-16' ~ "Sept.",
    date == '2021-09-17' ~ "Sept.",
    date == '2021-10-16' ~ "L. Oct.",
    date == '2021-10-17' ~ "L. Oct."
  )) %>%
  mutate(month_char2 = case_when(
   day < 15 & month == 4 ~ "E. April",
   day > 15 & month == 4 ~ "L. April", 
   day <= 15 & month == 5 ~ "E. May",
   day > 15 & month == 5 ~ "L. May",
     day < 15 & month == 6 ~ "E. June",
     day > 15 & month == 6 ~ "L. June",
     day < 15 & month == 7 ~ "E. July",
     day > 15 & month == 7 ~ "L. July",
     day < 15 & month == 8 ~ "E. Aug.",
     day > 15 & month == 8 ~ "L. Aug.",
    day < 15 & month == 9 ~ "E. Sept.",
     day > 15 & month == 9 ~ "L. Sept.",
     day < 15 & month == 10 ~ "E. Oct.",
     day >= 15 & month == 10 ~ "L. Oct.", 
   TRUE ~ as.character(month_char)
  )) %>% 
  filter(age != "both",
         lfm < 350,
         spp == "QUKE")

df1$month_char2 <- factor(df1$month_char2, levels = c("E. April", "L. April", "E. May", "L. May", 
                                          "E. June", "L. June","E. July",
                                          "L. July", "E. Aug.", "L. Aug.", "E. Sept.",
                                          "L. Sept.", "E. Oct.", "L. Oct."))
df2 <- field_data_all_3 %>% 
  filter(spp == "QUKE")

mean_lfm <- mean(df2$mean_lfm_fall_spp)

df3 <- pheno_fig3 %>%
  filter(spp == "QUKE") #%>% 
  #filter(phenophase_name %in% c("Breaking buds", "Increasing leaf size", "Ripe fruits"))

p1 <- ggplot(data = df1,
             aes(x = month_char2, 
                             y = lfm))+
  geom_boxplot(aes(fill = age_labs)) +
  geom_hline(aes(yintercept  = mean_lfm),
             linetype = "dotted") +
  scale_y_continuous(limits = c(0, 260)) +
  facet_wrap( ~ spp, labeller = labeller(spp = spp.labs)) +
  theme(
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(
      angle = 30,
      hjust = 1,
      size = 16
    ),
    axis.title.y = element_text(face = "bold", size = 16),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_blank(),
    legend.title = element_text(face = "bold"),
    strip.text = element_text(face = "italic", size = 14),
    legend.position = 'none'
  ) +
  labs(y = "Live Fuel Moisture",
       fill = "Tissue Status")
p1

p2 <- ggplot2::ggplot(data = df3, aes(x = date, y = lfm, color = phenophase_name)) +
  geom_line(alpha = 1, size = 3) +
  scale_color_manual(values = c("lightblue", "darkslategray4", "darkred", "pink")) +
  theme(aspect.ratio = 1/13,
        legend.position = 'none',
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = 'white'))
p2

p.quke <- p1 + annotation_custom(ggplotGrob(p2), xmin = "E. May", xmax = "L. Oct.",
                       ymin = -10, ymax = 30)
p.quke
```

#Legends:
```{r}
# Phenophase legend:
df.leg <- pheno_fig3 %>%
  filter(phenophase_name %in% c("Unripe seed cones" ,    
                                "Ripe seed cones" ,
                                "Breaking buds" ,
                                "Young leaves",
                                "Pollen cones",
                                "Recent seed drop",
                                "Pollen release" ,
                                "Fruits",
                                "Flowers or flower buds",
                                "Open flowers",
                                "Increasing leaf size",
                                "Falling leaves",
                                "Leaves",
                                "Colored leaves"))

df.leg$phenophase_name <- factor(df.leg$phenophase_name, levels = c( "Breaking buds",
                                                                     "Young leaves",
                                                                     "Increasing leaf size",
                                                                     "Leaves",
                                                                     "Flowers or flower buds",
                                                                      "Open flowers",
                                                                     "Unripe seed cones" ,  
                                                                     "Pollen cones",
                                                                     "Ripe seed cones" ,
                                                                      "Pollen release" ,
                                                                      "Fruits",
                                                                     "Recent seed drop",
                                                                      "Colored leaves",
                                                                      "Falling leaves"
                                                                     ))

legend.plot <- ggplot() +
  geom_line(
    aes(y = lfm, x = date, color = phenophase_name),
    alpha = 1,
    data = df.leg,
    size = 4,
    position = position_dodge(w = 1)
  ) +
  labs(color = "Phenophase") +
  #color_all +
   scale_color_manual(values = c("purple", 
                                 "blue", 
                                 "lightblue", 
                                 "lightgreen", 
                                 "darkslategray4", 
                                 "darkblue",
                                 "brown", 
                                 "goldenrod",
                                 "gold",
                                 "yellow",
                                 "pink",
                                "deeppink", 
                                  "darkred", 
                                "maroon")) + #Holder color palette, matched to the phenophase vector above
  theme(legend.position = 'top',
        legend.title = element_text(face = 'bold'))
legend.plot

legend <- cowplot::get_legend(legend.plot)

# Boxplot legend:
legend.plot2 <- ggplot(data = field_data_2021, aes(x = date, y = lfm)) +
  geom_boxplot(aes(fill = age_labs)) +
  labs(fill = "Tissue Status") +
  theme(legend.position = 'top',
        legend.title = element_text(face = 'bold'))
legend.plot2

legend2 <- cowplot::get_legend(legend.plot2)
```
Colors: 
"Breaking buds", --- purple
  "Young leaves", --- blue
 "Increasing leaf size", --- lightblue
"Leaves", --- "lightgreen"
 "Flowers or flower buds", ---"darkslategray4"
 "Open flowers", - "darkblue"
 "Unripe seed cones" ,  --- "brown"
"Pollen cones", ---"lightbrown"
"Ripe seed cones" , --- "goldenrod"
"Pollen release" , --- "gold"
"Fruits", --- "yellow"
 "Recent seed drop", --- "pink"
"Colored leaves", --- "deeppink"
"Falling leaves" --- "darkred"

c("purple", "blue", 
```{r}
abco <- pheno_fig3 %>% filter(spp == "ABCO") 
unique(abco$phenophase_name)
  
abco.phenophases <- c("Unripe seed cones",
                      "Ripe seed cones",
                      "Breaking buds",
                      "Young leaves",
                      "Pollen cones",
                      "Recent seed drop",
                      "Pollen release" )

#abco.colors <- c("lightblue", "lightgreen") # Based on above vector

abco.colors <- c("purple", 
                                 "blue", 
                                 #"lightblue", 
                                 "lightgreen", 
                                 #"darkslategray4", 
                                # "darkblue",
                                 "brown", 
                                 "goldenrod",
                                 "gold",
                                 "yellow"
                                # "pink",
                               # "deeppink", 
                               #   "darkred", 
                               # "maroon"
                 ) # Based on above vector

p.abco <-pheno.boxplot.vis(species = "ABCO",
                    phenophases = abco.phenophases,
                    colors = abco.colors)
p.abco
```


```{r}
#------
pije <- pheno_fig3 %>% filter(spp == "PIJE") 
listpije <- list(unique(pije$phenophase_name))
listpije

pije.phenophases <- listpije
pije.colors <- c( "brown", 
                  "gold",
                  "blue",
                  "goldenrod",
                  "deeppink",
                  "yellow",
                  "lightblue")
p.pije <-
  pheno.boxplot.vis(species = "PIJE",
                    phenophases = pije.phenophases,
                    colors = pije.colors)
p.pije

cade.phenophases <- c("Pollen cones", "Pollen release")
cade.colors <- c("brown", "gold")
p.cade <-
  pheno.boxplot.vis(
    species = "CADE",
    phenophases = cade.phenophases,
    max.y = 150,
    colors = cade.colors
  )

arpa.phenophases <-
  c("Breaking buds",
    "Flowers or flower buds",
    "Ripe fruits",
    "Young leaves")
arpa.colors <- c("lightblue", "deeppink", "darkred", "lightgreen")
p.arpa <-
  pheno.boxplot.vis(
    species = "ARPA",
    phenophases = arpa.phenophases,
    max.y = 210,
    colors = arpa.colors,
    no.phenophases = four
  )

ceco.phenophases <-
  c("Flowers or flower buds", "Ripe fruits", "Young leaves")
ceco.colors <- c("deeppink", "darkred", "lightgreen")
p.ceco <-
  pheno.boxplot.vis(
    species = "CECO",
    phenophases = ceco.phenophases,
    max.y = 260,
    colors = ceco.colors,
    no.phenophases = three
  )

```

#Arrange
```{r}
# I ended up doing some odd cowplot stuff here to get the final product we wanted
p.spp <- cowplot::plot_grid(p.abco, p.pije, p.cade, p.ceco, p.arpa, p.quke, ncol = 3)
p.spp

ggsave(here("figures", "phenophase.lfm.boxplot.jpg"),
       height = 10, width = 15,
       plot = p.spp)

blank_plot <- ggplot(data = df1, aes(x = lfm, y = week)) +
  geom_point(color = 'white') +
  theme_void()

legends <- cowplot::plot_grid(blank_plot, legend, legend2, ncol = 1,
                              rel_heights = c(3, 1, 1))
legends
ggsave(here("figures", "phenophase.lfm.legends.jpg"),
       height = 2, width = 7,
       plot = legends)

# For some strange reason, I could not get the legends and the plots to mesh together with cowplot or ggarrange... I ended up just stitching them together on Google Slides
```



```{r}
pheno_df %>% 
  filter(phenophase_status == "Yes", 
         #class == "Gymnosperm"
         ) %>% 
  ggplot(aes(
    y = phenophase_name, 
    x = date, 
    color = phenophase_name
    )) + 
  facet_wrap(~scientific_name) +
  geom_line() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
```


```{r}
field_data_all_3 %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(fill = lfm, y = lfm,  x = as.factor(date), color = age)) + 
  geom_boxplot(position="dodge") +
  
  theme(axis.ticks.x = element_blank(),
                              axis.title.x = element_blank(), 
                              axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = 166, linetype = "dashed", color = "blue") +
  geom_vline(xintercept = "2021-01-01")+
  ylab("Live Fuel Moisture") +
  xlab("Date") +
  ggtitle("Abies concolor")
```

```{r}
field_data_all_3 %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(fill = lfm, y = lfm,  x = as.factor(date), color = age)) + 
  geom_boxplot(position="dodge") +
  
  theme(axis.ticks.x = element_blank(),
                              axis.title.x = element_blank(), 
                              axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = 166, linetype = "dashed", color = "blue") +
  ylab("Live Fuel Moisture") +
  xlab("Date") +
  ggtitle("Abies concolor")
```

```{r}
field_data_all_3 %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(fill = lfm, y = midday,  x = as.factor(date))) + 
  geom_boxplot(position="dodge") +
  
  theme(axis.ticks.x = element_blank(),
                              axis.title.x = element_blank(), 
                              axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = -2.1, linetype = "dashed", color = "blue") +
  ylab("Midday (-Mpa)") +
  xlab("Date") +
  ggtitle("Abies concolor") 
```

```{r}
field_data_all_3 %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(fill = lfm, y = predawn,  x = as.factor(date))) + 
  geom_boxplot(position="dodge") +
  
  theme(axis.ticks.x = element_blank(),
                              axis.title.x = element_blank(), 
                              axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = -2.1, linetype = "dashed", color = "blue") +
  ylab("Predawn (-Mpa)") +
  xlab("Date") +
  ggtitle("Abies concolor") 
```
```{r}
field_data_all_3 %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(color = lfm, y = predawn,  x = as.factor(date))) + 
  geom_col(position="dodge") +
  
  theme(axis.ticks.x = element_blank(),
                              axis.title.x = element_blank(), 
                              axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_hline(yintercept = -2.1, linetype = "dashed", color = "blue") +
  ylab("Predawn (-Mpa)") +
  xlab("Date") +
  ggtitle("Abies concolor") 
```

#midday vs. predawn

####Setup
```{r}
field_data_2021_wider <- field_data_2021_tlps %>% 
  mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  filter(age != "both") %>% 
  pivot_wider(
    id_cols = c(unique_id, date, age, lfm),
    #names_from = Species, 
    values_from = c(predawn, midday))
```

```{r}
field_data_2021_longer <- field_data_2021_tlps %>% 
  mutate(Species = case_when(
     spp == "ABCO" ~ "A. concolor",
    spp == "PIJE" ~ "P. jeffreyi", 
    spp == "CADE" ~ "C. decurrens", 
    spp == "CECO" ~ "C. cordulatus", 
    spp == "ARPA" ~ "A. patula", 
    spp == "QUKE" ~ "Q. kelloggii"
    )) %>% 
  filter(age != "both") %>% 
  pivot_longer(
    cols = c("predawn", "midday"),
    names_to = "timing_mpa", 
    values_to = "field_mpa")
```

```{r}
field_data_2021_longer %>% 
 ggplot() + 
  geom_boxplot(aes(y = field_mpa, 
                   x = cut(date, breaks="week"),
                   #x = week, 
                 color = timing_mpa,
                 fill = "#dfbbc8"
                 ),
               data = field_data_2021) +
  facet_wrap(~ Species) +
  
  theme(axis.ticks.x = element_blank(),
        #axis.title.x = element_blank(), 
        axis.text.x = element_text(angle = 30, hjust = 1, size = 10), 
        #legend.position = "none"
        ) +
  #geom_hline(yintercept = mean_tlp_spp_spp, linetype = "dotted", color = "olivedrab") +
  labs( y ="Predawn (MPa)", 
        x = "Date", 
        #color = "Phenophase", 
        #shape = "Age", 
        #fill = "Age"
        ) +
  #ylim(40, 400) +
   scale_fill_manual(values=met.brewer("Morgenstern", 3)) 
   #scale_fill_manual(values=c("#7c668c","#db8872")) #+
  #scale_x_date(date_labels = "%b")

```


#Predawn over time
```{r}
field_data_all_3 %>% 
  filter(age != "both") %>% 
  filter(year == 2021) %>% 
  ggplot() + 
  geom_boxplot(aes(y = predawn, 
                   x = cut(date, breaks="week"),
                   #x = week, 
                 #color = age
                 fill = "#dfbbc8"
                 )) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs)) +
  
  theme(axis.ticks.x = element_blank(),
        #axis.title.x = element_blank(), 
        axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
        axis.title = element_text(face = "bold"),
        strip.text = element_text(face = "italic"),
        legend.position = "none"
        ) +
  #geom_hline(yintercept = field_data_all_3$mean_tlp_spp, linetype = "dotted", color = "olivedrab") +
  labs( y ="Predawn (MPa)", 
        x = "Date", 
        #color = "Phenophase", 
        #shape = "Age", 
        #fill = "Age"
        ) +
  #ylim(40, 400) +
   scale_fill_manual(values=met.brewer("Morgenstern", 3)) 
   #scale_fill_manual(values=c("#7c668c","#db8872")) #+
  #scale_x_date(date_labels = "%b")


```

#Midday over time
```{r}
field_data_all_3 %>% 
  filter(age != "both") %>% 
  filter(year == 2021) %>% 
  ggplot() + 
  geom_boxplot(aes(y = midday, 
                   x = cut(date, breaks="week"),
                   #x = week, 
                 #color = age
                 fill = "#dfbbc8"
                 )) +
  facet_wrap(~spp, labeller = labeller(spp = spp.labs)) +
  
  theme(axis.ticks.x = element_blank(),
        #axis.title.x = element_blank(), 
        axis.text.x = element_text(angle = 30, hjust = 1, size = 10),
        axis.title = element_text(face = "bold"),
        strip.text = element_text(face = "italic"),
        legend.position = "none"
        ) +
  #geom_hline(yintercept = field_data_all_3$mean_tlp_spp, linetype = "dotted", color = "olivedrab") +
  labs( y ="Midday (MPa)", 
        x = "Date", 
        #color = "Phenophase", 
        #shape = "Age", 
        #fill = "Age"
        ) +
  #ylim(40, 400) +
   scale_fill_manual(values=met.brewer("Morgenstern", 3)) 
   #scale_fill_manual(values=c("#7c668c","#db8872")) #+
  #scale_x_date(date_labels = "%b")

```

#Stems vs. Leaves

```{r}
stems_leaves_2021 <- read_csv(here("processed-data", "compiled-datasets", "SEKI", "stems_leaves_2021.csv")) %>% 
  mutate(stem_leaves = case_when(
    stem_leaves == "l" ~ "leaf", 
    stem_leaves == "s" ~ "stem", 
    stem_leaves == "both" ~ "both"
  ))
```

```{r}
stems_leaves_2021 %>% 
  filter(lfm > 0, age == "old") %>% 
  filter(spp %in% c("ABCO", "ARPA", "CECO")) %>% 
  ggplot(aes(y = lfm, x = stem_leaves, color = stem_leaves)) +
  #geom_beeswarm(aes(y = lfm, x = age, color = stem_leaves)) +
  facet_wrap(~spp) +
  geom_boxplot(fill = NA) +
  scale_color_manual(values = c("darkblue","olivedrab","goldenrod")) +
  
  labs(y = "LFM", 
       x = "Tissue Type", 
       color = "") +
  theme(legend.position = "none")
```

#-----------------------------------------------

#**Ignore me**

Organize data:
```{r}
data.xpp <- field_data_all_3 %>% 
  select(spp, age, site, pod, lfm, date, predawn, midday, type, doy, location, LFMtlp, Mpatlp) %>% #filter out super high LFM (check that this is ok? Necessary?)
  mutate(lfm.outliers.out = lfm) #add a column that we can use to take out outliers

range(data.xpp$LFMtlp)

data.xpp %>%
  filter(spp != "CECO") %>%
  summarise(mean(LFMtlp))


data.xpp <- data.xpp %>%
  filter(!is.na(predawn)) #remove rows where we are missing Xpp values 

data.xpp <- data.xpp %>%
  mutate_if(is.factor, as.character) 
str(data.xpp) #view data; 

data.xpp$date <- factor(data.xpp$date,       # Change ordering manually
                         levels = c("7/15/20", "7/27/20", "8/4/20", "8/26/20", "10/19/20", "4/24/21" ))

#LFM outliers? Check:
#source("http://goo.gl/UUyEzD")
#outlierKD(data.xpp, lfm.outliers.out) #

##create new dataset with all Xpp measurements together and column time = predawn or midday 
split.lfm <- gather(data.xpp, key = "time", value = "xpp",
       predawn, midday) 
str(split.lfm)#view

## order dates so they are in chronological order in the graph
split.lfm$date <- factor(split.lfm$date,       # Change ordering manually
                         levels = c("7/15/20", "7/27/20", "8/4/20", "8/26/20", "10/19/20", "4/24/21" ))
```

```{r, warning=FALSE}
#Visualize: plot LFM and Water potential:
ggplot(data = data.xpp, aes(x = predawn, y = lfm, color = date)) +
  geom_point(size = 1) +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") +
  xlim(-5,0) + 
  ylim(50,300)  + 
  ylab("Live Fuel Moisture") +
  xlab("Predawn (-Mpa)") +
  ggtitle("All values") +
  th

# #Visualize: plot LFM and Water potential (outliers out)
# plot <- ggplot(data = data.xpp, aes(x = predawn, y = lfm, color = date)) +
#   geom_point(size = 1) +
#   #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") +
#   xlim(-5,0) + 
#   ylab("Live Fuel Moisture") +
#   xlab("Predawn (-Mpa)") +
#   ylim(50,300) +
#   #ggtitle("Outliers removed (outlierKD)") +
#   th
# print(plot) #view plot
```

```{r}
#Visualize: plot LFM and midday Water potential
plot <- ggplot(data = data.xpp, aes(x = midday, y = lfm, color = date)) +
  geom_point(size = 1) +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") +
  xlim(-5,0) + 
  ylab("Live Fuel Moisture") +
  xlab("Midday (-Mpa)") +
  ylim(50,300) +
  #ggtitle("Outliers removed (outlierKD)") +
  th
print(plot) #view plot
```

Just one species (ABCO):

```{r}
predawn.xpp.spp.plot <- data.xpp %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(fill = lfm, y = lfm,  x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp") + theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              axis.title.x = element_blank()) +
  geom_hline(yintercept = 166, linetype = "dashed", color = "blue") +
  
  ylab("Live Fuel Moisture") +
  xlab("Date") +
  ggtitle("Abies concolor") 
predawn.xpp.spp.plot

predawn.xpp.spp.plot <- data.xpp %>%
  filter(spp == "ABCO") %>%
  #filter(time == "midday") %>%
  ggplot(aes(fill = lfm, y = midday,  x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp") + theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              axis.title.x = element_blank()) +
  geom_hline(yintercept = -2.1, linetype = "dashed", color = "blue") +
  
  ylab("Midday (-Mpa)") +
  xlab("Date") +
  ggtitle("Abies concolor") 
predawn.xpp.spp.plot
```


```{r}
#Visualize: plot LFM and Water potential (outliers in), by age (so select only PIJE and ABCO, which are the ones with old and new)
filter = dplyr::filter #apaprently there is a override in tidyverse that makes filter sometimes use package stats...so do this. 
old.new <- data.xpp %>%
  filter(spp == "PIJE"|spp == "ABCO") 
  #filter(spp == "ABCO")

plot <- ggplot(data = old.new, aes(x = midday, y = lfm, color = age, shape = spp)) +
  geom_point() +
  #stat_smooth(aes(x = LFM, y = predawn, colour = Date, linetype = "Linear Fit"), method = "lm") +
  xlim(-5,0) + 
  ylim(50,300) +
  ggtitle("By age, PIJE and ABCO")
print(plot) #view plot
```

Segmented regression: 

1. Predawn: 
```{r}
###Looks better with outliers in....300 lfm realistic?

#####build lm model and find inflection point using 'segmented' package...do this with each spp? 

model_segmented.pd <- segmented(lm(lfm ~ predawn, data=data.xpp), seg.Z = ~ predawn)
model_segmented.pd

predict_segmented = data.frame(predawn = data.xpp$predawn, lfm = broken.line(model_segmented.pd)$fit)

my.lines <- model_segmented.pd$psi[,2]

ggplot(df, aes(x = predawn, y = lfm, color = spp)) +
  geom_point() + geom_line(data = predict_segmented, color = 'blue') ##works! kinda weird looking though... 

predict_segmented = data.frame(predawn = data.xpp$predawn, lfm = broken.line(model_segmented)$fit)
ggplot(df, aes(x = predawn, y = lfm, color = date)) +
  geom_point() + 
  geom_line(data = predict_segmented, color = 'purple') +
   geom_vline(xintercept = my.lines, linetype = "dashed") +
   annotate(geom = "text",  x= my.lines ,y= 210, # Rectangle size around label
    label.size = .25, label = "TLP: 135% LFM")

model_segmented.lfm <- segmented(lm(predawn~lfm, data=data.xpp), seg.Z = ~ lfm)
model_segmented.lfm #get lfm breakpoint value....I think? Might actually be embedded in results above. 
```

2. Midday 
```{r}
###Looks better with outliers in....300 lfm realistic?

#####build lm model and find inflection point using 'segmented' package...do this with each spp? 

model_segmented.md <- segmented(lm(lfm ~ midday, data=data.xpp), seg.Z = ~ midday)
model_segmented.md

predict_segmented = data.frame(midday = data.xpp$midday, lfm = broken.line(model_segmented.md)$fit)

my.lines <- model_segmented.md$psi[,2]

ggplot(df, aes(x = midday, y = lfm, color = spp)) +
  geom_point() + geom_line(data = predict_segmented, color = 'blue') ##works! kinda weird looking though... 

predict_segmented = data.frame(midday = data.xpp$midday, lfm = broken.line(model_segmented)$fit)
ggplot(df, aes(x = midday, y = lfm, color = date)) +
  geom_point() + 
  geom_line(data = predict_segmented, color = 'purple') +
   geom_vline(xintercept = my.lines, linetype = "dashed") +
   annotate(geom = "text",  x= my.lines ,y= 210, # Rectangle size around label
    label.size = .25, label = "TLP: 164% LFM")

model_segmented.lfm <- segmented(lm(midday~lfm, data=data.xpp), seg.Z = ~ lfm)
model_segmented.lfm #get lfm breakpoint value....I think? Might actually be embedded in results above. 
```

```{r}
###
## Compare trees vs. shrubs xpps
###

shrubs.xpp <- split.lfm %>%
  filter(type == "shrub") %>%
  ggplot(aes(fill = time, y = xpp, x = date)) + 
  geom_bar(position="dodge", stat="identity") +
  ggtitle("shrubs") + theme(axis.text.x = element_blank(),
                            axis.ticks.x = element_blank(),
                            axis.title.x = element_blank())
shrubs.xpp
```


```{r}
shrubs.xpp <- split.lfm %>%
  filter(type == "shrub") %>%
  ggplot(aes(fill = time, y = xpp, x = date)) + 
  geom_bar(position="dodge", stat="identity") +
  ylab("Water Potential") +
  ggtitle("Shrubs") + 
  th
shrubs.xpp

#shrubs.xpp
trees.xpp <- split.lfm %>%
  filter(type == "tree") %>%
  ggplot(aes(fill = time, y = xpp, x = date)) + 
  geom_bar(position="dodge", stat="identity") +
  ylab("Water Potential") +
  ggtitle("Trees") +
  th 
trees.xpp
```

```{r}
###
##compare LFM and all XPPs, splitting trees vs. shrubs
###

lfm.type.plot <- ggplot(split.lfm, aes(fill = type, y = lfm, x = date)) + 
  geom_boxplot(position="dodge")  + theme(axis.text.x = element_blank(),
                                          axis.ticks.x = element_blank(),
                                          axis.title.x = element_blank() )
predawn.xpp.type.plot <- split.lfm %>%
  filter(time == "predawn") %>%
  ggplot(aes(fill = type, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp") + theme(axis.text.x = element_blank(),
                               axis.ticks.x = element_blank(),
                               axis.title.x = element_blank())
#predawn.xpp.type.plot
midday.xpp.type.plot <- split.lfm %>%
  filter(time == "midday") %>%
  ggplot(aes(fill = type, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("midday xpp")

# Create multiple plots in one
#   and then nest it inside of a second. Also, include a title at the top 
#   for the whole figure. 
# title <- ggdraw() + draw_label("Sierra Sites", fontface='bold')
# plot_grid(title, lfm.type.plot,
#           predawn.xpp.type.plot,
#           midday.xpp.type.plot,
#           nrow = 4, labels = c("", "", ""),
#           rel_heights = c(0.2, 1, 1, 1))

###
##compare LFM and all XPPs, split by spp. 
###

lfm.spp.plot <- ggplot(split.lfm, aes(fill = spp, y = lfm, x = date)) + 
  geom_boxplot(position="dodge")  + theme(axis.text.x = element_blank(),
                                          axis.ticks.x = element_blank(),
                                          axis.title.x = element_blank() )
predawn.xpp.spp.plot <- split.lfm %>%
  filter(spp == "ABCO") %>%
  filter(time == "midday") %>%
  ggplot(aes(fill = spp, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp") + theme(axis.text.x = element_blank(),
                              axis.ticks.x = element_blank(),
                              axis.title.x = element_blank()) +
  
  ylab("Midday (-Mpa)")
predawn.xpp.spp.plot
#predawn.xpp.type.plot

midday.xpp.spp.plot <- split.lfm %>%
  filter(time == "midday") %>%
  ggplot(aes(fill = spp, y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("Midday (-Mpa)") +
  xlab("Date")
midday.xpp.spp.plot
```
#####
#####
#####

```{r}
##compare LFM and predawn XPPs, no split

lfm.plot <- ggplot(split.lfm, aes(y = lfm, x = date)) + 
  geom_boxplot(position="dodge")  + theme(axis.text.x = element_blank(),
                                          axis.ticks.x = element_blank(),
                                          axis.title.x = element_blank() )
lfm.plot

predawn.plot <- split.lfm %>%
  filter(time == "predawn") %>%
  ggplot(aes(y = xpp, x = date)) + 
  geom_boxplot(position="dodge") +
  ylab("predawn xpp")
predawn.plot
```

```{r, message = FALSE}
field_data_2021%>% 
  ggplot(aes(y = -1/midday, x = rwd, color = spp)) +
  geom_point(alpha = 1, size = 1) +
  labs(y = "Midday (-1/Mpa)", 
       x = "Relative Water Deficit (%)")
```

```{r}
field_data_2021%>% 
  ggplot() +
 # geom_point(color = "olivedrab", alpha = .5, size = .5) +
  geom_jitter(aes(x= date, y = midday), color = "goldenrod", alpha = .5, size = .5) +
  geom_jitter(aes(x= date, y = predawn), color = "lightblue", alpha = .5, size = .5) 
```

```{r}
field_data_2021%>% 
  ggplot() +
  geom_jitter(aes(x= date, y = lfm), color = "goldenrod", alpha = .5, size = 1)


```

```{r}
field_data_2021%>% 
  ggplot() +
  geom_jitter(aes(x= date, y = lfm, color = spp), alpha = .5, size = 1)

```
